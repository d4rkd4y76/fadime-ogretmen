<!DOCTYPE html>

<html lang="tr">
<head>
<!-- NOVA SAFE HEAD -->
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style id="nova-space-arena-style">
/* === NOVA SAFE SPACE-ARENA PACK === */
:root{ --nova-neon:#00f0ff; --nova-mint:#00ffcc; --nova-blue:#66a6ff; }

/* Background upgrade (scoped by detection class when applied) */
.nova-duel-arena{
  position: relative; isolation:isolate;
  background: radial-gradient(1200px 600px at 50% 120%, #061129 0%, #040a1a 40%, #020611 70%, #01030a 100%) !important;
  overflow: hidden;
}
.nova-duel-arena::before{
  content:''; position:absolute; inset:-20%;
  background:
    radial-gradient(2px 2px at 20% 30%, #d1e6ff 50%, transparent 51%) repeat,
    radial-gradient(1px 1px at 60% 70%, #9bc2ff 50%, transparent 51%) repeat,
    radial-gradient(1px 1px at 80% 20%, #ffffff 50%, transparent 51%) repeat;
  background-size: 300px 300px, 250px 250px, 200px 200px;
  animation: novaStarDrift 40s linear infinite;
  opacity:.75; z-index:0; pointer-events:none;
  filter: drop-shadow(0 0 2px rgba(160,200,255,.4));
}
.nova-duel-arena::after{
  content:''; position:absolute; inset:-10%;
  background: conic-gradient(from 0deg at 50% -10%, rgba(0,255,255,.06), transparent 20%, rgba(255,0,255,.06) 40%, transparent 60%, rgba(0,255,255,.06) 80%, transparent);
  filter: blur(8px); animation: novaSweep 12s linear infinite; z-index:1; pointer-events:none;
}
@keyframes novaStarDrift{ to { transform: translateY(-200px); } }
@keyframes novaSweep{ to { transform: rotate(1turn); } }

/* Question card readability */
.nova-question{
  position:relative;
  background: rgba(8,18,40,.92) !important;
  border:2px solid rgba(0,200,255,.45) !important;
  border-radius:16px !important;
  box-shadow: inset 0 0 20px rgba(0, 200, 255, .25), 0 0 24px rgba(0, 200, 255, .25);
  color:#e9f4ff !important;
  backdrop-filter: blur(6px);
  z-index:5 !important;
}
.nova-question .nova-aurora{
  position:absolute; left:3%; width:94%; height:10px; top:-3px;
  background: linear-gradient(90deg, rgba(0,255,200,.0), rgba(0,255,200,.35), rgba(0,160,255,.55), rgba(0,255,200,.35), rgba(0,255,200,.0));
  filter: blur(8px); opacity:.9; border-radius: 8px;
  animation: novaAuroraMove 6s ease-in-out infinite; pointer-events:none;
}
@keyframes novaAuroraMove{
  0%,100%{ transform: translateX(-4%) scaleY(1); opacity:.85; }
  50%{ transform: translateX(4%) scaleY(1.08); opacity:1; }
}

/* Options readability */
.nova-duel-arena .option-button,
.nova-duel-arena [class*="option" i]{
  background: linear-gradient(180deg, rgba(28,40,72,.9), rgba(10,16,30,.9)) !important;
  border:1px solid rgba(0,200,255,.35) !important;
  color: #e9f4ff !important;
  box-shadow: 0 4px 12px rgba(0,0,0,.35), 0 0 12px rgba(0,200,255,.25) inset;
  position:relative; z-index:6 !important;
}

/* Neon +1 */
.animated-plus-one{
  font-weight:900; font-size: 9em;
  background: linear-gradient(90deg, var(--nova-neon), var(--nova-mint), var(--nova-blue), var(--nova-neon));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  filter: drop-shadow(0 0 10px rgba(0,255,255,.65)) drop-shadow(0 0 25px rgba(0,180,255,.45)) drop-shadow(0 0 40px rgba(0,120,255,.35));
  letter-spacing:-2px; animation: novaPlusFly 1.1s cubic-bezier(.25,.8,.25,1) forwards, novaPlusFlicker 1.1s linear; pointer-events:none; z-index: 1000;
}
@keyframes novaPlusFly{
  0%{ opacity:0; transform: translate(-50%, -50%) scale(.6) rotate(-6deg); }
  12%{ opacity:1; transform: translate(-50%, -50%) scale(1.05) rotate(0deg);}
  100%{ opacity:0; transform: translate(calc(-50% + 260px), calc(-50% - 260px)) scale(.55) rotate(6deg);}
}
@keyframes novaPlusFlicker{
  0%, 100%{ filter: drop-shadow(0 0 10px rgba(0,255,255,.65)) drop-shadow(0 0 25px rgba(0,180,255,.45)) drop-shadow(0 0 40px rgba(0,120,255,.35)); }
  50%{ filter: drop-shadow(0 0 14px rgba(0,255,255,.9)) drop-shadow(0 0 30px rgba(0,180,255,.7)) drop-shadow(0 0 54px rgba(0,120,255,.6)); }
}

/* Decorative orbs (anchored + behind UI) */
.nova-orbs{ position:absolute; inset:0; z-index:2; pointer-events:none; }
.nova-orb{ position:absolute; width:clamp(34px, 5vw, 58px); height:clamp(34px, 5vw, 58px); border-radius:50%; opacity:.82;
  background:
    radial-gradient(45% 45% at 30% 30%, rgba(255,255,255,.45), rgba(255,255,255,0) 60%),
    radial-gradient(75% 75% at 50% 50%, rgba(110,170,255,.38), rgba(24,60,130,.12) 74%, rgba(0,0,0,0) 76%);
  box-shadow: inset 0 0 18px rgba(120,180,255,.35), 0 6px 18px rgba(0,0,0,.35);
  animation: novaOrbBreath 4.8s ease-in-out infinite; will-change: transform, filter, opacity;
}
.nova-orb.orb-a{ left:10px; top:10px; }
.nova-orb.orb-b{ right:10px; bottom:10px; }
@keyframes novaOrbBreath{ 0%,100%{ transform: scale(1);} 50%{ transform: scale(1.07);} }

/* Force suspicious round blobs behind UI and non-interactive */
.nova-force-behind{ z-index:1 !important; pointer-events:none !important; opacity:.6 !important; mix-blend-mode: screen; }

/* UI elevation */
.nova-duel-arena .question-container, 
.nova-duel-arena [class*="soru" i],
.nova-duel-arena .option-button, 
.nova-duel-arena [class*="option" i],
.nova-duel-arena [class*="player" i], 
.nova-duel-arena [class*="score" i]{
  position:relative; z-index:8 !important;
}

/* Shockwave on orb */
.nova-orb .shockwave{
  position:absolute; left:50%; top:50%; width:10px; height:10px; border-radius:50%;
  border:2px solid rgba(0,255,200,.65);
  transform: translate(-50%,-50%) scale(0.2);
  opacity:.9; animation: novaOrbShock 800ms ease-out forwards; box-shadow: 0 0 16px rgba(0,255,200,.65);
}
@keyframes novaOrbShock{ to{ transform: translate(-50%,-50%) scale(5); opacity:0; } }
</style>

<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" name="viewport"/>
<title>Şampiyonlar Düellosu</title>
<!-- Comfortaa Font -->
<link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&amp;display=swap" rel="stylesheet"/>
<style>

/* === Nova: Explanation Highlight (Single Player) === */
.explanation-container{margin-top:14px;display:none;}

/** Mağaza kategori butonlarını DB'deki adlarla render eder. */

function renderStoreCategoryButtons() {
  const area = document.querySelector('.profile-categories');
  if (!area) return;
  area.style.display = 'flex';
  area.innerHTML = '';

  // Tüm mevcut anahtarları çıkar
  const keys = [];
  try {
    for (const k of Object.keys(photoCategories || {})) { keys.push(k); }
  } catch(_){}

  // Hiç yoksa yine de bilinen varsayılanları öner
  if (!keys.length) keys.push('DünyaDevleri','cesur','TemelKarakterler','SüperLig','DünyaFutbolcuları','KizlarKösesi','EFSANE');

  // Tekrarsızlaştır
  /*NOVA_RENDER_ORDER_ENFORCED*/
  // 'EFSANE' butonunu DOM'da en sona yazmak için listeyi böl
  const otherKeys = keys.filter(k => k !== 'EFSANE' && k !== 'duel');
  const ordered = [...(keys.includes('duel') ? ['duel'] : []), ...otherKeys, 'EFSANE'];
  // tekrarlı 'EFSANE' eklemelerini temizle
  const seen = new Set();
  const finalKeys = ordered.filter(k => (k==='EFSANE' ? (!seen.has('EFSANE') && (seen.add('EFSANE')||true)) : (!seen.has(k) && (seen.add(k)||true))));

  /*NOVA_FORCE_ORDER*/
  try {
    // 'EFSANE'yi sona taşı (güçlü garanti)
    const ix = keys.indexOf('EFSANE');
    if (ix > -1) { keys.splice(ix,1); }
    // ayrıca 'duel' varsa onu en başa çekme/yerinde bırakma
    // diğerlerini sırayla yaz, sonra EFSANE'yi ekle
    keys.push('EFSANE');
  } catch(_){}

  // 'EFSANE'yi en sona al
  try {
    const idx = keys.indexOf('EFSANE');
    if (idx > -1) { keys.splice(idx, 1); keys.push('EFSANE'); }
  } catch(_){}

  const seen = new Set(); const finalKeys = [];
  keys.forEach(k => { if (k && !seen.has(k)) { seen.add(k); finalKeys.push(k); } });

  finalKeys.forEach((k, i) => {
    const btn = document.createElement('button');
    btn.className = 'category-button' + (i===0 ? ' active' : '');
    btn.dataset.category = k;
    btn.textContent = k;
    btn.addEventListener('click', () => {
      document.querySelectorAll('.category-button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const duelStore = document.getElementById('duelCreditsStore');
      const photosContainer = document.getElementById('profilePhotosContainer');
      if (duelStore && photosContainer) {
        if (k === 'duel') { duelStore.style.display='block'; photosContainer.style.display='none'; }
        else { duelStore.style.display='none'; photosContainer.style.display='grid'; }
      }
      loadProfilePhotos(k);
    });
    area.appendChild(btn);
  });
}
);
    // Ekstra bilinmeyen anahtarlar için:
    try {
      const allKeys = Object.keys({DünyaDevleri:photoCategories.DünyaDevleri, cesur:photoCategories.cesur, sampiyon:photoCategories.sampiyon}).filter(Boolean);
      allKeys.forEach(k => set.add(k));
    } catch(_) {}
    cats.push(...Array.from(set));
  }

  // Butonları oluştur
  cats.forEach((k, i) => {
    const btn = document.createElement('button');
    btn.className = 'category-button' + (i===0 ? ' active' : '');
    btn.dataset.category = k;
    // Görünen isim DB anahtarı olsun (ör: 'DünyaDevleri', 'cesur'...), istersen burada displayName eşlemesi yapabiliriz
    btn.textContent = k;
    area.appendChild(btn);
  });

  // Event binding
  document.querySelectorAll('.category-button').forEach(button => {
    button.addEventListener('click', () => {
      document.querySelectorAll('.category-button').forEach(b => b.classList.remove('active'));
      button.classList.add('active');

      const duelStore = document.getElementById('duelCreditsStore');
      const photosContainer = document.getElementById('profilePhotosContainer');

      if (button.dataset.category === 'duel') {
        duelStore.style.display = 'block';
        photosContainer.style.display = 'none';
      } else {
        duelStore.style.display = 'none';
        photosContainer.style.display = 'grid';
        loadProfilePhotos(button.dataset.category);
      }
    });
  });
}
.explanation-card{
  background:#ecfdf5;             /* açık yeşil */
  border:3px solid #166534;       /* koyu yeşil çerçeve */
  border-radius:14px;
  padding:14px;
  box-shadow:0 10px 24px rgba(22,101,52,0.18);
  animation: expCardIn .25s ease-out;
}
@keyframes expCardIn{from{transform:translateY(6px);opacity:0}to{transform:translateY(0);opacity:1}}
.explanation-title{
  display:inline-block;
  font-weight:900;
  font-size:1rem;
  color:#065f46;
  background:#d1fae5;
  border:2px solid #065f46;
  padding:4px 10px;
  border-radius:999px;
  letter-spacing:.3px;
  margin-bottom:8px;
}
.explanation-correct{
  font-size:1.1rem;
  font-weight:800;
  color:#065f46;
  background:linear-gradient(0deg, rgba(5,150,105,.10), rgba(5,150,105,.10));
  border-left:6px solid #10b981;
  padding:8px 12px;
  border-radius:10px;
  margin:6px 0 8px 0;
}
.explanation-text{
  font-size:.98rem;
  color:#064e3b;
  line-height:1.35;
  background:#f0fdf4;
  border-left:4px dashed #34d399;
  padding:10px 12px;
  border-radius:8px;
}
.next-question-button{
  margin-top:10px;
  display:inline-flex;
  align-items:center;
  gap:8px;
  background:#10b981;
  color:#fff;
  font-weight:700;
  border:none;
  border-radius:10px;
  padding:10px 16px;
  cursor:pointer;
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease;
}
.next-question-button:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(16,185,129,.35);background:#059669}
.next-question-button:active{transform:translateY(0);box-shadow:none}
/* === End Nova === */

        /* CSS Kodları */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Comfortaa', cursive;
        }

        body {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: backgroundPulse 10s infinite alternate;
        }

        @keyframes backgroundPulse {
            from {
                background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            }
            to {
                background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
            }
        }

        .container, .game-container, .student-selection-container, .single-player-game-container, .duel-selection-container, .duel-game-container {
            background: white;
            padding: 30px 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 1200px;
            text-align: left;
            transform: scale(0.95);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            animation: fadeInUp 0.5s forwards;
        }

.logout-button {
    background-color: #dc3545; /* Kırmızı renk */
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 10px; /* Köşeleri yuvarla */
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s;
    font-size: 1.1em;
    margin-top: 20px; /* Üstten boşluk */
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.logout-button:hover {
    background-color: #c82333; /* Hover sırasında biraz daha koyu kırmızı */
    transform: scale(1.05);
    box-shadow: 0 7px 20px rgba(0,0,0,0.2);
}


select {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    border: 2px solid #ff8a00;
    border-radius: 12px;
    padding: 12px;
    font-size: 1.1em;
    color: #333;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease-in-out;
}

.friends-button {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
    color: white;
    padding: 18px;
    border: none;
    border-radius: 12px;
    font-size: 1.1em;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.student-stats-container {
    position: relative;
    margin-top: 10px; /* Azaltıldı: 20px -> 15px */
    padding: 2px; /* Azaltıldı: 5px -> 3px */
    perspective: 1000px;
}

.student-stats {
    display: flex;
    justify-content: center;
    gap: 6px; /* Azaltıldı: 25px -> 15px */
    padding: 5px; /* Azaltıldı: 15px -> 10px */
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px; /* Azaltıldı: 20px -> 15px */
    backdrop-filter: blur(10px);
    box-shadow: 0 6px 24px 0 rgba(31, 38, 135, 0.37); /* Azaltıldı shadow */
    border: 1px solid rgba(255, 255, 255, 0.18);
    transform-style: preserve-3d;
    animation: floatStats 6s ease-in-out infinite;
}

.stats-item {
    position: relative;
    display: flex;
    align-items: center;
    gap: 4px; /* Azaltıldı: 12px -> 8px */
    padding: 4px 8px; /* Azaltıldı: 12px 20px -> 8px 15px */
    border-radius: 8px; /* Azaltıldı: 16px -> 12px */
    background: rgba(255, 255, 255, 0.05);
    overflow: hidden;
    transition: all 0.3s ease;
}



.stats-glow {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100%;
    height: 100%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    z-index: 1;
}

.trophy-glow {
    background: radial-gradient(circle at center,
        rgba(255, 215, 0, 0.3) 0%,
        transparent 70%);
    animation: pulseGold 2s ease-in-out infinite;
}

.diamond-glow {
    background: radial-gradient(circle at center,
        rgba(30, 144, 255, 0.3) 0%,
        transparent 70%);
    animation: pulseBlue 2s ease-in-out infinite;
}

.stats-icon {
    position: relative;
    font-size: 1.1em; /* Azaltıldı: 2em -> 1.3em */
    z-index: 2;
}

.trophy-stats .stats-icon {
    animation: shakeRotate 3s ease-in-out infinite;
    filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
}

.diamond-stats .stats-icon {
    animation: floatShine 3s ease-in-out infinite;
    filter: drop-shadow(0 0 10px rgba(30, 144, 255, 0.5));
}

.stats-value {
    position: relative;
    font-size: 1em; /* Azaltıldı: 1.6em -> 1.2em */
    font-weight: bold;
    z-index: 2;
}

.trophy-stats .stats-value {
    font-size: 1em;
    background: linear-gradient(45deg, #ffd700, #ff8c00);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}

.diamond-stats .stats-value {
    background: linear-gradient(45deg, #00bfff, #1e90ff, #4169e1);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmerBlue 3s linear infinite;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.stats-item:hover {
    transform: translateY(-3px) scale(1.03); /* Azaltıldı: -5px -> -3px, 1.05 -> 1.03 */
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); /* Azaltıldı: 10px 20px -> 8px 16px */
}

@keyframes floatStats {
    0%, 100% { transform: translateY(0) rotateX(0); }
    50% { transform: translateY(-5px) rotateX(3deg); } /* Azaltıldı: -10px -> -5px, 5deg -> 3deg */
}

@keyframes pulseGold {
    0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
    50% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.1); } /* Azaltıldı: 1.2 -> 1.1 */
}

@keyframes pulseBlue {
    0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
    50% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.1); } /* Azaltıldı: 1.2 -> 1.1 */
}

@keyframes shakeRotate {
    0%, 100% { transform: rotate(-3deg); } /* Azaltıldı: -5deg -> -3deg */
    25% { transform: rotate(0deg) scale(1.05); } /* Azaltıldı: 1.1 -> 1.05 */
    50% { transform: rotate(3deg); } /* Azaltıldı: 5deg -> 3deg */
    75% { transform: rotate(0deg) scale(1); }
}

@keyframes floatShine {
    0%, 100% { transform: translateY(0) scale(1); filter: brightness(1); }
    50% { transform: translateY(-3px) scale(1.05); filter: brightness(1.2); } /* Azaltıldı: -5px -> -3px, 1.1 -> 1.05, 1.3 -> 1.2 */
}

@keyframes shimmerGold {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
}

@keyframes shimmerBlue {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
}

.trophy-stats:hover .trophy-glow {
    animation: pulseGold 1s ease-in-out infinite;
}

.diamond-stats:hover .diamond-glow {
    animation: pulseBlue 1s ease-in-out infinite;
}

/* Hover efektleri için ek parıltılar */
.stats-item::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle at center,
        rgba(255, 255, 255, 0.2) 0%,
        transparent 50%);
    transform: rotate(45deg);
    transition: 0.5s;
    opacity: 0;
}

.stats-item:hover::before {
    opacity: 1;
    animation: rotateSweep 1s linear infinite;
}

@keyframes rotateSweep {
    0% { transform: rotate(45deg) translateY(0%); }
    100% { transform: rotate(45deg) translateY(100%); }
}

.friends-button:hover {
    transform: scale(1.05);
    background: linear-gradient(135deg, #4f46e5, #4338ca);
}

.friends-container {
    display: none;
    flex-direction: column;
    gap: 25px;
    padding: 30px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
}

.search-section {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.search-box {
    display: flex;
    gap: 10px;
}

.search-box input {
    flex: 1;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1em;
}

#search-button {
    background: #10b981;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0 20px;
    cursor: pointer;
    transition: background 0.3s;
}

.search-results, .friends-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.friend-card {
    display: flex;
    align-items: center;
    padding: 15px;
    background: #f3f4f6;
    border-radius: 10px;
    gap: 15px;
}

.player-item {
    display: flex;
    align-items: center;
    gap: 15px;
    background: #f9f9f9;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.player-photo {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    object-fit: cover;
    border: 2px solid #ff8a00;
}

.player-name {
    flex: 1;
    font-size: 1em;
    font-weight: bold;
    color: #333;
}

.davet-et-button, .oyunda-button {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s;
    font-size: 0.9em;
}

.davet-et-button {
    background-color: #a2b8;
    color: white;
}

.davet-et-button:hover {
    background-color: #138496;
}

.oyunda-button {
    background-color: #f59e0b;
    color: white;
    cursor: not-allowed;
    opacity: 0.7;
}

.oyunda-button:hover {
    background-color: #d97706;
    opacity: 0.7;
}


.friend-photo {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    object-fit: cover;
}

.friend-info {
    flex: 1;
}

.friend-name {
    font-weight: bold;
    color: #111827;
}

.friend-class {
    color: #6b7280;
    font-size: 0.9em;
}

.add-friend-button {
    background: #10b981;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 15px;
    cursor: pointer;
    transition: all 0.3s;
}

.add-friend-button:hover {
    background: #059669;
    transform: scale(1.05);
}

.friend-status {
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 0.9em;
}

.status-offline {
    background: #e5e7eb;
    color: #374151;
}

.status-online {
    background: #dcfce7;
    color: #166534;
}



.status-in-game {
    background: #fee2e2;
    color: #991b1b;
}

/* Hover ve odaklanma efekti */
select:hover, select:focus {
    background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
    border-color: #f7786b;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    outline: none;
}

option {
    background-color: white;
    color: #333;
    padding: 10px;
    font-size: 1em;
    font-family: 'Comfortaa', sans-serif;
}


        @keyframes fadeInUp {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

#main-screen {
    display: flex;
    flex-direction: column; /* İçeriği dikey hizalar */
    align-items: center; /* Yatayda ortalar */
    justify-content: center; /* Dikeyde ortalar */
    gap: 20px; /* Elemanlar arasındaki boşluk */
    position: relative; /* Efektler için gerekli */
    padding: 30px;
    width: 950%; /* Genişlik (ekranın %80'i) */
    max-width: 1400px; /* Maksimum genişlik */
    min-height: 300px; /* Minimum yükseklik */
    background: url('https://i.ibb.co/2FVVr25/Yeni-proje-2.gif') center center;
    background-size: cover;
    background-repeat: no-repeat;
    border: 5px solid transparent;
    border-radius: 20px; /* Köşe yuvarlama */
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2); /* Yumuşak gölge */
    overflow: hidden; /* Taşmaları gizler */
    z-index: 1; /* Diğer elemanlarla çakışmayı önler */
}

/* Hareketli ışık efekti */
#main-screen::before {
    /* Bu bloğu tamamen kaldırabilir veya şu şekilde değiştirebilirsiniz: */
    content: '';
    position: absolute;
    top: -20%;
    left: -150%;
    width: 300%;
    height: 200%;
    background: none; /* linear-gradient yerine none kullanarak efekti kaldırıyoruz */
    animation: none; /* Animasyonu da kaldırıyoruz */
    z-index: 0;
    pointer-events: none;
}

/* Çerçeve parlaması */
@keyframes glowingBorder {
    0% {
        box-shadow: 0 0 5px #ff8a00, 0 0 10px #ff8a00;
    }
    50% {
        box-shadow: 0 0 15px #fbc2eb, 0 0 20px #fbc2eb;
    }
    100% {
        box-shadow: 0 0 5px #a6c1ee, 0 0 10px #a6c1ee;
    }
}

@keyframes lightMove {
    0% {
        transform: translateX(-100%);
    }
    100% {
        transform: translateX(100%);
    }
}

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .student-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40%;
            animation: bounceIn 1s;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        .student-photo {
            width: 160px;
            height: 160px;
            border-radius: 12px;
            object-fit: cover;
            border: 4px solid #ff8a00;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }

        .student-photo:hover {
            transform: rotate(360deg);
        }

        .student-name {
            font-size: 1em;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 2px 2px #ff8a00;
        }

        .student-cup {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 15px;
            animation: popIn 0.5s;
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

.game-cup-image {
    width: 40px;
    height: 40px;
    margin-bottom: 5px;
    transform-origin: center;
    animation: trophyBounce 2s infinite;
}

@keyframes trophyGlow {
    from {
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }
    to {
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
    }
}

@keyframes trophyBounce {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-10px);
    }
}

.trophy-container {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    margin: 10px auto;
    padding: 0 15px;
    max-width: 300px;
}

.trophy-inner {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.trophy {
    font-size: 1.5em;
    opacity: 0;
    transform: translateY(20px);
}

@keyframes trophyEntry {
    0% {
        opacity: 0;
        transform: translateY(50px) scale(0.5);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}


        @keyframes rotateCup {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

.game-cup-score {
    font-size: 1.5em;
    font-weight: bold;
    background: linear-gradient(45deg, #ffd700, #ff8c00);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
}

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 55%;
            align-items: flex-start;
            animation: slideButtons 0.7s ease forwards;
        }

        @keyframes slideButtons {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

.buttons {
    display: flex; /* Flexbox düzeni */
    flex-direction: column; /* Butonları dikey hizalar */
    align-items: stretch; /* Butonları çerçeveye tam yayar */
    justify-content: center; /* Butonlar arasında eşit hizalama */
    gap: 20px; /* Butonlar arasında dikey boşluk */
    padding: 10px; /* Çerçeve içi boşluk */
    width: 100%; /* Çerçeve genişliği */
    max-width: 900px; /* Maksimum genişlik */
    margin: 0 auto; /* Ortalamak için */
    box-sizing: border-box; /* Padding ve border dahil */
}

.buttons button {
    /* Mevcut özellikleri koru */
    width: 100%;
    padding: 18px;
    border: none;
    border-radius: 12px;
    font-size: 1.1em;
    cursor: pointer;
    transition: transform 0.2s, opacity 0.2s, box-shadow 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;

    /* Yeni metin geliştirmeleri */
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    letter-spacing: 0.5px;
    font-weight: 600;
}

.offline-button {
    background-color: #808080;
    color: white;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: not-allowed;
    opacity: 0.7;
    font-size: 0.9em;
}

.student-diamond {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 10px;
    animation: diamondGlow 3s infinite alternate;
}

.diamond-count {
    font-size: 1.3em;
    font-weight: bold;
    color: #1e90ff;
    text-shadow: 0 0 1px #1e90ff;
    animation: diamondPulse 2.5s infinite alternate;
}

@keyframes diamondGlow {
    from {
        filter: drop-shadow(0 0 2px #1e90ff);
    }
    to {
        filter: drop-shadow(0 0 8px #1e90ff);
    }
}

@keyframes diamondPulse {
    from {
        transform: scale(1);
    }
    to {
        transform: scale(1.1);
    }
}

.buttons button::before {
    content: '';
    position: absolute;
    width: 200%;
    height: 200%;
    background: rgba(255, 255, 255, 0.2);
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(45deg);
    transition: all 0.5s;
}

.buttons button:hover::before {
    width: 0%;
    height: 0%;
    opacity: 0;
}

.buttons button:hover {
    transform: scale(1.05);
    opacity: 0.9;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

.single-player {
    background: linear-gradient(135deg, #ff6f61, #ff9a9e);
    color: white;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}


.friend-added-button {
    background-color: #808080;
    color: white;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: not-allowed;
    opacity: 0.7;
    font-size: 0.9em;
}

.add-friend-button {
    background-color: #28a745;
    color: white;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s;
    font-size: 0.9em;
}

.add-friend-button:hover {
    background-color: #218838;
    transform: scale(1.05);
}

.kupa-siralama-button {
    background-color: #f7cac9;
    color: black !important;
    background-image: linear-gradient(135deg, #edf500, #8ff514);
    box-shadow: 0 0 15px rgba(247, 202, 201, 0.7);
    position: relative;
    overflow: hidden;
}

.kupa-siralama-button::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: rgba(247, 202, 201, 0.2);
    transform: rotate(45deg);
    animation: shine 3s infinite;
}


        @keyframes shine {
            0% {
                transform: rotate(45deg) translate(-100%, -100%);
            }
            100% {
                transform: rotate(45deg) translate(100%, 100%);
            }
        }

        .game-container, .student-selection-container, .single-player-game-container, .duel-selection-container, .duel-game-container {
            display: none;
            flex-direction: column;
            gap: 15px;
            animation: fadeIn 0.5s forwards;
        }

        .table-section {
            background-color: #fff3e0;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            text-align: left;
        }

        .table-section h3 {
            margin-bottom: 15px;
            color: #ff8a00;
            font-size: 1.0em;
            border-bottom: 2px solid #ff8a00;
            padding-bottom: 5px;
        }

        .table-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .table-section select, .table-section input {
            width: 100%;
            padding: 14px 20px;
            margin-bottom: 20px;
            border: 2px solid #ff8a00;
            border-radius: 8px;
            font-size: 1.2em;
            color: #333;
            background-color: #fff;
            transition: border-color 0.3s;
        }

        .table-section select:focus, .table-section input:focus {
            border-color: #f7786b;
            outline: none;
        }

        .back-button, .start-game-button, .login-button, .duel-start-button, .ranking-back-button, .close-ranking-button {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            font-size: 1.1em;
            margin-top: 25px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .back-button, .ranking-back-button, .close-ranking-button {
            background-color: #555;
            color: white;
            width: 100%;
            max-width: 220px;
        }

        .back-button:hover, .ranking-back-button:hover, .close-ranking-button:hover {
            background-color: #333;
            transform: scale(1.05);
        }

        .start-game-button, .duel-start-button {
            background-color: #28a745;
            color: white;
            opacity: 0.7;
            cursor: not-allowed;
            width: 100%;
            max-width: 220px;
        }

        .start-game-button.active, .duel-start-button.active {
            opacity: 1;
            cursor: pointer;
        }

        .start-game-button:hover.active, .duel-start-button:hover.active {
            transform: scale(1.05);
        }

        .login-button {
            background-color: #007BFF;
            color: white;
            opacity: 0.7;
            cursor: not-allowed;
            width: 100%;
            max-width: 220px;
            transition: opacity 0.3s;
        }

        .login-button.active {
            opacity: 1;
            cursor: pointer;
        }

        .login-button:hover.active {
            transform: scale(1.05);
        }

        .error {
            color: red;
            margin-top: 15px;
            text-align: center;
            font-size: 1.1em;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

.single-player-game-container, .duel-game-container {
    display: none; /* Bu konteyner başlangıçta görünmez */
    flex-direction: column; /* İçerikleri dikey olarak hizalar */
    gap: 25px; /* İçerikler arasındaki boşluk 25 piksel */
    width: 100%; /* Konteyner genişliği ekranın tamamını kaplar */
    max-width: none; /* Genişlik sınırı yok */
    justify-content: center; /* İçerikleri dikeyde ortalar */
    align-items: center; /* İçerikleri yatayda ortalar */
    padding: 30px; /* Kenar boşlukları (çerçevenin içindeki içeriklerin etrafındaki boşluk) */
    animation: fadeIn 0.5s forwards; /* Görünür hale geldiğinde fadeIn animasyonu oynar */
}


        .question-number {
            margin-bottom: 15px;
            font-size: 1.0em;
            color: #555;
            font-weight: bold;
        }

        .progress-container {
            width: 100%;
            max-width: 900px;
            margin-bottom: 1px;
        }

        .progress-bar {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            height: 25px;
        }

        .progress-bar-inner {
            height: 100%;
            width: 0%;
            background-color: #28a745;
            transition: width 0.4s ease;
        }

        .timer-container {
            margin-bottom: 1px;
        }

        .timer {
            font-size: 1.0em;
            color: #ff0000;
            font-weight: bold;
            animation: pulseTimer 1.5s infinite;
        }

        @keyframes pulseTimer {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .question-container {
    display: flex;
    flex-direction: column; /* Dikey hizalama */
    align-items: center; /* Yatayda ortalama */
    justify-content: center; /* Dikeyde ortalama */
    width: 100%; /* Çerçevenin genişliği */
    max-width: 700px; /* Maksimum genişlik azaltıldı */
    text-align: center; /* Metni ortala */
    min-height: 300px; /* Çerçeve yüksekliği azaltıldı */
    padding: 15px; /* Daha az boşluk */
    border: 2px solid #ff8a00; /* Çerçeve kalınlığı azaltıldı */
    border-radius: 10px; /* Köşe yuvarlama küçültüldü */
    background-color: #fffbea;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Gölge küçültüldü */
    overflow: hidden; /* Çerçeve dışına taşmaları gizle */
}

        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .question-image {
    max-width: 100%; /* Resmin genişliği çerçeveye sığacak şekilde */
    max-height: 60%; /* Resmin yüksekliğini sınırla */
    object-fit: contain; /* Resmin orantılı şekilde sığmasını sağla */
    margin: 0 auto; /* Resmi yatayda ortala */
    display: block; /* Blok element olarak davranır */
}

        @keyframes fadeInImage {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .question-text {
    font-size: 1.1em; /* Soru metni boyutunu ayarla */
    font-weight: bold;
    margin-bottom: 10px; /* Resim ile metin arasında boşluk */
    word-wrap: break-word; /* Uzun kelimeleri kır */
    text-align: center; /* Metni ortala */
    max-width: 100%; /* Çerçeve sınırları içinde kalmasını sağla */
}

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .options-container {
            display: flex;
            gap: 20px;
            flex-direction: row;
            justify-content: center;
            width: 100%;
            max-width: 900px;
            flex-wrap: wrap; 
            animation: fadeInOptions 0.5s;
        }

        @keyframes fadeInOptions {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .option-button {
            padding: 10px 15px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s, opacity 0.3s;
            flex: 1 1 30%;
            min-width: 160px;
            max-width: 350px;
            font-size: 1.0em;
            margin: 3px 2;
            white-space: normal;
            word-wrap: break-word;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .option-button::after {
            content: '';
            position: absolute;
            width: 300%;
            height: 300%;
            background: rgba(255, 255, 255, 0.2);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            transition: all 0.5s;
        }

        .option-button:hover::after {
            width: 0%;
            height: 0%;
            opacity: 0;
        }

        .option-button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
            opacity: 0.95;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .option-button.correct {
            background-color: #28a745 !important;
            animation: pulseCorrect 0.5s;
        }

        @keyframes pulseCorrect {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .option-button.wrong {
            background-color: #dc3545 !important;
            animation: shakeWrong 0.5s;
        }

        @keyframes shakeWrong {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .option-chosen {
            border: 4px solid #ff8a00;
            box-shadow: 0 0 15px rgba(255,138,0,0.5);
        }

        .option-faded {
            opacity: 0.5;
        }

        .score-container {
            font-size: 2em;
            color: #333;
            text-align: center;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            animation: fadeInScore 0.5s;
        }

        @keyframes fadeInScore {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

.score-message {
    font-size: 1.1em; /* Yazı boyutunu çerçeveye uygun olacak şekilde ayarlayın */
    font-weight: bold;
    margin-top: 25px;
    animation: glow 1.5s infinite alternate;
    text-align: center; /* Metni ortala */
    max-width: 90%; /* Çerçevenin genişliğine uygun olacak şekilde sınırla */
    white-space: normal; /* Alt satıra geçmesini sağla */
    word-wrap: break-word; /* Uzun kelimeleri kırarak alt satıra geçir */
    overflow: visible; /* Çerçeve dışına taşmayı engelle */
    margin: 0 auto; /* Yatayda ortala */
    line-height: 1.2; /* Satırlar arasındaki mesafeyi ayarla */
}

        .score-message.blue {
            color: #007BFF;
        }

        .score-message.green {
            color: #28a745;
        }

        .score-message.purple {
            color: #6f42c1;
            text-shadow: 0 0 15px #6f42c1, 0 0 25px #6f42c1, 0 0 35px #6f42c1;
            animation: glowMukemmel 1.5s infinite alternate;
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
            }
            to {
                text-shadow: 0 0 25px rgba(0, 123, 255, 1);
            }
        }

        @keyframes glowMukemmel {
            from {
                text-shadow: 0 0 15px rgba(111, 66, 193, 0.5);
            }
            to {
                text-shadow: 0 0 25px rgba(111, 66, 193, 1), 0 0 35px rgba(111, 66, 193, 0.7);
            }
        }

        .final-image {
            width: 220px;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: fadeInImage 1s;
        }

        /* Yeni Eklenen Stil: End Game Button (Geri Dön) */
        .end-game-button {
            background-color: #007BFF; /* Mavi renk */
            color: white;
            padding: 8px px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-size: 0.8em;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .end-game-button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
            box-shadow: 0 7px 20px rgba(0,0,0,0.2);
        }

        /* Yeni +1 Efekti */
        .animated-plus-one {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8em;
            color: #28a745;
            pointer-events: none;
            z-index: 1000;
            opacity: 1;
            animation: plusOneMove 1s forwards;
        }

        @keyframes plusOneMove {
            0% {
                opacity:1;
                transform: translate(-50%, -50%) translate(0px, 0px) scale(1);
            }
            100% {
                opacity:0;
                transform: translate(-50%, -50%) translate(300px, -300px) scale(0.5);
            }
        }

        /* "Oyunda" Butonu İçin Ek Stil */
        .oyunda-button {
            background-color: #f59e0b; /* Turuncu renk */
            border: none;
            border-radius: 6px;
            color: white;
            padding: 8px 14px;
            font-size: 1em;
            cursor: not-allowed;
            opacity: 0.7;
            transition: background-color 0.3s;
        }

        .oyunda-button:hover {
            background-color: #d97706;
            opacity: 0.7; /* Hover etkisini kaldırmak için */
            transform: none;
        }

        /* Alert, Prompt, Invitation Modals */
        .alert-overlay, .prompt-overlay, .invitation-overlay {
            position: fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items:center;
            justify-content:center;
            z-index:1000000;
            animation: fadeInModal 0.3s;
        }

        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .alert-content, .prompt-content, .invitation-content {
            background:#fff;
            padding:25px;
            border-radius:15px;
            width:90%;
            max-width:350px;
            box-shadow:0 10px 25px rgba(0,0,0,0.3);
            display:flex;
            flex-direction: column;
            gap:20px;
            animation: slideDownModal 0.3s;
        }

        @keyframes slideDownModal {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .alert-message, .prompt-message, .invitation-message {
            font-size:1.2em;
            color:#333;
            text-align: center;
        }

        .alert-ok-button, .prompt-ok-button, .prompt-cancel-button, .invitation-accept-button, .invitation-decline-button {
            background-color: #007BFF;
            color:white;
            border:none;
            border-radius:8px;
            padding:12px 25px;
            cursor:pointer;
            transition: background-color 0.3s;
            font-size:1em;
            font-weight: bold;
        }

        .alert-ok-button:hover, .prompt-ok-button:hover, .prompt-cancel-button:hover, .invitation-accept-button:hover, .invitation-decline-button:hover {
            background-color: #0056b3;
        }

        .prompt-input {
            width:100%;
            padding:12px;
            border:2px solid #ff8a00;
            border-radius:8px;
            font-size:1.1em;
            transition: border-color 0.3s;
        }

        .prompt-input:focus {
            border-color: #f7786b;
            outline: none;
        }

        .prompt-buttons, .invitation-buttons {
            display:flex;
            justify-content: space-between;
            gap: 10px;
        }

        .prompt-cancel-button, .invitation-decline-button {
            background-color:#dc3545;
        }

        .prompt-cancel-button:hover, .invitation-decline-button:hover {
            background-color:#c82333;
        }

        /* Düello Seçim Ekranı */
.duel-selection-container {
    display: none;
    flex-direction: column;
    gap: 15px;
    width: 100%;
    max-width: 1200px;
    background: white;
    padding: 30px 40px;
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    margin: auto;
    position: relative;
    z-index: 1000;
}

        /* İki oyuncuyu eşit orantıda yerleştirmek için space-evenly kullandık */
.duel-bottom-info {
    display: flex;
    justify-content: space-evenly; /* Kartlar arasında eşit boşluk */
    align-items: center; /* Kartları yatayda ortala */
    width: 100%; /* Genişlik tüm alanı kaplasın */
    padding: 10px 0; /* Üst ve alt boşluk */
}


.duel-player-info {
    display: flex;
    flex-direction: column; /* Resim ve ismi dikey hizalar */
    align-items: center; /* Yatayda ortalar */
    justify-content: center; /* Dikeyde ortalar */
    text-align: center; /* Yazıyı ortala */
    gap: 10px; /* Resim ile isim arasındaki boşluk */
    width: 100%; /* Kartın genişliği */
}

.duel-player-photo {
    width: 80px; /* Resim genişliği */
    height: 80px; /* Resim yüksekliği */
    border-radius: 12px; /* Yuvarlak resim */
    object-fit: cover; /* Resmi çerçeveye sığdır */
    border: 3px solid #ff8a00; /* Çerçeve rengi */
    margin-bottom: 5px; /* Resim ile isim arasındaki boşluk */
}


.duel-player-photo:hover {
    transform: rotate(360deg);
}

.duel-player-name {
    font-size: 1em; /* Yazı boyutu */
    font-weight: bold; /* Yazı kalınlığı */
    color: #333; /* Yazı rengi */
    text-align: center; /* Yazıyı ortala */
    white-space: normal; /* Yazının satır kaydırmasını etkinleştir */
    word-wrap: break-word; /* Uzun kelimeleri kaydır */
    overflow-wrap: break-word; /* Modern tarayıcı desteği */
    max-width: 100%; /* Çerçeve sınırında kal */
    line-height: 1.2; /* Satırlar arası boşluğu azalt */
}



        .duel-controls {
            display:flex;
            flex-direction: column;
            gap:15px;
            align-items:center;
            justify-content:center;
            margin-top:30px;
        }

        .duel-start-button {
            display:inline-block;
            margin:0 auto;
            background-color: #28a745;
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            cursor: not-allowed;
            opacity: 0.7;
            transition: background-color 0.3s, transform 0.3s, opacity 0.3s;
            font-size:1.1em;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .duel-start-button.active {
            cursor: pointer;
            opacity: 1;
        }

        .duel-start-button:hover.active {
            transform: scale(1.05);
            background-color: #218838;
        }

        .duel-game-container {
            display: none;
            flex-direction: column;
            gap: 5px;
            width: 100%;
            max-width: none;
            justify-content: center;
            align-items: center;
            padding: 30px;
            animation: fadeIn 0.5s forwards;
        }

        .players-info-row {
            display: flex;
            width: 100%;
            max-width: 900px;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            animation: slideInPlayers 0.5s forwards;
        }

        @keyframes slideInPlayers {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .duel-player-score {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 120px;
            overflow:hidden;
            position: relative;
            background-color: #f1f1f1;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .duel-player-score img {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            border: 3px solid #ff8a00;
            object-fit: cover;
            margin-bottom: 10px;
        }

.duel-player-score .duel-player-name {
    font-size: 0.8em; /* Yazı boyutunu biraz küçültebilirsiniz */
    font-weight: bold;
    color: #333;
    white-space: normal; /* Uzun metinlerin satır atlamasına izin verir */
    word-wrap: break-word; /* Uzun kelimelerin uygun yerlerde kırılmasını sağlar */
    text-align: center; /* Metni ortalar */
    overflow: hidden; /* Çerçevenin dışına taşmayı engeller */
    text-shadow: 1px 1px #ff8a00;
    max-width: 150px; /* Çerçevenin genişliğine göre uyarlanır */
    display: -webkit-box; /* Çok satırlı metni sınırlamak için */
    -webkit-line-clamp: 2; /* Maksimum 2 satır göster */
    -webkit-box-orient: vertical;
}

        .duel-player-correct-count {
            font-size: 1.5em;
            margin-top: 8px;
            color: #28a745;
            font-weight: bold;
            transition: transform 0.3s ease;
            animation: bounceCount 0.6s;
        }

        @keyframes bounceCount {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

.winner-message {
    font-size: 1.2em;
    font-weight: 900;
    background: linear-gradient(45deg, #FFD700, #FFA500);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: winnerEntry 1s forwards, winnerGlow 2s infinite alternate;
    text-align: center;
    margin: 15px 0;
    padding: 0 10px;
    max-width: 100%;
    word-wrap: break-word;
}

@keyframes winnerEntry {
    0% {
        opacity: 0;
        transform: scale(0.5) translateY(-20px);
    }
    100% {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}


@keyframes winnerGlow {
    from { text-shadow: 0 0 5px gold; }
    to { text-shadow: 0 0 10px gold; }
}

@media (max-width: 480px) {
    .winner-message {
        font-size: 1.2em;
    }
    
    .trophy {
        font-size: 1.1em;
    }
    
    .trophy-container {
        gap: 8px;
        max-width: 250px;
    }
}


        .score-flash {
            animation: scoreFlash 0.8s ease;
        }

        @keyframes scoreFlash {
            0% {transform: scale(1) rotate(0deg); color:#28a745;}
            30% {transform: scale(1.5) rotate(10deg); color:#28a745;}
            60% {transform: scale(1.3) rotate(-10deg); color:#28a745;}
            100% {transform: scale(1) rotate(0deg); color:#28a745;}
        }

        /* Oyundakiler Modal */
        .players-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width:100%;
            height:100%;
            background:rgba(0,0,0,0.6);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:1000000;
            animation: fadeInModal 0.3s;
        }

        .players-content {
            background:#fff;
            padding:30px;
            border-radius:15px;
            width:90%;
            max-width:450px;
            box-shadow:0 10px 25px rgba(0,0,0,0.3);
            display:flex;
            flex-direction:column;
            gap:25px;
            animation: slideDownModal 0.3s;
        }

        .players-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .players-header h3 {
            margin:0;
            font-size:1.8em;
            color:#ff8a00;
            text-shadow: 1px 1px #f7786b;
        }

        .players-close {
            background: none;
            border:none;
            font-size:1.5em;
            cursor:pointer;
            color:#ff6f61;
            transition: color 0.3s;
        }

        .players-close:hover {
            color:#e63946;
        }

        .players-list {
            list-style:none;
            padding:0;
            margin:0;
            display:flex;
            flex-direction:column;
            gap:15px;
        }

        .players-list li {
            display:flex;
            align-items:center;
            gap:15px;
            background:#f0f0f0;
            padding:12px;
            border-radius:8px;
            justify-content: space-between;
            transition: background-color 0.3s;
        }

        .players-list li:hover {
            background-color: #e0e0e0;
        }

        .players-list img {
            width:50px;
            height:50px;
            border-radius: 12px;
            object-fit:cover;
            border:3px solid #ff8a00;
        }

        .players-list .player-name {
            font-size:1.1em;
            color:#333;
            flex:1;
            text-shadow: 1px 1px #ff8a00;
        }

        /* Yeni Eklenen Stil: Ranking Panel (Yan Panel) */
.ranking-panel {
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   background: linear-gradient(135deg, #ffffff, #f0f0f0);
   z-index: 9999;
   padding: 20px;
   animation: slideIn 0.3s ease-out;
   display: flex;
   flex-direction: column;
   overflow: hidden;
}

@keyframes slideIn {
   0% {
       transform: translateX(100%);
       opacity: 0;
   }
   100% {
       transform: translateX(0);
       opacity: 1;
   }
}

                /* Açma Butonu */
        .open-ranking-button {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            background-color: #4e54c8;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .open-ranking-button:hover {
            background-color: #8f94fb;
            transform: scale(1.05);
            box-shadow: 0 7px 20px rgba(0,0,0,0.3);
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease;
            z-index: 999;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Ranking Panel */
        .ranking-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 400px;
            height: 100%;
            background: #ffffff;
            box-shadow: -2px 0 15px rgba(0, 0, 0, 0.3);
            transition: right 0.5s ease;
            z-index: 1000;
            border-radius: 0 20px 20px 0;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .ranking-panel.open {
            right: 0;
        }

        /* Ranking Panel Header */
.ranking-panel h2 {
   text-align: center;
   font-size: 2.2rem;
   font-weight: bold;
   margin: 0 0 25px 0;
   background: linear-gradient(45deg, #4338ca, #6366f1, #4338ca);
   background-size: 200% auto;
   color: transparent;
   -webkit-background-clip: text;
   background-clip: text;
   animation: titleGradient 3s ease infinite,
              titlePulse 2s ease infinite;
   padding: 10px;
   position: relative;
   text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

.ranking-panel h2::after {
   content: '';
   position: absolute;
   bottom: 0;
   left: 50%;
   transform: translateX(-50%);
   width: 150px;
   height: 3px;
   background: linear-gradient(90deg, transparent, #4338ca, transparent);
   animation: underlineAnim 2s ease infinite;
}


@keyframes titleGradient {
   0% { background-position: 0% 50%; }
   50% { background-position: 100% 50%; }
   100% { background-position: 0% 50%; }
}

@keyframes titlePulse {
   0%, 100% { transform: scale(1); }
   50% { transform: scale(1.02); }
}

@keyframes underlineAnim {
   0%, 100% { width: 150px; opacity: 0.5; }
   50% { width: 200px; opacity: 1; }
}


@media (max-width: 768px) {
   .ranking-panel h2 {
       font-size: 1.8rem;
   }
}

@keyframes fadeIn {
   from { opacity: 0; }
   to { opacity: 1; }
}

@media (max-width: 768px) {
   .ranking-panel {
       padding: 15px;
   }
   
   .ranking-table th,
   .ranking-table td {
       padding: 10px;
       font-size: 0.9rem;
   }
   
   .user-ranking-stats {
       padding: 12px;
       font-size: 0.9rem;
   }
}


        /* Geri Dön Butonu */
        .ranking-back-button {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            background-color: #555;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s, box-shadow 0.3s;
            font-size: 1.1em;
            margin-top: auto;
            align-self: center;
            width: 100%;
            max-width: 220px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .ranking-back-button:hover {
            background-color: #333;
            transform: scale(1.05);
            box-shadow: 0 7px 20px rgba(0,0,0,0.3);
        }

        /* Ranking Table Container */
.ranking-table-container {
   flex: 1;
   overflow-y: auto;
   margin: 15px 0;
   padding: 10px;
   border-radius: 15px;
   background: rgba(255,255,255,0.9);
   box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

        /* Ranking Table */
.ranking-table {
   width: 100%;
   border-collapse: separate;
   border-spacing: 0 8px;
}

        /* Float Animation */
        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* Table Header */
        .ranking-table th {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: #000;
            font-weight: bold;
            padding: 15px;
            text-align: center;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
            animation: slideIn 0.8s ease forwards;
        }

        /* Slide In Animation */
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .ranking-table th::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(255,255,255,0.3), rgba(255,255,255,0));
            animation: shimmer 2s infinite;
        }

        /* Shimmer Animation */
        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        /* Table Data */
        .ranking-table td {
            padding: 15px;
            text-align: center;
            color: #333;
            transition: background 0.3s, color 0.3s, transform 0.3s;
            font-weight: 500;
        }

        /* Row Hover Effect */
        .ranking-table tr:hover td {
            background: #ff8a00;
            color: white;
            transform: scale(1.02);
            cursor: pointer;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        /* Player Photo */
        .ranking-player-photo {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            object-fit: cover;
            border: 3px solid #ff8a00;
            transition: transform 0.3s;
        }

        .ranking-player-photo:hover {
            transform: scale(1.1);
        }

        /* Top 3 Rows */
        .ranking-table tr.top-1 td,
        .ranking-table tr.top-2 td,
        .ranking-table tr.top-3 td {
            color: white;
            font-weight: bold;
            animation: glow 2s infinite alternate;
        }

        .ranking-table tr.top-1 td {
            background: linear-gradient(135deg, #FFD700, #FFA500); /* Altın */
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }

        .ranking-table tr.top-2 td {
            background: linear-gradient(135deg, #C0C0C0, #A9A9A9); /* Gümüş */
            box-shadow: 0 0 15px rgba(192, 192, 192, 0.6);
        }

        .ranking-table tr.top-3 td {
            background: linear-gradient(135deg, #CD7F32, #8B4513); /* Bronz */
            box-shadow: 0 0 15px rgba(205, 127, 50, 0.6);
        }

        /* Glow Animation */
        @keyframes glow {
            from {
                box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            }
            to {
                box-shadow: 0 0 20px rgba(255, 255, 255, 1);
            }
        }

        /* Fade In Animasyonları */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .ranking-panel {
                width: 100%;
                border-radius: 0;
            }

.ranking-table th,
.ranking-table td {
    padding: 12px;
    text-align: left;
}


.ranking-table tr {
   background: white;
   border-radius: 10px;
   box-shadow: 0 2px 8px rgba(0,0,0,0.05);
   transition: all 0.2s ease;
}

.ranking-table tr:hover {
   transform: translateY(-2px);
   box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}


            .ranking-player-photo {
                width: 40px;
                height: 40px;
            }

            .open-ranking-button, .ranking-back-button {
                padding: 10px 20px;
                font-size: 1rem;
                max-width: 180px;
            }

            .ranking-table-container {
                padding: 10px;
            }
        }

.find-duel-button {
    background: linear-gradient(45deg, #ff4e50, #f9d423);
    color: white;
    padding: 15px 30px;
    border: none;
    border-radius: 15px;
    font-size: 1.2em;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(255, 78, 80, 0.4);
}

.find-duel-button .button-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    position: relative;
    z-index: 1;
}

.find-duel-button .duel-icon {
    font-size: 1.4em;
    animation: swordsSway 2s infinite;
}

.button-glow {
    display: none; /* Dönen efekti kaldır */
}

@keyframes swordsSway {
    0% { transform: rotate(-15deg); }
    50% { transform: rotate(15deg); }
    100% { transform: rotate(-15deg); }
}

@keyframes glowRotate {
    0% { transform: none; }
    100% { transform: none; }
}

/* Arama ekranı için stil */
.matchmaking-screen {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}

.friend-added-text {
    display: inline-block;
    font-size: 0.9em;
    background-color: #e9ecef;
    color: #495057;
    border-radius: 6px;
    padding: 8px 14px;
}

.matchmaking-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    text-align: center;
    max-width: 400px;
    width: 90%;
}

.searching-animation {
    width: 100px;
    height: 100px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #ff4e50;
    border-radius: 12px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

















/* Eşleştirme Ekranı Ana Stili */
.matchmaking-screen {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease-in-out;
}

.matchmaking-content {
    background: linear-gradient(145deg, #ffffff, #f0f0f0);
    padding: 30px;
    border-radius: 20px;
    width: 90%;
    max-width: 500px;
    text-align: center;
    box-shadow: 0 6px 18px rgba(0,0,0,0.3);
    animation: slideIn 0.5s ease-out;
}

/* Başlık Stili */
.matchmaking-content h2 {
    color: #333;
    margin-bottom: 20px;
    font-size: 1.8em;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

/* Arama Animasyonu */
.searching-animation {
    width: 80px;
    height: 80px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #ff4e50;
    border-radius: 12px;
    margin: 20px auto;
    animation: spin 1s linear infinite;
}

/* Oyuncu Listesi */
.available-players {
    margin-top: 30px;
    max-height: 300px;
    overflow-y: auto;
}

.player-item {
    display: flex;
    align-items: center;
    padding: 15px;
    margin: 10px 0;
    background: rgba(255,255,255,0.9);
    border-radius: 10px;
    transition: transform 0.3s ease;
}

.player-item:hover {
    transform: scale(1.02);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}





/* İptal Butonu */
.cancel-search-button {
    margin-top: 20px;
    padding: 12px 25px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.cancel-search-button:hover {
    background: #c82333;
    transform: scale(1.05);
}

/* Animasyonlar */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { 
        transform: translateY(-50px);
        opacity: 0;
    }
    to { 
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
















.duel-request-button {
    background: linear-gradient(45deg, #ff4e50, #f9d423);
    color: white;
    border: none;
    padding: 8px 8px;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    font-size: 16px; /* İsteğe bağlı: Buton metin boyutu */
}

/* Buton Üzerine Gelindiğinde Genel Efektler */
.duel-request-button:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

/* Duel İkonu (İçerik) */
.duel-icon {
    display: inline-block;
    transition: transform 0.3s ease, filter 0.3s ease;
    font-size: 20px; /* İsteğe bağlı: İkon boyutu */
}



/* Hover Durumunda Duel İkonu Efektleri */
.duel-request-button:hover .duel-icon {
    transform: rotate(360deg) scale(1.3);
    filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
}

/* Hover Durumunda Buton Metni Renk Değişikliği */
.duel-request-button:hover .button-text {
    color: #ffe066;
}

/* Dalgalanan Metin Efekti */
@keyframes wave {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-5px);
    }
}

/* Animasyonlu Arka Plan Parıltı Efekti */
@keyframes shine {
    0% {
        transform: translateX(-100%) skewX(-20deg);
    }
    50% {
        transform: translateX(100%) skewX(-20deg);
    }
    100% {
        transform: translateX(100%) skewX(-20deg);
    }
}

/* ::before Pseudo-Elementi ile Ek Dalga Efekti */
.duel-request-button::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: rgba(255, 255, 255, 0.1);
    transform: rotate(45deg) scale(0);
    transition: transform 0.5s ease;
    pointer-events: none;
}

/* Hover Durumunda ::before Efekti */
.duel-request-button:hover::before {
    transform: rotate(45deg) scale(1);
}

/* ::after Pseudo-Elementi ile Shine Efekti */
.duel-request-button::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        120deg,
        rgba(255, 255, 255, 0.2) 0%,
        rgba(255, 255, 255, 0.5) 50%,
        rgba(255, 255, 255, 0.2) 100%
    );
    transform: translateX(-100%) skewX(-20deg);
    animation: shine 2s infinite;
    pointer-events: none;
    border-radius: 8px;
}












.countdown-container {
    position: absolute;
    top: 15px; /* Küçültüldü */
    right: 15px; /* Küçültüldü */
    z-index: 100;
}

.countdown {
    font-size: 1.8em; /* Font boyutu küçültüldü */
    font-weight: bold;
    padding: 10px 15px; /* Padding küçültüldü */
    border-radius: 10px; /* Border-radius küçültüldü */
    background: rgba(0, 0, 0, 0.1);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15); /* Box-shadow küçültüldü */
    animation: pulse 1s infinite;
    transition: transform 0.3s ease; /* Transition'u sadece transform ile sınırladım */
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.03); } /* Scale miktarı hafifçe azaltıldı */
}

.countdown.green {
    color: #28a745;
    text-shadow: 0 0 8px rgba(40, 167, 69, 0.4); /* Text-shadow boyutu ve opaklığı azaltıldı */
}

.countdown.orange {
    color: #fd7e14;
    text-shadow: 0 0 8px rgba(253, 126, 20, 0.4);
}

.countdown.red {
    color: #dc3545;
    text-shadow: 0 0 8px rgba(220, 53, 69, 0.4);
}









/* Genel Sıfırlamalar (Opsiyonel) */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* Profil İkonu Container Stilleri */
.profile-icon-container {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 50px;
    height: 50px;
    z-index: 1000;
    cursor: pointer;
    transition: none; /* Geçiş efektini kaldırıyoruz */
}

/* Profil İkonu Stilleri */
.profile-icon {
    width: 100%;
    height: 100%;
    border-radius: 12px;
    object-fit: cover;
    border: 2px solid #ff8a00;
    box-shadow: none; /* Gölgeyi kaldırıyoruz */
    transition: none; /* Geçiş efektini kaldırıyoruz */
}

/* Hover Efekti */
.profile-icon-container:hover .profile-icon {
    transform: none; /* scale efektini kaldırıyoruz */
    box-shadow: none; /* gölge efektini kaldırıyoruz */
}

/* Profil Değiştirme Overlay ve İçerik Stilleri (Mevcut Kodunuzdan) */
.profile-change-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(5px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

.profile-change-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    width: 90%;
    max-width: 600px; /* Panel genişliğini sınırla */
    position: relative;
    animation: popIn 0.5s cubic-bezier(0.26, 0.53, 0.74, 1.48);
}

/* Profil Başlık Stili */
.profile-change-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 5px;
    margin-bottom: 5px;
    border-bottom: 2px solid #f0f0f0;
}

.profile-change-header h2 {
    font-size: 1.0em;
    color: #333;
    margin: 0;
}

/* Profil Fotoğrafları Grid Düzeni */
.profile-photos-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
    padding: 10px;
    max-height: 500px;
    overflow-y: auto;
}

/* Profil Fotoğraf Kartı Stili */
.profile-photo-item {
    background: linear-gradient(145deg, #ffffff05, #ffffff15);
    backdrop-filter: blur(12px);
    border-radius: 16px;
    padding: 20px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.profile-photo-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 200%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
    );
    transition: 0.5s;
}

/* Profil Fotoğrafı */
.profile-photo {
   width: 120px;  
   height: 120px;
   border-radius: 12px;
   object-fit: cover;
   display: block; /* Block görünüme al */
   margin: 0 auto; /* Yatayda otomatik margin ile ortalar */
   border: 3px solid #ff8a00;
   box-shadow: 0 0 15px rgba(255, 138, 0, 0.3);
   transition: transform 0.3s ease;
}

.profile-photo-item:hover .profile-photo {
    transform: scale(1.05);
}

/* Fiyat Etiketi */
.profile-photo-price {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background: rgba(0, 0, 0, 0.7);
    padding: 8px;
    border-radius: 8px;
    margin: 10px auto;
    width: fit-content;
    font-size: 1em;
    font-weight: bold;
    color: white;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* Buton Stilleri */
.profile-photo-button {
    width: 70%;
    padding: 8px;
    border: none;
    border-radius: 12px;
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.buy-button {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
}

.use-button {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: white;
}

.profile-photo-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.category-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    font-size: 0.8em;
    font-weight: bold;
    z-index: 1;
}

@keyframes shine {
    0% { transform: translateX(-100%) rotate(-25deg); }
    100% { transform: translateX(100%) rotate(-25deg); }
}

/* Kapatma Butonu */
.profile-close-button {
    background: none;
    border: none;
    color: #666;
    font-size: 1.5em;
    cursor: pointer;
    padding: 5px;
}

/* Animasyonlar */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes popIn {
    from { 
        opacity: 0; 
        transform: scale(0.9);
    }
    to { 
        opacity: 1;
        transform: scale(1);
    }
}

/* Hover Efektleri */
.profile-photo-item:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}


.profile-photo-item:hover::before {
    animation: shine 1.5s infinite;
}

.profile-close-button:hover {
    color: #ff4444;
}

.buy-button:hover {
    background: #218838;
}

.use-button:hover {
    background: #0056b3;
}

.profile-categories {
   display: flex;
   overflow-x: auto;
   padding: 15px;
   gap: 15px;
   background: linear-gradient(145deg, #f6f7f9, #ffffff);
   border-radius: 15px;
   -webkit-overflow-scrolling: touch;
   scrollbar-width: none;
   white-space: nowrap;
   margin-bottom: 20px;
}

.profile-categories::-webkit-scrollbar {
    display: none;
}

.category-button {
   min-width: 200px;
   height: 50px;
   padding: 0 20px;
   border: none;
   border-radius: 12px;
   font-size: 1rem;
   font-weight: 600;
   cursor: pointer;
   transition: all 0.3s ease;
   background: linear-gradient(45deg, #4e54c8, #8f94fb);
   color: white;
   box-shadow: 0 4px 15px rgba(78, 84, 200, 0.2);
   flex-shrink: 0;
   position: relative;
   overflow: hidden;
   opacity: 0.7; /* Default biraz soluk */
}

.category-button::before {
   content: '';
   position: absolute;
   top: 0;
   left: -100%;
   width: 100%;
   height: 100%;
   background: linear-gradient(120deg, transparent, rgba(255,255,255,0.3), transparent);
   transition: 0.5s;
}

.category-button:hover::before {
   left: 100%;
}

.category-button:hover {
   transform: translateY(-2px);
   box-shadow: 0 8px 20px rgba(78, 84, 200, 0.3);
}

.category-button.active {
   opacity: 1;
   transform: scale(1.05);
   border: 2px solid #000; 
   box-shadow: 0 4px 20px rgba(45, 50, 184, 0.4);
   animation: activeButtonPulse 2s infinite;
}

[data-category="duel"] {
   background: linear-gradient(45deg, #f12711, #f5af19);
}

[data-category="duel"].active {
   background: linear-gradient(45deg, #f12711, #f5af19);
}

[data-category="lider"] {
   background: linear-gradient(45deg, #11998e, #38ef7d);
}

[data-category="lider"].active {
   background: linear-gradient(45deg, #11998e, #38ef7d);
}

[data-category="sampiyon"] {
   background: linear-gradient(45deg, #FFD700, #FFA500);
}

[data-category="sampiyon"].active {
   background: linear-gradient(45deg, #FFD700, #FFA500);
}

/* Aktif buton animasyonu */
@keyframes activeButtonPulse {
   0% { transform: scale(1.05); }
   50% { transform: scale(1.08); }
   100% { transform: scale(1.05); }
}

.category-button:hover {
   opacity: 0.9;
   transform: translateY(-2px);
}

.category-button.active:hover {
   opacity: 1;
}

@media (max-width: 768px) {
   .profile-categories {
       gap: 10px;
       padding: 10px;
   }

   .category-button {
       min-width: 160px;
       height: 45px;
       font-size: 0.9rem;
   }
}


.category-button.active {
   opacity: 1;
   transform: scale(1.05);
   background: linear-gradient(45deg, #2d32b8, #5c61f9);
   box-shadow: 0 4px 20px rgba(45, 50, 184, 0.4);
   animation: activeButtonPulse 2s infinite;
   border: 2px solid #000; /* Siyah çerçeve */
}

.category-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
animation: floatButton 1s ease infinite;
}

@keyframes floatButton {
    0% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
    100% { transform: translateY(0); }
}

@media (max-width: 768px) {
    .category-button {
        min-width: 160px;
        font-size: 0.9rem;
        padding: 0 15px;
    }
}


.profile-categories::after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 30px;
    background: linear-gradient(to right, transparent, rgba(255,255,255,0.9));
    pointer-events: none;
}

.profile-photo-item {
   text-align: center; /* İçerikleri ortalar */
   padding: 15px;
}

.profile-photo-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.12);
}

@keyframes fadeInUp {
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes glowRotate {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}





.question-container {
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: 700px;
    padding: 15px;
    border: 2px solid #ff8a00;
    border-radius: 10px;
    background-color: #fffbea;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    gap: 15px; /* İçerikler arası boşluk */
}

/* Metin Bölümü */
.question-text-container {
    display: flex;
    flex-direction: column;
    width: 100%;
    gap: 15px;
}

/* Üst metin (bilgi metni) */
.question-info-text {
    font-size: 1.1em;
    color: #333;
    padding: 10px;
    text-align: center;
}

/* Ayırıcı çizgi */
.question-divider {
    width: 90%;
    height: 1px;
    background: #ff8a00;
    margin: 0 auto;
    opacity: 0.5;
}

/* Alt metin (soru metni) */
.question-actual-text {
    font-size: 1.2em;
    font-weight: bold;
    color: #000;
    padding: 10px;
    text-align: center;
}












.current-diamonds {
    position: relative; /* Pseudo-element için gerekli */
    background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
    color: white;
    padding: 10px 20px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    overflow: hidden; /* Pseudo-element taşmasını önlemek için */
    transition: transform 0.3s ease; /* Hover animasyonu için */
}

.current-diamonds::before {
    display: none; /* Efekti tamamen kaldır */
}

.current-diamonds::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 15px;
    box-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
    opacity: 0;
    transition: opacity 0.3s ease;
    animation: backgroundGlow 4s ease-in-out infinite; /* Arka plan parlaklık animasyonu */
}

.current-diamonds:hover::after {
    opacity: 1;
}

.current-diamonds:hover {
    transform: scale(1.05); /* Hover durumunda hafif büyüme */
}

.diamond-icon {
    font-size: 1.2em;
    position: relative;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-5px);
    }
}

@keyframes waveMove {
    0% {
        transform: rotate(0deg) translate(0, 0);
    }
    50% {
        transform: rotate(180deg) translate(10px, 10px);
    }
    100% {
        transform: rotate(360deg) translate(0, 0);
    }
}

/* Yeni Eklenen Arka Plan Parlaklık Animasyonu */
@keyframes backgroundGlow {
    0% {
        box-shadow: 0 0 10px rgba(79, 195, 247, 0.3), 0 0 20px rgba(79, 195, 247, 0.2);
    }
    50% {
        box-shadow: 0 0 20px rgba(79, 195, 247, 0.6), 0 0 30px rgba(79, 195, 247, 0.4);
    }
    100% {
        box-shadow: 0 0 10px rgba(79, 195, 247, 0.3), 0 0 20px rgba(79, 195, 247, 0.2);
    }
}

/* Metindeki Parlaklık Efektini Kaldırdım */
.diamond-amount {
    font-weight: bold;
    font-size: 1.1em;
    color: #4fc3f7;
    /* Metindeki glowText animasyonunu kaldırdık */
    /* transition: color 0.3s ease; */
}


















.register-button {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1.1em;
    margin-left: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.register-button:hover {
    transform: scale(1.05);
    box-shadow: 0 7px 20px rgba(0,0,0,0.2);
}

.registration-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000000;
    animation: fadeIn 0.3s ease-in-out;
}

.registration-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    width: 90%;
    max-width: 400px;
    animation: slideIn 0.3s ease-out;
}

.registration-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
}

.registration-input {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1em;
    transition: border-color 0.3s;
}

.registration-input:focus {
    border-color: #4CAF50;
    outline: none;
    box-shadow: 0 0 5px rgba(74, 175, 80, 0.2);
}

.registration-submit {
    width: 100%;
    padding: 12px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1em;
    cursor: pointer;
    transition: all 0.3s;
}

.registration-submit:disabled {
    background: #cccccc;
    cursor: not-allowed;
}

.registration-submit:not(:disabled):hover {
    background: #45a049;
    transform: scale(1.02);
}

.registration-error {
    color: #dc3545;
    font-size: 0.9em;
    text-align: center;
    margin-top: 10px;
    min-height: 20px;
}

.verification-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000000;
}

.verification-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    text-align: center;
    max-width: 400px;
    animation: fadeIn 0.3s ease-in-out;
}

.verification-content h3 {
    color: #4CAF50;
    margin-bottom: 15px;
}

.verification-content p {
    color: #666;
    line-height: 1.5;
    margin-bottom: 10px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { 
        transform: translateY(-20px);
        opacity: 0;
    }
    to { 
        transform: translateY(0);
        opacity: 1;
    }
}






.user-ranking-stats {
   margin-top: auto;
   padding: 15px;
   background: linear-gradient(135deg, #4338ca, #6366f1);
   border-radius: 15px;
   color: white;
   animation: slideUp 0.3s ease-out 0.2s backwards;
}

@keyframes slideUp {
   0% {
       transform: translateY(30px);
       opacity: 0;
   }
   100% {
       transform: translateY(0);
       opacity: 1;
   }
}

.user-ranking-stats:hover {
   transform: translateY(-2px);
   box-shadow: 0 12px 25px rgba(79, 70, 229, 0.3);
}

.stats-header {
   font-size: 1.3em;
   font-weight: bold;
   text-align: center;
   margin-bottom: 12px;
   text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}

.stats-content {
   display: flex;
   justify-content: space-between;
   align-items: center;
   padding: 12px 15px;
   background: rgba(255, 255, 255, 0.12);
   border-radius: 12px;
   backdrop-filter: blur(4px);
   border: 1px solid rgba(255, 255, 255, 0.1);
}

.rank-info {
   display: flex;
   align-items: center;
   gap: 25px;
}

.rank-number, .total-players {
   display: flex;
   flex-direction: column;
   align-items: center;
   gap: 4px;
}

.rank-label, .total-label {
   font-size: 0.85em;
   opacity: 0.95;
   letter-spacing: 0.3px;
}

.rank-value, .total-value {
   font-size: 1.5em;
   font-weight: bold;
   text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}

.user-trophy {
   display: flex;
   align-items: center;
   gap: 8px;
   background: rgba(255, 215, 0, 0.15);
   padding: 8px 15px;
   border-radius: 10px;
   border: 1px solid rgba(255, 215, 0, 0.2);
   margin-left: 10px;
}

.trophy-icon {
   font-size: 1.4em;
   animation: trophyBounce 2.5s infinite ease-in-out;
   filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.2));
}

.trophy-value {
   font-size: 1.4em;
   font-weight: bold;
   color: #ffd700;
   text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}

@keyframes trophyBounce {
   0%, 100% { transform: translateY(0) rotate(0deg); }
   50% { transform: translateY(-3px) rotate(3deg); }
}

@media (max-width: 480px) {
   .user-ranking-stats {
       margin: 10px auto;
       padding: 12px 15px;
   }
   
   .stats-content {
       padding: 10px 12px;
   }
   
   .rank-info {
       gap: 20px;
   }
   
   .rank-value, .total-value, .trophy-value {
       font-size: 1.3em;
   }
   
   .trophy-icon {
       font-size: 1.2em;
   }
}





.credits-stats {
    background: linear-gradient(145deg, #ff9900, #db6204);
    position: relative;
}

.credits-glow {
    background: radial-gradient(circle at center,
        rgba(99, 102, 241, 0.3) 0%,
        transparent 70%);
    animation: pulseCredits 2s ease-in-out infinite;
}

.credits-stats .stats-icon {
    animation: floatGame 3s ease-in-out infinite;
    filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5));
}

.credits-stats .stats-value {
    background: linear-gradient(45deg, #ffffff, #ffffff, #ffffff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmerCredits 3s linear infinite;
}

.tip-title {
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    white-space: nowrap;
    pointer-events: none;
    z-index: 10;
}

@keyframes pulseCredits {
    0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
    50% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.1); }
}

@keyframes floatGame {
    0%, 100% { transform: translateY(0) scale(1); filter: brightness(1); }
    50% { transform: translateY(-3px) scale(1.05); filter: brightness(1.2); }
}

@keyframes shimmerCredits {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
}






/* Ana mağaza kabı */
.duel-credits-store {
  background: linear-gradient(135deg, #1a1c2b, #2d324d);
  padding: 25px;
  border-radius: 20px;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
  max-width: 1200px; /* Daha geniş ekranlarda ortalamak için */
  margin: 0 auto;    /* Ortalamak için */
  max-height: 450px;      /* Sabit yükseklikten kaçın */
  overflow-y: auto;  /* İçerik uzadığında dikeyde kaydırma yapabilmek için */
}

/* Paketlerin bulunduğu konteyner - grid yapısı */
.credits-packages-container {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  padding: 15px;
  height: auto;      /* Sabit yükseklikten kaçın */
}

/* Paket Kartları */
.credit-package {
  background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 15px;
  padding: 20px;
  backdrop-filter: blur(10px);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.credit-package:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
}

/* Paket İçerikleri */
.package-header {
  text-align: center;
  margin-bottom: 15px;
}

.package-amount {
  font-size: 1.4em;
  font-weight: bold;
  background: linear-gradient(45deg, #f5d020, #ff9933);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 5px;
}

.package-subtitle {
  color: #a0aec0;
  font-size: 0.9em;
}

.package-price {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin: 15px 0;
  font-size: 1.2em;
  color: #4fd1c5;
}

/* Satın Al Butonu */
.buy-button {
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #4c1d95, #6d28d9);
  color: #ffffff;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.buy-button:hover {
  background: linear-gradient(135deg, #6d28d9, #4c1d95);
  transform: scale(1.05);
}

/* Unlimited Paketi Özel Görünüm */
.credit-package.unlimited {
  background: linear-gradient(145deg, #4f46e5, #4338ca);
  color: #ffffff;
  position: relative;
  overflow: hidden; /* Parlama efektini göstermek için parent'ta kalabilir */
}

.credit-package.unlimited::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(
    45deg,
    transparent,
    rgba(255, 255, 255, 0.1),
    transparent
  );
  animation: shine 3s infinite linear;
}

/* Parlaklık Animasyonu */
@keyframes shine {
  0% {
    transform: translateX(-100%) rotate(45deg);
  }
  100% {
    transform: translateX(100%) rotate(45deg);
  }
}

/* Mobil uyumlu tasarım için medya sorgusu */
@media (max-width: 768px) {
  .credits-packages-container {
    grid-template-columns: 1fr;
    gap: 15px;
  }

  .duel-credits-store {
    padding: 20px;
    /* Yine height: auto ve overflow-y: auto burada da geçerli kalmalı */
  }

  .credit-package {
    padding: 15px;
  }

  .package-amount {
    font-size: 1.2em;
  }

  .package-price {
    font-size: 1.1em;
  }
}







.credits-stats.unlimited {
    background: linear-gradient(145deg, #6ddb0d, #11f0d6);
    color: white;
    position: relative;
    overflow: hidden;
}

.credits-stats.unlimited::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 200%;
    height: 100%;
    background: linear-gradient(
        90deg, 
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
    );
    animation: shimmerEffect 2s infinite;
}

.credits-stats.unlimited .stats-value {
    font-weight: bold;
    text-shadow: 0 0 10px rgba(255,255,255,0.5);
    animation: pulseText 2s infinite;
}

@keyframes shimmerEffect {
    from { transform: translateX(-100%); }
    to { transform: translateX(100%); }
}

@keyframes pulseText {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}






/* Seçim animasyonu: Slide-in efekti */
.animate-slideIn {
  opacity: 0;
  transform: translateY(20px);
  animation: slideIn 0.5s forwards;
}

@keyframes slideIn {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* İsteğe bağlı: Seçim alanı (duel-selection-banner) için ekstra stil */
.duel-selection-banner {
  text-align: center;
  margin-bottom: 20px;
}

.selection-item {
  font-size: 1.2em;
  margin: 5px 0;
}



/* === Düello Seçim Ekranı için Yenilenmiş Stil === */
#duel-selection-screen {
  /* Dinamik ve derin bir arka plan */
  background: linear-gradient(135deg, #1f1c2c, #928dab);
  animation: duelBgAnimation 8s ease-in-out infinite alternate;
  padding: 40px;
  border-radius: 20px;
  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
  max-width: 900px;
  margin: 40px auto;
  transform: translateY(20px);
  opacity: 0;
  animation: fadeInUp 0.8s forwards, duelBgAnimation 8s ease-in-out infinite alternate;
  position: relative;
  overflow: hidden;
}

/* Arka plan animasyonu */
@keyframes duelBgAnimation {
  0% {
    background: linear-gradient(135deg, #1f1c2c, #928dab);
  }
  100% {
    background: linear-gradient(135deg, #232526, #414345);
  }
}

/* Fade in yukarı animasyonu */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Başlık animasyonu ve stil düzenlemesi */
#duel-selection-screen h2 {
  font-size: 2.2em;
  color: #fff;
  text-align: center;
  text-shadow: 0 0 10px rgba(0,0,0,0.7);
  margin-bottom: 20px;
  animation: headerPulse 2s ease-in-out infinite alternate;
}

@keyframes headerPulse {
  0% {
    transform: scale(1);
    text-shadow: 0 0 10px rgba(0,0,0,0.7);
  }
  100% {
    transform: scale(1.05);
    text-shadow: 0 0 20px rgba(0,0,0,0.9);
  }
}

.selecting-student-banner {
  font-size: 1.2em;
  font-weight: bold;
  color: #ffeb3b;
  text-align: center;
  /* Örneğin, üst, sağ, alt, sol için sırasıyla 20px, 15px, 10px, 15px boşluk */
  margin: 20px 15px 10px 15px;
  padding: 10px;
  border-radius: 20px;
  background: rgba(0,0,0,0.3);
  box-shadow: 0 0 10px rgba(255,235,59,0.7);
  animation: glowBanner 1.5s infinite alternate;
}


@keyframes glowBanner {
  from {
    box-shadow: 0 0 10px rgba(255,235,59,0.5);
  }
  to {
    box-shadow: 0 0 20px rgba(255,235,59,1);
  }
}

/* Table-section (konu belirleme) kutusu: hafif transparan, yuvarlatılmış */
#duel-selection-screen .table-section {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255,255,255,0.2);
  padding: 7px;
  border-radius: 15px;
  margin-bottom: 20px;
  animation: slideInFromLeft 0.6s ease-out;
}

@keyframes slideInFromLeft {
  from {
    transform: translateX(-50px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Label ve select elementleri */
#duel-selection-screen label {
  display: block;
  margin: 10px 0 5px;
  color: #fff;
  font-weight: 600;
}
#duel-selection-screen select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 8px;
  background: rgba(255,255,255,0.2);
  color: #fff;
  font-size: 1em;
  outline: none;
  transition: background 0.3s, border-color 0.3s;
}
#duel-selection-screen select:focus {
  background: rgba(255,255,255,0.3);
  border-color: #ffeb3b;
}

/* Duel start butonu */
.duel-start-button {
  background: linear-gradient(45deg, #ff5722, #e91e63);
  color: #fff;
  padding: 14px 30px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 1.1em;
  font-weight: bold;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  transition: transform 0.2s, box-shadow 0.3s;
  opacity: 0.8;
}
.duel-start-button.active,
.duel-start-button:hover {
  transform: scale(1.05);
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  opacity: 1;
}

/* Duel bottom info (oyuncu bilgileri) – dinamik hover ve animasyon */
.duel-bottom-info {
  display: flex;
  justify-content: space-evenly;
  margin-top: 5px;
  animation: fadeInUp 0.8s ease;
}
.duel-player-info {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}
.duel-player-photo {
  width: 80px;
  height: 80px;
  border-radius: 12px;
  object-fit: cover;
  border: 3px solid #ffeb3b;
  transition: transform 0.4s ease;
}
.duel-player-photo:hover {
  transform: rotate(360deg);
}
.duel-player-name {
  margin-top: 10px;
  color: #fff;
  font-size: 1em;
  font-weight: 600;
  text-shadow: 0 0 5px rgba(0,0,0,0.6);
}

/* Countdown container – modern ve net görünüm */
.countdown-container {
  position: absolute;
  margin-bottom: 10px;
  top: 15px;
  right: 15px;
  z-index: 10;
}
.countdown {
  font-size: 1em;
  color: #ff5722;
  margin-bottom: 10px;
  font-weight: bold;
  background: rgba(0, 0, 0, 0.4);
  padding: 8px 12px;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  animation: pulseCountdown 1.5s infinite;
}

@keyframes pulseCountdown {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* Option butonları (soru seçiminde kullanılanlar) – isteğe bağlı */
#duel-selection-screen .option-button {
  transition: transform 0.2s, background-color 0.2s;
}
#duel-selection-screen .option-button:hover {
  transform: scale(1.05);
}

/* Genel responsive ayarlamaları (isteğe bağlı) */
@media (max-width: 480px) {
  #duel-selection-screen {
    padding: 20px;
    margin: 20px;
  }
  #duel-selection-screen h2 {
    font-size: 1.8em;
  }
  .duel-player-photo {
    width: 60px;
    height: 60px;
  }
}








/* ========== Gelişmiş Alert Modal Tasarımı ========== */
.alert-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000000;
  animation: fadeInModal 0.3s ease;
}

@keyframes fadeInModal {
  from { opacity: 0; }
  to { opacity: 1; }
}

.alert-content {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(8px);
  padding: 30px;
  border-radius: 15px;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  text-align: center;
  position: relative;
  animation: slideDownModal 0.4s ease;
}

@keyframes slideDownModal {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.alert-message {
  font-size: 1.2em;
  color: #333;
  margin-bottom: 20px;
  /* Hafif parıltı efekti */
  animation: textGlow 1.5s infinite alternate;
}

@keyframes textGlow {
  from { text-shadow: 0 0 5px rgba(0,123,255,0.5); }
  to { text-shadow: 0 0 10px rgba(0,123,255,1); }
}

.alert-ok-button {
  background: linear-gradient(45deg, #007BFF, #00BFFF);
  color: #fff;
  padding: 12px 25px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1em;
  font-weight: bold;
  transition: background 0.3s, transform 0.2s;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.alert-ok-button:hover {
  background: linear-gradient(45deg, #0056b3, #009acd);
  transform: scale(1.05);
}











/* --- Nova Stars --- */
.star-badges{ display:inline-flex; gap:4px; vertical-align:middle; margin-left:6px; }

/* --- Nova Stars (Frame Update) --- */
.star-frame{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:4px;
  margin-top:6px;
  padding:4px 8px;
  border:1px solid rgba(255,193,7,.9);
  background: linear-gradient(180deg, rgba(255, 243, 205, .35), rgba(255, 214, 102, .12));
  border-radius:10px;
  min-height:26px;
  min-width:56px;
  box-shadow: 0 1px 2px rgba(0,0,0,.08), inset 0 0 4px rgba(255, 213, 79, .25);
}
.star-frame .star-badges{ margin-left:0 !important; }
.star-frame .star{ line-height:1; display:inline-block; }
.star{ font-size:16px; filter: drop-shadow(0 0 1px rgba(255,215,0,.6)); animation: starPulse 1.8s ease-in-out infinite; }
.star.bright{ filter: drop-shadow(0 0 2px rgba(255,230,80,.9)) drop-shadow(0 0 6px rgba(255,200,50,.6)); }
.star.flame{ position:relative; animation: starFlame 1.2s ease-in-out infinite; }
.star.flame::after{
    content: ''; position:absolute; top:-6px; left:50%; width:6px; height:10px; transform:translateX(-50%);
    background: radial-gradient(circle at 50% 100%, rgba(255,140,0,.9), rgba(255,69,0,.6) 60%, rgba(255,0,0,0) 70%);
    filter: blur(1px);
    border-radius: 12px 50% 40% 40%;
    opacity:.8;
}
@keyframes starPulse { 0%,100%{ transform: scale(1); } 50%{ transform: scale(1.12);} }
@keyframes starFlame { 0%,100%{ transform: translateY(0) rotate(-2deg);} 50%{ transform: translateY(-1px) rotate(2deg);} }


/* === Mobile Market/Profile Scroll Fixes (Nova) === */
html, body {
  min-height: 100dvh;
  overflow-y: auto;
}

@supports (height: 100dvh) {
  .profile-change-overlay { min-height: 100dvh; }
}

.profile-change-overlay {
  overflow-y: auto;                 /* Allow the overlay to scroll on small screens */
  align-items: flex-start;          /* Avoid vertical centering that hides the header */
  padding-top: max(12px, env(safe-area-inset-top));  /* Respect notches/status bars */
  padding-bottom: max(12px, env(safe-area-inset-bottom));
}

.profile-change-content {
  max-height: none;                 /* Let content grow; inner sections handle their own scroll */
}

/* Inner store scrollers */
.duel-credits-store {
  max-height: none;                 /* Remove restrictive height */
  overflow-y: visible;
}

/* Make package grid single-column on phones */
@media (max-width: 600px) {
  .profile-change-content {
    width: 100%;
    max-width: 100%;
    border-radius: 12px;
    padding: 16px;
  }
  .credits-packages-container {
    grid-template-columns: 1fr !important;
    gap: 14px;
  }
  .profile-categories {
    padding: 10px;
  }
  .ranking-panel { width: 100%; }
}

/* Ensure headers/buttons are fully visible and not cut */
.profile-change-header,
.profile-categories,
.profile-change-content h2 {
  scroll-margin-top: 16px;
}

/* Allow touch momentum scrolling on iOS */
.profile-change-overlay,
.duel-credits-store,
.credits-packages-container {
  -webkit-overflow-scrolling: touch;
}
/* === End of Mobile Fixes === */


/* === NOVA: Sürpriz Kutu Stil === */
.surprise-box{
  position:absolute;
  top:12px; left:12px; /* Sol üst */
  display:flex; flex-direction:column; align-items: center;
  z-index:2; /* profil fotoğrafı üstte kalsın */
  user-select:none; cursor:pointer;
  filter: grayscale(0.25);
  opacity:.85;
  transition: transform .2s ease, filter .2s ease, opacity .2s ease;
}
.surprise-box img{
  width:48px; height:48px; object-fit:contain; pointer-events:none;
}

@media (max-width: 480px){
  .surprise-box{ top:10px; left:10px; }
  .surprise-box img{ width:42px; height:42px; }
  .surprise-box-counter{
    margin-top:2px;
    padding:2px 4px;
    font-size:.72rem;
    max-width:42px;
    display:inline-flex;
  align-items:center;
  justify-content:center;
  white-space: nowrap;
  min-width: 48px;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
}

}

.surprise-box-counter{
  margin-top:3px;
  padding:2px 6px;
  background: rgba(0,0,0,.55);
  border: 2px solid rgba(255,255,255,.75);
  border-radius: 8px;
  color: #fff;
  font-weight: 800;
  font-size: .78rem;
  line-height: 1.1;
  text-align: center;
  text-shadow: 0 1px 2px rgba(0,0,0,.6);
  max-width: 48px;        /* kutu görseli ile orantılı olsun */
  width: max-content;     /* metne göre ölçülensin */
  white-space: normal;    /* taşarsa alt satıra geçsin */
  word-break: break-word;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  white-space: nowrap;
  min-width: 48px;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
}

.surprise-box.locked{ filter: grayscale(0.6); opacity:.6; cursor:not-allowed; animation:none !important; }
.surprise-box.active{ filter: grayscale(0); opacity:1; animation: sbPulse 1.4s ease-in-out infinite; }
@keyframes sbPulse { 0%,100%{ transform: scale(1)} 50%{ transform: scale(1.06)} }

/* Particles for reward animation */
.reward-overlay{
  position: fixed; inset:0; display:flex; align-items:center; justify-content:center;
  background: rgba(0,0,0,.45); z-index: 99999; animation: fadeIn .25s ease;
}
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.reward-chest{
  background: radial-gradient(ellipse at center, #fff 0%, #eee 55%, #ddd 100%);
  border-radius: 18px; padding: 24px 28px; box-shadow: 0 12px 40px rgba(0,0,0,.35);
  display:flex; flex-direction:column; align-items:center; gap:8px; min-width: 260px;
  transform: scale(.95);
  animation: popIn .28s ease forwards;
}
@keyframes popIn { to{ transform: scale(1)} }
.reward-amount{ font-size: 2.2rem; font-weight: 900 }
.reward-caption{ font-weight:800; opacity:.9 }
.particle{ position: fixed; font-size: 22px; pointer-events:none; will-change: transform, opacity }
@media (max-width:600px){
  .surprise-box{ top:8px; left:8px }
  .surprise-box img{ width:76px; height:76px }
  .surprise-box-counter{
  margin-top:3px;
  padding:2px 6px;
  background: rgba(0,0,0,.55);
  border: 2px solid rgba(255,255,255,.75);
  border-radius: 8px;
  color: #fff;
  font-weight: 800;
  font-size: .78rem;
  line-height: 1.1;
  text-align: center;
  text-shadow: 0 1px 2px rgba(0,0,0,.6);
  max-width: 48px;        /* kutu görseli ile orantılı olsun */
  width: max-content;     /* metne göre ölçülensin */
  white-space: normal;    /* taşarsa alt satıra geçsin */
  word-break: break-word;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  white-space: nowrap;
  min-width: 48px;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
}

}
/* === /NOVA Sürpriz Kutu Stil === */


/* === NOVA PATCH: Mağaza kategori rengi override (kızlarköşesi = pembe, TemelKarakterler = mavi) === */
.profile-categories .category-button[data-category="TemelKarakterler"],
.profile-categories .category-button[data-category="temelkarakterler"] {
  background-image: linear-gradient(135deg, #2f80ed, #56ccf2);
  color: #fff !important;
  border: none;
  box-shadow: 0 8px 18px rgba(47,128,237,0.35), inset 0 0 0 1px rgba(255,255,255,0.25);
  position: relative;
  overflow: hidden;
}
.profile-categories .category-button[data-category="TemelKarakterler"]::before,
.profile-categories .category-button[data-category="temelkarakterler"]::before {
  content: "";
  position: absolute;
  top: -150%;
  left: -150%;
  width: 300%;
  height: 300%;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.28), transparent 45%);
  animation: novaShine 2.4s linear infinite;
  pointer-events: none;
}
.profile-categories .category-button[data-category="TemelKarakterler"]:hover,
.profile-categories .category-button[data-category="temelkarakterler"]:hover {
  filter: brightness(1.06);
  transform: translateY(-1px);
}
.profile-categories .category-button[data-category="TemelKarakterler"].active,
.profile-categories .category-button[data-category="temelkarakterler"].active {
  box-shadow: 0 10px 24px rgba(47,128,237,0.45);
}

/* Türkçe karakter olasılıklarının tamamı için geniş seçiciler */
.profile-categories .category-button[data-category="KizlarKösesi"],
.profile-categories .category-button[data-category="KizlarKöşesi"],
.profile-categories .category-button[data-category="KızlarKösesi"],
.profile-categories .category-button[data-category="KızlarKöşesi"],
.profile-categories .category-button[data-category="KIZLARKÖŞESİ"],
.profile-categories .category-button[data-category="kızlarköşesi"],
.profile-categories .category-button[data-category="KizlarKosesi"],
.profile-categories .category-button[data-category="KIZLARKOSESİ"],
.profile-categories .category-button[data-category="kizlarkosesi"] {
  background-image: linear-gradient(135deg, #ff4db8, #ff8bd7);
  color: #fff !important;
  border: none;
  box-shadow: 0 8px 18px rgba(255, 77, 184, 0.35), inset 0 0 0 1px rgba(255,255,255,0.25);
  position: relative;
  overflow: hidden;
}
.profile-categories .category-button[data-category="KizlarKösesi"]::before,
.profile-categories .category-button[data-category="KizlarKöşesi"]::before,
.profile-categories .category-button[data-category="KızlarKösesi"]::before,
.profile-categories .category-button[data-category="KızlarKöşesi"]::before,
.profile-categories .category-button[data-category="KIZLARKÖŞESİ"]::before,
.profile-categories .category-button[data-category="kızlarköşesi"]::before,
.profile-categories .category-button[data-category="KizlarKosesi"]::before,
.profile-categories .category-button[data-category="KIZLARKOSESİ"]::before,
.profile-categories .category-button[data-category="kizlarkosesi"]::before {
  content: "";
  position: absolute;
  top: -150%;
  left: -150%;
  width: 300%;
  height: 300%;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.28), transparent 45%);
  animation: novaShine 2.4s linear infinite;
  pointer-events: none;
}
.profile-categories .category-button[data-category="KizlarKösesi"]:hover,
.profile-categories .category-button[data-category="KizlarKöşesi"]:hover,
.profile-categories .category-button[data-category="KızlarKösesi"]:hover,
.profile-categories .category-button[data-category="KızlarKöşesi"]:hover,
.profile-categories .category-button[data-category="KIZLARKÖŞESİ"]:hover,
.profile-categories .category-button[data-category="kızlarköşesi"]:hover,
.profile-categories .category-button[data-category="KizlarKosesi"]:hover,
.profile-categories .category-button[data-category="KIZLARKOSESİ"]:hover,
.profile-categories .category-button[data-category="kizlarkosesi"]:hover {
  filter: brightness(1.06);
  transform: translateY(-1px);
}
.profile-categories .category-button[data-category="KizlarKösesi"].active,
.profile-categories .category-button[data-category="KizlarKöşesi"].active,
.profile-categories .category-button[data-category="KızlarKösesi"].active,
.profile-categories .category-button[data-category="KızlarKöşesi"].active,
.profile-categories .category-button[data-category="KIZLARKÖŞESİ"].active,
.profile-categories .category-button[data-category="kızlarköşesi"].active,
.profile-categories .category-button[data-category="KizlarKosesi"].active,
.profile-categories .category-button[data-category="KIZLARKOSESİ"].active,
.profile-categories .category-button[data-category="kizlarkosesi"].active {
  box-shadow: 0 10px 24px rgba(255, 77, 184, 0.45);
}

/* Hafif parıltı animasyonu */
@keyframes novaShine {
  0%   { transform: translate(0,0) rotate(0deg); opacity: 0.9; }
  50%  { transform: translate(15%,15%) rotate(45deg); opacity: 1; }
  100% { transform: translate(30%,30%) rotate(90deg); opacity: 0.9; }
}
/* === NOVA PATCH SONU === */


/* === Nova Responsive Patch v1 === */
:root{
  --q-max-w: min(95vw, 900px);
  --q-min-h: min(60vh, 520px);
  --qpad: clamp(10px, 2.2vw, 20px);
  --q-font: clamp(16px, 2.2vw, 22px);
  --opt-font: clamp(14px, 2vw, 20px);
  --timer-font: clamp(16px, 2.5vw, 22px);
}
.single-player-game-container,
.duel-game-container{
  width: 100%;
  max-width: 1200px;
  padding: clamp(12px, 2.5vw, 30px);
}
.question-container{
  width: 100%;
  max-width: var(--q-max-w);
  min-height: var(--q-min-h);
  padding: var(--qpad);
}
.question-text{
  font-size: var(--q-font);
  line-height: 1.3;
  padding: 6px 0;
}
.timer{ font-size: var(--timer-font); }
.options-container{
  width: 100%;
  max-width: var(--q-max-w);
  gap: clamp(8px, 2vw, 18px);
}
.option-button{
  flex: 1 1 calc(50% - 12px);
  min-width: clamp(140px, 40vw, 360px);
  font-size: var(--opt-font);
  padding: clamp(10px, 2vw, 16px) clamp(12px, 2.2vw, 18px);
}
@media (max-width: 640px){
  .option-button{ flex: 1 1 100%; min-width: 0; }
}
.question-image{
  max-width: 100%;
  max-height: 50vh;
  height: auto;
  object-fit: contain;
}
/* Duel top info row width guard */
.players-info-row{
  width: 100%;
  max-width: var(--q-max-w);
}
/* Make score/winner messages wrap safely on mobile */
.winner-message,.score-message{
  word-break: break-word;
  overflow-wrap: anywhere;
}
/* === End Nova Responsive Patch v1 === */


/* Ensure game containers expand full width when visible */
.single-player-game-container[style*="display: block"],
.duel-game-container[style*="display: block"],
.single-player-game-container.active,
.duel-game-container.active{
  display:flex !important;
}


/* === NOVA: Single Player Result - Circular Percentage Ring === */
.nova-circular-wrap{width:220px;height:220px;position:relative;margin:10px auto 0;display:flex;align-items:center;justify-content:center}
.nova-circular{width:220px;height:220px;transform:rotate(-90deg)}
.nova-track{fill:none;stroke:#e6e6e6;stroke-width:14}
.nova-progress{fill:none;stroke-width:14;stroke-linecap:round;transition:stroke-dashoffset 1.2s ease}
.nova-percent-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:2.2rem;letter-spacing:.5px;color:#111;text-shadow:0 2px 8px rgba(0,0,0,.15)}
.nova-ring-glow{filter:drop-shadow(0 4px 14px rgba(0,0,0,.15))}
@keyframes novaPop{from{transform:scale(.9);opacity:.0}to{transform:scale(1);opacity:1}}
.nova-circular-wrap{animation:novaPop .35s ease-out}
/* === NOVA END === */


/* === Nova: Duel Result FX v2 === */
.duel-player-score.winner{
  background: linear-gradient(135deg, rgba(16,185,129,.08), rgba(5,150,105,.08));
  box-shadow: 0 10px 28px rgba(16,185,129,.25), inset 0 0 0 2px rgba(5,150,105,.45);
  transform-origin: center;
  animation: novaWinPulse .9s ease-out 1, novaWinGlow 2.2s ease-in-out infinite alternate;
}
.duel-player-score.loser{
  background: linear-gradient(135deg, rgba(239,68,68,.06), rgba(220,38,38,.06));
  box-shadow: 0 10px 24px rgba(220,38,38,.18), inset 0 0 0 2px rgba(220,38,38,.35);
  filter: grayscale(.25) saturate(.9);
  position: relative;
  overflow: hidden;
  animation: novaLoseShake 1.2s ease-in-out 1;
}
.duel-player-score.loser::after{
  content:'';
  position:absolute; inset:-10px;
  background: radial-gradient(ellipse at center, rgba(239,68,68,.20), transparent 60%);
  backdrop-filter: blur(2px);
  pointer-events:none;
}
.duel-player-score.tie{
  background: linear-gradient(135deg, rgba(59,130,246,.08), rgba(37,99,235,.08));
  box-shadow: 0 10px 24px rgba(59,130,246,.22), inset 0 0 0 2px rgba(37,99,235,.45);
}

#winner-message {
  letter-spacing:.4px;
}
.duel-final-theme-win #winner-message{
  background: linear-gradient(90deg,#22c55e,#16a34a,#22c55e);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  text-shadow: 0 0 18px rgba(16,185,129,.35);
}
.duel-final-theme-lose #winner-message{
  background: linear-gradient(90deg,#ef4444,#dc2626,#ef4444);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  text-shadow: 0 0 14px rgba(239,68,68,.35);
}
.duel-final-theme-tie #winner-message{
  background: linear-gradient(90deg,#60a5fa,#3b82f6,#60a5fa);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  text-shadow: 0 0 14px rgba(59,130,246,.35);
}

/* Subtle vignette on the whole duel screen based on result */
#duel-game-screen.duel-final-theme-win::before,
#duel-game-screen.duel-final-theme-lose::before,
#duel-game-screen.duel-final-theme-tie::before{
  content:''; position:fixed; inset:0; z-index:0; pointer-events:none;
}
#duel-game-screen.duel-final-theme-win::before{ background: radial-gradient(1200px 800px at 50% 30%, rgba(16,185,129,.10), transparent 60%); }
#duel-game-screen.duel-final-theme-lose::before{ background: radial-gradient(1200px 800px at 50% 30%, rgba(239,68,68,.12), transparent 60%); }
#duel-game-screen.duel-final-theme-tie::before{ background: radial-gradient(1200px 800px at 50% 30%, rgba(59,130,246,.10), transparent 60%); }

/* Confetti canvas positioning */
#duel-confetti {
  position: fixed; inset:0; z-index: 9998; pointer-events: none;
}

/* keyframes */
@keyframes novaWinPulse{
  0%{ transform: scale(.9) }
  60%{ transform: scale(1.05) }
  100%{ transform: scale(1) }
}
@keyframes novaWinGlow{
  from{ box-shadow: 0 10px 28px rgba(16,185,129,.25), inset 0 0 0 2px rgba(5,150,105,.45) }
  to{ box-shadow: 0 14px 34px rgba(16,185,129,.35), inset 0 0 0 2px rgba(5,150,105,.65) }
}
@keyframes novaLoseShake{
  0%,100%{ transform: translateX(0) }
  20%{ transform: translateX(-4px) }
  40%{ transform: translateX(4px) }
  60%{ transform: translateX(-3px) }
  80%{ transform: translateX(3px) }
}

</style>
<style>
/* --- Nova: Düello cezası kilit stili --- */
.find-duel-button.locked,
#findDuelButton:disabled {
  opacity: 0.6 !important;
  cursor: not-allowed !important;
  filter: grayscale(0.3);
  position: relative;
}
.find-duel-button.locked::after,
#findDuelButton:disabled::after {
  content: "🔒";
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1.1em;
}
/* Buton içindeki geri sayım metninin görünürlüğü için */
#findDuelButton .button-content span.countdown-label {
  font-weight: 700;
}
</style>
<style>
/* === RESİMLİ SORU (robust) === */
.resimli-soru-banner {
  display: none;
  font-size: 1.25rem;
  font-weight: 800;
  color: #ff5722;
  background: linear-gradient(90deg, #ffecd2, #fcb69f, #ffecd2);
  padding: 10px 18px;
  border-radius: 12px;
  margin-bottom: 12px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  animation: rsbPulse 1.5s infinite alternate;
}
@keyframes rsbPulse { from{ transform:scale(1); opacity:.85 } to{ transform:scale(1.05); opacity:1 } }

/* === Nova: Rank Labels === */
.rank-label{
  margin-top: 4px;
  font-weight: 800;
  letter-spacing: .5px;
  text-transform: uppercase;
  display:inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  line-height: 1.1;
  animation: rankPop .4s ease-out both;
  user-select: none;
}
@keyframes rankPop {
  0% { transform: translateY(6px) scale(.9); opacity: .0; filter: blur(2px); }
  100% { transform: translateY(0) scale(1); opacity: 1; filter: blur(0); }
}
/* Per-rank styles */
/* --- Nova update: clearer visual separation for Acemi/binbaşı, upgraded albay --- */
.rank-0{
  color:#666;
  background: linear-gradient(180deg,#f7f7f9,#ececf1);
  box-shadow: inset 0 0 0 1px #d0d3da;
  filter: saturate(.85);
}





  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

  50% { opacity:1; transform: translateY(-1px) rotate(7deg) scale(1.05); }
}}


.rank-3{ color:#555; background:linear-gradient(90deg,#f0f3f5,#dfe6ea); box-shadow:0 0 12px rgba(180,180,200,.35); }
.rank-4{ color:#7a4; background:linear-gradient(90deg,#fff2a8,#ffe27a); box-shadow:0 0 14px rgba(255,200,50,.45); animation: shine 2.2s linear infinite; }

/* --- Nova update v3: richer 'uzman', side stars for 'general' --- */
.rank-1{
  color:#075e3a;
  background:
    linear-gradient(120deg, rgba(255,255,255,.55), rgba(255,255,255,0) 35%),
    linear-gradient(90deg,#eafff1,#d7ffe9,#c9f7df);
  box-shadow:
    inset 0 0 0 1px rgba(10,140,90,.25),
    0 0 10px rgba(0,160,110,.20);
  text-shadow: 0 1px 0 rgba(255,255,255,.6);
  position: relative;
  animation: rankPop .4s ease-out both;
}

.rank-2{
  color:#5a2d00;
  background:
    linear-gradient(120deg, rgba(255,255,255,.4), rgba(255,255,255,0) 40%),
    linear-gradient(90deg,#ffe9c8,#ffd79a,#ffc477);
  box-shadow:
    inset 0 0 0 1px rgba(120,70,20,.3),
    0 0 14px rgba(200,140,60,.35);
  text-shadow: 0 1px 1px rgba(255,255,255,.75);
  border-radius: 8px;
  animation: rankPop .5s ease-out both;
}


.rank-1::after{
  content:"";
  position:absolute; right:6px; top:50%;
  width:28px; height:14px;
  background: radial-gradient(circle at 0 50%, rgba(0,180,120,.18), rgba(0,0,0,0) 70%);
  transform: translateY(-50%);
  filter: blur(0.2px);
  opacity:.7;
}

.rank-5{
  color:#fff;
  background:linear-gradient(120deg,#ffbb33,#ffaa00,#ff6600);
  box-shadow:0 0 18px rgba(255,136,0,.6);
  text-shadow:0 1px 2px rgba(0,0,0,.4);
  animation: crown 1.6s ease-in-out infinite alternate;
  position: relative;
}
.rank-5::before,
.rank-5::after{
  content:"★";
  font-size:.9em;
  position:absolute;
  top:50%; transform: translateY(-55%) rotate(-8deg);
  opacity:.95;
  filter: drop-shadow(0 0 6px rgba(255,180,70,.8));
  animation: twinkle 1.8s ease-in-out infinite;
}
.rank-5::before{
  left:-14px;
}
.rank-5::after{
  right:-14px; transform: translateY(-55%) rotate(8deg);
}




/* --- Nova update: clearer visual separation for Acemi/binbaşı, upgraded albay --- */
.rank-0{
  color:#666;
  background: linear-gradient(180deg,#f7f7f9,#ececf1);
  box-shadow: inset 0 0 0 1px #d0d3da;
  filter: saturate(.85);
}
.rank-3{
  color:#1f2937;
  background:
    repeating-linear-gradient(135deg, rgba(255,255,255,.25) 0 6px, rgba(255,255,255,0) 6px 12px),
    linear-gradient(90deg,#cfd8e3,#b7c0cc,#9aa5b1);
  box-shadow:
    inset 0 0 0 1px rgba(60,72,88,.25),
    0 0 14px rgba(120,140,170,.35);
  text-shadow: 0 1px 0 rgba(255,255,255,.4);
  position: relative;
}
.rank-3::before{
  content: "⟫";
  font-weight: 900;
  opacity:.25;
  position:absolute;
  left:6px; top:50%; transform:translateY(-48%);
}
.rank-4{
  color:#6b4e00;
  background:
    linear-gradient(120deg, rgba(255,255,255,.6), rgba(255,255,255,0) 30%),
    linear-gradient(120deg,#fff4b3,#ffe27a,#ffc94d,#ffb347);
  background-size: 200% 200%;
  animation: goldGleam 3.2s linear infinite;
  box-shadow:
    inset 0 0 0 1px rgba(210,170,0,.55),
    0 0 18px rgba(255,200,70,.55);
  text-shadow: 0 1px 1px rgba(255,255,255,.6);
  position: relative;
}
.rank-4::after{
  content:"★";
  font-size:.9em;
  margin-left:6px;
  filter: drop-shadow(0 0 4px rgba(255,200,60,.7));
  animation: twinkle 1.8s ease-in-out infinite;
}
@keyframes goldGleam {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
@keyframes twinkle {
  0%,100% { opacity:.8; transform: translateY(0) rotate(0deg) scale(1); }
  50% { opacity:1; transform: translateY(-1px) rotate(7deg) scale(1.05); }
}


@keyframes shine {
  0% { filter: brightness(1); }
  50% { filter: brightness(1.15); }
  100% { filter: brightness(1); }
}
@keyframes crown {
  from { transform: translateY(0) }
  to   { transform: translateY(-1px) }
}
/* Compact rank inside tables/cards */
.player-name-column .rank-label{ display:block; margin:2px auto 0; font-size:.8em; }
.star-frame + .rank-label{ display:block; }
</style>
<style id="nova-rank-centering-fix">
/* --- Nova mobile/desktop centering & stacking for name → stars → rank --- */
#main-screen{ width:100% !important; max-width:1400px; margin:0 auto !important; }
.player-name-column{
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  text-align:center; line-height:1.15;
}
.player-name-column .name-line{ margin:0 0 4px 0; font-weight:600; }
.player-name-column .star-frame{ margin-top:4px; }
.player-name-column .rank-label{ margin-top:6px; min-width:72px; text-align:center; }
.rank-label{ display:inline-block; text-transform:capitalize; }
/* Ensure the star frame itself is perfectly centered and "symmetric" */
.star-frame{ display:flex; justify-content:center; align-items:center; margin-left:auto; margin-right:auto; }
/* Profile block (ana ekran) — guarantee order: name > stars > rank and center */
.student-info{ display:flex; flex-direction:column; align-items:center; text-align:center; }
#student-name{ text-align:center; }
#student-stars{ margin-top:6px; }
#student-rank{ margin-top:6px; }
/* Ranking table name cell */
.ranking-table .player-name-column .rank-label{ margin-top:6px; }
/* Phones: keep everything centered in a single column nicely */
@media (max-width: 520px){
  .ranking-table .player-name-column{ align-items:center; text-align:center; }
  .ranking-table td, .ranking-table th{ vertical-align:middle; }
  .star-frame{ min-width:56px; }
}
</style>
<style id="nova-store-title-top">
.profile-change-header{
  display:flex; flex-direction:column; align-items:center;
  gap:8px; padding:10px; background:rgba(255,255,255,.9); backdrop-filter:blur(6px);
  border-bottom:1px solid #eef2f7;
}
.store-title{
  margin:0; font-weight:900; font-size:clamp(16px,4vw,20px);
  padding:6px 12px; border-radius:12px;
  background:rgba(2,132,199,.08); border:1px solid rgba(2,132,199,.22);
  display:flex; align-items:center; gap:6px;
}
.store-controls{
  display:flex; align-items:center; justify-content:center;
  gap:10px; flex-wrap:wrap;
}
.current-diamonds{
  display:flex; align-items:center; gap:6px; padding:6px 10px; border-radius:10px;
  background:linear-gradient(180deg, rgba(14,165,233,.10), rgba(14,165,233,.05));
  border:1px solid rgba(14,165,233,.35);
}
.current-diamonds .diamond-amount{
  font-weight:900; background:linear-gradient(90deg,#0ea5e9,#3b82f6);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
#openExchangeButton{
  background:linear-gradient(135deg,#0ea5e9,#2563eb); color:#fff; border:none;
  border-radius:999px; padding:8px 14px; font-weight:800; cursor:pointer;
}
#profileCloseButton{
  background:rgba(239,68,68,.08); border:1px solid rgba(239,68,68,.28);
  border-radius:10px; padding:6px 10px; color:#b91c1c; font-weight:900; cursor:pointer;
}
</style>
<style id="nova-placement-fix">
/* Nova placement: keep surprise box away from profile image */
.student-photo { position: relative; z-index: 10 !important; }
@media (max-width: 480px) {
  #main-screen { position: relative !important; }
  .surprise-box { position: fixed !important; top: 10px !important; left: 10px !important; z-index: 50 !important; }
  .surprise-box img { width: 44px !important; height: 44px !important; }
  .surprise-box-counter{
  margin-top:3px;
  padding:2px 6px;
  background: rgba(0,0,0,.55);
  border: 2px solid rgba(255,255,255,.75);
  border-radius: 8px;
  color: #fff;
  font-weight: 800;
  font-size: .78rem;
  line-height: 1.1;
  text-align: center;
  text-shadow: 0 1px 2px rgba(0,0,0,.6);
  max-width: 48px;        /* kutu görseli ile orantılı olsun */
  width: max-content;     /* metne göre ölçülensin */
  white-space: normal;    /* taşarsa alt satıra geçsin */
  word-break: break-word;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  white-space: nowrap;
  min-width: 48px;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
}

}
</style>
<style id="nova-perf">
/* Performance guardrails */
@media (prefers-reduced-motion: reduce) {
  * { animation: none !important; transition: none !important; }
}
.find-duel-button, .single-player, .friends-button, .surprise-box { will-change: transform; }
/* Lighter shadows (global pass) */
</style>
<style>
.explanation-container{margin-top:12px;display:none;}
.explanation-card{background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
.explanation-title{font-weight:700;margin-bottom:8px;}
.next-question-button{margin-top:12px;padding:10px 14px;border:none;border-radius:10px;background:#2563eb;color:#fff;font-weight:600;cursor:pointer;}
.next-question-button:hover{opacity:.92;transform:translateY(-1px);}
.explanation-correct{margin-bottom:8px;}
</style>
<style>
/* === Nova: Ders Videosu Akışı (Single Player Result) === */
.lesson-video-button{
  display:inline-flex;align-items:center;gap:8px;
  background: linear-gradient(135deg,#4338ca,#4f46e5);
  color:#fff;border:none;border-radius:12px;padding:12px 18px;
  font-weight:800;letter-spacing:.2px;cursor:pointer;
  box-shadow:0 10px 24px rgba(79,70,229,.25);
  transition:transform .15s ease, box-shadow .2s ease, filter .2s ease;
}
.lesson-video-button:hover{transform:translateY(-1px);box-shadow:0 14px 30px rgba(79,70,229,.35);filter:brightness(1.05)}
.lesson-video-button:active{transform:translateY(0);box-shadow:none}

.lesson-video-screen{
  display:none;flex-direction:column;gap:16px;
  width:100%;max-width:1200px;margin:0 auto;
  background:#fff;border-radius:20px;padding:24px 28px;
  box-shadow:0 15px 35px rgba(0,0,0,.2);
}
.lesson-video-header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
.lesson-pill{
  background:#eef2ff;color:#3730a3;border:2px solid #3730a3;
  border-radius:999px;padding:6px 12px;font-weight:800;font-size:.95rem
}
.video-title{font-size:1.25rem;font-weight:900;color:#111;text-align:left}
.video-frame{width:100%;aspect-ratio:16/9;background:#000;border-radius:14px;overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.25)}
.video-frame iframe{width:100%;height:100%;border:0;display:block}

.lesson-video-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:6px}
.lesson-video-back{background:#111827;color:#fff;border:none;border-radius:10px;padding:10px 16px;cursor:pointer;font-weight:700}
.lesson-video-back:hover{filter:brightness(1.1)}

@media (max-width: 640px){
  .video-title{font-size:1.05rem}
  .lesson-video-button{width:100%;justify-content:center}
  .lesson-video-screen{padding:18px}
}
/* === End Nova === */
</style>
<style id="nova-profile-frame-override">
/* === Nova Override: 440x550 oranlı dikdörtgen (köşeleri yuvarlatılmış) çerçeve === */
/* Tüm görseller aynı oran ve stil: */
.student-photo,
.player-photo,
.friend-photo,
.duel-player-photo,
.duel-player-score img,
.ranking-player-photo,
.players-list img {
  border-radius: 12px !important;
  object-fit: cover !important;
  display: block;
  overflow: hidden;
  background: #fff;
}

/* Orana göre her ekrandaki boyutlar (genişlik sabit, yükseklik = genişlik * 1.25) */
.student-photo { width: 160px !important; height: 200px !important; }          /* 160 * 1.25 = 200 */
.player-photo { width: 50px !important; height: 62px !important; }
.friend-photo { width: 50px !important; height: 62px !important; }
.players-list img { width: 50px !important; height: 62px !important; }
.duel-player-photo { width: 80px !important; height: 100px !important; }
.duel-player-score img { width: 70px !important; height: 88px !important; }
.ranking-player-photo { width: 60px !important; height: 75px !important; }

/* İsteğe bağlı: ana/duel/ranking kutuları içinde taşmayı gizle */
.duel-player-score,
.players-list li {
  overflow: hidden;
}
</style>
<style id="nova-extra-frames">
/* === Nova Ek Düzenleme: Tüm ekranlarda aynı oran (440x550) === */

.player-photo,
.friend-photo,
.duel-player-photo,
.duel-player-score img,
.ranking-player-photo,
.players-list img {
  border-radius: 12px !important;
  object-fit: cover !important;
  display: block;
  overflow: hidden;
  background: #fff;
}

/* Boyutlar oranlı (genişlik * 1.25 = yükseklik) */
.player-photo,
.friend-photo,
.players-list img { width: 50px !important; height: 62px !important; }

.duel-player-photo { width: 80px !important; height: 100px !important; }

.duel-player-score img { width: 70px !important; height: 88px !important; }

.ranking-player-photo { width: 60px !important; height: 75px !important; }
</style>
<style id="nova-store-fix">
/* Mağaza kartlarındaki görsel oranını 440x550 (w:h=1:1.25) yap */
.profile-photo {
  width: 120px !important;
  height: 150px !important; /* 120 * 1.25 */
  border-radius: 12px !important;
  object-fit: cover !important;
}
/* Güvenlik: grid içindeki tüm img'lere de uygula */
.profile-photos-container img {
  border-radius: 12px !important;
  object-fit: cover !important;
}
</style>
<style>
/* --- NOVA: EFSANE özel buton stili --- */
.category-button.legendary{
  position: relative;
  font-weight: 800;
  letter-spacing: .5px;
  border: 0;
  outline: 0;
  background: linear-gradient(180deg,#ff8a00 0%, #ff3d00 60%, #8b0000 100%);
  color: #fff;
  box-shadow: 0 6px 16px rgba(255,61,0,.35), inset 0 0 12px rgba(255,255,255,.15);
}
.category-button.legendary::before,
.category-button.legendary::after{
  content: '';
  position: absolute;
  left: -6px; right: -6px;
  height: 55%;
  top: -10px;
  background: radial-gradient(ellipse at bottom, rgba(255,200,0,.75), rgba(255,0,0,.0) 60%);
  filter: blur(6px);
  animation: flame-flicker 1.2s infinite ease-in-out alternate;
  pointer-events: none;
}
.category-button.legendary::after{
  top: auto; bottom: -12px;
  background: radial-gradient(ellipse at top, rgba(255,120,0,.6), rgba(255,0,0,0) 60%);
  height: 45%;
}
@keyframes flame-flicker{
  0%{ transform: translateY(0) scale(1); opacity:.9;}
  100%{ transform: translateY(-2px) scale(1.03); opacity:1;}
}
.category-button.legendary:hover{
  box-shadow: 0 10px 24px rgba(255,61,0,.55), inset 0 0 20px rgba(255,255,255,.25);
  transform: translateY(-1px);
}

</style>
<style>
/* --- NOVA: Store header responsive layout --- */
.profile-change-header{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; margin-bottom:10px;
}
.store-title{ margin:0; font-size:1.15rem; font-weight:800; letter-spacing:.2px; display:flex; align-items:center; gap:6px; }
.store-controls{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.current-diamonds{ display:flex; align-items:center; gap:6px; padding:6px 10px; border-radius:12px;
  background:rgba(255,255,255,.6); backdrop-filter: blur(4px); font-weight:700; }
#openExchangeButton{ padding:8px 12px; border-radius:10px; border:0; cursor:pointer;
  background:#2d6cdf; color:#fff; font-weight:700; }
#profileCloseButton{ padding:8px 10px; border-radius:10px; border:0; cursor:pointer;
  background:#f6465d; color:#fff; font-weight:800; }
@media(max-width:600px){
  .profile-change-header{ flex-direction:column; align-items:stretch; gap:8px; }
  .store-controls{ justify-content:space-between; }
  .store-title{ font-size:1.05rem; justify-content:center; }
}
</style>
<style>
/* === NOVA v7: Store header layout update === */
.profile-change-content{ position:relative; }

.profile-change-header{
  display:grid;
  grid-template-columns: 1fr;
  row-gap: 10px;
  align-items:center;
  justify-items:center;
  margin-bottom: 12px;
  padding-top: 8px;
}

.store-title{
  margin:0;
  text-align:center;
  font-weight:800;
  letter-spacing:.3px;
  display:flex; align-items:center; gap:8px; justify-content:center;
  font-size: clamp(20px, 2.6vw, 32px);
}

.store-controls{
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 12px;
  flex-wrap: wrap;
}

.current-diamonds{
  display:flex; align-items:center; gap:8px;
  padding: 8px 12px;
  border-radius: 14px;
  background: rgba(255,255,255,.65);
  backdrop-filter: blur(6px);
  font-weight: 800;
  font-size: clamp(14px, 1.6vw, 16px);
}

#openExchangeButton{
  padding: 10px 14px;
  border-radius: 12px; border:0; cursor:pointer;
  background:#2d6cdf; color:#fff; font-weight:800;
  font-size: clamp(13px, 1.4vw, 15px);
  box-shadow: 0 4px 12px rgba(45,108,223,.28);
}

#profileCloseButton{
  position:absolute; top:12px; right:12px;
  width: clamp(32px, 4vw, 40px); height: clamp(32px, 4vw, 40px);
  display:flex; align-items:center; justify-content:center;
  border-radius: 12px; border:0; cursor:pointer; z-index:5;
  background:#f6465d; color:#fff; font-weight:900; font-size: clamp(14px, 2vw, 18px);
  box-shadow: 0 6px 14px rgba(246,70,93,.35);
}

@media (min-width: 920px){
  .profile-change-header{ row-gap: 12px; }
  .store-controls{ gap: 14px; }
}

/* keep category bar spacing consistent after new header */
.profile-categories{ margin-top: 8px; }
</style>
<style id="nova-storebar-fix-20251002">
/* === Nova Single-Row Store Header Fix (2025-10-02) === */
.profile-change-header{
  display:flex !important;
  align-items:center !important;
  justify-content:space-between !important;
  gap:clamp(6px,1.5vw,14px) !important;
  flex-wrap:nowrap !important;
}
.store-title{
  flex:1 1 auto !important;
  min-width:0 !important;
  overflow:hidden !important;
  text-overflow:ellipsis !important;
  white-space:nowrap !important;
  font-size:clamp(16px,4vw,22px) !important;
  line-height:1.1 !important;
  margin:0 !important;
}
.store-controls{
  display:flex !important;
  align-items:center !important;
  justify-content:flex-end !important;
  gap:clamp(6px,1.2vw,12px) !important;
  flex-wrap:nowrap !important;
  overflow:hidden !important;
}
.store-controls > *{
  flex:0 1 auto !important;
  min-width:0 !important;
}
.current-diamonds{
  margin:0 !important;
  padding:clamp(6px,1.2vw,10px) clamp(10px,2vw,14px) !important;
  gap:clamp(6px,1.2vw,10px) !important;
}
.current-diamonds .diamond-icon,
.store-title .cart-icon{
  font-size:clamp(14px,4vw,18px) !important;
  line-height:1 !important;
}
#openExchangeButton{
  white-space:nowrap !important;
  font-size:clamp(12px,3.4vw,14px) !important;
  padding:clamp(6px,1.2vw,8px) clamp(10px,2vw,14px) !important;
}
#profileCloseButton{
  white-space:nowrap !important;
  font-size:clamp(14px,4vw,18px) !important;
  padding:clamp(6px,1.2vw,8px) clamp(8px,2vw,10px) !important;
  line-height:1 !important;
}
/* Ensure icons/buttons never overlap */
#openExchangeButton, #profileCloseButton, .current-diamonds{ max-width:100%; }
@media (max-width: 400px){
  /* On very small screens, slightly tighten paddings to keep single row */
  #openExchangeButton{ padding:4px 10px !important; }
  .current-diamonds{ padding:4px 10px !important; }
}
</style>
<style>
/* === Nova Responsive Patch v1.1 (compact mobile typography) === */
:root{
  --q-max-w: min(98vw, 980px);
  --q-min-h: min(56vh, 480px);
  --qpad: clamp(6px, 1.6vw, 14px);
  --q-font: clamp(14px, 1.8vw, 19px);
  --opt-font: clamp(13px, 1.7vw, 18px);
  --timer-font: clamp(12px, 1.8vw, 18px);
}
.question-text{
  font-size: var(--q-font) !important;
  line-height: 1.22 !important;
  margin: 2px 0 !important;
}
.options-container{
  gap: clamp(6px, 1.2vw, 12px) !important;
  max-width: var(--q-max-w) !important;
}
.option-button{
  font-size: var(--opt-font) !important;
  padding: clamp(8px, 1.6vw, 14px) clamp(10px, 1.8vw, 16px) !important;
  min-width: clamp(120px, 38vw, 340px) !important;
}
.timer{ font-size: var(--timer-font) !important; }
@supports (text-wrap: balance){
  .question-text{ text-wrap: balance; }
}
@media (max-width: 480px){
  .option-button{ flex: 1 1 100% !important; min-width: 0 !important; }
  .question-image{ max-height: 40vh !important; }
}
@media (max-width: 360px){
  .question-text{ font-size: clamp(13px, 4.6vw, 16px) !important; line-height: 1.18 !important; }
}
/* === End Patch v1.1 === */
</style>
<style>

/* ==== NOVA PREMIUM v3 ==== */
#premium-summary{display:none;flex-direction:column;gap:16px;width:100%;max-width:960px;margin:0 auto}
#premium-summary .metric-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
#premium-summary .metric{background:#ffffff;border:2px solid #e5e7eb;border-radius:14px;padding:12px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.06)}
#premium-summary .metric .label{font-size:.9rem;color:#6b7280;font-weight:700}
#premium-summary .metric .value{font-size:1.6rem;font-weight:900;color:#111827}

#premium-summary .viz{display:flex;align-items:center;justify-content:center;gap:18px;flex-wrap:wrap}
#premium-summary .gauge{width:140px;height:140px;position:relative}
#premium-summary .gauge svg{width:140px;height:140px;display:block}
#premium-summary .gauge .pct{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1.4rem;color:#111827}

#premium-summary .badge{min-width:150px;padding:12px 14px;border-radius:12px;border:2px dashed #e5e7eb;background:#f9fafb;text-align:center}
#premium-summary .badge .badge-title{font-size:.85rem;color:#6b7280;font-weight:800;margin-bottom:4px}
#premium-summary .badge .badge-value{font-size:1.2rem;font-weight:900;letter-spacing:.5px}

#premium-summary .actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:4px}
#premium-summary .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;transition:transform .15s ease,box-shadow .2s ease}
#premium-summary .btn:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,0,0,.12)}
#premium-summary .btn-primary{background:#111827;color:#fff}
#premium-summary .btn-accent{background:#2563eb;color:#fff}
#premium-summary .btn-outline{background:#fff;border:2px solid #e5e7eb;color:#111827}

#premium-summary .wrong-block{background:#fff;border:2px solid #e5e7eb;border-radius:14px;padding:12px}
#premium-summary .wrong-block h4{margin:0 0 8px 0;font-size:1rem;color:#111827}
#premium-summary .wrong-list{display:grid;grid-template-columns:1fr;gap:18px}
#premium-summary .wrong-card{border:2px solid #e5e7eb;border-radius:14px;padding:14px 16px;background:#ffffff;box-shadow:0 6px 14px rgba(0,0,0,.06)}
#premium-summary .wrong-card .q{display:flex;align-items:center;gap:8px;font-weight:900;color:#0f172a;margin-bottom:10px;font-size:1.05rem}
#premium-summary .wrong-card .qid{flex:0 0 auto;width:28px;height:28px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:900;color:#fff;background:#111827;box-shadow:0 3px 8px rgba(0,0,0,.15)}
#premium-summary .wrong-card .divider{height:1px;background:#e5e7eb;margin:8px 0 10px 0;border-radius:1px}
#premium-summary .wrong-card .row{font-size:.95rem;line-height:1.35;margin-top:6px;display:block}
#premium-summary .wrong-card .k{font-weight:800;color:#6b7280;margin-right:6px;min-width:120px;display:inline-block}

/* Modal */
#premium-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:999999}
#premium-modal .box{background:#fff;width:clamp(320px,92vw,960px);max-height:85vh;overflow:auto;border-radius:16px;padding:16px;box-shadow:0 20px 50px rgba(0,0,0,.35)}
#premium-modal .box h3{margin:0 0 12px 0}
#premium-modal .box .close{float:right;border:none;background:#111827;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
#premium-modal .wrong-card{border:2px solid #e5e7eb;border-radius:14px;padding:14px 16px;background:#ffffff;box-shadow:0 6px 14px rgba(0,0,0,.06); margin-bottom:14px}
#premium-modal .wrong-card .q{display:flex;align-items:center;gap:8px;font-weight:900;color:#0f172a;margin-bottom:10px;font-size:1.05rem}
#premium-modal .wrong-card .qid{flex:0 0 auto;width:28px;height:28px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:900;color:#fff;background:#111827;box-shadow:0 3px 8px rgba(0,0,0,.15)}
#premium-modal .wrong-card .divider{height:1px;background:#e5e7eb;margin:8px 0 10px 0;border-radius:1px}
#premium-modal .wrong-card .row{font-size:.95rem;line-height:1.35;margin-top:6px;display:block}
#premium-modal .wrong-card .k{font-weight:800;color:#6b7280;margin-right:6px;min-width:120px;display:inline-block}

@media (max-width:640px){
  #premium-summary .metric-grid{grid-template-columns:1fr}
  #premium-summary .gauge{width:120px;height:120px}
  #premium-summary .gauge svg{width:120px;height:120px}
}
@media print{ #premium-summary .actions{display:none!important} }

/* Premium "Ders Videosu" görünümü */
#premium-summary .actions #act-lesson{
  background:linear-gradient(135deg,#2563eb,#7c3aed);
  color:#fff;border:none;box-shadow:0 10px 22px rgba(37,99,235,.35);
  position:relative;padding-left:40px;font-weight:900;letter-spacing:.3px
}
#premium-summary .actions #act-lesson::before{
  content:'▶'; position:absolute;left:14px;top:50%;transform:translateY(-50%);
  font-weight:900;font-size:1rem;line-height:1
}
#premium-summary .actions #act-lesson:hover{ transform:translateY(-1px) scale(1.01); box-shadow:0 16px 30px rgba(124,58,237,.35) }

</style>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&amp;family=Inter:wght@400;600;700;800&amp;display=swap" rel="stylesheet"/><style id="nova-kids-login-styles">
/* === NOVA KIDS LOGIN (scoped to #student-selection-screen.nova-kids-login) === */
#student-selection-screen.nova-kids-login{
  --bg1:#f0f7ff;
  --bg2:#fff7f0;
  --panel:#ffffff;
  --primary:#5b8cff;
  --secondary:#ff7ac6;
  --accent:#ffcf5a;
  --ok:#22c55e;
  --err:#ef4444;
  --ink:#0f172a;
  --muted:#64748b;
  --radius:20px;
  --shadow: 0 14px 38px rgba(18, 24, 40, .12);
  font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
  color: var(--ink);
  max-width: 1100px;
  margin: 0 auto;
  padding: clamp(12px, 3vw, 24px);
  position: relative;
  isolation: isolate;
}

/* playful background */
#student-selection-screen.nova-kids-login::before{
  content:"";
  position:absolute; inset:0; z-index:-1;
  background:
    radial-gradient(700px 300px at 10% -10%, rgba(91,140,255,.15), transparent 60%),
    radial-gradient(600px 300px at 110% 110%, rgba(255,122,198,.12), transparent 60%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
}

/* layout */
#student-selection-screen.nova-kids-login .grid{
  display:grid;
  grid-template-columns: 1.1fr 1fr;
  gap: clamp(14px, 2.5vw, 28px);
  align-items: stretch;
}
@media (max-width: 900px){
  #student-selection-screen.nova-kids-login .grid{ grid-template-columns: 1fr }
}

/* left: hero */
#student-selection-screen.nova-kids-login .hero{
  background: var(--panel);
  border-radius: var(--radius);
  padding: clamp(16px, 3vw, 28px);
  box-shadow: var(--shadow);
  position:relative; overflow:hidden;
}
#student-selection-screen.nova-kids-login .badge{
  display:inline-flex; align-items:center; gap:10px;
  background: #eef2ff; color:#334155; border:1px solid #e2e8f0;
  padding:8px 12px; border-radius:999px; font-weight:800; letter-spacing:.2px;
}
#student-selection-screen.nova-kids-login h1{
  font-family:"Baloo 2", cursive;
  font-size: clamp(28px, 4vw, 44px);
  line-height:1.1; margin:16px 0 8px; color:#0b1220;
}
#student-selection-screen.nova-kids-login .lead{ color:var(--muted); margin:0 0 10px }
#student-selection-screen.nova-kids-login .stickers{
  display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;
}
#student-selection-screen.nova-kids-login .sticker{
  display:flex; align-items:center; gap:8px; background:#fff7ed; border:1px solid #ffe0b2; color:#7c4a03;
  padding:10px 12px; border-radius:14px; font-weight:700;
}

/* simple mascot (SVG) */
#student-selection-screen.nova-kids-login .mascot{
  position:absolute; right:-20px; bottom:-10px; width:180px; height:180px; opacity:.25;
}
@media (max-width: 520px){
  #student-selection-screen.nova-kids-login .mascot{ display:none }
}

/* right: form card */
#student-selection-screen.nova-kids-login .card{
  background: var(--panel);
  border-radius: var(--radius);
  padding: clamp(16px, 3vw, 24px);
  box-shadow: var(--shadow);
  display:flex; flex-direction:column; gap:12px;
}
#student-selection-screen.nova-kids-login .toprow{
  display:flex; align-items:center; justify-content:space-between;
}
#student-selection-screen.nova-kids-login .brand{
  display:flex; align-items:center; gap:10px; font-weight:900;
  letter-spacing:.2px; color:#0b1220;
}
#student-selection-screen.nova-kids-login .brand .dot{
  width:12px; height:12px; border-radius:50%;
  background: radial-gradient(circle at 30% 30%, var(--accent), var(--secondary));
}
#student-selection-screen.nova-kids-login .register-link{
  background:none; border:0; font-weight:800; color:var(--primary); cursor:pointer;
}
#student-selection-screen.nova-kids-login .register-link:hover{ text-decoration:underline }

#student-selection-screen.nova-kids-login .subtitle{
  color:var(--muted); margin:0 0 6px; font-size:14px;
}

#student-selection-screen.nova-kids-login form{ display:grid; gap:12px }

#student-selection-screen.nova-kids-login .field{
  display:flex; align-items:center; gap:10px; background:#f8fafc; border:2px solid #e2e8f0; border-radius:14px;
  padding:12px 14px; transition: border-color .15s, box-shadow .15s, transform .12s;
}
#student-selection-screen.nova-kids-login .field:focus-within{
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(91,140,255,.18);
  transform: translateY(-1px);
}
#student-selection-screen.nova-kids-login .ico{ font-size:20px }
#student-selection-screen.nova-kids-login .field input,
#student-selection-screen.nova-kids-login .field select{
  appearance:none; border:0; outline:0; background:transparent; width:100%; color:#0b1220;
  font: inherit; font-size:16px;
}
#student-selection-screen.nova-kids-login .eye{ cursor:pointer; padding:6px 8px; border-radius:10px }
#student-selection-screen.nova-kids-login .eye:hover{ background:#eef2ff }

#student-selection-screen.nova-kids-login .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px }
@media (max-width: 560px){
  #student-selection-screen.nova-kids-login .row{ grid-template-columns: 1fr }
}

#student-selection-screen.nova-kids-login .actions{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  flex-wrap:wrap;
}
#student-selection-screen.nova-kids-login .muted{ color:var(--muted); font-size:13px }
#student-selection-screen.nova-kids-login .link{ background:none; border:0; color:var(--primary); font-weight:800; cursor:pointer }
#student-selection-screen.nova-kids-login .link:hover{ text-decoration:underline }

#student-selection-screen.nova-kids-login .cta{
  width:100%; border:0; border-radius:14px; padding:16px; font-weight:900;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  color:#fff; letter-spacing:.3px; box-shadow: 0 10px 28px rgba(91,140,255,.25);
  cursor:not-allowed; opacity:.7; transition: transform .15s, box-shadow .15s, opacity .15s;
}
#student-selection-screen.nova-kids-login .cta.active{ cursor:pointer; opacity:1 }
#student-selection-screen.nova-kids-login .cta.active:hover{ transform: translateY(-1px) }

#student-selection-screen.nova-kids-login .error{ color:var(--err); font-weight:800; min-height:22px }

#student-selection-screen.nova-kids-login .helper{
  display:flex; gap:10px; align-items:center; margin-top:2px; color:#0f5132;
  background:#d1fae5; border:1px solid #86efac; padding:10px 12px; border-radius:12px; font-weight:700;
}

/* accessibility & motion */
@media (prefers-reduced-motion: reduce){
  #student-selection-screen.nova-kids-login .field,
  #student-selection-screen.nova-kids-login .cta{ transition: none }
}

/* safe-area & small screens */
#student-selection-screen.nova-kids-login .card,
#student-selection-screen.nova-kids-login .hero{ margin: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) }

/* visually hidden labels */
#student-selection-screen.nova-kids-login .sr{
  position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0
}
</style>
<!-- === Nova: Result Screen Cleanup & Premium Summary (CSS v3) === -->
<style>
/* Hide legacy/duplicate parts so only Nova UI stays visible */
.wrong-block,
#wrong-list,
#act-review,
#act-lesson,
#act-print,
#premium-modal,
#lesson-video-button { display:none !important; }

/* Nova UI styles (same base as before, minor tweaks) */
:root{
  --nz-border:rgba(148,163,184,.25);
}
#nova-summary{display:none;flex-direction:column;gap:18px;width:100%;max-width:980px;margin:0 auto;}
#nova-summary.nz-show{display:flex;}
.nz-row{display:flex;gap:14px;flex-wrap:wrap}
.nz-card{flex:1 1 200px;min-width:220px;background:#ffffff;border:2px solid var(--nz-border);border-radius:16px;padding:14px 16px;box-shadow:0 10px 24px rgba(2,6,23,.06)}
.nz-kpi{display:flex;align-items:center;justify-content:space-between}
.nz-kpi .label{font-weight:700;color:#111827;font-size:.95rem}
.nz-kpi .value{font-weight:900;font-size:1.4rem}
.nz-kpi .value.ok{color:#065f46}
.nz-kpi .value.warn{color:#92400e}
.nz-kpi .value.bad{color:#991b1b}
.nz-gauge{flex:2 1 280px;display:flex;align-items:center;justify-content:center;background:#ffffff;border:2px solid var(--nz-border);border-radius:16px;position:relative;min-height:170px}
.nz-gauge canvas{width:240px;height:240px;max-width:90%}
.nz-badge{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-weight:800;padding:6px 10px;border-radius:999px;border:2px solid #111827;background:#f8fafc;color:#111827}
.nz-wrong-list{display:grid;grid-template-columns:1fr;gap:12px}
.nz-item{background:#fff;border:2px solid var(--nz-border);border-left:8px solid #ef4444;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:6px}
.nz-q{font-weight:800;color:#111827}
.nz-pair{display:grid;grid-template-columns:120px 1fr;gap:10px;font-size:.95rem}
.nz-pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--nz-border);font-weight:700}
.nz-you{background:#fee2e2;color:#991b1b}
.nz-true{background:#dcfce7;color:#065f46}
.nz-exp{background:#f1f5f9;border:1px dashed var(--nz-border);padding:8px;border-radius:8px;color:#1f2937}
.nz-actions{display:flex;gap:10px;flex-wrap:wrap}
.nz-btn{border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;box-shadow:0 6px 16px rgba(2,6,23,.12);transition:transform .12s ease}
.nz-btn:hover{transform:translateY(-1px)}
.nz-primary{background:#111827;color:#fff}
.nz-secondary{background:#f8fafc;border:2px solid var(--nz-border);color:#111827}
#nova-modal{position:fixed;inset:0;background:rgba(2,6,23,.6);display:none;align-items:center;justify-content:center;z-index:999999}
#nova-modal .modal-card{width:min(1000px,96%);max-height:86vh;overflow:auto;background:#ffffff;border-radius:18px;border:2px solid var(--nz-border);padding:18px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.modal-title{font-weight:900;font-size:1.2rem;color:#111827}
.modal-close{border:none;background:#111827;color:#fff;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
.modal-list{display:flex;flex-direction:column;gap:12px}
@media (min-width:760px){
  .nz-wrong-list{grid-template-columns:1fr 1fr}
}
</style>
<style>
/* === NOVA FINAL: Single-Source End Screen (Responsive) === */
#score-container.nova-final-wrap{width:100%;max-width:1200px;margin:0 auto;padding:clamp(12px,2vw,24px);}
#score-container .nz-row{display:flex;flex-wrap:wrap;gap:14px}
#score-container .nz-card{flex:1 1 320px}
#score-container .actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:10px}
#score-container .btn{border-radius:12px;padding:12px 16px;font-weight:800;border:1px solid #e5e7eb}
#score-container #act-restart{background:linear-gradient(135deg,#8b5cf6,#6366f1);color:#fff;border:none;box-shadow:0 8px 22px rgba(99,102,241,.32)}
/* Remove any remaining duplicated progress/gauges outside our mount */
body > #nova-summary{display:none !important;}
</style><style>
/* NOVA SAFE PATCH: Only hide visuals; keep DOM for scripts */
#nova-end-root #nova-summary .nz-row:first-of-type { display:none !important; } /* KPI cards */
#nova-end-root .nz-gauge, 
#nova-end-root #nzBadge { 
  visibility:hidden !important; 
  height:0 !important; 
  margin:0 !important; 
  padding:0 !important; 
  border:0 !important; 
  overflow:hidden !important; 
}
#premium-summary, .metric-grid { display:none !important; } /* bottom premium block */
</style>
<style>
/* Nova: Kullanıcı talebiyle yanlış soru listesi sonuç ekranında gösterilmesin */
#nzWrongList { display: none !important; }
/* İlgili kart başlığı silindi; butonlar (Yanlışları Tekrar Et / Ders Videosu) korunuyor. */
</style>
<style>
/* === Nova: Sonuç Ekranı iyileştirmeleri === */

/* Global modern button look (keeps existing class names working) */
.nz-btn, .btn, .btn-outline, .btn-primary {
  --nz-bg: #0f172a;
  --nz-fg: #fff;
  --nz-ring: rgba(2,132,199,.35);
  --nz-shadow: rgba(0,0,0,.18);
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 12px 18px;
  border-radius: 14px;
  border: 1px solid rgba(0,0,0,.08);
  background: var(--nz-bg);
  color: var(--nz-fg);
  font-weight: 700;
  line-height: 1;
  cursor: pointer;
  transition: transform .18s ease, box-shadow .18s ease, background .18s ease, color .18s ease, border-color .18s ease;
  box-shadow: 0 8px 22px var(--nz-shadow);
  user-select: none;
}
.nz-btn:hover, .btn:hover, .btn-outline:hover, .btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 12px 28px var(--nz-shadow);
}
.nz-btn:active, .btn:active, .btn-outline:active, .btn-primary:active {
  transform: translateY(0);
  box-shadow: 0 6px 18px var(--nz-shadow);
}
/* Secondary look (for "Ders Videosu" gibi) */
.nz-secondary, .btn-outline {
  --nz-bg: #0b1220;
  --nz-fg: #f8fafc;
  border-color: rgba(255,255,255,.06);
}

/* Success / primary accent (ör: "Yanlışları Tekrar Et" butonu) */
.nz-primary, .btn-primary {
  --nz-bg: linear-gradient(135deg,#16a34a,#0ea5e9);
  --nz-fg: #fff;
  border: 0;
}

/* Icon pill */
.nz-btn .nz-ico, .btn .nz-ico { 
  width: 22px; height: 22px; display:inline-grid; place-items:center; 
  border-radius: 999px; background: rgba(255,255,255,.12);
}

/* Küçük ekran yerleşimi: butonları alt alta ve eşit genişlikte göster */
@media (max-width: 640px){
  .result-actions, .actions-row, .buttons-row, .nz-actions {
    display: grid !important;
    grid-template-columns: 1fr !important;
    gap: 10px !important;
  }
  .result-actions .nz-btn, .actions-row .nz-btn, .buttons-row .btn, .nz-actions .btn{
    width: 100% !important;
    justify-content: center !important;
  }
}

/* Sabit Geri Dön butonu */
#result-back-btn {
  position: fixed;
  top: 12px;
  left: 12px;
  z-index: 1000;
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,.08);
  background: rgba(15,23,42,.9);
  color: #fff;
  font-weight: 800;
  box-shadow: 0 10px 24px rgba(0,0,0,.25);
  display: none; /* sadece sonuç ekranında görünecek */
}
#result-back-btn .nz-ico {
  width: 18px; height: 18px; margin-right: 8px; display:inline-grid; place-items:center;
  border-radius: 999px; background: rgba(255,255,255,.12);
}
#result-back-btn:hover { transform: translateY(-1px); }
#result-back-btn:active { transform: translateY(0); }
</style>
<style>

/* === Nova Patch: Center actions row on result screen === */
.nz-actions, .result-actions, .buttons-row {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 12px !important;
  width: 100%;
  margin: 8px 0 4px 0;
}
/* Make the two buttons visually balanced */
.nz-actions .nz-btn, .result-actions .nz-btn {
  min-width: 180px;
  justify-content: center;
}
@media (max-width: 640px){
  .nz-actions, .result-actions, .buttons-row { flex-direction: column !important; }
  .nz-actions .nz-btn, .result-actions .nz-btn { width: 100%; }
}
/* Semi-transparent, but clear Back button for results screen */
#result-back-btn{
  position: fixed;
  top: 14px;
  left: 14px;
  z-index: 9999;
  padding: 10px 14px;
  border-radius: 12px;
  background: rgba(17, 24, 39, 0.65); /* slate-900 @ 65% */
  color: #fff;
  border: 1px solid rgba(255,255,255,0.2);
  box-shadow: 0 10px 24px rgba(0,0,0,0.25);
  font-weight: 700;
  backdrop-filter: blur(2px);
  display: none; /* only visible on result screen */
}
#result-back-btn .ico {
  display:inline-block;
  width: 18px; height: 18px;
  margin-right: 8px;
  border-radius: 999px;
  background: rgba(255,255,255,0.15);
  text-align:center; line-height:18px;
}
#result-back-btn:hover{ transform: translateY(-1px); }
#result-back-btn:active{ transform: translateY(0); }

</style>
<style>
/* === Nova v5b: Teacher Advice Card (robust) === */
.advice-card{
  margin-top:16px;
  background:#fff7ed;
  border:2px solid #fb923c;
  border-radius:14px;
  box-shadow:0 8px 20px rgba(251,146,60,.22);
  padding:12px 14px;
  text-align:center;
  gap:8px;
}
.advice-title{
  display:inline-block;
  font-weight:900;
  font-size:1.05rem;
  color:#9a3412;
  background:#ffedd5;
  border:2px dashed #fb923c;
  border-radius:999px;
  padding:4px 10px;
  letter-spacing:.2px;
  margin-bottom:8px;
}
.advice-text{
  margin-top:6px;
  font-size:1rem;
  line-height:1.45;
  color:#7c2d12;
  min-height:60px;
}
</style>

<!-- NOVA_DUEL_ENHANCEMENTS_START -->
<style>
/* === Nova Duel Enhancements v1.0 === */
/* Intro Overlay */
.duel-intro-overlay{
  position:fixed; inset:0; background:radial-gradient(120% 120% at 50% 50%, rgba(10,10,20,.96) 0%, rgba(10,10,20,.98) 60%, rgba(0,0,0,.98) 100%);
  display:none; align-items:center; justify-content:center; z-index:999999;
  overflow:hidden;
}
.duel-intro-stage{ position:relative; width:min(1100px,95vw); height:min(540px,70vh); border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.5); overflow:hidden; }
.duel-side{
  position:absolute; top:0; bottom:0; width:55%;
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px;
  padding:24px;
  transform:translateX(var(--tx,0)); opacity:0;
  animation: sideIn .6s ease forwards;
}
.duel-side.left{
  left:0; --tx:-40px;
  background:linear-gradient(135deg, rgba(99,102,241,.15), rgba(59,130,246,.05));
  border-right:1px solid rgba(255,255,255,.08);
}
.duel-side.right{
  right:0; --tx:40px;
  background:linear-gradient(225deg, rgba(244,63,94,.15), rgba(251,146,60,.05));
  border-left:1px solid rgba(255,255,255,.08);
}
@keyframes sideIn{ to{ transform:translateX(0); opacity:1; } }

.duel-intro-photo{
  width:min(120px,20vmin); height:min(120px,20vmin);
  border-radius:16px; object-fit:cover; border:4px solid rgba(255,255,255,.2);
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.duel-intro-name{
  font-size:clamp(18px,3.2vmin,28px); font-weight:900; letter-spacing:.5px;
  color:#fff; text-align:center; text-shadow:0 2px 10px rgba(0,0,0,.6);
  max-width:90%; word-break:break-word;
}

.duel-vs-wrap{
  position:absolute; inset:auto 0 24px 0; display:flex; align-items:center; justify-content:center; gap:18px;
}
.duel-vs-badge{
  font-weight:900; font-size:clamp(20px,3.2vmin,28px);
  color:#111; background:#f5f5f5; padding:8px 18px; border-radius:999px;
  box-shadow:0 8px 24px rgba(255,255,255,.15), inset 0 1px 0 rgba(255,255,255,.6);
  animation:pulseVS 1.2s ease-in-out infinite;
}
@keyframes pulseVS{ 0%,100%{ transform:scale(1) } 50%{ transform:scale(1.06) } }

/* Swords (SVG) */
.swords{
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) rotate(8deg);
  width:min(420px,70vmin); height:auto; opacity:0; filter:drop-shadow(0 18px 30px rgba(0,0,0,.6));
  animation:swordsIn .9s .25s ease forwards;
}
@keyframes swordsIn{ to{ opacity:1; transform:translate(-50%,-50%) rotate(0deg) } }

/* Countdown */
.duel-countdown{
  position:absolute; top:22px; left:50%; transform:translateX(-50%);
  font-size:clamp(26px,4vmin,34px); font-weight:900; color:#fff; letter-spacing:2px;
  text-shadow:0 3px 18px rgba(0,0,0,.7);
}
.count-num{ display:inline-block; min-width:1ch; animation:popNum .6s ease; }
@keyframes popNum{ 0%{ transform:scale(.6); opacity:.5 } 60%{ transform:scale(1.3); opacity:1 } 100%{ transform:scale(1) } }

/* Question Screen polish */
.question-container.duel-animate{ animation:qcIn .35s ease both; }
@keyframes qcIn{ from{ transform:scale(.98); opacity:.0; filter:saturate(.9) } to{ transform:scale(1); opacity:1; filter:saturate(1) } }

.option-button{ position:relative; overflow:hidden; }
.option-button .ring{
  position:absolute; inset:0; border:2px solid rgba(255,255,255,.15); border-radius:10px; pointer-events:none;
}
.option-button.correct{ box-shadow:0 10px 20px rgba(16,185,129,.35) }
.option-button.wrong{ box-shadow:0 10px 20px rgba(239,68,68,.35) }

/* Tap particles */
.tap-pop{ position:fixed; width:8px; height:8px; background:#fff; border-radius:50%; pointer-events:none; will-change:transform,opacity; }

/* Winner fireworks */
.confetti{
  position:fixed; top:-10px; width:8px; height:12px; opacity:0; transform:translateY(-20px);
  animation: fall var(--dur) linear forwards; z-index:999998;
}
@keyframes fall{
  to{ transform:translate(var(--tx), 100vh) rotate(var(--rot)); opacity:1 }
}

/* Top VS bar */
.duel-topbar{ display:none; position:sticky; top:0; z-index:99996; width:100%; max-width:900px; margin-bottom:8px }
.duel-topbar-inner{
  display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:12px; padding:8px 12px;
  background:linear-gradient(90deg, rgba(99,102,241,.15), rgba(244,63,94,.15));
  border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.15);
}
.duel-topbar .pname{ font-weight:800; color:#111; text-shadow:0 1px 0 rgba(255,255,255,.6); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.duel-topbar .vs{ font-weight:900 }
.duel-topbar .bar{ height:8px; background:#eee; border-radius:999px; overflow:hidden; }
.duel-topbar .fill{ height:100%; width:0%; transition:width .3s ease; }

/* Guard against overlap */
.duel-intro-overlay.dismissed{ display:none !important; }
</style>
<!-- NOVA_DUEL_ENHANCEMENTS_END -->


<!-- NOVA: Duel Screen Lighten + Orb Removal (scoped) -->
<style id="nova-duel-lighten-overrides">
  /* Only affect the duel question screen container */
  .duel-game-container {
    position: relative;
    isolation: isolate;
    /* lighter, friendlier arena gradient */
    background: radial-gradient(1200px 620px at 50% 120%, #112241 0%, #152a51 40%, #13264a 70%, #10213f 100%) !important;
    overflow: hidden;
  }
  /* Keep subtle stars/sweep very soft if any applied */
  .duel-game-container.nova-duel-arena::before { opacity: .28 !important; filter: drop-shadow(0 0 1px rgba(160,200,255,.2)) !important; }
  .duel-game-container.nova-duel-arena::after  { opacity: .18 !important; }
  /* Hide decorative orbs/planets on this screen completely */
  .duel-game-container .nova-orbs,
  .duel-game-container .nova-orb,
  .duel-game-container .nova-force-behind,
  .duel-game-container [class*="orb" i],
  .duel-game-container [class*="planet" i],
  .duel-game-container [class*="gezegen" i] { display: none !important; opacity: 0 !important; visibility: hidden !important; }
  /* Ensure question & options stay crisp on the lighter theme */
  .duel-game-container .question-container {
    background: #fffdf7 !important;
    border-color: #ffd18a !important;
    color: #1b2a3f !important;
    box-shadow: 0 6px 18px rgba(0,0,0,.12);
  }
  .duel-game-container .question-text { color: #0f213f !important; }
  .duel-game-container .option-button {
    background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(245,247,252,.95)) !important;
    color: #0f213f !important;
    border: 1px solid rgba(20,40,80,.15) !important;
    box-shadow: 0 4px 10px rgba(0,0,0,.08), 0 0 0 2px rgba(0,0,0,0) inset !important;
  }
  .duel-game-container .option-button:hover {
    background: linear-gradient(180deg, rgba(255,255,255,1), rgba(245,247,252,1)) !important;
  }
</style>
<script id="nova-duel-lighten-script">
(function(){
  try {
    // Scope arena visuals only to the duel game container
    const duel = document.querySelector('.duel-game-container');
    if (duel) {
      duel.classList.add('nova-duel-arena');
      // Remove any existing decorative "orb/planet" elements that might sit above content
      document.querySelectorAll('.nova-orbs, .nova-orb, .nova-force-behind, [class*="orb" i], [class*="planet" i], [class*="gezegen" i]').forEach(el => {
        try { if (duel.contains(el)) el.remove(); } catch(_) {}
      });
      // Also defensively move any stray orb layers behind and hide them
      const stray = document.querySelectorAll('.nova-orbs, .nova-orb, .nova-force-behind');
      stray.forEach(el => { 
        try { el.style.zIndex = '0'; el.style.display = 'none'; el.style.opacity = '0'; } catch(_){}
      });
    }
  } catch(e) { /* no-op */ }
})();
</script>


<style id="nova-duel-hotfix-20251006-v3">
/* Scope strictly to the real duel screen id */
#duel-game-screen{
  position: relative;
  isolation: isolate;
  overflow: hidden;
}

/* Lighten the OUTER background only when duel screen is visible */
#duel-game-screen::before{
  content:"";
  position:absolute; inset:-12%;
  background:
    radial-gradient(1200px 600px at 50% 110%, rgba(0, 240, 255, .12), transparent 70%),
    radial-gradient(1100px 680px at 50% -10%, rgba(0, 180, 255, .10), transparent 75%);
  filter: blur(10px);
  mix-blend-mode: screen;
  pointer-events:none;
  z-index:0;
}

/* Keep actual UI above the ambient layer */
#duel-game-screen > *{ position:relative; z-index:2; }

/* NEON halo that spills out of the question container and "lights" the arena */
#duel-game-screen .question-container{
  position: relative;
  background: rgba(12, 26, 56, .88) !important;
  border: 2px solid rgba(0, 240, 255, .55) !important;
  border-radius: 14px !important;
  box-shadow:
    inset 0 0 22px rgba(0, 240, 255, .25),
    0 0 22px rgba(0, 180, 255, .25);
  color: #eaf6ff !important;
  backdrop-filter: blur(6px);
}
#duel-game-screen .question-container::before{
  content:"";
  position:absolute; inset:-26px;
  border-radius: 16px;
  background:
    radial-gradient(520px 200px at 50% 0%, rgba(0, 240, 255, .24), transparent 60%),
    radial-gradient(360px 260px at 0% 100%, rgba(0, 210, 255, .14), transparent 70%),
    radial-gradient(360px 260px at 100% 100%, rgba(0, 210, 255, .14), transparent 70%);
  filter: blur(14px);
  mix-blend-mode: screen;
  z-index:-1;
  pointer-events:none;
}
#duel-game-screen .question-container::after{
  content:"";
  position:absolute; left:6%; right:6%; top:-6px; height:8px;
  background: linear-gradient(90deg,
     rgba(0,255,200,0),
     rgba(0,255,200,.55),
     rgba(0,160,255,.65),
     rgba(0,255,200,.55),
     rgba(0,255,200,0));
  filter: blur(8px);
  border-radius: 10px;
  pointer-events:none;
  animation: novaAuroraEdge 6s ease-in-out infinite;
}
@keyframes novaAuroraEdge{
  0%,100%{ transform: translateX(-3%); opacity:.9; }
  50%{ transform: translateX(3%); opacity:1; }
}

/* Readability upgrades */
#duel-game-screen .question-text{ color:#eaf6ff !important; text-shadow: 0 1px 1px rgba(0,0,0,.35); }
#duel-game-screen .options-container .option-button,
#duel-game-screen .option-button{
  background: linear-gradient(180deg, rgba(26,38,70,.94), rgba(10,16,30,.96)) !important;
  border:1px solid rgba(0, 210, 255, .38) !important;
  color:#eaf6ff !important;
  box-shadow: 0 4px 12px rgba(0,0,0,.35), 0 0 12px rgba(0,200,255,.25) inset !important;
}

/* Progress bar alignment to lighter theme */
#duel-game-screen .progress-bar{ background: rgba(255,255,255,.10) !important; }
#duel-game-screen #duel-progress-bar-inner{ background: linear-gradient(90deg,#00f0ff,#00ffcc) !important; }

/* >>> REMOVE the planet balls on duel screen <<< */
.nova-planet,
#nova-planet-1,
#nova-planet-2{ display:none !important; opacity:0 !important; visibility:hidden !important; }
</style>

<style>
/* === NOVA VS HUD (MK-style) === */
.nova-vs-hud{
  width:100%; max-width:900px; margin:4px auto 8px auto;
  display:flex; align-items:center; justify-content:space-between; gap:14px;
  position:relative; z-index:50;
}
.nova-hud-side{ flex:1; display:flex; flex-direction:column; gap:6px; position:relative; }
.nova-hud-side.right{ align-items:flex-end; }
.nova-name{
  font-weight:900; letter-spacing:.4px; font-size:clamp(12px,2.1vmin,14px);
  color:#eaf6ff; text-transform:uppercase; text-shadow:0 2px 10px rgba(0,0,0,.55);
  opacity:.95;
}
.nova-hp{
  width:100%; height:18px; border-radius:999px; position:relative; overflow:hidden;
  background: linear-gradient(180deg, rgba(5,10,24,.85), rgba(12,20,40,.85));
  box-shadow: inset 0 0 0 1px rgba(96,200,255,.18), inset 0 0 18px rgba(0,200,255,.18),
              0 8px 20px rgba(0,0,0,.35);
}
.nova-hp.mirror{ transform: scaleX(-1); }
.nova-hp-fill{
  position:absolute; left:0; top:0; height:100%; width:50%;
  background: linear-gradient(90deg, #24ffb5, #00d8ff, #6aa7ff);
  box-shadow: 0 0 18px rgba(0,230,255,.35), 0 0 30px rgba(0,255,230,.25);
  transition: width .7s cubic-bezier(.2,.8,.2,1);
}
.nova-hp-gloss{ pointer-events:none; position:absolute; inset:0;
  background: radial-gradient(80% 220% at 50% -120%, rgba(255,255,255,.45), transparent 60%);
  mix-blend-mode:screen; opacity:.35;
}
.nova-hp-count{
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  font-weight:900; font-size:clamp(10px,1.8vmin,13px);
  color:#0c162e; background:rgba(234,246,255,.9); padding:1px 8px; border-radius:999px;
  box-shadow:0 2px 8px rgba(0,0,0,.25);
}
.nova-hp.mirror .nova-hp-count{ transform:translate(-50%,-50%) scaleX(-1); }
.nova-center-badge{
  min-width:52px; height:28px; padding:0 10px;
  display:flex; align-items:center; justify-content:center;
  font-weight:900; color:#0c162e; letter-spacing:1px;
  background: linear-gradient(180deg, #eaf6ff, #bfe6ff);
  border-radius:8px; box-shadow:0 10px 25px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.6);
  text-shadow:none; user-select:none;
}
/* FX */
.nova-hit{ animation: novaHit .75s ease; }
@keyframes novaHit{
  0%{ filter: drop-shadow(0 0 0 rgba(255,0,80,0)); }
  30%{ filter: drop-shadow(0 0 18px rgba(255,60,120,.85)); }
  100%{ filter: drop-shadow(0 0 0 rgba(255,0,80,0)); }
}
.nova-boost{ animation: novaBoost .75s ease; }
@keyframes novaBoost{
  0%{ box-shadow: 0 0 18px rgba(0,230,255,.25), 0 0 40px rgba(0,255,230,.15) }
  50%{ box-shadow: 0 0 30px rgba(0,255,255,.65), 0 0 75px rgba(0,255,200,.45) }
  100%{ box-shadow: 0 0 18px rgba(0,230,255,.25), 0 0 40px rgba(0,255,230,.15) }
}
/* Sadece soru ekranında: üstteki topbarı ve alttaki oyuncu kartlarını gizle */
#duel-game-screen .duel-topbar{ display:none !important; }
#duel-game-screen .players-info-row{ display:none !important; }
/* === /NOVA VS HUD === */
</style>
<style id="nova-matchmaking-skin">
/* === NOVA: Matchmaking (Düello Ara) Skin — lightweight, GPU-friendly === */
.matchmaking-screen.nova-duel-arena{
  position:fixed; inset:0; display:none; /* shown via JS */
  align-items:center; justify-content:center;
  padding: clamp(12px, 2vw, 24px);
  z-index: 100000; /* above everything */
  /* background comes from .nova-duel-arena */
}
.matchmaking-screen.nova-duel-arena .matchmaking-content{
  position:relative; z-index:8;
  width:min(920px, 96vw);
  border-radius: 18px;
  border:1.5px solid rgba(0,200,255,.35);
  background: rgba(8,18,40,.86);
  box-shadow: inset 0 0 24px rgba(0,200,255,.18), 0 10px 40px rgba(0,0,0,.45);
  backdrop-filter: blur(6px);
  padding: clamp(18px, 2.5vw, 28px);
  animation: novaMMCardIn .35s ease-out;
}
@keyframes novaMMCardIn{ from{ transform: translateY(10px); opacity:.0 } to{ transform:none; opacity:1 } }

/* Title */
.matchmaking-screen.nova-duel-arena .matchmaking-content h2{
  margin: 0 0 10px 0;
  font-weight: 900;
  letter-spacing:.5px;
  color:#e9f4ff;
  text-shadow: 0 0 12px rgba(0,200,255,.28);
}

/* Searching ring */
.searching-animation{
  width: 140px; height: 140px; margin: 10px auto 16px auto;
  border-radius: 50%;
  position: relative;
  background: conic-gradient(from 0deg, rgba(0,255,255,.0) 0% 60%, rgba(0,255,255,.6) 75%, rgba(255,0,255,.65) 95%, rgba(0,255,255,.0) 100%);
  -webkit-mask: radial-gradient(circle, transparent 62%, #000 64%);
  mask: radial-gradient(circle, transparent 62%, #000 64%);
  animation: novaSpin 1.8s linear infinite;
  filter: drop-shadow(0 0 8px rgba(0,255,255,.35));
}
.searching-animation::before{
  content:''; position:absolute; inset:18%;
  border-radius:50%;
  box-shadow: 0 0 14px rgba(0,255,200,.45), inset 0 0 18px rgba(0,255,200,.25);
  animation: novaPulse 2.4s ease-in-out infinite;
}
.searching-animation::after{
  content:''; position:absolute; left:50%; top:50%; width:12px; height:12px;
  transform: translate(-50%, -50%);
  border-radius:50%;
  background: radial-gradient(circle at 35% 35%, #fff, #9be6ff 50%, #00ffd9 70%, transparent 71%);
  box-shadow: 0 0 18px rgba(0,255,255,.65);
  animation: novaPing 1.8s ease-in-out infinite;
}
@keyframes novaSpin{ to{ transform: rotate(1turn) } }
@keyframes novaPulse{ 0%,100%{ opacity:.7; transform: scale(1)} 50%{ opacity:1; transform: scale(1.05)} }
@keyframes novaPing{ 0%,100%{ transform: translate(-50%,-50%) scale(.95)} 50%{ transform: translate(-50%,-50%) scale(1.05)} }

/* Available players list */
.available-players{
  margin-top: 10px;
  padding: 10px 12px;
  border-radius: 14px;
  background: rgba(12,24,48,.55);
  border:1px solid rgba(0,200,255,.18);
}
.available-players h3{
  margin: 0 0 8px 0;
  color:#a5c9ff;
  font-weight:800;
  text-shadow: 0 0 8px rgba(0,140,255,.25);
}
.players-list .player-item{
  background: rgba(16,30,64,.6) !important;
  border:1px solid rgba(0,200,255,.22) !important;
  color:#e9f4ff !important;
  transition: transform .2s ease, box-shadow .2s ease;
}
.players-list .player-item:hover{
  transform: translateY(-2px);
  box-shadow: 0 10px 24px rgba(0,0,0,.35), 0 0 18px rgba(0,200,255,.18) inset;
}

/* Cancel button */
.cancel-search-button{
  display:inline-flex; align-items:center; justify-content:center;
  gap:10px; 
  margin: 14px auto 2px auto; padding: 12px 22px;
  border-radius: 12px; cursor:pointer; border:1px solid rgba(255,80,95,.4);
  background: linear-gradient(180deg, rgba(55,10,18,.65), rgba(35,8,12,.75));
  color:#ffe9ec; font-weight:900; letter-spacing:.3px;
  box-shadow: 0 8px 18px rgba(0,0,0,.35), 0 0 16px rgba(255,80,95,.2) inset;
  transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
}
.cancel-search-button:hover{ transform: translateY(-1px); filter: brightness(1.05); box-shadow: 0 12px 26px rgba(0,0,0,.45), 0 0 20px rgba(255,80,95,.3) inset; }
.cancel-search-button:active{ transform:none; box-shadow: 0 6px 12px rgba(0,0,0,.25) }

/* Small banner style if used */
.selecting-student-banner{
  display:block; text-align:center; margin: 6px 0 10px 0; padding: 8px 12px;
  border-radius: 10px;
  background: rgba(12,24,48,.55);
  border:1px solid rgba(0,200,255,.22);
  color:#e9f4ff;
}

/* Count-down neon style (if visible on this screen) */
#duelCountdown{
  display:inline-flex; align-items:center; justify-content:center;
  width: 52px; height: 52px; margin: 0 auto 8px auto;
  font-weight: 900; font-size: 1.2rem; color:#001014;
  background: radial-gradient(circle at 50% 45%, #a6f7ff, #35e6d9 60%, #00a3ff 100%);
  border-radius: 50%;
  box-shadow: 0 0 8px rgba(0,255,255,.5), 0 0 22px rgba(0,180,255,.35);
}

/* Responsive tweaks */
@media (max-width:540px){
  .matchmaking-screen.nova-duel-arena .matchmaking-content{ padding: 16px }
  .available-players{ padding: 10px }
}
</style>


<style id="nova-duel-start-pack">
/* === NOVA Duel Start Pack (lightweight, responsive, non-breaking) === */
:root{
  --vs-cyan:#00f0ff; --vs-mint:#00ffcc; --vs-blue:#66a6ff;
  --vs-gold:#ffd700; --vs-amber:#ffb000;
}

/* Scope all effects to the duel-selection-container only */
.duel-selection-container{
  position:relative;
  overflow:hidden;
  isolation:isolate;
  background:
    radial-gradient(1200px 600px at 50% 120%, #0a1231 0%, #070e27 45%, #040a1a 75%, #020611 100%);
}

/* subtle starfield */
.duel-selection-container::before{
  content:''; position:absolute; inset:-12%;
  background:
    radial-gradient(2px 2px at 20% 30%, #d1e6ff 50%, transparent 51%) repeat,
    radial-gradient(1px 1px at 60% 70%, #9bc2ff 50%, transparent 51%) repeat,
    radial-gradient(1px 1px at 80% 20%, #ffffff 50%, transparent 51%) repeat;
  background-size: 300px 300px, 240px 240px, 180px 180px;
  animation: novaStarFloat 52s linear infinite;
  opacity:.7; z-index:0; pointer-events:none;
  filter: drop-shadow(0 0 2px rgba(160,200,255,.4));
}

/* slow rotating aurora sweep */
.duel-selection-container::after{
  content:''; position:absolute; inset:-10%;
  background: conic-gradient(from 0deg at 50% -10%, rgba(0,255,255,.06), transparent 20%, rgba(255,0,255,.06) 40%, transparent 60%, rgba(0,255,255,.06) 80%, transparent);
  filter: blur(10px);
  animation: novaSweepSlow 18s linear infinite;
  z-index:1; pointer-events:none;
}

/* Central VS badge (created via JS) */
.nova-vs-badge{
  position:absolute; left:50%; top:50%;
  transform: translate(-50%, -50%);
  width:clamp(72px, 10vw, 140px); height:clamp(72px, 10vw, 140px);
  border-radius:50%;
  display:grid; place-items:center;
  background: radial-gradient(circle at 50% 40%, rgba(0,240,255,.15), rgba(0,0,0,.4) 60%);
  box-shadow: 0 0 24px rgba(0,255,255,.35), inset 0 0 32px rgba(0,255,255,.2);
  z-index:5; pointer-events:none;
}
.nova-vs-badge::before{
  content:"VS"; font-weight:900; letter-spacing:.04em;
  font-size:clamp(22px, 5vw, 40px);
  background: linear-gradient(90deg, var(--vs-cyan), var(--vs-mint), var(--vs-blue));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  filter: drop-shadow(0 0 8px rgba(0,255,255,.65));
}
.nova-vs-badge::after{
  content:''; position:absolute; inset:-6px;
  border-radius:inherit;
  background:
    conic-gradient(from 0deg, rgba(0,255,200,.35), transparent 20%, rgba(0,255,255,.35) 40%, transparent 60%, rgba(0,255,200,.35) 80%, transparent);
  filter: blur(4px);
  animation: novaRingSpin 6s linear infinite;
}

/* Player cards glow-up (without changing structure/classes) */
.duel-selection-container .duel-player-photo{
  box-shadow: 0 0 0 3px rgba(0,230,255,.25), 0 8px 18px rgba(0,0,0,.35);
  transition: transform .35s ease, box-shadow .35s ease, filter .35s ease;
  will-change: transform, filter;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.15), transparent 60%);
}
.duel-selection-container .duel-player-photo:hover{
  transform: translateY(-6px) scale(1.03) rotateZ(-1deg);
  filter: brightness(1.08);
  box-shadow: 0 0 0 3px rgba(0,230,255,.55), 0 14px 28px rgba(0,0,0,.45);
}

/* Player name readability + theme match */
.duel-selection-container .duel-player-name{
  font-weight:900;
  font-size: clamp(.9rem, 2.3vw, 1.15rem);
  background: linear-gradient(90deg, #eaf6ff, #cde8ff);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  text-shadow: 0 0 18px rgba(0,180,255,.35);
}

/* Start button: epic but lightweight */
.duel-selection-container .duel-start-button{
  background: linear-gradient(135deg, #1e90ff, #00e5ff);
  color:#001523;
  font-weight:900;
  letter-spacing:.6px;
  border: none;
  box-shadow: 0 8px 22px rgba(0, 200, 255, .35);
  transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
  position:relative; overflow:hidden;
}
.duel-selection-container .duel-start-button::after{
  content:''; position:absolute; inset:-40%; border-radius:50%;
  background: radial-gradient(circle, rgba(255,255,255,.35), transparent 60%);
  transform: scale(0.2); opacity:.0;
  transition: transform .4s ease, opacity .4s ease;
}
.duel-selection-container .duel-start-button:hover{
  transform: translateY(-2px);
  box-shadow: 0 12px 28px rgba(0, 200, 255, .45);
}
.duel-selection-container .duel-start-button:hover::after{
  transform: scale(1); opacity:.4;
}

/* Bottom info row spacing + subtle float */
.duel-selection-container .duel-bottom-info{
  gap:clamp(8px, 3vw, 24px);
  animation: novaFloat 8s ease-in-out infinite;
}

/* Decorative corner orbs (created once by JS) behind UI */
.nova-corner-orb{ position:absolute; width:clamp(28px,4.5vw,56px); height:clamp(28px,4.5vw,56px); border-radius:50%;
  background:
    radial-gradient(45% 45% at 30% 30%, rgba(255,255,255,.45), rgba(255,255,255,0) 60%),
    radial-gradient(75% 75% at 50% 50%, rgba(110,170,255,.38), rgba(24,60,130,.12) 74%, rgba(0,0,0,0) 76%);
  box-shadow: inset 0 0 18px rgba(120,180,255,.35), 0 6px 18px rgba(0,0,0,.35);
  pointer-events:none; z-index:2; opacity:.8;
  animation: novaOrbBreath 6s ease-in-out infinite;
  mix-blend-mode: screen;
}
.nova-corner-orb.a{ left:10px; top:10px; }
.nova-corner-orb.b{ right:10px; bottom:10px; }

/* Keyframes */
@keyframes novaStarFloat{ to{ transform: translateY(-220px);} }
@keyframes novaSweepSlow{ to{ transform: rotate(1turn);} }
@keyframes novaRingSpin{ to{ transform: rotate(1turn);} }
@keyframes novaFloat{
  0%,100%{ transform: translateY(0); }
  50%{ transform: translateY(-6px); }
}
@keyframes novaOrbBreath{ 0%,100%{ transform: scale(1);} 50%{ transform: scale(1.08);} }

/* Accessibility: respect reduced motion */
@media (prefers-reduced-motion: reduce){
  .duel-selection-container::before,
  .duel-selection-container::after,
  .duel-selection-container .duel-bottom-info,
  .nova-corner-orb,
  .nova-vs-badge::after { animation: none !important; }
}
</style>


    <!-- NOVA_RESULT_STYLES_START -->
    <style>
      /* Duel Result Overlay — lightweight, responsive, theme-aware */
      .nova-duel-result{ 
        width: min(980px, 92vw); 
        margin: 14px auto; 
        display: grid; 
        gap: 14px; 
        place-items: center; 
        position: relative;
      }
      .nova-result-card{
        width: 100%;
        border-radius: 20px;
        padding: clamp(14px, 3.5vw, 28px);
        background: linear-gradient(180deg, rgba(15,23,42,.75), rgba(2,6,23,.65));
        border: 1px solid rgba(148,163,184,.25);
        box-shadow: 0 20px 60px rgba(0,0,0,.35);
        position: relative;
        overflow: hidden;
        transform: translateZ(0);
      }
      .nova-result-card::before{
        content:"";
        position:absolute; inset:-2px;
        background: radial-gradient(800px 220px at 50% 0%, rgba(255,215,0,.10), transparent 40%);
        pointer-events:none;
      }
      .nova-hero{
        display:grid; place-items:center; gap:10px; text-align:center;
      }
      .nova-hero .crown{
        font-size: clamp(28px, 5vw, 56px);
        line-height: 1;
        animation: novaFloat 2.4s ease-in-out infinite;
        filter: drop-shadow(0 4px 12px rgba(250,204,21,.45));
      }
      .nova-hero .winner-name{
        font-weight: 800;
        font-size: clamp(22px, 4.8vw, 38px);
        letter-spacing:.5px;
        background: linear-gradient(90deg,#facc15,#fde68a,#facc15);
        -webkit-background-clip:text; background-clip:text; color:transparent;
        text-shadow: 0 0 22px rgba(250,204,21,.35);
      }
      .nova-hero .subtitle{
        font-size: clamp(13px, 3vw, 16px);
        color: #e5e7eb; opacity:.85;
      }
      .nova-scoreboard{
        display: grid; 
        grid-template-columns: 1fr auto 1fr; 
        gap: clamp(10px, 3vw, 18px);
        align-items: center; 
        margin-top: 8px;
      }
      .nova-player{
        background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
        border: 1px solid rgba(148,163,184,.25);
        border-radius: 16px;
        padding: clamp(8px, 2.4vw, 14px);
        display:grid; grid-template-columns: auto 1fr auto; gap:10px; align-items:center;
        min-width: 0;
      }
      .nova-player.loser{ 
        filter: grayscale(.15) opacity(.95); 
        box-shadow: inset 0 0 0 2px rgba(239,68,68,.35);
      }
      .nova-player.winner{ 
        box-shadow: inset 0 0 0 2px rgba(16,185,129,.45), 0 0 42px rgba(16,185,129,.18);
      }
      .nova-avatar{
        width: clamp(46px, 9vw, 72px); height: clamp(46px, 9vw, 72px);
        border-radius: 14px; object-fit: cover;
        border: 3px solid rgba(255,255,255,.35);
      }
      .nova-names{min-width:0}
      .nova-names .nm{
        color:#f8fafc; font-weight:700; font-size: clamp(14px, 3.2vw, 18px);
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      }
      .nova-names .rk{ color:#cbd5e1; font-size: clamp(12px, 2.6vw, 14px); opacity:.8 }
      .nova-score{
        font-weight:900; font-size: clamp(22px, 6vw, 36px);
        min-width: 2ch; text-align:right; color:#e5e7eb;
      }
      .nova-score.tie{ color:#93c5fd }
      .nova-vs{
        font-size: clamp(18px, 5vw, 28px);
        padding: .1rem .8rem; border-radius: 999px; 
        border: 1px solid rgba(148,163,184,.35);
        color:#e2e8f0; opacity:.9;
      }
      .nova-actions{
        margin-top: 12px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
      }
      .nova-btn{
        appearance:none; border:none; cursor:pointer;
        padding: .75rem 1.25rem; border-radius: 999px;
        font-weight: 800; letter-spacing:.3px;
        transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
        box-shadow: 0 6px 22px rgba(0,0,0,.25);
      }
      .nova-btn:active{ transform: translateY(1px) scale(.995); }
      .nova-btn.primary{ 
        background: linear-gradient(90deg, #22c55e, #16a34a);
        color: white;
      }
      .nova-btn.secondary{ 
        background: linear-gradient(90deg, #1f2937, #111827);
        color: #e5e7eb; border: 1px solid rgba(148,163,184,.35);
      }
      .duel-final-theme-tie .nova-hero .winner-name{ 
        background: linear-gradient(90deg,#60a5fa,#3b82f6,#60a5fa);
        -webkit-background-clip:text; background-clip:text; color:transparent;
        text-shadow: 0 0 22px rgba(59,130,246,.35);
      }

      @keyframes novaFloat{
        0%{ transform: translateY(0) } 
        50%{ transform: translateY(-6px) } 
        100%{ transform: translateY(0) }
      }
      @keyframes novaCount{
        from{ opacity:.6; transform: scale(.96) }
        to{ opacity:1; transform: scale(1) }
      }

      /* Ensure the final container stays above gameplay HUD */
      #duel-final-container{ z-index: 9990; }

      /* Mobile stack */
      @media (max-width: 640px){
        .nova-scoreboard{ grid-template-columns: 1fr; }
        .nova-vs{ display:none }
        .nova-result-card{ padding: 14px }
      }
    </style>
    <!-- NOVA_RESULT_STYLES_END -->
    

<style>
/* NOVA v5: reuse v4 visuals (name + rank pill + cup pill) */
#duel-intro-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 999999; font-family: 'Comfortaa', cursive; }
#duel-intro-overlay.show { display: flex; }
#duel-intro-overlay .nova-backdrop{ position:absolute; inset:0; background: radial-gradient(1400px 700px at 50% 120%, #061129 0%, #040a1a 40%, #020611 70%, #01030a 100%); overflow:hidden; isolation:isolate; }
#duel-intro-overlay .nova-stars::before,#duel-intro-overlay .nova-stars::after{ content:''; position:absolute; inset:-20%;
  background: radial-gradient(2px 2px at 20% 30%, #d1e6ff 50%, transparent 51%) repeat,
              radial-gradient(1px 1px at 60% 70%, #9bc2ff 50%, transparent 51%) repeat,
              radial-gradient(1px 1px at 80% 20%, #ffffff 50%, transparent 51%) repeat;
  background-size: 300px 300px, 250px 250px, 200px 200px; animation: novaStarDrift 50s linear infinite; opacity:.7; filter: drop-shadow(0 0 2px rgba(160,200,255,.4)); }
#duel-intro-overlay .nova-stars::after{ inset:-10%; background: conic-gradient(from 0deg at 50% -10%, rgba(0,255,255,.06), transparent 20%, rgba(255,0,255,.06) 40%, transparent 60%, rgba(0,255,255,.06) 80%, transparent); filter: blur(8px); animation: novaSweep 12s linear infinite; }
@keyframes novaStarDrift{ to { transform: translateY(-200px); } }
@keyframes novaSweep{ to { transform: rotate(1turn); } }
#duel-intro-overlay .arena{ position:relative; display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:clamp(12px,3vw,36px);
  padding:clamp(14px,3vw,40px); width:min(1200px,96vw); height:min(92vh,900px); border-radius:clamp(12px,2vw,24px);
  background:linear-gradient(180deg, rgba(8,18,40,.82), rgba(5,12,28,.88)); border:2px solid rgba(0,200,255,.35); box-shadow:0 0 24px rgba(0,200,255,.25), inset 0 0 24px rgba(0,200,255,.22); color:#e9f4ff; z-index:2; }
#duel-intro-overlay .player-card{ display:grid; grid-template-rows:auto auto auto; justify-items:center; gap:clamp(8px,1.6vw,16px); padding:clamp(8px,2vw,18px);
  border-radius:clamp(10px,1.4vw,18px); background:linear-gradient(180deg, rgba(28,40,72,.35), rgba(10,16,30,.35)); border:1px solid rgba(0,200,255,.25); width:100%; min-width:0; text-align:center; }
#duel-intro-overlay .player-photo{ width:clamp(86px,22vw,220px); height:clamp(86px,22vw,220px); border-radius:clamp(10px,1.4vw,16px); object-fit:cover; border:3px solid rgba(0,200,255,.45); box-shadow:0 6px 18px rgba(0,0,0,.35), 0 0 18px rgba(0,200,255,.25) inset; }
#duel-intro-overlay .player-name{ font-weight:900; font-size:clamp(14px,3.2vw,28px); line-height:1.15; text-shadow:0 0 10px rgba(0,200,255,.25); word-break:break-word; max-width:90%; color:#cfeaff; }
#duel-intro-overlay .player-meta{ display:flex; align-items:center; flex-wrap:wrap; gap:clamp(6px,1.2vw,12px); flex-wrap:wrap; justify-content:center; min-height: clamp(22px, 2.8vw, 28px); }
#duel-intro-overlay .rank-pill{ padding:3px 10px; border-radius:999px; font-weight:800; font-size:clamp(10px,2.2vw,14px); background:linear-gradient(180deg, rgba(14,110,95,.22), rgba(10,30,28,.5)); border:1px solid rgba(0,255,200,.35); color:#aef7da; letter-spacing:.2px; box-shadow:inset 0 0 10px rgba(0,255,200,.18); }
#duel-intro-overlay .rank-pill:empty{ display:none; }
#duel-intro-overlay .cup-pill{ display:inline-flex; align-items:center; gap:6px; padding:3px 10px; border-radius:10px; font-weight:800; font-size:clamp(10px,2.2vw,14px); color:#ffe7a8; background:linear-gradient(180deg, rgba(60,45,18,.35), rgba(25,20,10,.45)); border:1px solid rgba(255,204,0,.35); box-shadow: inset 0 0 10px rgba(255,200,0,.12); }
#duel-intro-overlay .cup-pill .cup-emoji{ display:inline-block; font-size:14px; line-height:1; filter: drop-shadow(0 0 4px rgba(255,200,0,.35)); }
#duel-intro-overlay .cup-pill[data-empty="1"]{ display:none; }
#duel-intro-overlay .vs{ display:grid; place-items:center; gap:clamp(12px,2vw,18px); }
#duel-intro-overlay .vs-badge{ font-weight:900; letter-spacing:2px; font-size:clamp(22px,6vw,64px); background:linear-gradient(90deg, #00f0ff, #00ffcc, #66a6ff, #00f0ff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; filter: drop-shadow(0 0 10px rgba(0,255,255,.65)) drop-shadow(0 0 25px rgba(0,180,255,.45)); animation: novaFlick 1.5s linear infinite; }
@keyframes novaFlick{ 0%,100%{opacity:.95} 50%{opacity:1; filter: drop-shadow(0 0 16px rgba(0,255,255,.9)) drop-shadow(0 0 34px rgba(0,180,255,.7)); } }
#duel-intro-overlay .ring-wrap{ position:relative; width:clamp(120px,22vw,240px); height:clamp(120px,22vw,240px); display:grid; place-items:center; }
#duel-intro-overlay .ring{ position:absolute; inset:0; border-radius:50%; background: conic-gradient(#00e1ff var(--pct, 0%), rgba(255,255,255,.1) 0); mask: radial-gradient(circle at center, transparent 60%, black 61%); -webkit-mask: radial-gradient(circle at center, transparent 60%, black 61%); box-shadow: 0 0 24px rgba(0,200,255,.2); }
#duel-intro-overlay .ring-center{ position:relative; z-index:1; display:grid; place-items:center; width:62%; height:62%; border-radius:50%; border:1px solid rgba(0,255,200,.35); background: rgba(10,20,36,.7); box-shadow: inset 0 0 18px rgba(0,200,255,.15); }
#duel-intro-overlay .countdown{ font-size:clamp(16px,3.6vw,40px); font-weight:900; }
#duel-intro-overlay .flash{ position:absolute; inset:0; pointer-events:none; background: radial-gradient(120% 60% at 50% 50%, rgba(255,255,255,.75), rgba(255,255,255,.25), rgba(255,255,255,0)); opacity:0; mix-blend-mode:screen; animation:novaFlash 900ms ease-out; }
@keyframes novaFlash{ 0%{opacity:1} 100%{opacity:0} }
[data-nova-hide]{ display:none !important; }
</style>
<style>

/* === NOVA: Wrong Review Öncül (Info) Styles === */
.nz-info { margin: 8px 0 6px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.nz-info-img {
  max-width: 180px; max-height: 130px; width: auto; height: auto;
  border-radius: 12px; border: 1.5px solid #e5e7eb;
  box-shadow: 0 6px 14px rgba(0,0,0,.12);
  background: #fff; padding: 6px; object-fit: contain;
}
.nz-info-text {
  background: #fff7ed; border: 1.5px dashed #f59e0b; color: #7c2d12;
  padding: 8px 10px; border-radius: 10px; font-size: .95rem; line-height: 1.35;
}
@media (max-width: 480px){
  .nz-info-img { max-width: 44vw; max-height: 28vh; }
}

</style>

<!-- NOVA: Duel Scale Toolbar Styles (safe) -->



<!-- NOVA: Duel Scale Styles v3 (apply transform directly to duel screen) -->
<style id="nova-duel-scale-styles">
  :root{ --duel-scale: 1; }
  /* Scale only when the duel screen is active & we add the class */
  #duel-game-screen.nova-scaled{
    transform: scale(var(--duel-scale));
    transform-origin: top center;
    will-change: transform;
  }
  #nova-duel-scale-toolbar{
    position: fixed;
    left: 50%; bottom: 10px;
    transform: translateX(-50%);
    z-index: 2147483000;
    width: min(92vw, 820px);
    padding: 10px 12px;
    border-radius: 16px;
    backdrop-filter: blur(10px);
    background: linear-gradient(135deg, rgba(18,25,48,.82), rgba(28,38,76,.82));
    box-shadow: 0 10px 28px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
    color: #cfe3ff;
    display: none;
    align-items: center;
    gap: 10px;
    pointer-events: auto;
  }
  #nova-duel-scale-toolbar .label{
    font: 600 12px/1.2 ui-sans-serif,system-ui,Segoe UI,Roboto;
    opacity: .9; letter-spacing:.3px; white-space: nowrap;
  }
  #nova-duel-scale-toolbar .pct{
    font: 700 12px/1.2 ui-sans-serif,system-ui,Segoe UI,Roboto;
    min-width: 46px; text-align: right;
  }
  #nova-duel-scale-toolbar .btn{
    appearance: none; border: none; border-radius: 10px;
    padding: 8px 10px; background: rgba(255,255,255,.08);
    color: #e7f0ff; cursor: pointer;
    font: 600 13px/1 ui-sans-serif,system-ui,Segoe UI,Roboto;
    transition: transform .08s ease, background .2s ease;
    user-select: none;
  }
  #nova-duel-scale-toolbar .btn:active{ transform: translateY(1px) scale(.98); }
  #nova-duel-scale-toolbar .btn:hover{ background: rgba(255,255,255,.12); }
  #nova-duel-scale-toolbar .btn.small{ padding: 6px 9px; border-radius: 8px; }
  #nova-duel-scale-toolbar input[type="range"]{
    -webkit-appearance: none; appearance: none;
    width: 100%; height: 6px;
    background: rgba(255,255,255,.18); border-radius: 999px; outline: none;
  }
  #nova-duel-scale-toolbar input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%;
    background: linear-gradient(180deg,#9fd1ff,#6aa6ff);
    box-shadow: 0 2px 6px rgba(0,0,0,.35); cursor: pointer;
    border: 1px solid rgba(255,255,255,.5);
  }
  #nova-duel-scale-toolbar .group{ display:flex; align-items:center; gap:8px; }
  #nova-duel-scale-toolbar .grow{ flex:1; }
  #nova-duel-scale-toolbar .sep{ width:1px; height:22px; background: rgba(255,255,255,.12); margin: 0 2px; }
  #nova-duel-scale-toolbar .badge{
    padding: 6px 10px; border-radius: 8px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.08);
  }
</style>

<style id="nova-image-center-css">

/* === NOVA: Center question images (single & duel) === */
#question-image, .question-image,
#duel-question-image, .duel-question-image,
.question-info-image {
  display: block !important;
  margin-left: auto !important;
  margin-right: auto !important;
  object-fit: contain !important;
  height: auto !important;
  width: auto !important;
}
/* Container text align center as a light hint (non-destructive) */
.question-container { text-align: center; }

</style>

<style id="nova-homework-above-photo">
/* Place existing ÖDEV button just above the profile photo on the main screen.
   Do NOT change its behavior; only its layout. */
#main-screen .homework-above-photo{
  display:flex;
  justify-content:center;
  align-items:center;
  margin: 6px 0 6px 0;
  width:100%;
}
#main-screen #homework_fab{
  position: static !important;
  inset: auto !important;
  margin: 0 auto !important;
}
</style>

</head>
<body data-nova-back='1'>

<style id="nova-duel-intro-column">
/* === Nova Duel Intro: vertical stack for meta (rank & cups under stars) === */
#duel-intro-overlay .player-meta{
  display:flex !important;
  flex-direction: column !important;   /* force vertical stacking */
  align-items: center !important;
  justify-content: flex-start !important;
  gap: 8px !important;
  flex-wrap: nowrap !important;        /* no horizontal packing */
  min-width: 0 !important;
}
#duel-intro-overlay .player-meta > .star-frame{
  order: 1;
  width: 100%;
  display:flex;
  flex-wrap: wrap;
  justify-content: center;
  max-width: 100%;
}
#duel-intro-overlay .player-meta > .rank-label{ order: 2; }
#duel-intro-overlay .player-meta > .cup-pill{ order: 3; }
</style>

<style id="nova-duel-intro-wrap">
/* === Nova Duel Intro Overflow Fix (wrap & clamp) === */
#duel-intro-overlay .player-card{ overflow: hidden; }
#duel-intro-overlay .player-meta{
  display:flex;
  flex-wrap: wrap;           /* allow second row for rank/cups when stars are many */
  justify-content: center;
  align-items: center;
  row-gap: 6px;
  column-gap: 8px;
  min-width: 0;              /* let flex children shrink inside */
}
#duel-intro-overlay .player-meta > .star-frame{
  flex: 1 1 100%;
  display:flex;
  flex-wrap: wrap;           /* wrap stars to next line */
  justify-content: center;
  max-width: 100%;
  box-sizing: border-box;
  overflow: hidden;          /* hard clamp any visual spill */
}
#duel-intro-overlay .player-meta > .rank-label,
#duel-intro-overlay .player-meta > .cup-pill{
  flex: 0 1 auto;
  max-width: 100%;
}
#duel-intro-overlay .star-badges .star{
  font-size: 14px;           /* a touch smaller inside intro overlay */
  line-height: 1;
}
</style>

<style id="nova-available-name-color">
/* Nova tweak: Available players name color (theme-friendly, readable) */
.matchmaking-screen.nova-duel-arena .players-list .player-name{
  color:#e9f4ff !important;
  text-shadow: 0 0 8px rgba(0,160,255,.22), 0 0 2px rgba(0,0,0,.35);
  font-weight: 800;
}
/* ensure the entire item uses light text on dark card */
.matchmaking-screen.nova-duel-arena .players-list .player-item{
  color:#e9f4ff !important;
}
/* also override any generic orange shadow on duel-name inside matchmaking */
.matchmaking-screen.nova-duel-arena .duel-player-name{
  color:#e9f4ff !important;
  text-shadow: 0 0 6px rgba(0,160,255,.18);
}
</style>
<button id="result-back-btn" aria-label="Geri Dön"><span class="ico">←</span>Geri Dön</button>

<!-- Oyundakiler Modal -->
<div class="players-overlay" id="playersOverlay">
<div class="players-content">
<div class="players-header">
<h3>Oyundakiler</h3>
<button class="players-close" id="playersCloseButton">✖</button>
</div>
<ul class="players-list" id="playersList"></ul>
</div>
</div>
<!-- Öğrenci Seçimi Ekranı -->
<div aria-labelledby="kidsLoginTitle" class="nova-kids-login" id="student-selection-screen" role="region">
<div class="grid">
<!-- Left: friendly hero -->
<section class="hero">
<span class="badge">🎒 Öğrenci Dostu • Hızlı Giriş</span>
<h1 id="kidsLoginTitle">Şampiyonlar Düellosu’na Hoş Geldin!</h1>
<p class="lead">Sınıfını seç, adını yaz, şifreni gir. Hemen oyuna başla! Hem telefonda hem bilgisayarda pırıl pırıl.</p>
<div aria-hidden="true" class="stickers">
<div class="sticker">🏆 Başarı Rozeti</div>
<div class="sticker" style="background:#ecfeff;border-color:#bae6fd;color:#0c4a6e">🧠 Zihin Egzersizi</div>
<div class="sticker" style="background:#f0fdf4;border-color:#bbf7d0;color:#065f46">⏱️ Hızlı Başlangıç</div>
</div>
<!-- simple SVG mascot -->
<svg aria-hidden="true" class="mascot" fill="none" viewbox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
<circle cx="60" cy="60" fill="#FFCF5A" opacity=".6" r="50"></circle>
<circle cx="45" cy="50" fill="#0b1220" r="6"></circle>
<circle cx="75" cy="50" fill="#0b1220" r="6"></circle>
<path d="M40 78 C 56 90, 64 90, 80 78" stroke="#0b1220" stroke-linecap="round" stroke-width="6"></path>
</svg>
</section>
<!-- Right: login card -->
<section aria-label="Giriş paneli" class="card">
<div class="toprow">
<div class="brand"><span class="dot"></span> <span>Şampiyonlar Düellosu</span></div>
<button aria-label="Kayıt Ol" class="register-link" id="register-button" type="button">Kayıt Ol</button>
</div>
<p class="subtitle">Sınıfını seç, kullanıcı adını ve şifreni gir.</p>
<form novalidate="">
<div class="field">
<span aria-hidden="true" class="ico">🏫</span>
<label class="sr" for="selection-class-select">Sınıf</label>
<select id="selection-class-select">
<option value="">Sınıfını Seç</option>
</select>
</div>
<div class="row">
<div class="field">
<span aria-hidden="true" class="ico">👤</span>
<label class="sr" for="selection-name-input">Kullanıcı Adı</label>
<input autocomplete="username" id="selection-name-input" inputmode="text" placeholder="Kullanıcı adın" type="text"/>
</div>
<div class="field">
<span aria-hidden="true" class="ico">🔒</span>
<label class="sr" for="student-password-input">Şifre</label>
<input autocomplete="current-password" id="student-password-input" placeholder="Şifre" type="password"/>
<span aria-label="Şifreyi göster/gizle" class="eye" id="togglePwd" role="button">👁️</span>
</div>
</div>
<div class="actions">
<label class="muted" style="display:flex;align-items:center;gap:8px">
<input id="rememberMe" style="accent-color:#5b8cff" type="checkbox"/> Beni hatırla
          </label>
<button class="link" id="forgot" type="button">Şifremi Unuttum?</button>
</div>
<button class="cta" disabled="" id="login-button" type="button">Hemen Başla</button>
<div aria-live="polite" class="error" id="student-selection-error" role="alert"></div>
<div aria-live="polite" class="helper">
<span>📌</span>
<span>İpucu: Alanları doldurunca buton aktif olur. Enter’a basarak da başlayabilirsin.</span>
</div>
</form>
</section>
</div>
</div>
<!-- Ana Ekran -->
<div class="container" id="main-screen" style="display: none; position: relative;">
<div class="profile-icon-container">
<img alt="Profile" class="profile-icon" decoding="async" id="profile-icon" loading="lazy" src="https://i.pinimg.com/originals/66/22/ab/6622ab37c6db6ac166dfec760a2f2939.gif"/>
</div>
<!-- === NOVA: Sürpriz Kutu (her 5 düello) === -->
<div class="surprise-box locked" id="surprise-box" title="Sürpriz kutu">
<img alt="Sürpriz Kutu" decoding="async" id="surprise-box-img" loading="lazy" src="https://i.giphy.com/ojujiWCHxud7s3cY4F.webp"/>
<div class="surprise-box-counter" id="surprise-box-counter">Kalan maç: 5</div>
</div>
<!-- === /NOVA Sürpriz Kutu === -->
<div class="student-info">
<img alt="Öğrenci Fotoğrafı" class="student-photo" id="student-photo" src="" style="display: none;"/>
<div class="student-name" id="student-name"></div>
<div class="star-frame" id="student-stars"></div>
<div class="rank-label" id="student-rank"></div>
<div class="student-stats-container">
<div class="student-stats">
<div class="stats-item trophy-stats">
<div class="stats-glow trophy-glow"></div>
<span class="stats-icon">🏆</span>
<span class="stats-value trophy-value" id="game-cup-score">0</span>
</div>
<div class="stats-item diamond-stats">
<div class="stats-glow diamond-glow"></div>
<span class="stats-icon">💎</span>
<span class="stats-value diamond-value" id="diamond-value">0</span>
</div>
<div class="stats-item credits-stats" id="credits-stats">
<div class="stats-glow credits-glow"></div>
<span class="stats-icon">⚔️</span>
<span class="stats-value credits-value" id="duel-credits-value">0</span>
<div class="tip-title" style="display: none;">Düello Hakkı</div>
</div>
</div>
</div>
</div>
<div class="buttons">
<button class="single-player">Tek Kişilik Oyun</button>
<button class="find-duel-button" id="findDuelButton">
<span class="button-content">
<i class="duel-icon">⚔️</i>
<span>Düello Ara</span>
</span>
<div class="button-glow"></div>
</button>
<button class="friends-button" id="friends-button" style="display: none;">
   👥 Arkadaşlar
</button>
<!-- Yeni Eklenen "Kupa Sıralaması" Butonu -->
<button class="kupa-siralama-button" id="kupa-siralama-button">
                🏆 Sezon Sıralaması
            </button>
<button class="logout-button" id="logout-button">Çıkış Yap</button>
</div>
</div>
<!-- Arkadaşlar Ekranı -->
<div class="friends-container" id="friends-screen" style="display: none;">
<h2>Arkadaşlar</h2>
<!-- Arama Bölümü -->
<div class="search-section">
<div class="search-box">
<input id="friend-search" placeholder="Arkadaş Ara..." type="text"/>
<button id="search-button">🔍 Ara</button>
</div>
<div class="search-results" id="search-results">
<!-- Arama sonuçları buraya gelecek -->
</div>
</div>
<!-- Arkadaş Listesi -->
<div class="friends-list-section">
<h3>Arkadaş Listem</h3>
<ul class="players-list" id="friends-list">
<!-- Arkadaş listesi buraya gelecek -->
</ul>
</div>
<button class="back-button">Geri Dön</button>
</div>
<!-- Ranking Panel (Yan Panel - Yeni Eklendi) -->
<div class="ranking-panel" id="rankingPanel" style="display: none;">
<h2>Sezon Sıralaması</h2>
<div class="ranking-table-container">
<table class="ranking-table" id="ranking-table">
<thead>
<tr>
<th>Sıra</th>
<th>Foto</th>
<th>İsim</th>
<th>Sınıf</th>
<th>D.Kredisi</th>
<th>KupaSayısı</th>
</tr>
</thead>
<tbody id="ranking-table-body">
<!-- Sıralama verileri buraya eklenecek -->
</tbody>
</table>
</div>
<div class="user-ranking-stats">
<div class="stats-header">Genel Sıralama Durumunuz</div>
<div class="stats-content">
<div class="rank-info">
<div class="rank-number" id="userRankNumber">
<span class="rank-label">Sıralama</span>
<span class="rank-value">-</span>
</div>
<div class="total-players" id="totalPlayers">
<span class="total-label">Toplam Oyuncu</span>
<span class="total-value">-</span>
</div>
</div>
<div class="user-trophy">
<span class="trophy-icon">🏆</span>
<span class="trophy-value" id="userTrophyCount">-</span>
</div>
</div>
</div>
<button class="ranking-back-button" id="rankingBackButton">Geri Dön</button>
</div>
<!-- Tek Kişilik Oyun Ekranı -->
<div class="game-container" id="single-player-screen">
<h2>Tek Kişilik Oyun</h2>
<div class="table-section">
<h3>Konu Belirleme</h3>
<label for="class-select">Sınıf Seç:</label>
<select id="class-select">
<option value="">Seçiniz</option>
</select>
<label for="subject-select">Ders Seç:</label>
<select id="subject-select">
<option value="">Seçiniz</option>
</select>
<label for="topic-select">Konu Seç:</label>
<select id="topic-select">
<option value="">Seçiniz</option>
</select>
</div>
<button class="start-game-button" disabled="" id="start-game-button">Oyuna Başla</button>
<button class="back-button">Geri Dön</button>
</div>
<!-- Tek Kişilik Oyun Sorular Ekranı -->
<div class="single-player-game-container" id="single-player-game-screen">
<div class="progress-container">
<div class="question-number" id="question-number">Soru 1/10</div>
<div class="progress-bar">
<div class="progress-bar-inner" id="progress-bar-inner"></div>
</div>
</div>
<div class="timer-container">
<div class="timer" id="timer">45</div>
</div>
<div class="question-container">
<img alt="Soru Resmi" class="question-image" id="question-image" src="" style="display: none;"/>
<div class="question-text" id="question-text">Soru metni burada olacak.</div>
</div>
<div class="options-container" id="options-container"></div>
<div class="explanation-container" id="explanation-container" style="display:none"></div>
<div class="score-container" id="score-container">
<span data-score="0" id="score"></span>
<div class="score-message" id="score-message"></div>
<img alt="Sonuç Resmi" class="final-image" id="score-image" style="display:none;"/>
<!-- "Geri Dön" butonu -->
<button class="end-game-button" id="final-back-button">Geri Dön</button>
<button class="end-game-button play-again-button" id="btnTekrar">Tekrar Oyna</button><button class="lesson-video-button" id="lesson-video-button">🎬 Ders videosunu izle</button>
</div>
</div>
<!-- Düello Seçim Ekranı -->
<div class="duel-selection-container" id="duel-selection-screen">
<div class="countdown-container">
<div class="countdown" id="duelCountdown">10</div>
</div>
<div class="selecting-student-banner" id="selecting-student-banner"></div>
<div class="table-section">
<h3>Konu Belirlendi.</h3>
<label for="duel-class-select">Sınıfınız:</label>
<select id="duel-class-select">
<option value="">Seçiniz</option>
</select>
<label for="duel-subject-select">Düello Dersi:</label>
<select id="duel-subject-select">
<option value="">Seçiniz</option>
</select>
<label for="duel-topic-select">Düello Konusu:</label>
<select id="duel-topic-select">
<option value="">Seçiniz</option>
</select>
</div>
<div class="duel-bottom-info">
<div class="duel-player-info" id="duel-inviter-info">
<img class="duel-player-photo" id="duel-inviter-photo" src=""/>
<div class="duel-player-name" id="duel-inviter-name"></div>
<div class="star-frame" id="duel-inviter-stars"></div>
<div class="rank-label" id="duel-inviter-rank"></div>
</div>
<div class="duel-player-info" id="duel-invited-info">
<img class="duel-player-photo" id="duel-invited-photo" src=""/>
<div class="duel-player-name" id="duel-invited-name"></div>
<div class="star-frame" id="duel-invited-stars"></div>
<div class="rank-label" id="duel-invited-rank"></div>
</div>
<div class="duel-controls">
<button class="duel-start-button" disabled="" id="duel-start-button" style="display:none;">Düelloya Başla</button>
</div>
</div>
</div>
<!-- Yeni modal ekranları - body etiketinin sonuna, diğer modallardan önce eklenecek -->
<div class="registration-overlay" id="registrationOverlay" style="display: none;">
<div class="registration-content">
<div class="registration-header">
<h2>Yeni Hesap Oluştur</h2>
<button class="close-button" id="closeRegistration">✖</button>
</div>
<div class="registration-form">
<select class="registration-input" id="registerClassSelect">
<option value="">Sınıf Seçin</option>
</select>
<input class="registration-input" id="registerUsername" maxlength="11" placeholder="Kullanıcı Adı (max 11 karakter)" type="text"/>
<input class="registration-input" id="registerPassword" placeholder="Şifre (en az 6 karakter, harf ve rakam içermeli)" type="password"/>
<input class="registration-input" id="registerEmail" placeholder="E-posta Adresi" type="email"/>
<button class="registration-submit" disabled="" id="submitRegistration">
                Kayıt Ol
            </button>
</div>
<div class="registration-error" id="registrationError"></div>
</div>
</div>
<div class="verification-overlay" id="verificationOverlay" style="display: none;">
<div class="verification-content">
<h3>Şahane Kayıt Başarılı 🎉</h3>
<p>Şimdi Giriş Yaparak Mücadeleye Başlayabilirsin 🤩</p>
</div>
</div>
<div class="matchmaking-screen nova-duel-arena" id="matchmakingScreen">
<div class="matchmaking-content">
<h2>Düello Rakibi Aranıyor</h2>
<!-- Arama Animasyonu -->
<div class="searching-animation"></div>
<!-- Mevcut Oyuncular Listesi -->
<div class="available-players">
<h3>Müsait Oyuncular</h3>
<div class="players-list" id="availablePlayersList">
<!-- Oyuncular dinamik olarak buraya eklenecek -->
</div>
</div>
<!-- İptal Butonu -->
<button class="cancel-search-button" id="cancelSearchButton">
            Aramayı İptal Et
        </button>
</div>
</div>
<!-- Düello Oyun Ekranı -->
<div class="duel-game-container" id="duel-game-screen">
<!-- NOVA VS HUD (MK-style health bars with counters) -->
<div id="nova-vs-hud" class="nova-vs-hud" aria-hidden="false">
  <div class="nova-hud-side left">
    <div class="nova-name" id="novaLeftName">Oyuncu 1</div>
    <div class="nova-hp">
      <div class="nova-hp-fill" id="novaLeftHP"></div>
      <div class="nova-hp-gloss"></div>
      <div class="nova-hp-count" id="novaLeftCount">0</div>
    </div>
  </div>
  <div class="nova-center-badge" title="Düello">VS</div>
  <div class="nova-hud-side right">
    <div class="nova-name" id="novaRightName">Oyuncu 2</div>
    <div class="nova-hp mirror">
      <div class="nova-hp-fill" id="novaRightHP"></div>
      <div class="nova-hp-gloss"></div>
      <div class="nova-hp-count" id="novaRightCount">0</div>
    </div>
  </div>
</div>
<!-- /NOVA VS HUD -->

<div class="progress-container">
<div class="question-number" id="duel-question-number">Soru 1/10</div>
<div class="progress-bar">
<div class="progress-bar-inner" id="duel-progress-bar-inner"></div>
</div>
</div>
<div class="timer-container">
<div class="timer" id="duel-timer">45</div>
</div>
<div class="question-container">
<img alt="Soru Resmi" class="question-image" id="duel-question-image" src="" style="display: none;"/>
<div class="question-text" id="duel-question-text">Soru metni burada olacak.</div>
</div>
<div class="options-container" id="duel-options-container"></div>
<div class="players-info-row">
<div class="duel-player-score" id="duel-player-inviter-score">
<img id="duel-player-inviter-photo" src=""/>
<div class="duel-player-name" id="duel-player-inviter-name"></div>
<div class="star-frame" id="duel-player-inviter-stars-ingame"></div>
<div class="rank-label" id="duel-player-inviter-rank-ingame"></div>
<div class="duel-player-correct-count" id="inviter-correct-count">0</div>
</div>
<div class="duel-player-score" id="duel-player-invited-score">
<img id="duel-player-invited-photo" src=""/>
<div class="duel-player-name" id="duel-player-invited-name"></div>
<div class="star-frame" id="duel-player-invited-stars-ingame"></div>
<div class="rank-label" id="duel-player-invited-rank-ingame"></div>
<div class="duel-player-correct-count" id="invited-correct-count">0</div>
</div>
</div>
<div class="score-container" id="duel-final-container">
<div class="winner-message" id="winner-message"></div>
<button class="end-game-button" id="duel-final-back-button">Oyunu Sonlandır</button>
</div>
</div>
<!-- Alert Modal -->
<div class="alert-overlay" id="alertOverlay">
<div class="alert-content">
<div class="alert-message" id="alertMessage"></div>
<button class="alert-ok-button" id="alertOkButton">Tamam</button>
</div>
</div>
<!-- Prompt Modal -->
<div class="prompt-overlay" id="promptOverlay">
<div class="prompt-content">
<div class="prompt-message" id="promptMessage"></div>
<input class="prompt-input" id="promptInput" type="text"/>
<div class="prompt-buttons">
<button class="prompt-cancel-button" id="promptCancelButton">İptal</button>
<button class="prompt-ok-button" id="promptOkButton">Tamam</button>
</div>
</div>
</div>
<!-- Davet Modalı -->
<div class="invitation-overlay" id="invitationOverlay">
<div class="invitation-content">
<div class="invitation-message" id="invitationMessage"></div>
<div class="invitation-buttons">
<button class="invitation-decline-button" id="invitationDeclineButton">Reddet</button>
<button class="invitation-accept-button" id="invitationAcceptButton">Kabul Et</button>
</div>
</div>
</div>
<div class="profile-change-overlay" id="profileChangeOverlay">
<!-- Elmas Takas Modal (Minimal, layoutı bozmaz) -->
<div id="diamondExchangeModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999;">
<div style="max-width:420px;margin:8vh auto;background:#0b1220;border:2px solid #1f2a44;border-radius:16px;box-shadow: 0 6px 18px rgba(0,0,0,.5);padding:18px;">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
<div style="font-size:20px;font-weight:800;color:#e5e7eb;">💱 Elmas Takas</div>
<button aria-label="Kapat" onclick="closeDiamondExchangeModal()" style="background:transparent;border:none;color:#94a3b8;font-size:20px;cursor:pointer;">✖</button>
</div>
<div style="font-size:13px;color:#94a3b8;margin-bottom:12px;">
      1 Düello Kredisi → <b style="color:#f0f9ff">5 💎</b>
</div>
<div style="display:flex;align-items:center;gap:8px;margin:10px 0 14px;">
<label for="exchange-count-input" style="color:#cbd5e1;font-size:14px;">Adet</label>
<input id="exchange-count-input" min="1" style="flex:0 0 120px;padding:10px;border-radius:10px;border:2px solid #ff8a00;font-size:1.05em;text-align:center;background:#0b1220;color:#e2e8f0;" type="number" value="1"/>
<span id="exchange-current-credits" style="margin-left:auto;font-size:13px;color:#94a3b8;">Mevcut Kredin: ...</span>
</div>
<button onclick="handleDiamondExchangeModal()" style="width:100%;background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;border-radius:12px;padding:12px 18px;font-weight:800;cursor:pointer;">
      Elmas Al
    </button>
<div style="margin-top:10px;font-size:12px;color:#64748b;">İşlem onayından sonra elmas ve krediler anında güncellenir.</div>
</div>
</div>
<div class="profile-change-content">
<div class="profile-change-header">
<h2 class="store-title">Mağaza <span class="cart-icon">🛒</span></h2>
<div class="store-controls">
<div class="current-diamonds">
<span class="diamond-icon">💎</span>
<span class="diamond-amount" id="currentDiamonds">0</span>
</div>
<button id="openExchangeButton" onclick="openDiamondExchangeModal()">💱 Elmas Takas</button>
<button id="profileCloseButton">✖</button>
</div>
</div>
<div class="profile-categories">
<!-- Buttons will be rendered from DB by renderStoreCategoryButtons() -->
</div>
<!-- Düello Hakları Mağazası -->
<div class="duel-credits-store" id="duelCreditsStore" style="display: none;">
<div class="credits-packages-container">
<!-- 100 Hak Paketi -->
<div class="credit-package">
<div class="package-header">
</div>
<div class="package-price">
<span class="diamond-amount">100</span>
<span class="diamond-icon">💎</span>
</div>
<button class="buy-button" onclick="purchaseCredits(100, 100)">
                        Satın Al
                    </button>
</div>
<!-- 300 Hak Paketi -->
<div class="credit-package">
<div class="package-header">
<span class="package-amount">🎫 300 Düello Bileti</span>
</div>
<div class="package-price">
<span class="diamond-amount">250</span>
<span class="diamond-icon">💎</span>
</div>
<button class="buy-button" onclick="purchaseCredits(300, 250)">
                        Satın Al
                    </button>
</div>
<!-- 750 Hak Paketi -->
<div class="credit-package">
<div class="package-header">
<span class="package-amount">🎫 750 Düello Bileti</span>
</div>
<div class="package-price">
<span class="diamond-amount">500</span>
<span class="diamond-icon">💎</span>
</div>
<button class="buy-button" onclick="purchaseCredits(750, 500)">
                        Satın Al
                    </button>
</div>
</div>
</div>
<!-- Profil Fotoğrafları Konteyneri -->
<div class="profile-photos-container" id="profilePhotosContainer"></div>
</div>
</div>
<!-- Arka Plan Müziği için Audio Elementi -->
<audio id="duelBackgroundMusic" preload="none" src="https://github.com/d4rkd4y76/OYUN-MZK/raw/refs/heads/main/dllo%20mz.mp3"></audio>
<!-- Kazanan Ekranı için Yeni Audio Elementi -->
<audio id="winnerMusic" preload="none" src="https://github.com/d4rkd4y76/OYUN-MZK/raw/refs/heads/main/win%20mz.mp3"></audio>
<!-- Tek Kişilik Oyun Müziği için Yeni Audio Elementi -->
<audio id="singlePlayerQuestionMusic" preload="none" src="https://github.com/d4rkd4y76/OYUN-MZK/raw/refs/heads/main/oyun%20tek%20mz.mp3"></audio>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js">
// Yardımcı: aktif invite ban var mı? (global veya sınıf path'i)
async function readInviteBan(studentId, classId) {
    if (typeof database === 'undefined' || !studentId) return null;
    try {
        const snapGlobal = await database.ref(`inviteBans/${studentId}`).once('value');
        let data = snapGlobal && snapGlobal.exists && snapGlobal.exists() ? (snapGlobal.val() || null) : null;
        if (!data && classId) {
            const snapClass = await database.ref(`classes/${classId}/inviteBans/${studentId}`).once('value');
            if (snapClass && snapClass.exists && snapClass.exists()) data = snapClass.val() || null;
        }
        return data;
    } catch (e) {
        console.warn('readInviteBan hata:', e);
        return null;
    }
}
</script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script>
        // JavaScript Kodları

        // Audio Elementlerini Seçme
        const duelMusic = document.getElementById('duelBackgroundMusic');
        const winnerMusic = document.getElementById('winnerMusic');
        const singlePlayerQuestionMusic = document.getElementById('singlePlayerQuestionMusic');

        // "Oyunu Sonlandır" butonuna eklenen event listener
document.getElementById('duel-final-back-button').addEventListener('click', async () => {
    await showAlert('🏆 Kupa verileriniz güncellendi.');
    if (currentDuelRef) {
        try {
            await currentDuelRef.remove();
            currentDuelRef = null;
            isInviter = false;
            duelGameStarted = false;
            window.location.reload();
        } catch (error) {
            console.error("Düello referansı kaldırılırken hata:", error);
            await showAlert('Düello referansı kaldırılırken hata oluştu.');
        }
    } else {
        window.location.reload();
    }
});


        window.addEventListener('beforeunload', () => {
            if (selectedStudent && selectedStudent.studentId) {
                database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/inDuel`).set(false)
                .then(() => console.log("inDuel set to false"))
                .catch(err => console.error("Failed to update inDuel status:", err));

                // Eğer bir düello referansı varsa, düelloyu kaldır ve diğer oyuncunun inDuel durumunu false yap
                if (currentDuelRef) {
                    currentDuelRef.once('value').then(async (snapshot) => {
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            const inviterRef = database.ref(`classes/${data.inviter.classId}/students/${data.inviter.studentId}/inDuel`);
                            const invitedRef = database.ref(`classes/${data.invited.classId}/students/${data.invited.studentId}/inDuel`);
                            try {
                                await inviterRef.set(false);
                                await invitedRef.set(false);
                                await currentDuelRef.remove();
                            } catch (error) {
                                console.error("Düello referansı kaldırılırken hata:", error);
                            }
                        }
                    });
                }
            }
        });

        // Lütfen kendi firebaseConfig değerlerinizi girin
const firebaseConfig = {
  apiKey: "AIzaSyAZeMfg1mRKH-b3Y9vWcscC7sLu5C3WULw",
  authDomain: "fadime-hoca-uygulama.firebaseapp.com",
  databaseURL: "https://fadime-hoca-uygulama-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "fadime-hoca-uygulama",
  storageBucket: "fadime-hoca-uygulama.firebasestorage.app",
  messagingSenderId: "567109416531",
  appId: "1:567109416531:web:2855d9228acde212bf78a6",
  measurementId: "G-P6RHPXLVTW"
};
        firebase.initializeApp(firebaseConfig);
    // Nova guard for auth
    try { window.auth = window.auth || (firebase && firebase.auth ? firebase.auth() : null); } catch(e){ window.auth = null; }
        const database = firebase.database();
        const auth = firebase.auth();


        // Diğer değişkenler
        let classNameMap = {};
        let duelEnded = false; // Eklendi

        const playersOverlay = document.getElementById('playersOverlay');
        const playersCloseButton = document.getElementById('playersCloseButton');
        const playersList = document.getElementById('playersList');
        const invitationOverlay = document.getElementById('invitationOverlay');
        const invitationMessage = document.getElementById('invitationMessage');

        playersCloseButton.addEventListener('click', () => {
            playersOverlay.style.display = 'none';
        });

        let loggedinPlayerRef = null;
        let selectedStudent = {
            classId: '',
            studentId: '',
            studentName: ''
        };

        const studentPhoto = document.getElementById('student-photo');
        const studentName = document.getElementById('student-name');

        async function addLoggedInPlayer(student) {
            const newRef = database.ref('loggedinPlayers').push();
            await newRef.set({
                name: student.studentName,
                photo: (studentPhoto.src && studentPhoto.src !== "") ? studentPhoto.src : "",
                classId: student.classId,
                studentId: student.studentId
            });
            newRef.onDisconnect().remove();
            loggedinPlayerRef = newRef;
        }

 async function showLoggedInPlayers() {
    playersList.innerHTML = '';
    const snapshot = await database.ref('loggedinPlayers').once('value');
    let playersArr = [];

    if (snapshot.exists()) {
        snapshot.forEach(child => {
            const player = child.val();
            playersArr.push({ ...player, key: child.key });
        });

        // Sınıf adına göre sırala (aynı sınıftakiler önce)
        const sameClassPlayers = playersArr.filter(p => p.classId === selectedStudent.classId && p.studentId !== selectedStudent.studentId);
        const otherClassPlayers = playersArr.filter(p => p.classId !== selectedStudent.classId);
        playersArr = [...sameClassPlayers, ...otherClassPlayers];

        for (const player of playersArr) {
            let photoURL = "https://via.placeholder.com/50";
            try {
                const photoSnapshot = await database.ref(`classes/${player.classId}/students/${player.studentId}/photo`).once('value');
                if (photoSnapshot.exists()) {
                    photoURL = photoSnapshot.val();
                }
            } catch (e) {
                console.error('Fotoğraf alınamadı:', e);
            }

            // "inDuel" durumu
            let inDuel = false;
            try {
                const inDuelSnapshot = await database.ref(`classes/${player.classId}/students/${player.studentId}/inDuel`).once('value');
                if (inDuelSnapshot.exists()) {
                    inDuel = inDuelSnapshot.val();
                }
            } catch (e) {
                console.error('inDuel durumu alınamadı:', e);
            }

            const playerData = {
                name: player.name,
                classId: player.classId,
                className: classNameMap[player.classId] ? classNameMap[player.classId] : player.classId,
                photo: photoURL,
                inDuel: inDuel,
                studentId: player.studentId
            };

            const li = createFriendCard(playerData);
            playersList.appendChild(li);
        }
    } else {
        const li = document.createElement('li');
        li.textContent = "Şu an oyunda kimse yok.";
        playersList.appendChild(li);
    }
    playersOverlay.style.display = 'flex';
}


        const studentSelectionScreen = document.getElementById('student-selection-screen');
        const mainScreen = document.getElementById('main-screen');
        const singlePlayerScreen = document.getElementById('single-player-screen');
        const singlePlayerGameScreen = document.getElementById('single-player-game-screen');
        const duelSelectionScreen = document.getElementById('duel-selection-screen');
        const duelGameScreen = document.getElementById('duel-game-screen');
        const rankingPanel = document.getElementById('rankingPanel'); // Ranking Panel ID

        const loginButton = document.getElementById('login-button');
        const singlePlayerButton = document.querySelector('.single-player');
        const backButtons = document.querySelectorAll('.back-button');
        const startGameButton = document.getElementById('start-game-button');
        const finalBackButton = document.getElementById('final-back-button');

        const playAgainButton = document.getElementById('btnTekrar');if(playAgainButton && !playAgainButton.dataset.bound){  playAgainButton.dataset.bound='1';  playAgainButton.addEventListener('click', ()=>{ try{ window.scrollTo(0,0);}catch(e){}; location.reload(); });}const selectionClassSelect = document.getElementById('selection-class-select');
        const selectionNameSelect = document.getElementById('selection-name-select');

        const classSelect = document.getElementById('class-select');
        const subjectSelect = document.getElementById('subject-select');
        const topicSelect = document.getElementById('topic-select');

        const studentPasswordInput = document.getElementById('student-password-input');
        const studentSelectionError = document.getElementById('student-selection-error');

        let gameQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;

        const questionNumber = document.getElementById('question-number');
        const progressBarInner = document.getElementById('progress-bar-inner');
        const questionImage = document.getElementById('question-image');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const scoreContainer = document.getElementById('score-container');
        const scoreDisplay = document.getElementById('score');
        const scoreMessage = document.getElementById('score-message');
        const scoreImage = document.getElementById('score-image');
        const timerElement = document.getElementById('timer');

        const duelClassSelect = document.getElementById('duel-class-select');
        const duelSubjectSelect = document.getElementById('duel-subject-select');
        const duelTopicSelect = document.getElementById('duel-topic-select');
        const duelStartButton = document.getElementById('duel-start-button');

        const duelInviterPhoto = document.getElementById('duel-inviter-photo');
        const duelInviterName = document.getElementById('duel-inviter-name');
        const duelInvitedPhoto = document.getElementById('duel-invited-photo');
        const duelInvitedName = document.getElementById('duel-invited-name');

        const duelQuestionNumber = document.getElementById('duel-question-number');
        const duelProgressBarInner = document.getElementById('duel-progress-bar-inner');
        const duelTimerElement = document.getElementById('duel-timer');
        const duelQuestionImage = document.getElementById('duel-question-image');
        const duelQuestionText = document.getElementById('duel-question-text');
        const duelOptionsContainer = document.getElementById('duel-options-container');

        const inviterCorrectCountEl = document.getElementById('inviter-correct-count');
        const invitedCorrectCountEl = document.getElementById('invited-correct-count');

        const duelFinalContainer = document.getElementById('duel-final-container');
        const winnerMessage = document.getElementById('winner-message');

        // Ranking Panel Elements
        const kupaSiralamaButton = document.getElementById('kupa-siralama-button');
        const rankingTableBody = document.getElementById('ranking-table-body');
        const rankingBackButton = document.getElementById('rankingBackButton');

        let timer;
        let timeLeft = 45;

        let duelTimer;
        let duelTimeLeft = 45;

        let currentDuelRef = null;
        let isInviter = false;
        let currentInvitation = null;

        let duelQuestions = [];
        let duelCurrentQuestionIndex = 0;
        let duelInviterScore = 0;
        let duelInvitedScore = 0;
        let duelClassId = "";
        let duelSubjectId = "";
        let duelTopicId = "";
        let duelQuestionLocked = false;
        let duelGameStarted = false;

window.onload = async () => {
    try {
        // Cleanup işlemini başlat
        startRejectedInvitesCleanup();

        // Sınıf ve öğrenci seçimi için event listener'lar
        selectionClassSelect.addEventListener('change', () => {
            if (selectionClassSelect.value === "") {
                selectionNameInput.disabled = true;
                selectionNameInput.value = "";
            } else {
                selectionNameInput.disabled = false;
            }
            checkLoginButtonState();
        });

        // Yeni input event listener'ı
        selectionNameInput.addEventListener('input', checkLoginButtonState);

        const storedStudent = localStorage.getItem('selectedStudent');
        if (storedStudent) {
            selectedStudent = JSON.parse(storedStudent);
            
            // Ana ekranı göster
            mainScreen.style.display = 'flex';
            studentSelectionScreen.style.display = 'none';
            studentSelectionError.textContent = '';
            studentPasswordInput.value = '';

            // Fotoğraf yükleme
            try {
                const photoSnapshot = await database.ref(
                    `classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/photo`
                ).once('value');

                if (photoSnapshot.exists()) {
                    const photoURL = photoSnapshot.val();
                    studentPhoto.src = photoURL;
                    studentPhoto.style.display = 'block';
                } else {
                    studentPhoto.style.display = 'none';
                }
            } catch (error) {
                console.error("Fotoğraf çekilirken hata:", error);
                studentPhoto.style.display = 'none';
            }

            // Öğrenci bilgilerini ayarla
            studentName.textContent = selectedStudent.studentName;
            try {
                database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/duelCredits`).once('value')
                .then(function(snap){
                    var cnt = snap && snap.exists() ? snap.val() : 0;
                    var st = document.getElementById('student-stars');
                    if (st) st.innerHTML = getStars(cnt);
                var rk=document.getElementById('student-rank'); if(rk) rk.innerHTML=getRankHTML(cnt);})
                .catch(function(e){
                    console.warn('Yıldızlar (ana ekran) yüklenemedi:', e);
                });
            } catch(e) {
                console.warn('Yıldızlar (ana ekran) yüklenemedi:', e);
            }


            // Sırasıyla sistemleri başlat
            await addLoggedInPlayer(selectedStudent);
            startInvitationListener(selectedStudent.studentId);
            await fetchAndDisplayGameCup();
            onMainScreenLoad(); // Elmas sistemini başlat

            // 30 saniye aralıklarla reddedilen davetleri kontrol et ve temizle
            setInterval(async () => {
                try {
                    const rejectedInvitesRef = database.ref('rejectedInvites')
                        .orderByChild('timestamp')
                        .endAt(Date.now() - 30000);
                    
                    const snapshot = await rejectedInvitesRef.once('value');
                    if (snapshot.exists()) {
                        const updates = {};
                        snapshot.forEach(child => {
                            updates[child.key] = null;
                        });
                        await database.ref('rejectedInvites').update(updates);
                    }
                } catch (error) {
                    console.error("Reddedilen davetleri temizlerken hata:", error);
                }
            }, 30000); // Her 30 saniyede bir kontrol et

        } else {
            studentSelectionScreen.style.display = 'flex';
        }

        // Gerekli verileri yükle
        await Promise.all([
            fetchClassesForSelection(),
            fetchChampionData()
        ]);

    } catch (error) {
        console.error("Uygulama başlatma hatası:", error);
        showAlert('Bir hata oluştu. Lütfen sayfayı yenileyin.');
    }
};

        async function fetchAllClasses() {
            const snapshot = await database.ref('classes').once('value');
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const classId = childSnapshot.key;
                    const className = childSnapshot.val().name;
                    classNameMap[classId] = className;
                });
            }
        }
        fetchAllClasses();

        (auth ? auth : null).onAuthStateChanged(user => {
            if (user) {
                console.log("Kullanıcı oturum açtı:", user);
            } else {
                console.log("Kullanıcı oturum açmadı.");
            }
        });

loginButton.addEventListener('click', async () => {
    const selectedClass = selectionClassSelect.value;
    const enteredUsername = selectionNameInput.value.trim(); // Yeni input değerini al
    const enteredPassword = studentPasswordInput.value.trim();

    if (!selectedClass || !enteredUsername) {
        studentSelectionError.textContent = 'Lütfen tüm alanları doldurunuz.';
        return;
    }

    // Kullanıcı ID'sini ve bilgilerini veritabanından al
    try {
        const studentsRef = database.ref(`classes/${selectedClass}/students`);
        const snapshot = await studentsRef.orderByChild('name').equalTo(enteredUsername).once('value');

        if (!snapshot.exists()) {
            studentSelectionError.textContent = 'Kullanıcı bulunamadı.';
            return;
        }

        // Snapshot'tan ilk (ve muhtemelen tek) kullanıcıyı al
        const studentData = Object.entries(snapshot.val())[0];
        const studentId = studentData[0]; // Firebase tarafından oluşturulan ID
        const studentInfo = studentData[1]; // Kullanıcı bilgileri

        // selectedStudent nesnesini güncelle
        selectedStudent.classId = selectedClass;
        selectedStudent.studentId = studentId;
        selectedStudent.studentName = studentInfo.name;

        if (enteredPassword === "") {
            studentSelectionError.textContent = 'Lütfen şifrenizi giriniz.';
            return;
        }

        // Buradan sonrası mevcut şifre kontrolü ve giriş işlemleri aynen devam edebilir
        database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/password`).once('value').then(async snapshot => {
            if (snapshot.exists()) {
                const correctPassword = snapshot.val();
                if (enteredPassword === correctPassword) {
                    // Mevcut giriş başarılı işlemleri...
                    studentSelectionScreen.style.display = 'none';
                    mainScreen.style.display = 'flex';
                    studentSelectionError.textContent = '';
                    studentPasswordInput.value = '';

                    // Fotoğraf yükleme işlemi...
                    database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/photo`).once('value').then(photoSnapshot => {
                        if (photoSnapshot.exists()) {
                            const photoURL = photoSnapshot.val();
                            studentPhoto.src = photoURL;
                            studentPhoto.style.display = 'block';
                        } else {
                            studentPhoto.style.display = 'none';
                        }
                    }).catch(error => {
                        console.error("Fotoğraf çekilirken hata:", error);
                        studentPhoto.style.display = 'none';
                    });

                    studentName.textContent = selectedStudent.studentName;
                    await addLoggedInPlayer(selectedStudent);
                    startInvitationListener(selectedStudent.studentId);
                    fetchAndDisplayGameCup();
                    onMainScreenLoad();

                    localStorage.setItem('selectedStudent', JSON.stringify(selectedStudent));
                } else {
                    studentSelectionError.textContent = 'Yanlış şifre. Lütfen tekrar deneyiniz.';
                }
            } else {
                studentSelectionError.textContent = 'Bu öğrenci için şifre tanımlanmamış.';
            }
        }).catch(error => {
            console.error("Şifre kontrol hata:", error);
            studentSelectionError.textContent = 'Şifre kontrol edilirken hata oluştu.';
        });

    } catch (error) {
        console.error("Kullanıcı arama hatası:", error);
        studentSelectionError.textContent = 'Bir hata oluştu. Lütfen tekrar deneyin.';
    }
});

// Elmas sayısını güncelleme fonksiyonu
// Elmas sayısını güncelleme fonksiyonu
async function updateDiamondCount() {
    if (!selectedStudent?.studentId) return;
    
    try {
        const studentRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`);
        const snapshot = await studentRef.once('value');
        const userData = snapshot.val();
        
        const currentTime = Date.now();
        const lastUpdate = userData.lastDiamondUpdate || currentTime;
        const hoursPassed = Math.floor((currentTime - lastUpdate) / (1000 * 60 * 60));
        
        if (hoursPassed > 0) {
            // Mevcut elmas sayısı
            let currentDiamonds = userData.diamond || 0;
            
            // Eğer mevcut elmas sayısı 30'dan küçükse saatlik artış uygula
            if (currentDiamonds < 30) {
                // Eklenecek elmas sayısı (saatte 1)
                let diamondsToAdd = hoursPassed * 10;
                // Yeni toplam elmas sayısı (maksimum 30)
                let newDiamonds = Math.min(currentDiamonds + diamondsToAdd, 30);
                
                await studentRef.update({
                    diamond: newDiamonds,
                    lastDiamondUpdate: currentTime
                });
                
                document.getElementById('diamond-value').textContent = newDiamonds;
            } else {
                // Elmas sayısı zaten 30 veya üzerindeyse mevcut değeri koru
                document.getElementById('diamond-value').textContent = currentDiamonds;
                await studentRef.update({
                    lastDiamondUpdate: currentTime
                });
            }
        } else {
            document.getElementById('diamond-value').textContent = userData.diamond || 0;
        }
    } catch (error) {
        console.error("Elmas güncelleme hatası:", error);
    }
}

// Ana ekrana gelindiğinde elmas sayısını güncelle
function onMainScreenLoad() {
    // NOVA: Sürpriz kutuyu başlat
    try{ initSurpriseBox(); }catch(e){ console.warn(e); }

    updateDiamondCount();
    
    const studentRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`);
    studentRef.once('value').then(snapshot => {
        const userData = snapshot.val();
        const creditsStats = document.getElementById('credits-stats');
        const creditsValue = document.getElementById('duel-credits-value');
        
        // Sınırsız hak kontrolü
        if (userData.unlimitedCreditsUntil && userData.unlimitedCreditsUntil > Date.now()) {
            creditsStats.classList.add('unlimited');
            // Kalan süreyi hesapla
            const daysLeft = Math.ceil((userData.unlimitedCreditsUntil - Date.now()) / (1000 * 60 * 60 * 24));
            creditsValue.innerHTML = `<span class="unlimited-badge">${daysLeft}Gün</span>`;
        } else {
            creditsStats.classList.remove('unlimited');
            creditsValue.textContent = userData.duelCredits || 0;
        }
    });
    
    setInterval(updateDiamondCount, 1000 * 60 * 60);
}


// Yeni input elementi için referans
const selectionNameInput = document.getElementById('selection-name-input');

// Login butonuna yeni kontrol fonksiyonu
async function handleLogin() {
    const enteredUsername = selectionNameInput.value.trim();
    const selectedClass = selectionClassSelect.value;
    const enteredPassword = studentPasswordInput.value.trim();

    if (!enteredUsername || !selectedClass || !enteredPassword) {
        studentSelectionError.textContent = 'Lütfen tüm alanları doldurunuz.';
        return;
    }

    try {
        // Kullanıcı adını veritabanında ara
        const studentsRef = database.ref(`classes/${selectedClass}/students`);
        const snapshot = await studentsRef.orderByChild('name').equalTo(enteredUsername).once('value');

        if (!snapshot.exists()) {
            studentSelectionError.textContent = 'Kullanıcı bulunamadı.';
            return;
        }

        // Kullanıcı bilgilerini al
        const studentData = Object.entries(snapshot.val())[0];
        const studentId = studentData[0];
        const studentInfo = studentData[1];

        // Şifre kontrolü
        if (enteredPassword !== studentInfo.password) {
            studentSelectionError.textContent = 'Yanlış şifre.';
            return;
        }

        // Login işlemleri
        selectedStudent = {
            classId: selectedClass,
            studentId: studentId,
            studentName: studentInfo.name
        };

        // Ana ekrana geçiş ve diğer işlemler
        mainScreen.style.display = 'flex';
        studentSelectionScreen.style.display = 'none';
        studentSelectionError.textContent = '';
        studentPasswordInput.value = '';

        // Fotoğraf ve diğer bilgileri yükle
        if (studentInfo.photo) {
            studentPhoto.src = studentInfo.photo;
            studentPhoto.style.display = 'block';
        } else {
            studentPhoto.style.display = 'none';
        }

        studentName.textContent = studentInfo.name;
        await addLoggedInPlayer(selectedStudent);
        startInvitationListener(selectedStudent.studentId);
        fetchAndDisplayGameCup();
        onMainScreenLoad();

        localStorage.setItem('selectedStudent', JSON.stringify(selectedStudent));

    } catch (error) {
        console.error("Login hatası:", error);
        studentSelectionError.textContent = 'Bir hata oluştu. Lütfen tekrar deneyin.';
    }
}

// Ana değişkenler
const friendsButton = document.querySelector('.friends-button');
const friendsScreen = document.getElementById('friends-screen');
const friendSearchInput = document.getElementById('friend-search');
const searchButton = document.getElementById('search-button');
const searchResults = document.getElementById('search-results');
const friendsList = document.getElementById('friends-list');

// Arkadaşlar butonuna tıklama olayı
friendsButton.addEventListener('click', () => {
    mainScreen.style.display = 'none';
    friendsScreen.style.display = 'flex';
    loadFriendsList(); // Arkadaş listesini yükle
});

// Geri dön butonu için olay dinleyici
friendsScreen.querySelector('.back-button').addEventListener('click', () => {
    friendsScreen.style.display = 'none';
    mainScreen.style.display = 'flex';
});

// Arkadaş arama işlevi
searchButton.addEventListener('click', searchFriends);
friendSearchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        searchFriends();
    }
});

async function searchFriends() {
    const searchTerm = friendSearchInput.value.toLowerCase().trim();
    if (!searchTerm) return;
    
    searchResults.innerHTML = '<div class="loading">Aranıyor...</div>';
    
    try {
        // Sadece öğrencinin kendi sınıfını referans al
        const classRef = database.ref(`classes/${selectedStudent.classId}`);
        const snapshot = await classRef.once('value');
        const results = [];
        
        const classData = snapshot.val();
        const students = classData.students;
        
        if (students) {
            Object.entries(students).forEach(([studentId, studentData]) => {
                if (studentData.name?.toLowerCase().includes(searchTerm) && 
                    studentId !== selectedStudent.studentId) {
                    results.push({
                        studentId,
                        classId: selectedStudent.classId,
                        className: classData.name || selectedStudent.classId,
                        ...studentData
                    });
                }
            });
        }
        
        displaySearchResults(results);
    } catch (error) {
        console.error("Arama hatası:", error);
        searchResults.innerHTML = '<div class="error">Arama hatası oluştu</div>';
    }
}








// Merkezi puanlama fonksiyonu
async function updateDuelScore(type, data) {
    const {inviterId, inviterClassId, invitedId, invitedClassId} = data;
    
    try {
        switch(type) {
            case 'TIME_OUT':
                // Süre dolduğunda davet eden -3, misafir +6
                await Promise.all([
                    database.ref(`classes/${inviterClassId}/students/${inviterId}/gameCup`)
                        .transaction(current => Math.max((current || 0) - 3, 0)),
                    database.ref(`classes/${invitedClassId}/students/${invitedId}/gameCup`)
                        .transaction(current => (current || 0) + 6)
                ]);
                await showAlert('⏰ Süre doldu! Misafir oyuncu kazandı. (-3/+6 🏆)');
                break;

            case 'DISCONNECTED':
    // Sadece OYUNDAN ÇIKAN kişiyi banla; kalan kişiye sadece bilgilendirme göster.
    try {
        const dcId = data && (data.disconnectedId || data.playerId || data.uid || data.studentId);
        const dcClassId = data && (data.disconnectedClassId || data.classId || data.classID);
        if (!dcId) {
            console.warn('DISCONNECTED event without dcId, işlem yapılmadı.');
            break;
        }

        // Bu istemci OYUNDAN ÇIKAN kişi mi?
        const currentUid = (auth && (auth ? auth : null).currentUser && (auth ? auth : null).currentUser.uid) ? (auth ? auth : null).currentUser.uid : null;
        const currentStudentId = (typeof currentStudent !== 'undefined' && currentStudent && currentStudent.studentId) ? currentStudent.studentId : null;
        const selectedId = (typeof selectedStudent !== 'undefined' && selectedStudent && selectedStudent.studentId) ? selectedStudent.studentId : null;
        const localId = currentStudentId || currentUid || selectedId;

        const isLeaver = (localId && (localId === dcId));

        if (isLeaver) {
            // YALNIZCA ayrılan istemcide ban yaz ve uyarı göster
            const TEN_MINUTES_MS = 10 * 60 * 1000;
            const expiresAt = Date.now() + TEN_MINUTES_MS;
            let wrote = false;
            if (typeof database !== 'undefined') {
                try { await database.ref(`inviteBans/${dcId}`).set({ expiresAt }); wrote = true; } catch(e1){ console.warn('inviteBans global yazma hatası:', e1); }
                if (dcClassId) {
                    try { await database.ref(`classes/${dcClassId}/inviteBans/${dcId}`).set({ expiresAt }); wrote = true; } catch(e2){ console.warn('inviteBans class yazma hatası:', e2); }
                }
            }
            if (typeof showAlert === 'function') {
                const msg = wrote 
                    ? 'Bağlantınız kesildi. Kupa değişmedi. 10 dakika davet gönderemezsiniz.'
                    : 'Bağlantınız kesildi. Kupa değişmedi. (Ceza kaydı yazılamadı, loglandı.)';
                await showAlert(msg);
            }
        } else {
            // Bu istemci ayrılan kişi DEĞİL → sadece bilgi ver (ban yazma!)
            if (typeof showAlert === 'function') {
                await showAlert('Rakibiniz oyundan ayrıldı. Kupa değişmedi.');
            }
        }
    } catch (err) {
        console.error('DISCONNECTED işleminde hata:', err);
        if (typeof showAlert === 'function') {
            await showAlert('Bağlantı kesildi olayı işlendi, ancak beklenmeyen bir hata oluştu.');
        }
    }
    break;

            case 'GAME_END':
                
                // Normal oyun sonu: Kazanan +6, Kaybeden -3 (tek sefer)
                const {winnerId, winnerClassId, loserId, loserClassId} = data;

                let canApply = true;
                try {
                    if (typeof currentDuelRef !== 'undefined' && currentDuelRef) {
                        const tx = await currentDuelRef.child('scoreApplied').transaction((val) => {
                            if (val === true) return; // zaten uygulanmış
                            return true;              // ilk uygulama
                        });
                        if (!tx.committed) {
                            canApply = false;
                        }
                    }
                } catch (e) {
                    console.warn('scoreApplied transaction yapılamadı:', e);
                }

                if (canApply && winnerId && loserId) {
                    await Promise.all([
                        database.ref(`classes/${winnerClassId}/students/${winnerId}/gameCup`).transaction(current => (current || 0) + 6),
                        database.ref(`classes/${loserClassId}/students/${loserId}/gameCup`).transaction(current => Math.max((current || 0) - 3, 0))
                    ]);
                    // End-of-duel showAlert disabled by Nova

                } else {
                    console.log('GAME_END: puanlar zaten uygulanmış — ikinci yazım engellendi.');
                }
            
                break;
        }
        return true;
    } catch (error) {
        console.error('Puan güncelleme hatası:', error);
        await showAlert('❌ Puan güncellenirken bir hata oluştu!');
        return false;
    }
}
















async function displaySearchResults(results) {
    searchResults.innerHTML = '';
    if (!results.length) {
        searchResults.innerHTML = '<div class="no-results">Sonuç bulunamadı</div>';
        return;
    }

    for (const student of results) {
        const friendshipRef = database.ref(`friendships/${selectedStudent.studentId}/${student.studentId}`);
        const isFriend = (await friendshipRef.once('value')).exists();
        
        const inDuelRef = database.ref(`classes/${student.classId}/students/${student.studentId}/inDuel`);
        const inDuel = (await inDuelRef.once('value')).val();

        const li = document.createElement('li');
        li.className = 'player-item';

        const photo = student.photo || 'https://via.placeholder.com/50';
        const className = classNameMap[student.classId] || student.classId;

        // Arkadaşlık durumuna göre buton veya metin gösterme
        let actionHtml = '';
        if (inDuel) {
            actionHtml = '<button class="oyunda-button" disabled>Oyunda</button>';
        } else if (isFriend) {
            actionHtml = '<span class="friend-added-text" style="padding: 8px 14px; background-color: #e9ecef; color: #495057; border-radius: 6px;">Arkadaşsınız</span>';
        } else {
            actionHtml = '<button class="add-friend-button">+ Arkadaş Ekle</button>';
        }

        li.innerHTML = `
            <img src="${photo}" alt="${student.name}" class="player-photo">
            <span class="player-name">${student.name} / (${className}) </span>
            <div class="star-frame">${getStars(student.duelCredits || 0)}</div>
            ${actionHtml}
        `;

        // Sadece arkadaş değilse ve oyunda değilse buton işlevselliği ekle
        if (!isFriend && !inDuel) {
            const button = li.querySelector('.add-friend-button');
            if (button) {
                button.onclick = () => addFriend({
                    id: student.studentId,
                    name: student.name,
                    classId: student.classId,
                    className,
                    photo: student.photo
                });
            }
        }

        searchResults.appendChild(li);
    }
}


async function addFriend(student) {
    try {
        const currentFriendsRef = database.ref(`friendships/${selectedStudent.studentId}`);
        const snapshot = await currentFriendsRef.once('value');
        if (snapshot.numChildren() >= 10) {
            showAlert('En fazla 10 arkadaş ekleyebilirsiniz!');
            return;
        }

        const friendshipData = {
            friendId: student.id,
            friendName: student.name,
            friendClassId: student.classId,
            friendClassName: student.className,
            friendPhoto: student.photo || null,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        };

        await Promise.all([
            database.ref(`friendships/${selectedStudent.studentId}/${student.id}`).set(friendshipData),
            database.ref(`friendships/${student.id}/${selectedStudent.studentId}`).set({
                friendId: selectedStudent.studentId,
                friendName: selectedStudent.studentName,
                friendClassId: selectedStudent.classId,
                friendClassName: classNameMap[selectedStudent.classId],
                friendPhoto: studentPhoto.src || null,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            })
        ]);

        showAlert('Arkadaş başarıyla eklendi!');
        loadFriendsList();
        searchFriends();
    } catch (error) {
        showAlert('Arkadaş eklenirken hata oluştu');
    }
}

async function checkIfFriend(friendId) {
    const snapshot = await database.ref(`friendships/${selectedStudent.studentId}/${friendId}`).once('value');
    return snapshot.exists();
}

async function addFriend(student) {
    try {
        // Önce mevcut arkadaş sayısını kontrol et
        const currentFriendsRef = database.ref(`friendships/${selectedStudent.studentId}`);
        const snapshot = await currentFriendsRef.once('value');
        const currentFriendsCount = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;

        if (currentFriendsCount >= 10) {
            showAlert('En fazla 10 arkadaş ekleyebilirsiniz!');
            return;
        }

        // Arkadaş zaten ekli mi kontrol et
        const existingFriendRef = database.ref(`friendships/${selectedStudent.studentId}/${student.id}`);
        const existingFriend = await existingFriendRef.once('value');
        
        if (existingFriend.exists()) {
            showAlert('Bu kişi zaten arkadaş listenizde!');
            return;
        }

        const friendshipRef = database.ref(`friendships/${selectedStudent.studentId}/${student.id}`);
        await friendshipRef.set({
            friendId: student.id,
            friendName: student.name,
            friendClassId: student.classId,
            friendClassName: classNameMap[student.classId] || student.classId,
            friendPhoto: student.photo || null,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        });

        showAlert('Arkadaş başarıyla eklendi!');
        loadFriendsList(); // Listeyi yenile

    } catch (error) {
        console.error('Arkadaş ekleme hatası:', error);
        showAlert('Arkadaş eklenirken bir hata oluştu. Lütfen tekrar deneyin.');
    }
}

// Arkadaş listesini yükleme fonksiyonunu güncelle
async function loadFriendsList() {
    try {
        // Cache key oluştur
        const CACHE_KEY = `friendsList_${selectedStudent.studentId}`;
        const CACHE_DURATION = 30000; // 30 saniye

        friendsList.innerHTML = '<div class="loading">Yükleniyor...</div>';

        // Cache kontrolü
        const cachedData = localStorage.getItem(CACHE_KEY);
        const cachedTime = localStorage.getItem(`${CACHE_KEY}_time`);
        
        if (cachedData && cachedTime && (Date.now() - parseInt(cachedTime)) < CACHE_DURATION) {
            friendsList.innerHTML = '';
            const friends = JSON.parse(cachedData);
            await displayCachedFriends(friends);
            return;
        }

        const friendshipsRef = database.ref(`friendships/${selectedStudent.studentId}`);
        const snapshot = await friendshipsRef.once('value');

        if (!snapshot.exists()) {
            friendsList.innerHTML = '<div class="no-friends">Henüz arkadaşınız yok</div>';
            return;
        }

        friendsList.innerHTML = '';
        const friends = [];

        // Arkadaşları topla
        for (const [friendId, friendData] of Object.entries(snapshot.val())) {
            // Batch sorgu için referansları hazırla
            const photoRef = database.ref(`classes/${friendData.friendClassId}/students/${friendId}/photo`);
            const inDuelRef = database.ref(`classes/${friendData.friendClassId}/students/${friendId}/inDuel`);
            
            // Paralel sorgu yap
            const [photoSnap, inDuelSnap] = await Promise.all([
                photoRef.once('value'),
                inDuelRef.once('value')
            ]);

            const currentPhoto = photoSnap.exists() ? photoSnap.val() : (friendData.friendPhoto || 'https://via.placeholder.com/50');
            const inDuel = inDuelSnap.val() || false;

            friends.push({
                studentId: friendId,
                name: friendData.friendName,
                classId: friendData.friendClassId,
                className: friendData.friendClassName,
                photo: currentPhoto,
                inDuel: inDuel,
                isOnline: false
            });
        }

        // Tüm online durumları tek sorguda al
        const loggedInRef = database.ref('loggedinPlayers');
        const loggedInSnapshot = await loggedInRef.once('value');
        const onlinePlayers = loggedInSnapshot.val() || {};

        // Online durumlarını güncelle
        friends.forEach(friend => {
            friend.isOnline = Object.values(onlinePlayers).some(
                player => player.studentId === friend.studentId
            );
        });

        // Stil tanımlaması
        const style = document.createElement('style');
        style.textContent = `
            .remove-friend-button {
                background-color: #dc3545;
                color: white;
                border: none;
                border-radius: 12px;
                width: 25px;
                height: 25px;
                line-height: 25px;
                text-align: center;
                cursor: pointer;
                margin-left: 10px;
                font-size: 14px;
                transition: all 0.3s ease;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }
            
            .remove-friend-button:hover {
                background-color: #c82333;
                transform: scale(1.1);
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            }
        `;
        document.head.appendChild(style);

        // Cache'e kaydet
        localStorage.setItem(CACHE_KEY, JSON.stringify(friends));
        localStorage.setItem(`${CACHE_KEY}_time`, Date.now().toString());

        // Arkadaş listesini göster
        friends.forEach(friend => {
            const li = document.createElement('li');
            li.className = 'player-item';

            let buttonClass = 'davet-et-button';
            let buttonText = 'Davet Et';
            let isDisabled = false;

            if (friend.inDuel) {
                buttonClass = 'oyunda-button';
                buttonText = 'Oyunda';
                isDisabled = true;
            } else if (!friend.isOnline) {
                buttonClass = 'offline-button';
                buttonText = 'Çevrimdışı';
                isDisabled = true;
            }

            li.innerHTML = `
                <img src="${friend.photo}" alt="${friend.name}" class="player-photo">
                <span class="player-name">${friend.name} / (${friend.className})</span>
                <div style="display: flex; align-items: center;">
                    <button class="${buttonClass}" ${isDisabled ? 'disabled' : ''}>${buttonText}</button>
                    <button class="remove-friend-button" title="Arkadaşı Sil">✖</button>
                </div>
            `;

            if (!isDisabled) {
                const davetButton = li.querySelector(`.${buttonClass}`);
                davetButton.onclick = () => sendInvitation(friend);
            }

            const removeButton = li.querySelector('.remove-friend-button');
            removeButton.onclick = async (e) => {
                e.stopPropagation();
                if (await showConfirmation(`${friend.name} arkadaşlıktan çıkarılacak. Emin misiniz?`)) {
                    await removeFriend(friend.studentId);
                    await loadFriendsList();
                }
            };

            friendsList.appendChild(li);
        });

    } catch (error) {
        console.error('Arkadaş listesi yükleme hatası:', error);
        friendsList.innerHTML = '<div class="error">Liste yüklenirken bir hata oluştu</div>';
    }
}

// Cache'den arkadaş listesini gösterme fonksiyonu
async function displayCachedFriends(friends) {
    for (const friend of friends) {
        const li = document.createElement('li');
        li.className = 'player-item';

        let buttonClass = 'davet-et-button';
        let buttonText = 'Davet Et';
        let isDisabled = false;

        if (friend.inDuel) {
            buttonClass = 'oyunda-button';
            buttonText = 'Oyunda';
            isDisabled = true;
        } else if (!friend.isOnline) {
            buttonClass = 'offline-button';
            buttonText = 'Çevrimdışı';
            isDisabled = true;
        }

        li.innerHTML = `
            <img src="${friend.photo}" alt="${friend.name}" class="player-photo">
            <span class="player-name">${friend.name} / (${friend.className})</span>
            <div style="display: flex; align-items: center;">
                <button class="${buttonClass}" ${isDisabled ? 'disabled' : ''}>${buttonText}</button>
                <button class="remove-friend-button" title="Arkadaşı Sil">✖</button>
            </div>
        `;

        if (!isDisabled) {
            const davetButton = li.querySelector(`.${buttonClass}`);
            davetButton.onclick = () => sendInvitation(friend);
        }

        const removeButton = li.querySelector('.remove-friend-button');
        removeButton.onclick = async (e) => {
            e.stopPropagation();
            if (await showConfirmation(`${friend.name} arkadaşlıktan çıkarılacak. Emin misiniz?`)) {
                await removeFriend(friend.studentId);
                await loadFriendsList();
            }
        };

        friendsList.appendChild(li);
    }
}

// Arkadaş silme fonksiyonu
async function removeFriend(friendId) {
    try {
        // Her iki taraftan da arkadaşlığı kaldır
        await database.ref(`friendships/${selectedStudent.studentId}/${friendId}`).remove();
        await database.ref(`friendships/${friendId}/${selectedStudent.studentId}`).remove();
        await showAlert('Arkadaş başarıyla silindi!');
    } catch (error) {
        console.error('Arkadaş silme hatası:', error);
        await showAlert('Arkadaş silinirken bir hata oluştu!');
    }
}

function showConfirmation(message) {
    return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        `;

        const dialog = document.createElement('div');
        dialog.style.cssText = `
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 300px;
            width: 90%;
        `;

        dialog.innerHTML = `
            <p style="margin-bottom: 20px;">${message}</p>
            <button id="confirmYes" style="
                background: #dc3545;
                color: white;
                border: none;
                padding: 8px 20px;
                border-radius: 5px;
                margin-right: 10px;
                cursor: pointer;
            ">Evet</button>
            <button id="confirmNo" style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 8px 20px;
                border-radius: 5px;
                cursor: pointer;
            ">Hayır</button>
        `;

        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        const handleClick = (result) => {
            document.body.removeChild(overlay);
            resolve(result);
        };

        dialog.querySelector('#confirmYes').onclick = () => handleClick(true);
        dialog.querySelector('#confirmNo').onclick = () => handleClick(false);
    });
}




        backButtons.forEach(backButton => {
            backButton.addEventListener('click', () => {
                const currentScreen = backButton.parentElement;
                if(currentScreen.id === 'duel-selection-screen' && currentDuelRef) {
                    // Düello referansını kaldır ve sayfayı yenile
                    currentDuelRef.remove().then(() => {
                        // Her iki oyuncunun inDuel durumunu false yap
                        currentDuelRef.once('value').then(async (snapshot) => {
                            if (snapshot.exists()) {
                                const data = snapshot.val();
                                const inviterRef = database.ref(`classes/${data.inviter.classId}/students/${data.inviter.studentId}/inDuel`);
                                const invitedRef = database.ref(`classes/${data.invited.classId}/students/${data.invited.studentId}/inDuel`);
                                try {
                                    await inviterRef.set(false);
                                    await invitedRef.set(false);
                                } catch (error) {
                                    console.error("inDuel güncellenirken hata:", error);
                                }
                            }
                        });
                        currentDuelRef = null;
                        isInviter = false;
                        duelGameStarted = false;
                        window.location.reload();
                    }).catch(error => {
                        console.error("Düello referansı kaldırılırken hata:", error);
                        showAlert('Düello referansı kaldırılırken hata oluştu.');
                    });
                } else {
                    currentScreen.style.display = 'none';
                    mainScreen.style.display = 'flex';
                    resetGameScreens();
                }
            });
        });

        singlePlayerButton.addEventListener('click', () => {
            mainScreen.style.display = 'none';
            singlePlayerScreen.style.display = 'flex';
        });

        startGameButton.addEventListener('click', () => {
            const selectedClass = classSelect.value;
            const selectedSubject = subjectSelect.value;
            const selectedTopic = topicSelect.value;

            if (selectedClass && selectedSubject && selectedTopic) {
                fetchQuestions(selectedClass, selectedSubject, selectedTopic);
            } else {
                showAlert('Lütfen tüm alanları doldurunuz.');
            }
        });


        async function handlePasswordUpdate(classId, studentId) {
            const newPassword = await showPrompt('Yeni şifreyi giriniz:');
            if (newPassword !== null) {
                if (newPassword.trim() !== "") {
                    database.ref(`classes/${classId}/students/${studentId}/password`).set(newPassword.trim()).then(() => {
                        showAlert('Şifre oluşturuldu/güncellendi.');
                    }).catch(error => {
                        console.error("Şifre güncellenirken hata:", error);
                        showAlert('Şifre güncellerken hata oluştu.');
                    });
                } else {
                    showAlert('Şifre boş olamaz.');
                }
            }
        }



       // GÜNCELLENMİŞ HAL
function fetchChampionData() {
    const CACHE_KEY = 'cachedChampionData';
    const CACHE_TIMESTAMP_KEY = 'cachedChampionDataTimestamp';
    const CACHE_DURATION = 15 * 60 * 1000; // 15 dakika

    const cachedChampionData = localStorage.getItem(CACHE_KEY);
    const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
    const now = Date.now();

    if (cachedChampionData && cachedTimestamp) {
        const age = now - parseInt(cachedTimestamp, 10);
        if (age < CACHE_DURATION) {
            // Cache süresi dolmamış, veriyi kullan
            const parsedData = JSON.parse(cachedChampionData);
            populateChampionSelect(parsedData);
            return;
        } else {
            // Cache süresi dolmuş, temizle
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(CACHE_TIMESTAMP_KEY);
        }
    }

    // Cache yok veya süresi dolmuş, Firebase'den çek
    database.ref('championData/headings').once('value')
        .then(snapshot => {
            if (!snapshot.exists()) {
                console.warn("championData/headings boş.");
                return;
            }
            const result = [];
            snapshot.forEach(childSnapshot => {
                result.push({
                    id: childSnapshot.key,
                    name: childSnapshot.val().name || "No name"
                });
            });

            // localStorage’a kaydet
            localStorage.setItem(CACHE_KEY, JSON.stringify(result));
            localStorage.setItem(CACHE_TIMESTAMP_KEY, now.toString());

            // Seçime aktar
            populateChampionSelect(result);
        })
        .catch(error => {
            console.error("Sınıf bilgileri hata:", error);
        });
}

function populateChampionSelect(data) {
    // Önce mevcut seçenekleri temizleyin
    classSelect.innerHTML = '<option value="">Seçiniz</option>';

    data.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.name;
        classSelect.appendChild(option);
    });
}



async function fetchLessons(classId, subjectSelectElement) {
    const CACHE_KEY = `cachedLessons_${classId}`;
    const CACHE_TIMESTAMP_KEY = `cachedLessonsTimestamp_${classId}`;
    const CACHE_DURATION = 15 * 60 * 1000;

    // Select elementini temizle
    subjectSelectElement.innerHTML = '<option value="">Seçiniz</option>';
    if (!classId) return false;

    try {
        // Önce seçimleri Firebase'den kontrol et (davet edilen için)
        if (!isInviter && currentDuelRef) {
            const selectionsSnapshot = await currentDuelRef.child('selections').once('value');
            if (selectionsSnapshot.exists()) {
                const selections = selectionsSnapshot.val();
                if (selections.subject) {
                    // Cache'i kontrol et
                    const cachedLessons = localStorage.getItem(CACHE_KEY);
                    const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
                    const now = Date.now();

                    if (cachedLessons && cachedTimestamp && (now - parseInt(cachedTimestamp, 10)) < CACHE_DURATION) {
                        const parsedLessons = JSON.parse(cachedLessons);
                        populateLessonsSelect(parsedLessons, subjectSelectElement);
                        subjectSelectElement.value = selections.subject;
                        return true;
                    }
                }
            }
        }

        // Firebase'den dersleri çek
        const snapshot = await database.ref(`championData/headings/${classId}/lessons`).once('value');
        if (snapshot.exists()) {
            const lessonsData = [];
            snapshot.forEach(childSnapshot => {
                const lessonId = childSnapshot.key;
                const lessonName = childSnapshot.val().name || 'No name';
                lessonsData.push({ id: lessonId, name: lessonName });
            });

            // Cache'e kaydet
            localStorage.setItem(CACHE_KEY, JSON.stringify(lessonsData));
            localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());

            // Select'i doldur
            populateLessonsSelect(lessonsData, subjectSelectElement);

            // Davet edilen için seçili dersi ayarla
            if (!isInviter && currentDuelRef) {
                const selections = (await currentDuelRef.child('selections').once('value')).val();
                if (selections && selections.subject) {
                    subjectSelectElement.value = selections.subject;
                }
            }

            return true;
        }
        return false;
    } catch (error) {
        console.error("Dersler yüklenirken hata:", error);
        return false;
    }
}

async function fetchTopics(classId, lessonId, topicSelectElement) {
    const CACHE_KEY = `cachedTopics_${classId}_${lessonId}`;
    const CACHE_TIMESTAMP_KEY = `cachedTopicsTimestamp_${classId}_${lessonId}`;
    const CACHE_DURATION = 15 * 60 * 1000;

    topicSelectElement.innerHTML = '<option value="">Seçiniz</option>';
    if (!classId || !lessonId) return false;

    try {
        // Önce seçimleri Firebase'den kontrol et (davet edilen için)
        if (!isInviter && currentDuelRef) {
            const selectionsSnapshot = await currentDuelRef.child('selections').once('value');
            if (selectionsSnapshot.exists()) {
                const selections = selectionsSnapshot.val();
                if (selections.topic) {
                    // Cache'i kontrol et
                    const cachedTopics = localStorage.getItem(CACHE_KEY);
                    const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
                    const now = Date.now();

                    if (cachedTopics && cachedTimestamp && (now - parseInt(cachedTimestamp, 10)) < CACHE_DURATION) {
                        const parsedTopics = JSON.parse(cachedTopics);
                        populateTopicsSelect(parsedTopics, topicSelectElement);
                        topicSelectElement.value = selections.topic;
                        return true;
                    }
                }
            }
        }

        // Firebase'den konuları çek
        const snapshot = await database.ref(`championData/headings/${classId}/lessons/${lessonId}/topics`).once('value');
        if (snapshot.exists()) {
            const topicsData = [];
            snapshot.forEach(childSnapshot => {
                const v = childSnapshot.val() || {};
                if (v.active === false) return; // gizli konu
                const topicId = childSnapshot.key;
                const topicName = v.name || 'No name';
                topicsData.push({ id: topicId, name: topicName });
            });

            // Cache'e kaydet
            localStorage.setItem(CACHE_KEY, JSON.stringify(topicsData));
            localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());

            // Select'i doldur
            populateTopicsSelect(topicsData, topicSelectElement);

            // Davet edilen için seçili konuyu ayarla
            if (!isInviter && currentDuelRef) {
                const selections = (await currentDuelRef.child('selections').once('value')).val();
                if (selections && selections.topic) {
                    topicSelectElement.value = selections.topic;
                }
            }

            return true;
        }
        return false;
    } catch (error) {
        console.error("Konular yüklenirken hata:", error);
        return false;
    }
}

// populateSelect fonksiyonları aynı kalabilir
function populateLessonsSelect(lessonsData, subjectSelectElement) {
    lessonsData.forEach(lesson => {
        const option = document.createElement('option');
        option.value = lesson.id;
        option.textContent = lesson.name;
        subjectSelectElement.appendChild(option);
    });
}

function populateTopicsSelect(topicsData, topicSelectElement) {
    topicsData.forEach(topic => {
        const option = document.createElement('option');
        option.value = topic.id;
        option.textContent = topic.name;
        topicSelectElement.appendChild(option);
    });
}



        const singlePlayerSelects = singlePlayerScreen.querySelectorAll('select');
        singlePlayerSelects.forEach(select => {
            select.addEventListener('change', checkSinglePlayerSelections);
        });

        function checkSinglePlayerSelections() {
            let allSelected = true;
            singlePlayerSelects.forEach(select => {
                if (select.value === "") {
                    allSelected = false;
                }
            });

            if (allSelected) {
                startGameButton.classList.add('active');
                startGameButton.disabled = false;
            } else {
                startGameButton.classList.remove('active');
                startGameButton.disabled = true;
            }
        }

selectionClassSelect.addEventListener('change', () => {
    if (selectionClassSelect.value === "") {
        selectionNameInput.disabled = true;
        selectionNameInput.value = "";
    } else {
        selectionNameInput.disabled = false;
    }
    checkLoginButtonState();
});



function checkLoginButtonState() {
    if (selectionClassSelect.value !== "" && selectionNameInput.value.trim() !== "") {
        loginButton.classList.add('active');
        loginButton.disabled = false;
        studentPasswordInput.disabled = false;
    } else {
        loginButton.classList.remove('active');
        loginButton.disabled = true;
        studentPasswordInput.disabled = true;
        studentPasswordInput.value = '';
    }
}

        classSelect.addEventListener('change', () => {
            const selectedClass = classSelect.value;
            fetchLessons(selectedClass, subjectSelect);
        });

        subjectSelect.addEventListener('change', () => {
            const selectedClass = classSelect.value;
            const selectedLesson = subjectSelect.value;
            fetchTopics(selectedClass, selectedLesson, topicSelect);
        });

        function resetGameScreens() {
            // Tek Kişilik Oyun Ekranı
            singlePlayerSelects.forEach(select => {
                select.value = "";
            });
            startGameButton.classList.remove('active');
            startGameButton.disabled = true;

            scoreContainer.style.display = 'none';
            scoreDisplay.textContent = '';
            scoreMessage.textContent = '';
            scoreMessage.className = 'score-message';
            scoreImage.style.display = 'none';

            // Düello Oyun Ekranı
            duelQuestionNumber.textContent = 'Soru 1/10';
            duelProgressBarInner.style.width = '0%';
            duelTimerElement.textContent = '45';
            duelTimerElement.style.color = '#ff0000';

            // Yeni eklenen sıfırlamalar
            gameQuestions = [];
            currentQuestionIndex = 0;
            score = 0;
            clearInterval(timer);

            // Tek Kişilik Oyun Müziğini Durdur
            singlePlayerQuestionMusic.pause();
            singlePlayerQuestionMusic.currentTime = 0;

            // Düello Oyun Müziğini Durdur
            duelMusic.pause();
            duelMusic.currentTime = 0;
        }

// "Çıkış Yap" Butonunu Seçme
const logoutButton = document.getElementById('logout-button');

// "Çıkış Yap" Butonuna Event Listener Ekleme
logoutButton.addEventListener('click', async () => {
   try {
       // Önce seçili öğrencinin inDuel durumunu false yap
       if (selectedStudent && selectedStudent.classId && selectedStudent.studentId) {
           await database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/inDuel`).set(false);
       }

       // Düello referansını temizle
       if (currentDuelRef) {
           await currentDuelRef.remove();
           currentDuelRef = null;
       }

       // Kullanıcıya özel tüm cache'leri temizle
       if (selectedStudent?.studentId) {
           Object.values(CACHE_KEYS).forEach(key => {
               const userKey = getUserSpecificCacheKey(key);
               localStorage.removeItem(userKey);
           });
       }

       // localStorage'ı temizle
       localStorage.removeItem('selectedStudent');

       // Loggedin player'ı kaldır
       if (loggedinPlayerRef) {
           await loggedinPlayerRef.remove();
           console.log("Kullanıcı Firebase'den başarıyla kaldırıldı.");
       }

       // Sayfayı yenile
       window.location.reload();

   } catch (error) {
       console.error("Çıkış yaparken hata oluştu:", error);
       showAlert('Çıkış yaparken bir hata oluştu. Lütfen tekrar deneyin.');
   }
});


        function fetchQuestions(classId, subjectId, topicId) {
    const questionsRef = database.ref(`championData/headings/${classId}/lessons/${subjectId}/topics/${topicId}/questions`);
    questionsRef.once('value').then(snapshot => {
        if (snapshot.exists()) {
            const allQuestions = [];
            snapshot.forEach(childSnapshot => {
                const questionData = childSnapshot.val();
                // Soru yapısını uyumlu hale getiriyoruz
const formattedQuestion = {
    info: questionData.question.info || '',
    actualQuestion: questionData.question.text || questionData.question,
    question: questionData.question.text || questionData.question, // Düzeltilmiş
    correct: questionData.correct,
    wrong1: questionData.wrong1,
    wrong2: questionData.wrong2,
    explanation: (questionData.explanation || questionData.aciklama || questionData['açıklama'] || '')
};
                allQuestions.push(formattedQuestion);
            });

            if (allQuestions.length < (window.NOVA_Q_LIMIT||10)) {
                showAlert('Bu konuya ait yeterli soru yok.');
                return;
            }

            gameQuestions = shuffleArray(allQuestions).slice(0, (window.NOVA_Q_LIMIT||10));
            currentQuestionIndex = 0;
            score = 0;

            singlePlayerScreen.style.display = 'none';
            singlePlayerGameScreen.style.display = 'flex';
            scoreContainer.style.display = 'none';
            displayCurrentQuestion();

            // Tek Kişilik Oyun Müziğini Başlat
            singlePlayerQuestionMusic.currentTime = 0;
            singlePlayerQuestionMusic.play().catch(error => {
                console.error("Tek Kişilik Oyun Müziği Çalınamadı:", error);
            });
        } else {
            showAlert('Bu konuya ait soru bulunamadı.');
        }
    }).catch(error => {
        console.error("Sorular çekme hata:", error);
        showAlert('Sorular çekilirken hata oluştu.');
    });
}

        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

       function displayCurrentQuestion() {
    // Nova: clear explanation on new question
    (function(){var _e=document.getElementById('explanation-container'); if(_e){_e.style.display='none'; _e.innerHTML='';}})();

    if (currentQuestionIndex >= gameQuestions.length) {
        endGame();
        return;
    }

    const currentQuestion = gameQuestions[currentQuestionIndex];
    questionNumber.textContent = `Soru ${currentQuestionIndex + 1}/${window.NOVA_Q_LIMIT||10}`;
    const progressPercentage = ((currentQuestionIndex) / (window.NOVA_Q_LIMIT||10)) * 100;
    progressBarInner.style.width = `${progressPercentage}%`;

// Soru konteynerini temizle
const questionContainer = document.querySelector('.question-container');
questionContainer.innerHTML = '';

if (currentQuestion.question.startsWith('http')) {
  // Eğer soru resim URL'siyse
  const questionImage = document.createElement('img');
  questionImage.src = currentQuestion.question;
  questionImage.className = 'question-image';
  questionImage.style.display = 'block';
  questionImage.alt = "Soru resmi";
  questionContainer.appendChild(questionImage);

  if (currentQuestion.actualQuestion) {
    const questionTextDiv = document.createElement('div');
    questionTextDiv.className = 'question-text';
    questionTextDiv.textContent = currentQuestion.actualQuestion;
    questionContainer.appendChild(questionTextDiv);
  }
} else {
  // Metin şeklindeki soru için
  const textContainer = document.createElement('div');
textContainer.className = 'question-text-container';

// Eğer "info" alanı bir resim URL'si içeriyorsa (örneğin http://...png)
if (
  currentQuestion.info &&
  /^https?:\/\/.*\.(png|jpg|jpeg|gif)$/i.test(currentQuestion.info)
) {
  const infoImage = document.createElement('img');
  infoImage.src = currentQuestion.info;
  infoImage.alt = 'Bilgi resmi';
  infoImage.className = 'question-info-image'; // CSS ile boyutlandırma yapabilirsiniz
  textContainer.appendChild(infoImage);
} else {
  // Aksi halde, metin olarak göster
  const infoText = document.createElement('div');
  infoText.className = 'question-info-text';
  infoText.textContent = currentQuestion.info || '';
  textContainer.appendChild(infoText);
}

const divider = document.createElement('div');
divider.className = 'question-divider';
textContainer.appendChild(divider);

const questionText = document.createElement('div');
questionText.className = 'question-actual-text';
questionText.textContent = currentQuestion.question;
textContainer.appendChild(questionText);

questionContainer.appendChild(textContainer);

}

    // Seçenekleri oluştur
    const options = [
        { text: currentQuestion.correct, correct: true },
        { text: currentQuestion.wrong1, correct: false },
        { text: currentQuestion.wrong2, correct: false }
    ];
    
    const shuffledOptions = shuffleArray(options);
    optionsContainer.innerHTML = '';
    
    shuffledOptions.forEach(option => {
        const button = document.createElement('button');
        button.classList.add('option-button');
        button.textContent = option.text;
        button.dataset.correct = option.correct;
        button.addEventListener('click', selectOption);
        optionsContainer.appendChild(button);
    });

            // Görünürlük ayarları
            questionNumber.style.display = 'block';
            document.querySelector('.progress-container').style.display = 'block';
            document.querySelector('.timer-container').style.display = 'block';
            document.querySelector('.question-container').style.display = 'flex';
            optionsContainer.style.display = 'flex';

            // Timer'ı sıfırla ve başlat
            resetTimer();
            startTimer();
        }

        function selectOption(e) {
            const selectedButton = e.target;
            const isCorrect = selectedButton.dataset.correct === 'true';

            document.querySelectorAll('.option-button').forEach(button => {
                button.disabled = true;
                if (button !== selectedButton) {
                    button.classList.add('option-faded');
                } else {
                    button.classList.add('option-chosen');
                }
            });

            if (isCorrect) {
                selectedButton.classList.add('correct');
                score++;
            } else {
                selectedButton.classList.add('wrong');
                document.querySelectorAll('.option-button').forEach(button => {
                    if (button.dataset.correct === 'true') {
                        button.classList.add('correct');
                    }
                });
            }

            clearInterval(timer);

            showExplanationAndNext();
        }

function proceedToNextQuestion() {
    currentQuestionIndex++;
    const limit = Array.isArray(window.gameQuestions)
      ? window.gameQuestions.length
      : (window.NOVA_Q_LIMIT || 10);

    if (currentQuestionIndex < limit) {
        displayCurrentQuestion();
    } else {
        endGame();
    }
}


        function endGame() {
            questionNumber.style.display = 'none';
            document.querySelector('.progress-container').style.display = 'none';
            document.querySelector('.timer-container').style.display = 'none';
            document.querySelector('.question-container').style.display = 'none';
            optionsContainer.style.display = 'none';

            scoreContainer.style.display = 'flex';
try{ (function prune(){ const sc=document.querySelector('.single-player-game-container .score-container'); if(sc){ sc.querySelectorAll('div').forEach(n=>{ if(n.id==='score-message'||n.id==='score'||n.id==='score-image') return; const hasChildren=n.children&&n.children.length>0; const t=(n.textContent||'').trim(); if(!hasChildren && !t) n.remove(); }); } })(); }catch(e){};

const totalQ = Array.isArray(window.gameQuestions)
  ? window.gameQuestions.length
  : (window.NOVA_Q_LIMIT || 10);
scoreDisplay.textContent = `Doğru Sayısı: ${score}/${totalQ}`;

try{ document.getElementById('score')?.setAttribute('data-score', String(score)); }catch(e){}
window.score = score;
window.singleScore = score;
window.totalQuestions = totalQ; let message = '';

            let messageClass = '';
            let imageUrl = '';
            scoreMessage.style.display = 'block';

            if (score === 10) {
                message = 'ŞAHANE';
                messageClass = 'purple';
                imageUrl = 'https://i.giphy.com/YX8IKLsJJXagt5rZMV.webp';
            } else if (score >= 8 && score <= 9) {
                message = 'Gayet İyi';
                messageClass = 'green';
                imageUrl = 'https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExOHAxM2E0cGY1bmJxcXdvbDYxYXBrZjRncXV0dzJwMXZ4bzJ1bWxzNSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/AFmZwgpOXOqWwtcVve/giphy.webp';
            } else if (score >= 6 && score <= 7) {
                message = 'Daha iyisi olabilir.';
                messageClass = 'green';
                imageUrl = 'https://cdn.pixabay.com/photo/2019/10/28/14/35/emoticon-4584554_960_720.png';
            } else if (score >= 3 && score <= 5) {
                message = 'Kendini Geliştirmen Gerek.';
                messageClass = 'blue';
                imageUrl = 'https://cdn.pixabay.com/photo/2019/10/28/14/35/emoticon-4584554_960_720.png';
            } else {
                message = 'Başarısız Sonuç';
                messageClass = 'red';
                imageUrl = 'https://media.tenor.com/rPTWl04F5igAAAAM/byuntear-emoji.gif';
            }

            scoreMessage.textContent = message;
            if (messageClass !== '') {
                scoreMessage.classList.add(messageClass);
            } else {
                scoreMessage.textContent = '';
            }

            scoreImage.src = imageUrl;
            scoreImage.style.display = 'block';

            // Müzik çalma işlemi burada
            if (score > 9) { // Örneğin, belirli bir başarı düzeyinde müzik çalınır
                winnerMusic.currentTime = 0;
                winnerMusic.play().catch(error => {
                    console.error("Kazanan müziği çalınamadı:", error);
                });
            }
        
            // NOVA: Homework result writeback
            try {
                if (window.NOVA_ACTIVE_HOMEWORK) {
                    (async function(){
                        try{
                            var d = (typeof firebase!=='undefined' && firebase.database) ? firebase.database() : null;
                            var s = (typeof selectedStudent!=='undefined' && selectedStudent && selectedStudent.studentId) ? selectedStudent.studentId : null;
                            if(d && s){
                                var hw = window.NOVA_ACTIVE_HOMEWORK;
                                var total = Array.isArray(window.gameQuestions) ? window.gameQuestions.length : (window.NOVA_Q_LIMIT||10);
                                var correct = Number(window.score||0);
                                var startedAt = window.NOVA_HW_STARTED_AT || Date.now();
                                var finishedAt = Date.now();
                                var payload = { correct: correct, total: total, startedAt: startedAt, finishedAt: finishedAt, durationMs: Math.max(0, finishedAt - startedAt) };
                                await d.ref('homeworkResults/'+hw.hwId+'/'+s).set(payload);
                                await d.ref('studentHomework/'+s+'/'+hw.hwId).update({ status:'completed', completedAt: finishedAt, correct: correct, total: total });
                            }
                        }catch(e){ console.warn('Homework write failed', e); }
                        
                        // NOVA_HW_REWARD_HOOK: award diamonds once based on homework percent
                        try{
                          (async ()=>{
                            const hw = window.NOVA_ACTIVE_HOMEWORK;
                            const sObj = (typeof selectedStudent!=='undefined') ? selectedStudent : null;
                            if(hw && sObj && sObj.studentId && sObj.classId){
                              const totalQ = Array.isArray(window.gameQuestions) ? window.gameQuestions.length : (window.NOVA_Q_LIMIT||10);
                              const correctQ = Number(window.score||0);
                              await awardHomeworkDiamonds(hw.hwId, correctQ, totalQ, sObj);
                            }
                          })();
                        }catch(_){ console.warn('HW reward hook failed', _); }
finally{
                            window.NOVA_ACTIVE_HOMEWORK = null;
    // NOVA_HW_BACK_HOOK: Ensure back button is visible on results
    try{
      var endBtn = document.getElementById('final-back-button');
      if (endBtn) endBtn.style.display = 'inline-flex';
    }catch(_){}
    
                            window.NOVA_Q_LIMIT = null;
                            window.NOVA_HW_STARTED_AT = null;
                        }
                    })();
                }
            } catch(_){}
}

        // "Geri Dön" butonu için event listener
        finalBackButton.addEventListener('click', () => {
            // Müzikleri durdur
            stopAllMusic();

            // Ekranları sıfırla ve ana ekrana dön
            singlePlayerGameScreen.style.display = 'none';
            mainScreen.style.display = 'flex';
            resetGameScreens();
        });

        // Tüm müzikleri durdurma fonksiyonu
        function stopAllMusic() {
            if (!duelMusic.paused) {
                duelMusic.pause();
                duelMusic.currentTime = 0;
            }
            if (!winnerMusic.paused) {
                winnerMusic.pause();
                winnerMusic.currentTime = 0;
            }
            if (!singlePlayerQuestionMusic.paused) {
                singlePlayerQuestionMusic.pause();
                singlePlayerQuestionMusic.currentTime = 0;
            }
        }

        // Kupa Sıralaması Butonuna Event Listener (Yan Panel Açma)
        kupaSiralamaButton.addEventListener('click', () => {
            rankingPanel.classList.add('open');
            loadRanking(); // Sıralamayı yükle
        });

        // Ranking Back Button Event Listener (Yan Panel Kapatma)
        rankingBackButton.addEventListener('click', () => {
            rankingPanel.classList.remove('open');
        });

        // Bu event listener, düello oyununun sonunda "Oyunu Sonlandır" butonunu özel işlevle değiştirir.
        // "Oyunu Sonlandır" butonunun işlevi, önce uyarıyı gösterir, ardından eski işlevini sürdürür.
        // Ayrıca, kazanan ekranında müziğin çalmasını sağlar.
        // (Bu kısım artık düello bitişte kazanan ekranında müzik çaldığı için kaldırıldı)

        function resetTimer() {
            clearInterval(timer);
            timeLeft = 70;
            timerElement.textContent = timeLeft;
            timerElement.style.color = '#ff0000';
        }

        function startTimer() {
            timer = setInterval(() => {
                timeLeft--;
                timerElement.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    markQuestionAsWrong();
                    showExplanationAndNext();
                }
            }, 1000);
        }

        function markQuestionAsWrong() {
            document.querySelectorAll('.option-button').forEach(button => {
                if (button.dataset.correct === 'true') {
                    button.classList.add('correct');
                } else {
                    button.classList.add('wrong');
                }
                button.disabled = true;
            });
        }

        // GÜNCELLENMİŞ HAL
function fetchClassesForSelection() {
    const CACHE_KEY = 'cachedClasses';
    const CACHE_TIMESTAMP_KEY = 'cachedClassesTimestamp';
    const CACHE_DURATION = 15 * 60 * 1000; // 15 dakika

    const cachedClasses = localStorage.getItem(CACHE_KEY);
    const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
    const now = Date.now();

    if (cachedClasses && cachedTimestamp) {
        const age = now - parseInt(cachedTimestamp, 10);
        if (age < CACHE_DURATION) {
            // Cache süresi dolmamış, veriyi kullan
            const parsedClasses = JSON.parse(cachedClasses);
            populateClassSelect(parsedClasses);
            return;
        } else {
            // Cache süresi dolmuş, temizle
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(CACHE_TIMESTAMP_KEY);
        }
    }

    // Cache yok veya süresi dolmuş, Firebase'den çek
    database.ref('classes').once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                const classesData = [];
                snapshot.forEach(childSnapshot => {
                    const classId = childSnapshot.key;
                    const className = childSnapshot.val().name || classId;
                    classesData.push({ id: classId, name: className });
                });

                // LocalStorage'a kaydet
                localStorage.setItem(CACHE_KEY, JSON.stringify(classesData));
                localStorage.setItem(CACHE_TIMESTAMP_KEY, now.toString());

                // Seçime aktar
                populateClassSelect(classesData);
            } else {
                console.warn("Seçim için sınıf yok.");
            }
        })
        .catch(error => {
            console.error("Seçim için sınıf çekme hata:", error);
        });
}

// Doldurma fonksiyonu
function populateClassSelect(classesData) {
    // Önce mevcut seçenekleri temizleyin
    selectionClassSelect.innerHTML = '<option value="">Seçiniz</option>';
    
    classesData.forEach(cls => {
        const option = document.createElement('option');
        option.value = cls.id;
        option.textContent = cls.name;
        selectionClassSelect.appendChild(option);
    });
}



        // Alert fonksiyonu
        const alertOverlay = document.getElementById('alertOverlay');
        const alertMessage = document.getElementById('alertMessage');
        const alertOkButton = document.getElementById('alertOkButton');

        function showAlert(message, showButton = true) {
    alertMessage.textContent = message;
    alertOverlay.style.display = 'flex';
    alertOkButton.style.display = showButton ? 'block' : 'none';
    return new Promise(resolve => {
        if (showButton) {
            alertOkButton.onclick = () => {
                alertOverlay.style.display = 'none';
                resolve();
            };
        } else {
            resolve();
        }
    });
}

        // Prompt fonksiyonu
        const promptOverlay = document.getElementById('promptOverlay');
        const promptMessage = document.getElementById('promptMessage');
        const promptInput = document.getElementById('promptInput');
        const promptCancelButton = document.getElementById('promptCancelButton');
        const promptOkButton = document.getElementById('promptOkButton');

        function showPrompt(message) {
            promptMessage.textContent = message;
            promptInput.value = '';
            promptOverlay.style.display = 'flex';

            return new Promise(resolve => {
                promptOkButton.onclick = () => {
                    const val = promptInput.value;
                    promptOverlay.style.display = 'none';
                    resolve(val);
                };

                promptCancelButton.onclick = () => {
                    promptOverlay.style.display = 'none';
                    resolve(null);
                };
            });
        }

        // Davet Etme ve Dinleme
async function sendInvitation(player) {
    

        // --- INVITE BAN HARD GATE (ilk satırda kontrol) ---
        try {
            const inviterIdForBan = (selectedStudent && selectedStudent.studentId) || (currentStudent && currentStudent.studentId) || (auth && (auth ? auth : null).currentUser && (auth ? auth : null).currentUser.uid);
            const inviterClassForBan = (selectedStudent && selectedStudent.classId) || (currentClassId) || (currentStudent && currentStudent.classId);
            const banDataGate = await readInviteBan(inviterIdForBan, inviterClassForBan);
            if (banDataGate) {
                const expiresAtGate = banDataGate.expiresAt || 0;
                const nowGate = Date.now();
                if (expiresAtGate > nowGate) {
                    const remainingSecGate = Math.ceil((expiresAtGate - nowGate) / 1000);
                    if (typeof showAlert === 'function') {
                        await showAlert(`⚠️ Davet gönderemezsiniz. Kalan ceza süresi: ${remainingSecGate} saniye.`);
                    }
                    return; // kesin dönüş: daveti durdur
                }
            }
        } catch (eGate) {
            console.warn('Invite ban hard gate kontrolü sırasında hata:', eGate);
            // Hata olsa bile devam etmek yerine fail-safe davranalım:
            // Eğer policy gereği mutlaka engellemek istiyorsan burada return; bırak.
            // Şimdilik devam ediyoruz.
        }
        // --- /INVITE BAN HARD GATE ---
try {
        console.log("Davet gönderilmeye çalışılıyor, oyuncu:", player);

        // --- 1. Kredi Kontrolleri ---
        // Davet edenin kredi kontrolü
        const inviterCreditsSnap = await database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/duelCredits`).once('value');
        const inviterCredits = inviterCreditsSnap.exists() ? inviterCreditsSnap.val() : 0;
        if (inviterCredits < 0) {
            await showAlert('Düello başlatmak için en az 3 düello kredisine sahip olmalısınız.');
            return;
        }

        // Davet edilecek oyuncunun kredi kontrolü
        const invitedCreditsSnap = await database.ref(`classes/${player.classId}/students/${player.studentId}/duelCredits`).once('value');
        const invitedCredits = invitedCreditsSnap.exists() ? invitedCreditsSnap.val() : 0;
        if (invitedCredits < 0) {
            await showAlert(`${player.name} yeterli düello kredisine sahip değil.`);
            return;
        }
        // --- Kredi Kontrolleri Bitiş ---

        const inviterSnapshot = await database.ref('loggedinPlayers')
            .orderByChild('studentId')
            .equalTo(selectedStudent.studentId)
            .once('value');
            
        if (!inviterSnapshot.exists()) {
            showAlert('Bağlantı hatası! Lütfen tekrar giriş yapın.');
            return;
        }

        
        // --- Kupa farkı kontrolü (50'den fazlaysa davet engellenir) ---
// --- Davet gönderen üzerinde aktif invite ban var mı kontrol et ---
try {
    const inviterIdForBan = (selectedStudent && selectedStudent.studentId) || (currentStudent && currentStudent.studentId) || (auth && (auth ? auth : null).currentUser && (auth ? auth : null).currentUser.uid);
    const inviterClassForBan = (selectedStudent && selectedStudent.classId) || (currentClassId) || (currentStudent && currentStudent.classId);
    const banData = await readInviteBan(inviterIdForBan, inviterClassForBan);
    if (banData) {
        const expiresAt = banData.expiresAt || 0;
        const now = Date.now();
        if (expiresAt > now) {
            const remainingSec = Math.ceil((expiresAt - now) / 1000);
            if (typeof showAlert === 'function') {
                await showAlert(`⚠️ Davet gönderemezsiniz. Kalan ceza süresi: ${remainingSec} saniye.`);
            }
            return; // aktif ceza varken daveti engelle
        } else {
            // Süresi geçmişse temizle
            try { await database.ref(`inviteBans/${inviterIdForBan}`).remove(); } catch(_) {}
            if (inviterClassForBan) {
                try { await database.ref(`classes/${inviterClassForBan}/inviteBans/${inviterIdForBan}`).remove(); } catch(_) {}
            }
        }
    }
} catch (e) {
    console.error('inviteBan kontrolü sırasında hata:', e);
    // Hata olsa bile davet akışına devam edilebilir
}
// --- /invite ban kontrolü sonu ---
        try {
            const [inviterCupSnap, invitedCupSnap] = await Promise.all([
                database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/gameCup`).once('value'),
                database.ref(`classes/${player.classId}/students/${player.studentId}/gameCup`).once('value')
            ]);
            const inviterCup = inviterCupSnap.exists() ? inviterCupSnap.val() : 0;
            const invitedCup = invitedCupSnap.exists() ? invitedCupSnap.val() : 0;
            const cupDiff = Math.abs((inviterCup || 0) - (invitedCup || 0));
            if (cupDiff > 50) {
                await showAlert('⚠️ Aranızdaki kupa sayısı 50\'den fazla, davet gönderemezsiniz.');
                return;
            }
        } catch(e) {
            console.warn('Kupa farkı kontrolü yapılamadı:', e);
            await showAlert('⚠️ Kupa bilgileri alınamadı. Lütfen tekrar deneyin.');
            return;
        }
        // --- Kupa farkı kontrolü bitti ---
        console.log("Davet gönderilecek oyuncu ID:", player.studentId);
        const invitationPath = `invitations/${player.studentId}`;
        console.log("Davet path:", invitationPath);
        
        const invitationRef = database.ref(invitationPath);
        const activeInviteSnapshot = await invitationRef.once('value');
        
        if (activeInviteSnapshot.exists()) {
            showAlert('Bu oyuncu şu anda başka bir davet değerlendiriyor.');
            return;
        }

        // --- 2. Reddedilen Davet Kontrolü ---
        const rejectedInviteRef = database.ref('rejectedInvites')
            .orderByChild('inviterId')
            .equalTo(selectedStudent.studentId);
            
        const snapshot = await rejectedInviteRef.once('value');
        let canSendInvite = true;
        let remainingTime = 0;
        const updates = {};
        let needsUpdate = false;

        if (snapshot.exists()) {
            snapshot.forEach(child => {
                const invite = child.val();
                if (invite.invitedId === player.studentId) {
                    const timeDiff = Date.now() - invite.timestamp;
                    if (timeDiff < 30000) {
                        canSendInvite = false;
                        remainingTime = Math.ceil((30000 - timeDiff) / 1000);
                    } else {
                        // 30 saniyeyi geçen kayıtları silmek için işaretle
                        updates[child.key] = null;
                        needsUpdate = true;
                    }
                }
            });

            if (needsUpdate) {
                await database.ref('rejectedInvites').update(updates);
                // Kayıtlar silindiyse, daveti göndermeye izin ver
                canSendInvite = true;
            }
        }

        if (!canSendInvite) {
            showAlert(`Bu kişi davetinizi reddetti. ${remainingTime} sn sonra tekrar deneyiniz.`);
            return;
        }
        // --- Reddedilen Davet Kontrolü Bitiş ---

        const inDuelSnapshot = await database.ref(`classes/${player.classId}/students/${player.studentId}/inDuel`).once('value');
        const isInDuel = inDuelSnapshot.exists() ? inDuelSnapshot.val() : false;
        
        if (isInDuel) {
            showAlert(`${player.name} zaten bir düelloda!`);
            return;
        }

        const inviteData = {
            invitedByName: selectedStudent.studentName,
            invitedByClassId: selectedStudent.classId,
            invitedByStudentId: selectedStudent.studentId,
            invitedByPhoto: studentPhoto.src ? studentPhoto.src : "",
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        console.log("Gönderilecek davet verisi:", inviteData);
        await invitationRef.set(inviteData);
        console.log("Davet veritabanına yazıldı");

        // --- 3. Davet Gönderildikten Sonra Geri Sayım ---
        let timeLeft = 10;
        const alertOverlay = document.getElementById('alertOverlay');
        const countdownInterval = setInterval(() => {
            if (timeLeft > 0) {
                // İsteğe bağlı: İkinci parametre false verildiğinde showAlert buton olmadan sadece mesaj gösterir
                showAlert(`Davet gönderildi! ${timeLeft} saniye sonra kapanacak...`, false);
                timeLeft--;
            } else {
                clearInterval(countdownInterval);
                alertOverlay.style.display = 'none';
                invitationRef.remove().then(() => {
                    console.log("Davet zaman aşımı nedeniyle silindi");
                });
            }
        }, 1000);

        const unsubscribe = invitationRef.on('value', (snapshot) => {
            if (!snapshot.exists()) {
                clearInterval(countdownInterval);
                alertOverlay.style.display = 'none';
                invitationRef.off('value', unsubscribe);
            }
        });
        // --- Geri Sayım Bitiş ---
    } catch (error) {
        console.error("Davet gönderme hatası:", error);
        showAlert('Davet gönderilirken bir hata oluştu.');
    }
}

// Periyodik temizleme fonksiyonu - Bu fonksiyonu window.onload içinde çağırın
function startRejectedInvitesCleanup() {
    setInterval(async () => {
        try {
            const rejectedInvitesRef = database.ref('rejectedInvites');
            const snapshot = await rejectedInvitesRef.once('value');

            if (snapshot.exists()) {
                const updates = {};
                let hasExpired = false;

                snapshot.forEach(child => {
                    const invite = child.val();
                    if (Date.now() - invite.timestamp > 30000) {
                        updates[child.key] = null;
                        hasExpired = true;
                    }
                });

                if (hasExpired) {
                    await rejectedInvitesRef.update(updates);
                }
            }
        } catch (error) {
            console.error("Temizleme hatası:", error);
        }
    }, 5000); // Her 5 saniyede bir kontrol
}

        function startInvitationListener(studentId) {
   const invitationRef = database.ref(`invitations/${studentId}`);
   
   // Mevcut dinleyiciyi temizle
   invitationRef.off();

   // Eski reddedilen davetleri temizle
   cleanupOldRejectedInvites(studentId);
   
   // Davetleri dinle
   invitationRef.on('value', async snapshot => {
       try {
           if (snapshot.exists()) {
               const data = snapshot.val();
               
               // Davet zaten değerlendirilmiş veya timeout olmuşsa çık
               if (!data || (data.timestamp && (Date.now() - data.timestamp) > 10000)) {
                   await invitationRef.remove();
                   invitationOverlay.style.display = 'none';
                   return;
               }

               // Reddedilen davet kontrolü
               const rejectedInviteRef = database.ref('rejectedInvites')
                   .orderByChild('inviterId')
                   .equalTo(data.invitedByStudentId);

               const rejectedSnapshot = await rejectedInviteRef.once('value');
               let isRejected = false;

               if (rejectedSnapshot.exists()) {
                   rejectedSnapshot.forEach(child => {
                       const invite = child.val();
                       if (invite.invitedId === studentId) {
                           const timeDiff = Date.now() - invite.timestamp;
                           if (timeDiff >= 30000) {
                               database.ref(`rejectedInvites/${child.key}`).remove();
                           } else {
                               isRejected = true;
                           }
                       }
                   });
               }

               if (isRejected) {
                   await invitationRef.remove();
                   invitationOverlay.style.display = 'none';
                   return;
               }
               
               // Davet gönderenin online durumunu kontrol et
               const inviterOnlineSnapshot = await database.ref('loggedinPlayers')
                   .orderByChild('studentId')
                   .equalTo(data.invitedByStudentId)
                   .once('value');
                   
               if (!inviterOnlineSnapshot.exists()) {
                   await invitationRef.remove();
                   invitationOverlay.style.display = 'none';
                   return;
               }
               
               // Davet gönderen düelloda mı kontrol et
               const inDuelSnapshot = await database.ref(`classes/${data.invitedByClassId}/students/${data.invitedByStudentId}/inDuel`).once('value');
               if (inDuelSnapshot.val()) {
                   await invitationRef.remove();
                   invitationOverlay.style.display = 'none';
                   return;
               }
               
               // Eğer geçerli bir davetse göster
               currentInvitation = { ...data };
               showInvitationModal(data);
               
               // 10 saniyelik geri sayım
               let timeLeft = 10;
               const countdownInterval = setInterval(() => {
                   // Eğer overlay kapalıysa interval'i temizle
                   if (invitationOverlay.style.display !== 'flex') {
                       clearInterval(countdownInterval);
                       return;
                   }
                   
                   // Eski countdown elementini bul ve kaldır
                   const oldCountdown = document.querySelector('.countdown-text');
                   if (oldCountdown) {
                       oldCountdown.remove();
                   }
                   
                   if (timeLeft > 0) {
                       const countdownElement = document.createElement('div');
                       countdownElement.textContent = `${timeLeft} saniye kaldı`;
                       countdownElement.className = 'countdown-text';
                       countdownElement.style.marginTop = '10px';
                       countdownElement.style.color = timeLeft <= 5 ? '#ff0000' : '#000000';
                       invitationMessage.parentElement.appendChild(countdownElement);
                       timeLeft--;
                   } else {
                       clearInterval(countdownInterval);
                       invitationRef.remove();
                       invitationOverlay.style.display = 'none';
                   }
               }, 1000);
           } else {
               // Davet yoksa veya silindiyse overlay'i kapat
               if (invitationOverlay.style.display === 'flex') {
                   invitationOverlay.style.display = 'none';
               }
               currentInvitation = null;
           }
       } catch (error) {
           console.error("Davet işleme hatası:", error);
           invitationOverlay.style.display = 'none';
           currentInvitation = null;
       }
   });

   // Düello dinleyicileri
   const duelInviterRef = database.ref('duels').orderByChild('inviter/studentId').equalTo(studentId);
   const duelInvitedRef = database.ref('duels').orderByChild('invited/studentId').equalTo(studentId);
   
   // Mevcut dinleyicileri temizle
   duelInviterRef.off();
   duelInvitedRef.off();
   
   // Yeni dinleyicileri ekle
   duelInviterRef.on('child_added', snapshot => {
       if (!currentDuelRef) {
           currentDuelRef = snapshot.ref;
           isInviter = true;
           switchToDuelScreen(snapshot.key);
       }
   });

   duelInvitedRef.on('child_added', snapshot => {
       if (!currentDuelRef) {
           currentDuelRef = snapshot.ref;
           isInviter = false;
           switchToDuelScreen(snapshot.key);
       }
   });

   // Düello silinme dinleyicisi
   database.ref('duels').on('child_removed', snapshot => {
       if (currentDuelRef && snapshot.key === currentDuelRef.key && !duelEnded) {
           showAlert('...').then(() => window.location.reload());
       }
   });
}

function showInvitationModal(data) {
   invitationMessage.textContent = `${data.invitedByName} (${classNameMap[data.invitedByClassId] ? classNameMap[data.invitedByClassId] : data.invitedByClassId}) seni düelloya davet ediyor.`;
   invitationOverlay.style.display = 'flex';
}

const invitationDeclineButton = document.getElementById('invitationDeclineButton');
const invitationAcceptButton = document.getElementById('invitationAcceptButton');

invitationDeclineButton.addEventListener('click', async () => {
   if (!currentInvitation) {
       console.error("Geçerli davet bulunamadı");
       return;
   }

   try {
       // Önce reddedilen daveti kaydet
       await database.ref('rejectedInvites').push().set({
           inviterId: currentInvitation.invitedByStudentId,
           invitedId: selectedStudent.studentId,
           timestamp: Date.now()
       });

       // Davet referansını oluştur ve kaldır
       const invitationRef = database.ref(`invitations/${selectedStudent.studentId}`);
       await invitationRef.remove();

       // Overlay'i kapat
       invitationOverlay.style.display = 'none';
       
       // currentInvitation'ı temizle
       currentInvitation = null;

       await showAlert('Davet reddedildi');

   } catch (error) {
       console.error("Davet reddetme hatası:", error);
       await showAlert('Davet reddedilirken hata oluştu: ' + error.message);
   }
});

async function cleanupRejectedInvites() {
   const thirtySecondsAgo = Date.now() - 30000;
   const rejectedInvitesRef = database.ref('rejectedInvites');
   const oldInvitesSnapshot = await rejectedInvitesRef
       .orderByChild('timestamp')
       .endAt(thirtySecondsAgo)
       .once('value');

   if (oldInvitesSnapshot.exists()) {
       const updates = {};
       oldInvitesSnapshot.forEach(child => {
           updates[child.key] = null;
       });
       await rejectedInvitesRef.update(updates);
   }
}

// Eski reddedilen davetleri temizleme helper fonksiyonu
async function cleanupOldRejectedInvites(studentId) {
   try {
       const rejectedInvitesRef = database.ref('rejectedInvites');
       const snapshot = await rejectedInvitesRef
           .orderByChild('invitedId')
           .equalTo(studentId)
           .once('value');

       if (snapshot.exists()) {
           const updates = {};
           snapshot.forEach(child => {
               const invite = child.val();
               if (Date.now() - invite.timestamp >= 30000) {
                   updates[child.key] = null;
               }
           });
           
           if (Object.keys(updates).length > 0) {
               await rejectedInvitesRef.update(updates);
           }
       }
   } catch (error) {
       console.error("Eski reddedilen davetleri temizlerken hata:", error);
   }
}

// Her 30 saniyede bir temizlik yap
setInterval(cleanupRejectedInvites, 30000);

invitationAcceptButton.addEventListener('click', async () => {
    // --- Kupa farkı kontrolü (accept tarafı) ---
    try {
        const inviterId = currentInvitation.invitedByStudentId;
        const inviterClassId = currentInvitation.invitedByClassId;
        const invitedId = selectedStudent.studentId;
        const invitedClassId = selectedStudent.classId;
        const [inviterCupSnap, invitedCupSnap] = await Promise.all([
            database.ref(`classes/${inviterClassId}/students/${inviterId}/gameCup`).once('value'),
            database.ref(`classes/${invitedClassId}/students/${invitedId}/gameCup`).once('value')
        ]);
        const inviterCup = inviterCupSnap.exists() ? inviterCupSnap.val() : 0;
        const invitedCup = invitedCupSnap.exists() ? invitedCupSnap.val() : 0;
        const cupDiff = Math.abs((inviterCup || 0) - (invitedCup || 0));
        if (cupDiff > 50) {
            await showAlert('⚠️ Aranızdaki kupa sayısı 50\'den fazla, daveti kabul edemezsiniz.');
            try { await database.ref(`invitations/${selectedStudent.studentId}`).remove(); } catch(e) {}
            invitationOverlay.style.display = 'none';
            currentInvitation = null;
            return;
        }
    } catch(e) {
        console.warn('Kupa farkı kontrolü (accept) yapılamadı:', e);
        await showAlert('⚠️ Kupa bilgileri alınamadı. Lütfen tekrar deneyin.');
        return;
    }
    // --- Kupa farkı kontrolü bitti ---
    
   if (currentInvitation && selectedStudent.studentId) {
       try {
           // Önce davet gönderen kişinin hala online olup olmadığını kontrol et
           const inviterOnlineSnapshot = await database.ref('loggedinPlayers')
               .orderByChild('studentId')
               .equalTo(currentInvitation.invitedByStudentId)
               .once('value');
               
           if (!inviterOnlineSnapshot.exists()) {
               await database.ref(`invitations/${selectedStudent.studentId}`).remove();
               invitationOverlay.style.display = 'none';
               currentInvitation = null;
               showAlert('Davet gönderen oyuncu artık çevrimiçi değil!');
               return;
           }

           const inDuelSnap = await database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/inDuel`).once('value');
           const isInDuel = inDuelSnap.exists() ? inDuelSnap.val() : false;

           if (isInDuel) {
               showAlert(`Zaten bir düellodasın!`);
               invitationOverlay.style.display = 'none';
               currentInvitation = null;
               return;
           }

           playersOverlay.style.display = 'none';
           invitationOverlay.style.display = 'none';
           
           await createDuelSession(
               currentInvitation.invitedByStudentId, 
               currentInvitation.invitedByClassId, 
               currentInvitation.invitedByName, 
               currentInvitation.invitedByPhoto
           );
           await database.ref(`invitations/${selectedStudent.studentId}`).remove();
       } catch (error) {
           console.error("Düello başlatılırken hata:", error);
           showAlert('Düello başlatılırken bir hata oluştu.');
       }
   }
});


const cupStyle = document.createElement('style');
cupStyle.textContent = `
    .duel-player-cup {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        margin-top: 8px;
        padding: 5px 10px;
        background: linear-gradient(135deg, #ffd700, #ffa500);
        border-radius: 15px;
        box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        animation: cupGlow 2s infinite alternate;
    }

    .duel-player-cup .cup-icon {
        font-size: 1.2em;
        animation: cupBounce 2s infinite ease-in-out;
    }

    .duel-player-cup .cup-value {
        font-weight: bold;
        color: #fff;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    @keyframes cupGlow {
        from {
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }
        to {
            box-shadow: 0 2px 12px rgba(255, 215, 0, 0.6);
        }
    }

    @keyframes cupBounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-3px); }
    }
`;
document.head.appendChild(cupStyle);

// Düello başlatma fonksiyonunu güncelle
async function createDuelSession(inviterId, inviterClassId, inviterName, inviterPhoto) {
    const duelRef = database.ref('duels').push();
    
    // Her iki oyuncunun inDuel durumunu izleyen referansları oluştur
    const inviterInDuelRef = database.ref(`classes/${inviterClassId}/students/${inviterId}/inDuel`);
    const invitedInDuelRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/inDuel`);
    
    // Bağlantı kesildiğinde inDuel durumlarını false yap
    inviterInDuelRef.onDisconnect().set(false);
    invitedInDuelRef.onDisconnect().set(false);

    // Kupa değerlerini al
    const inviterCupRef = database.ref(`classes/${inviterClassId}/students/${inviterId}/gameCup`);
    const invitedCupRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/gameCup`);
    
    const [inviterCupSnap, invitedCupSnap] = await Promise.all([
        inviterCupRef.once('value'),
        invitedCupRef.once('value')
    ]);

    await duelRef.set({
        inviter: {
            classId: inviterClassId,
            studentId: inviterId,
            name: inviterName,
            photo: inviterPhoto,
            gameCup: inviterCupSnap.val() || 0
        },
        invited: {
            classId: selectedStudent.classId,
            studentId: selectedStudent.studentId,
            name: selectedStudent.studentName,
            photo: (studentPhoto.src && studentPhoto.src !== "") ? studentPhoto.src : "",
            gameCup: invitedCupSnap.val() || 0
        },
        selections: {
            class: "",
            subject: "",
            topic: ""
        },
        gameStarted: false,
        questions: []
    });

    // İki oyuncunun da inDuel durumunu true yap
    await inviterInDuelRef.set(true);
    await invitedInDuelRef.set(true);

    // Bağlantı kesildiğinde düelloyu sil
    duelRef.onDisconnect().remove();

    currentDuelRef = duelRef;
    isInviter = false;
    switchToDuelScreen(duelRef.key);
}






// ----- 1. Otomatik seçim fonksiyonu -----
function autoSelectDuelSelections() {
  // Öncelikle mevcut sınıf değerini alıyoruz
  const classId = duelClassSelect.value;
  if (!classId) {
    console.error("duelClassSelect değeri boş!");
    return;
  }
  
  // Dersleri çekmek için fetchLessons fonksiyonunu kullanın
  // fetchLessons(classId, subjectSelectElement) mevcut kodunuzda dersleri dolduruyor.
  fetchLessons(classId, duelSubjectSelect).then(() => {
    // "Seçiniz" hariç, ders seçeneklerini alalım
    const lessonOptions = Array.from(duelSubjectSelect.options).filter(opt => opt.value !== "");
    if (lessonOptions.length === 0) {
      console.error("Hiç ders bulunamadı!");
      return;
    }
    // Rastgele bir ders seçelim
    const randomLesson = lessonOptions[Math.floor(Math.random() * lessonOptions.length)];
    duelSubjectSelect.value = randomLesson.value;
    
    // Eğer davet eden taraf iseniz, seçimi veritabanına yansıtın
    if (isInviter) {
      updateDuelSelection('subject', randomLesson.value);
    }
    const selectedLessonName = randomLesson.textContent;
    
    // Şimdi, seçilen derse ait konuları çekelim
    fetchTopics(classId, randomLesson.value, duelTopicSelect).then(() => {
      const topicOptions = Array.from(duelTopicSelect.options).filter(opt => opt.value !== "");
      if (topicOptions.length === 0) {
        console.error("Hiç konu bulunamadı!");
        return;
      }
      // Rastgele bir konu seçelim
      const randomTopic = topicOptions[Math.floor(Math.random() * topicOptions.length)];
      duelTopicSelect.value = randomTopic.value;
      
      if (isInviter) {
        updateDuelSelection('topic', randomTopic.value);
      }
      const selectedTopicName = randomTopic.textContent;
      
      // Seçilen ders ve konuyu animasyonlu şekilde göster
      animateDuelSelection(selectedLessonName, selectedTopicName);
      
      // 10 saniyelik geri sayım başlat
      startDuelAutoCountdown();
    });
  });
}

// ----- 2. Seçimi animasyonlu gösterme fonksiyonu -----
function animateDuelSelection(lessonName, topicName) {

}

// ----- 3. 10 Saniyelik geri sayım ve otomatik düello başlatma fonksiyonu -----
function startDuelAutoCountdown() {
  const countdownEl = document.getElementById('duelCountdown');
  let timeLeft = 10; // Geri sayım süresi: 10 saniye
  countdownEl.textContent = timeLeft;
  
  const autoTimer = setInterval(() => {
    timeLeft--;
    countdownEl.textContent = timeLeft;
    
    // (İsteğe bağlı: Geri sayım sırasında renk veya başka efektler ekleyebilirsiniz)
    if (timeLeft <= 0) {
      clearInterval(autoTimer);
      // Geri sayım bittiğinde, otomatik olarak düello başlatmak için:
      duelStartButton.click();
    }
  }, 1000);
}










function switchToDuelScreen(duelKey) {
    // Diğer ekranları gizle
    mainScreen.style.display = 'none';
    singlePlayerScreen.style.display = 'none';
    singlePlayerGameScreen.style.display = 'none';
    friendsScreen.style.display = 'none';
    rankingPanel.classList.remove('open');
    playersOverlay.style.display = 'none';
    
    // Body genel ayarları
    document.body.style.display = 'flex';
    document.body.style.justifyContent = 'center';
    document.body.style.alignItems = 'center';
    document.body.style.minHeight = '100vh';
    
    // Duel seçim ekranı stil ayarları
    duelSelectionScreen.style.display = 'flex';
    duelSelectionScreen.style.flexDirection = 'column';
    duelSelectionScreen.style.width = '100%';
    duelSelectionScreen.style.maxWidth = '900px';
    duelSelectionScreen.style.background = 'white';
    duelSelectionScreen.style.padding = '30px 40px';
    duelSelectionScreen.style.borderRadius = '20px';
    duelSelectionScreen.style.boxShadow = '0 15px 35px rgba(0, 0, 0, 0.2)';
    duelSelectionScreen.classList.add('container');

    const duelRef = database.ref(`duels/${duelKey}`);
    let inviterId, inviterClassId, invitedId, invitedClassId;
    let countdownInterval;
    
    duelRef.once('value').then(initialSnap => {
        if (initialSnap.exists()) {
            const initialData = initialSnap.val();
            inviterId = initialData.inviter.studentId;
            inviterClassId = initialData.inviter.classId;
            invitedId = initialData.invited.studentId;
            invitedClassId = initialData.invited.classId;
            
            // Nova: update framed stars under names in selection panel
            try {
                Promise.all([
                    database.ref(`classes/${inviterClassId}/students/${inviterId}/duelCredits`).once('value'),
                    database.ref(`classes/${invitedClassId}/students/${invitedId}/duelCredits`).once('value')
                ]).then(function(snaps){
                    var invCountSnap = snaps[0], inCountSnap = snaps[1];
                    var invCount = invCountSnap && invCountSnap.exists() ? invCountSnap.val() : 0;
                    var inCount  = inCountSnap && inCountSnap.exists()  ? inCountSnap.val()  : 0;
                    var invStarsEl = document.getElementById('duel-inviter-stars');
                    var inStarsEl  = document.getElementById('duel-invited-stars');
                    if (invStarsEl) invStarsEl.innerHTML = getStars(invCount);
                    if (inStarsEl)  inStarsEl.innerHTML  = getStars(inCount);
                     var invRankEl = document.getElementById('duel-inviter-rank'); if (invRankEl) invRankEl.innerHTML = getRankHTML(invCount);
                     var inRankEl = document.getElementById('duel-invited-rank'); if (inRankEl) inRankEl.innerHTML = getRankHTML(inCount);
                }).catch(function(e){
                    console.warn('Yıldızlar (selection) yüklenemedi:', e);
                });
            } catch(e) {
                console.warn('Yıldızlar (selection) yüklenemedi:', e);
            }

            
            // --- Kredilerin Düşürülmesi İşlemi ---
            // Eğer henüz kredi düşülmemişse (creditsDeducted yoksa)
            if (!initialData.creditsDeducted) {
                Promise.all([
                    database.ref(`classes/${inviterClassId}/students/${inviterId}/duelCredits`).once('value'),
                    database.ref(`classes/${invitedClassId}/students/${invitedId}/duelCredits`).once('value')
                ]).then(([inviterCreditsSnap, invitedCreditsSnap]) => {
                    const inviterCredits = inviterCreditsSnap.exists() ? inviterCreditsSnap.val() : 0;
                    const invitedCredits = invitedCreditsSnap.exists() ? invitedCreditsSnap.val() : 0;
                    
                    if (inviterCredits < 0 || invitedCredits < 0) {
                        showAlert('Düello başlatmak için her iki tarafın da en az 3 düello kredisine sahip olması gerekmektedir.')
                            .then(() => {
                                // Yetersiz kredi varsa duel oturumunu kaldırıp sayfayı yenile
                                duelRef.remove();
                                window.location.reload();
                            });
                        return;
                    } else {
                        // Kredileri 3 eksiltelim
                        database.ref(`classes/${inviterClassId}/students/${inviterId}/duelCredits`)
                            .set((inviterCredits || 0) + 1);
                        database.ref(`classes/${invitedClassId}/students/${invitedId}/duelCredits`)
                            .set((invitedCredits || 0) + 1);
                        // Tekrar kredi düşülmesini engellemek için bayrak ekleyelim
                        duelRef.child('creditsDeducted').set(true);
                    }
                });
            }
            // --- Kredilerin Düşürülmesi Bitti ---
            
            // Sonrasında diğer seçim ekranı ayarlarını yapıyoruz
            database.ref(`classes/${selectedStudent.classId}`).once('value').then(classSnapshot => {
                if (classSnapshot.exists()) {
                    const studentClassName = classSnapshot.val().name;

                    // championData'dan sınıf verilerini çek ve eşleştir
                    database.ref('championData/headings').once('value').then(async snapshot => {
                        duelClassSelect.innerHTML = '<option value="">Seçiniz</option>';
                        if (snapshot.exists()) {
                            snapshot.forEach(childSnapshot => {
                                const classId = childSnapshot.key;
                                const championClassName = childSnapshot.val().name;
                                
                                // Eğer kullanıcının sınıf adı ile championData eşleşiyorsa
                                if (championClassName === studentClassName) {
                                    const option = document.createElement('option');
                                    option.value = classId;
                                    option.textContent = championClassName;
                                    duelClassSelect.appendChild(option);
                                    duelClassSelect.value = classId; // Otomatik seç

                                    if (isInviter) {
                                        // Davet eden için: dersleri yükle ve otomatik seçim yap
                                        fetchLessons(classId, duelSubjectSelect);
                                        autoSelectDuelSelections();
                                    } else {
                                        // Davet edilen için: selections verisini sürekli dinle
                                        currentDuelRef.child('selections').on('value', async selectionsSnapshot => {
                                            console.log("Selections changed:", selectionsSnapshot.val());
                                            if (selectionsSnapshot.exists() && selectionsSnapshot.val().subject) {
                                                setTimeout(async () => {
                                                    await fetchLessons(classId, duelSubjectSelect);
                                                    duelSubjectSelect.value = selectionsSnapshot.val().subject;
                                                    
                                                    if (selectionsSnapshot.val().topic) {
                                                        await fetchTopics(classId, selectionsSnapshot.val().subject, duelTopicSelect);
                                                        duelTopicSelect.value = selectionsSnapshot.val().topic;
                                                    } else {
                                                        duelTopicSelect.value = "";
                                                    }
                                                }, 300);
                                            } else {
                                                duelSubjectSelect.value = "";
                                                duelTopicSelect.value = "";
                                            }
                                        });
                                    }
                                }
                            });
                        }
                    });
                }
            });



// Ana countdown kodunu güncelleyelim
const countdownEl = document.getElementById('duelCountdown');
let timeLeft = 10; // 10 saniyeye düşürüldü

countdownInterval = setInterval(() => {
    timeLeft--;
    countdownEl.textContent = timeLeft;
    
    // Renk değişimleri güncellendi
    if (timeLeft > 7) {
        countdownEl.className = 'countdown green';
    } else if (timeLeft > 3) {
        countdownEl.className = 'countdown orange';
    } else {
        countdownEl.className = 'countdown red';
    }
    
    // Süre bittiğinde sadece interval'i temizle
    if (timeLeft <= 0) {
        clearInterval(countdownInterval);
        countdownEl.textContent = '0';
    }
}, 1000);


duelRef.child('gameStarted').on('value', snapshot => {
    if (snapshot.val() === true && countdownInterval) {
        clearInterval(countdownInterval);
        const countdownEl = document.getElementById('duelCountdown');
        if (countdownEl) countdownEl.style.display = 'none';
    }
});



        
        // Sadece davet eden kişinin ismini göster
        const selectingStudentBanner = document.getElementById('selecting-student-banner');
        selectingStudentBanner.textContent = `Düello Başlıyor`;
        selectingStudentBanner.style.display = 'block';
    }
});

    duelRef.onDisconnect().remove();

    database.ref('championData/headings').once('value').then(snapshot => {
        duelClassSelect.innerHTML = '<option value="">Seçiniz</option>';
        if (snapshot.exists()) {
            snapshot.forEach(childSnapshot => {
                const classId = childSnapshot.key;
                const className = childSnapshot.val().name || 'No name';
                const option = document.createElement('option');
                option.value = classId;
                option.textContent = className;
                duelClassSelect.appendChild(option);
            });
        }
    }).catch(error => {
        console.error("Sınıf verileri yüklenirken hata:", error);
        showAlert('Sınıf verileri yüklenirken bir hata oluştu.');
    });












async function syncDuelSelections(data) {
    if (!data.selections) return;
    
    try {
        // Sınıf seçimini güncelle
        if (data.selections.class) {
            duelClassSelect.value = data.selections.class;
            
            // Dersleri yükle
            await fetchLessons(data.selections.class, duelSubjectSelect);
            
            // Ders seçimini güncelle
            if (data.selections.subject) {
                duelSubjectSelect.value = data.selections.subject;
                
                // Konuları yükle
                await fetchTopics(data.selections.class, data.selections.subject, duelTopicSelect);
                
                // Konu seçimini güncelle
                if (data.selections.topic) {
                    duelTopicSelect.value = data.selections.topic;
                }
            }
        }
    } catch (error) {
        console.error("Seçimler senkronize edilirken hata:", error);
    }
}














duelRef.on('value', async (snap) => {
    if (snap.exists()) {
        const data = snap.val();
        
        // Oyuncu bilgilerini güncelle
        duelInviterPhoto.src = data.inviter.photo || "https://via.placeholder.com/80";
        duelInviterName.textContent = data.inviter.name;
        duelInvitedPhoto.src = data.invited.photo || "https://via.placeholder.com/80";
        duelInvitedName.textContent = data.invited.name;

        // Kupa değerlerini güncelle
        const inviterInfo = document.getElementById('duel-inviter-info');
        const invitedInfo = document.getElementById('duel-invited-info');

        // Mevcut kupaları temizle
        const existingCups = document.querySelectorAll('.duel-player-cup');
        existingCups.forEach(cup => cup.remove());

        // Yeni kupa elementlerini ekle
        const inviterCup = document.createElement('div');
        inviterCup.className = 'duel-player-cup';
        inviterCup.innerHTML = `
            <span class="cup-icon">🏆</span>
            <span class="cup-value">${data.inviter.gameCup}</span>
        `;
        inviterInfo.appendChild(inviterCup);

        const invitedCup = document.createElement('div');
        invitedCup.className = 'duel-player-cup';
        invitedCup.innerHTML = `
            <span class="cup-icon">🏆</span>
            <span class="cup-value">${data.invited.gameCup}</span>
        `;
        invitedInfo.appendChild(invitedCup);

        // Select elementlerini devre dışı bırak
        [duelClassSelect, duelSubjectSelect, duelTopicSelect].forEach(select => {
            select.disabled = true;
            select.style.pointerEvents = 'none';
            select.style.cursor = 'not-allowed';
            select.style.opacity = '0.7';
        });

        // Seçimleri senkronize et
        if (data.selections) {
            try {
                // Sınıf seçimini güncelle
                if (data.selections.class) {
                    duelClassSelect.value = data.selections.class;
                    
                    // Dersleri yükle ve senkronize et
                    const lessonsLoaded = await fetchLessons(data.selections.class, duelSubjectSelect);
                    if (lessonsLoaded && data.selections.subject) {
                        duelSubjectSelect.value = data.selections.subject;
                        
                        // Konuları yükle ve senkronize et
                        const topicsLoaded = await fetchTopics(data.selections.class, data.selections.subject, duelTopicSelect);
                        if (topicsLoaded && data.selections.topic) {
                            duelTopicSelect.value = data.selections.topic;
                        }
                    }
                }

                // Davet edilen oyuncu için seçenekleri doldur
                if (!isInviter) {
                    const [classOptions, subjectOptions, topicOptions] = await Promise.all([
                        data.selections.class ? getClassOptions() : null,
                        data.selections.subject ? getLessonOptions(data.selections.class) : null,
                        data.selections.topic ? getTopicOptions(data.selections.class, data.selections.subject) : null
                    ]);

                    if (classOptions) {
                        duelClassSelect.innerHTML = classOptions;
                        duelClassSelect.value = data.selections.class;
                    }
                    if (subjectOptions) {
                        duelSubjectSelect.innerHTML = subjectOptions;
                        duelSubjectSelect.value = data.selections.subject;
                    }
                    if (topicOptions) {
                        duelTopicSelect.innerHTML = topicOptions;
                        duelTopicSelect.value = data.selections.topic;
                    }
                }

            } catch (error) {
                console.error("Seçimler senkronize edilirken hata:", error);
            }
        }

        // Oyun durumu kontrolü
        if (data.gameStarted && !duelGameStarted) {
            duelGameStarted = true;
            duelEnded = false;
            startDuelGame(data);
        }

        // Düello başlatma butonu kontrolü
        if (!isInviter) {
            duelStartButton.disabled = true;
        } else {
            checkDuelSelections();
        }

    } else {
        if (!duelEnded) { try { } catch(e){}
            try {
                const currentPlayerId = selectedStudent.studentId;
                
                await updateDuelScore('DISCONNECTED', {
                    inviterId,
                    inviterClassId,
                    invitedId,
                    invitedClassId,
                    disconnectedId: currentPlayerId === inviterId ? invitedId : inviterId,
                    disconnectedClassId: currentPlayerId === inviterId ? invitedClassId : inviterClassId
                });

                // inDuel durumlarını güncelle
                await Promise.all([
                    database.ref(`classes/${inviterClassId}/students/${inviterId}/inDuel`).set(false),
                    database.ref(`classes/${invitedClassId}/students/${invitedId}/inDuel`).set(false)
                ]);

                window.location.reload();

            } catch (error) {
                console.error("Oyun sonlandırma hatası:", error);
                await showAlert('Oyun sonlandırılırken bir hata oluştu');
                window.location.reload();
            }
        }
    }
});


// Select elementleri için yardımcı fonksiyonlar
async function getClassOptions() {
   const snapshot = await database.ref('championData/headings').once('value');
   let options = '<option value="">Seçiniz</option>';
   if (snapshot.exists()) {
       snapshot.forEach(childSnapshot => {
           const className = childSnapshot.val().name;
           options += `<option value="${childSnapshot.key}">${className}</option>`;
       });
   }
   return options;
}

async function getLessonOptions(classId) {
   const snapshot = await database.ref(`championData/headings/${classId}/lessons`).once('value');
   let options = '<option value="">Seçiniz</option>';
   if (snapshot.exists()) {
       snapshot.forEach(childSnapshot => {
           const lessonName = childSnapshot.val().name;
           options += `<option value="${childSnapshot.key}">${lessonName}</option>`;
       });
   }
   return options;
}

async function getTopicOptions(classId, lessonId) {
   const snapshot = await database.ref(`championData/headings/${classId}/lessons/${lessonId}/topics`).once('value');
   let options = '<option value="">Seçiniz</option>';
   if (snapshot.exists()) {
       snapshot.forEach(childSnapshot => {
            const v = childSnapshot.val() || {};
            if (v.active === false) return; // gizli konu
            const topicName = v.name;
            options += `<option value="${childSnapshot.key}">${topicName}</option>`;
        });
   }
   return options;
}


    const hiddenPlayButton = document.createElement('button');
    hiddenPlayButton.style.display = 'none';
    hiddenPlayButton.id = 'hiddenPlayButton';
    duelSelectionScreen.appendChild(hiddenPlayButton);

    hiddenPlayButton.addEventListener('click', () => {
        duelMusic.play().then(() => {
            duelMusic.loop = true;
        }).catch(error => {
            console.error("Müzik çalınamadı:", error);
        });
    });

    setTimeout(() => {
        hiddenPlayButton.click();
    }, 1000);
}

      function resetDuelGameState() {
            duelQuestionNumber.textContent = 'Soru 1/10';
            duelProgressBarInner.style.width = '0%';
            duelTimerElement.textContent = '45';
            duelTimerElement.style.color = '#ff0000';
            inviterCorrectCountEl.textContent = "0";
            invitedCorrectCountEl.textContent = "0";

            duelQuestions = [];
            duelCurrentQuestionIndex = 0;
            duelInviterScore = 0;
            duelInvitedScore = 0;
            clearInterval(duelTimer);
            duelQuestionLocked = false;
            duelGameStarted = false;
            duelEnded = true; // Duel bittiğinde bayrağı ayarla

            // Düello Oyun Müziğini Durdur
            duelMusic.pause();
            duelMusic.currentTime = 0;
        }

duelClassSelect.addEventListener('change', (e) => {
    e.preventDefault(); // Değişikliği engelle
    return false;
});

        duelSubjectSelect.addEventListener('change', () => {
            if (isInviter) {
                fetchTopics(duelClassSelect.value, duelSubjectSelect.value, duelTopicSelect);
                updateDuelSelection('subject', duelSubjectSelect.value);
            }
        });

        duelTopicSelect.addEventListener('change', () => {
            if (isInviter) {
                updateDuelSelection('topic', duelTopicSelect.value);
            }
        });

async function updateDuelSelection(field, value) {
    // Eğer referans yoksa çık
    if (!currentDuelRef) return;

    // Sınıf seçimini değiştirmeye çalışıyorsa engelle
    if (field === 'class' && value !== duelClassSelect.value) {
        return;
    }
    
    try {
        // Seçimi veritabanında güncelle
        await currentDuelRef.child('selections').child(field).set(value);

        // Seçime göre bağımlı alanları güncelle
        if (field === 'subject') {
            // Konu seçildiğinde alt konuları yükle
            const topicsLoaded = await fetchTopics(duelClassSelect.value, value, duelTopicSelect);
            if (!topicsLoaded) {
                console.warn('Konular yüklenemedi');
            }
        }

        // Her iki oyuncunun select elementlerini senkronize et
        if (field === 'subject' || field === 'topic') {
            const selections = (await currentDuelRef.child('selections').once('value')).val() || {};
            
            // Davet eden oyuncu için seçimleri güncelle
            if (isInviter) {
                duelSubjectSelect.value = selections.subject || '';
                duelTopicSelect.value = selections.topic || '';
            }
        }

        // Seçimlerin durumunu kontrol et
        checkDuelSelections();

    } catch (error) {
        console.error('Seçim güncellenirken hata:', error);
        showAlert('Seçim güncellenirken bir hata oluştu').catch(console.error);
    }
}

        function checkDuelSelections() {
            if (isInviter) {
                const c = duelClassSelect.value;
                const s = duelSubjectSelect.value;
                const t = duelTopicSelect.value;
                if (c !== "" && s !== "" && t !== "") {
                    duelStartButton.classList.add('active');
                    duelStartButton.disabled = false;
                } else {
                    duelStartButton.classList.remove('active');
                    duelStartButton.disabled = true;
                }
            }
        }

        duelStartButton.addEventListener('click', async () => {
            duelClassId = duelClassSelect.value;
            duelSubjectId = duelSubjectSelect.value;
            duelTopicId = duelTopicSelect.value;

    const classSnapshot = await database.ref(`classes/${selectedStudent.classId}`).once('value');
    const championDataSnapshot = await database.ref(`championData/headings/${duelClassSelect.value}`).once('value');
    
    if (!classSnapshot.exists() || !championDataSnapshot.exists()) {
        showAlert('Sınıf seçimi ile ilgili bir hata oluştu.');
        return;
    }

    const studentClassName = classSnapshot.val().name;
    const championClassName = championDataSnapshot.val().name;

    if (studentClassName !== championClassName) {
        showAlert('Sınıf seçimi uyuşmazlığı tespit edildi.');
        return;
    }

            const questionsRef = database.ref(`championData/headings/${duelClassId}/lessons/${duelSubjectId}/topics/${duelTopicId}/questions`);
            const snapshot = await questionsRef.once('value');
            if (snapshot.exists()) {
                const allQuestions = [];
                snapshot.forEach(cs => {
                    allQuestions.push(cs.val());
                });
                if (allQuestions.length < 10) {
                    showAlert('Bu konuya ait yeterli soru yok.');
                    return;
                }
                // Firebase'den çekilen tüm sorulardan 10 tanesini rastgele seçelim:
let chosen = shuffleArray(allQuestions).slice(0, 10);

// Soru formatını doğru şekilde eşleyelim:
chosen = chosen.map(q => {
    let infoText = "";
    let questionText = "";
    // Eğer soru nesne formatındaysa:
    if (typeof q.question === 'object' && q.question !== null) {
        infoText = q.question.info || "";
        questionText = q.question.text || "";
    } else {
        // Eğer soru doğrudan metin olarak saklanmışsa:
        questionText = q.question;
    }
    return {
        info: infoText,
        actualQuestion: questionText,
        question: questionText,
        correct: q.correct,
        wrong1: q.wrong1,
        wrong2: q.wrong2,
        options: shuffleArray([
            { text: q.correct, correct: true },
            { text: q.wrong1, correct: false },
            { text: q.wrong2, correct: false }
        ])
    };
});

await currentDuelRef.child('questions').set(chosen);
                await currentDuelRef.child('gameStarted').set(true);
                
            } else {
                showAlert("Bu konuya ait soru bulunamadı.");
            }
        });

        function startDuelGame(data) {
            // Düello başlarken final ekranı ve skorları resetleyelim
            duelFinalContainer.style.display='none';
            winnerMessage.textContent = '';

            duelSelectionScreen.style.display = 'none';
            duelGameScreen.style.display = 'flex';
            try{ novaInitDuelHud(data); }catch(e){}


            document.getElementById('duel-player-inviter-photo').src = data.inviter.photo ? data.inviter.photo : "https://via.placeholder.com/80";
            document.getElementById('duel-player-inviter-name').textContent = data.inviter.name;
            document.getElementById('duel-player-invited-photo').src = data.invited.photo ? data.invited.photo : "https://via.placeholder.com/80";
            document.getElementById('duel-player-invited-name').textContent = data.invited.name;

            duelInviterScore = 0;
            // Nova: populate framed stars under names (in‑game)
            try {
                Promise.all([
                    database.ref(`classes/${data.inviter.classId}/students/${data.inviter.studentId}/duelCredits`).once('value'),
                    database.ref(`classes/${data.invited.classId}/students/${data.invited.studentId}/duelCredits`).once('value')
                ]).then(function(snaps){
                    var invCountSnap = snaps[0], inCountSnap = snaps[1];
                    var invCount = invCountSnap && invCountSnap.exists() ? invCountSnap.val() : 0;
                    var inCount  = inCountSnap && inCountSnap.exists()  ? inCountSnap.val()  : 0;
                    var invStarsGame = document.getElementById('duel-player-inviter-stars-ingame');
                    var inStarsGame  = document.getElementById('duel-player-invited-stars-ingame');
                    if (invStarsGame) invStarsGame.innerHTML = getStars(invCount);
                    if (inStarsGame)  inStarsGame.innerHTML  = getStars(inCount);
                     var invRankGame = document.getElementById('duel-player-inviter-rank-ingame'); if (invRankGame) invRankGame.innerHTML = getRankHTML(invCount);
                     var inRankGame = document.getElementById('duel-player-invited-rank-ingame'); if (inRankGame) inRankGame.innerHTML = getRankHTML(inCount);
                }).catch(function(e){
                    console.warn('Yıldızlar (in‑game) yüklenemedi:', e);
                });
            } catch(e) {
                console.warn('Yıldızlar (in‑game) yüklenemedi:', e);
            }

            duelInvitedScore = 0;
            inviterCorrectCountEl.textContent = "0";
            invitedCorrectCountEl.textContent = "0";

            duelCurrentQuestionIndex = 0;
            if (data.questions) {
                duelQuestions = data.questions;
                loadDuelQuestion();
            }

            listenToResponses();

            // Düello oyunu başladığında arka plan müziğini çal
            duelMusic.currentTime = 0;
            duelMusic.play().then(() => {
                duelMusic.loop = true;
            }).catch(error => {
                console.error("Müzik çalınamadı:", error);
            });
        }

        function loadDuelQuestion() {
    if (duelCurrentQuestionIndex >= 10) {
        endDuelGame();
        return;
    }
    duelQuestionLocked = false;
    const currentQuestion = duelQuestions[duelCurrentQuestionIndex];
    duelQuestionNumber.textContent = `Soru ${duelCurrentQuestionIndex + 1}/10`;
    const progressPercentage = ((duelCurrentQuestionIndex) / 10) * 100;
    duelProgressBarInner.style.width = `${progressPercentage}%`;

    // Soru konteynerini düello oyun ekranından seçiyoruz
    const questionContainer = document.querySelector('#duel-game-screen .question-container');
    questionContainer.innerHTML = '';

    if (currentQuestion.question.startsWith('http')) {
        // Eğer soru resim URL'siyse
        const questionImage = document.createElement('img');
        questionImage.src = currentQuestion.question;
        questionImage.className = 'question-image';
        questionImage.style.display = 'block';
        questionImage.alt = "Soru resmi";
        questionContainer.appendChild(questionImage);

        if (currentQuestion.actualQuestion) {
            const questionTextDiv = document.createElement('div');
            questionTextDiv.className = 'question-text';
            questionTextDiv.textContent = currentQuestion.actualQuestion;
            questionContainer.appendChild(questionTextDiv);
        }
    } else {
        // Metin şeklindeki soru için
        const textContainer = document.createElement('div');
        textContainer.className = 'question-text-container';

        // "info" alanı için resim URL kontrolü
        if (currentQuestion.info && /^https?:\/\/.*\.(png|jpg|jpeg|gif)$/i.test(currentQuestion.info)) {
            const infoImage = document.createElement('img');
            infoImage.src = currentQuestion.info;
            infoImage.alt = 'Bilgi resmi';
            infoImage.className = 'question-info-image';
            textContainer.appendChild(infoImage);
        } else {
            const infoText = document.createElement('div');
            infoText.className = 'question-info-text';
            infoText.textContent = currentQuestion.info || '';
            textContainer.appendChild(infoText);
        }

        const divider = document.createElement('div');
        divider.className = 'question-divider';
        textContainer.appendChild(divider);

        const questionText = document.createElement('div');
        questionText.className = 'question-actual-text';
        questionText.textContent = currentQuestion.question;
        textContainer.appendChild(questionText);

        questionContainer.appendChild(textContainer);
    }

    duelOptionsContainer.innerHTML = '';
    currentQuestion.options.forEach((option, idx) => {
        const button = document.createElement('button');
        button.classList.add('option-button');
        button.textContent = option.text;
        button.dataset.correct = option.correct;
        button.dataset.optionIndex = idx;
        button.addEventListener('click', duelSelectOption);
        duelOptionsContainer.appendChild(button);
    });

    resetDuelTimer();
    startDuelTimer();
    currentDuelRef.child('responses').child(duelCurrentQuestionIndex).remove();
}



function resetDuelTimer() {
    clearInterval(duelTimer);
    duelTimeLeft = 70;
    duelTimerElement.textContent = duelTimeLeft;
    duelTimerElement.style.color = '#ff0000';
}

function startDuelTimer() {
    duelTimer = setInterval(() => {
        duelTimeLeft--;
        duelTimerElement.textContent = duelTimeLeft;
        if (duelTimeLeft <= 0 && !duelQuestionLocked) {
            clearInterval(duelTimer);
            duelQuestionLocked = true;
            revealDuelAnswerAfterTimeout();
        }
    }, 1000);
}

function duelSelectOption(e) {
    if (duelQuestionLocked) return;
    const selectedButton = e.target;
    const chosenOptionText = selectedButton.textContent;
    const isCorrect = selectedButton.dataset.correct === 'true';
    const playerId = selectedStudent.studentId;

    duelOptionsContainer.querySelectorAll('.option-button').forEach(b => {
        b.disabled = true;
        if (b !== selectedButton) {
            b.classList.add('option-faded');
        } else {
            b.classList.add('option-chosen');
        }
    });

    currentDuelRef.child('responses').child(duelCurrentQuestionIndex).child(playerId).set({
        chosen: chosenOptionText,
        correct: isCorrect
    });
    // NOVA: Immediate COUNTER TEXT update only (no bar animation, no score mutation)
    try{
        if (isCorrect) {
            var lc = document.getElementById('novaLeftCount');
            var rc = document.getElementById('novaRightCount');
            if (isInviter && lc) { var v = parseInt(lc.textContent||'0',10); lc.textContent = String(v+1); }
            if (!isInviter && rc) { var v2 = parseInt(rc.textContent||'0',10); rc.textContent = String(v2+1); }
        }
    }catch(e){ /* silent */ }

    


}

function listenToResponses() {
    currentDuelRef.child('responses').on('value', snap => {
        if (snap.exists()) {
            const data = snap.val();
            currentDuelRef.once('value', dsnap => {
                const ddata = dsnap.val();
                const invId = ddata.inviter.studentId;
                const inId = ddata.invited.studentId;
                const answeredCount = Object.keys(data[duelCurrentQuestionIndex] || {}).length;
                if (answeredCount === 2 && !duelQuestionLocked) {
                    duelQuestionLocked = true;
                    clearInterval(duelTimer);
                    revealDuelAnswerAfterTimeout();
                }
            });
        }
    });
}

        // Yeni +1 Efekti Fonksiyonu
        function showScoreIncrementEffect(scoreElement) {
            return; // NOVA: +1 effect disabled
        }

        function revealDuelAnswerAfterTimeout() {
            setTimeout(() => {
                revealDuelAnswer();
            }, 500);
        }

        function revealDuelAnswer() {
            currentDuelRef.child('responses').child(duelCurrentQuestionIndex).once('value').then(resSnap => {
                const responses = resSnap.val() || {};
                currentDuelRef.once('value').then(dSnap => {
                    const ddata = dSnap.val();
                    const invId = ddata.inviter.studentId;
                    const inId = ddata.invited.studentId;

                    const optionButtons = duelOptionsContainer.querySelectorAll('.option-button');
                    optionButtons.forEach(btn => {
                        if (btn.dataset.correct === 'true') {
                            btn.classList.add('correct');
                        } else {
                            btn.classList.add('wrong');
                        }
                    });

                    let inviterOldScore = duelInviterScore;
                    let invitedOldScore = duelInvitedScore;

                    if (responses[invId] && responses[invId].correct) duelInviterScore++;
                    if (responses[inId] && responses[inId].correct) duelInvitedScore++;

                    if (duelInviterScore > inviterOldScore) {
                        inviterCorrectCountEl.textContent = duelInviterScore;
                        inviterCorrectCountEl.classList.add('score-flash');
                        showScoreIncrementEffect(inviterCorrectCountEl);
                        setTimeout(()=>inviterCorrectCountEl.classList.remove('score-flash'),1000);
                    }

                    if (duelInvitedScore > invitedOldScore) {
                        invitedCorrectCountEl.textContent = duelInvitedScore;
                        invitedCorrectCountEl.classList.add('score-flash');
                        showScoreIncrementEffect(invitedCorrectCountEl);
                        setTimeout(()=>invitedCorrectCountEl.classList.remove('score-flash'),1000);
                    try{ novaUpdateDuelHud(duelInviterScore, duelInvitedScore, inviterOldScore, invitedOldScore); }catch(e){}

                    }

                    setTimeout(() => {
                        duelCurrentQuestionIndex++;
                        loadDuelQuestion();
                    }, 1500);
                });
            });
        }

function endDuelGame() {
    // NOVA hook: maç sayısını bir kez artır
    try{ novaSafeIncrementMatchCountOnce(); }catch(e){ console.warn(e); }

    currentDuelRef.off('value');
    currentDuelRef.child('responses').off('value');
    
    duelQuestionNumber.style.display = 'none';
    document.querySelector('#duel-game-screen .progress-container').style.display = 'none';
    document.querySelector('#duel-game-screen .timer-container').style.display = 'none';
    document.querySelector('#duel-game-screen .question-container').style.display = 'none';
    duelOptionsContainer.style.display = 'none';
    duelFinalContainer.style.display = 'flex';

    currentDuelRef.once('value').then(async (dSnap) => {
        const ddata = dSnap.val();
        let winnerName = '';
        let winnerId = null;
        let loserId = null;
        let winnerClassId = null;
        let loserClassId = null;

        if (duelInviterScore > duelInvitedScore) {
            winnerName = ddata.inviter.name;
            winnerId = ddata.inviter.studentId;
            winnerClassId = ddata.inviter.classId;
            loserId = ddata.invited.studentId;
            loserClassId = ddata.invited.classId;
        } else if (duelInvitedScore > duelInviterScore) {
            winnerName = ddata.invited.name;
            winnerId = ddata.invited.studentId;
            winnerClassId = ddata.invited.classId;
            loserId = ddata.inviter.studentId;
            loserClassId = ddata.inviter.classId;
        }

        // Winner message animation
        const finalMessage = winnerId ? `👑${winnerName}👑` : "🤝 Berabere! 🤝";
        winnerMessage.textContent = finalMessage;

        
            // Nova: Apply themed winner/loser visuals
            try{
              if (winnerId && duelInviterScore !== duelInvitedScore){
                const outcome = (duelInviterScore>duelInvitedScore)?'inviterWin':'invitedWin';
                window.novaDecorateDuelResult && window.novaDecorateDuelResult(outcome);
              } else {
                window.novaDecorateDuelResult && window.novaDecorateDuelResult('tie');
              }
            }catch(e){ console.warn(e); }
// Trophy container
        const trophyContainer = document.createElement('div');
        trophyContainer.className = 'trophy-container';
        
        // Add trophies with animation
        if (winnerId) {
            for(let i = 0; i < 1; i++) {
                const trophy = document.createElement('div');
                trophy.className = 'trophy';
                trophy.textContent = '';
                trophy.style.animation = `trophyEntry 0.5s ${i * 0.2}s forwards`;
                trophyContainer.appendChild(trophy);
            }
        }

      // Update scores
if (winnerId && loserId) {
    try {
        await updateDuelScore('GAME_END', {
            winnerId,
            winnerClassId,
            loserId,
            loserClassId
        });

        // Puanları görsel olarak güncelle
        if (selectedStudent.studentId === winnerId || selectedStudent.studentId === loserId) {
            fetchAndDisplayGameCup();
        }
    } catch (error) {
        console.error("Puan güncelleme hatası:", error);
        await showAlert('❌ Puan güncellenirken bir hata oluştu!');
    }
}

        // Remove old trophies if exist
        const oldTrophies = duelFinalContainer.querySelector('.trophy-container');
        if(oldTrophies) oldTrophies.remove();
        
        // Add new trophies
        duelFinalContainer.appendChild(trophyContainer);

        // Handle music
        duelMusic.pause();
        duelMusic.currentTime = 0;

        if (winnerId || finalMessage.includes("Berabere")) {
            winnerMusic.currentTime = 0;
            winnerMusic.play().catch(error => {
                console.error("Kazanan müziği çalınamadı:", error);
            });
        }

        duelEnded = true;
    });
}

        // Fetch and display gameCup for the logged-in student
        function fetchAndDisplayGameCup() {
            database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/gameCup`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    document.getElementById('game-cup-score').textContent = snapshot.val();
                } else {
                    // Initialize gameCup to 0
                    database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/gameCup`).set(0);
                    document.getElementById('game-cup-score').textContent = '0';
                }
            }).catch(error => {
                console.error("gameCup çekilirken hata:", error);
                document.getElementById('game-cup-score').textContent = '0';
            });
        }

        async function loadRanking() {
   const CACHE_DURATION = 360000; // 1 saat
   const PLAYER_LIMIT = 25; // İlk 10 oyuncu

   // Check cache first
   const cachedData = localStorage.getItem('rankingCache');
   const cachedTimestamp = localStorage.getItem('rankingCacheTimestamp');
   
   if (cachedData && cachedTimestamp) {
       const age = Date.now() - parseInt(cachedTimestamp);
       if (age < CACHE_DURATION) {
           const data = JSON.parse(cachedData);
           displayRankingData(data);
           return;
       }
   }

   rankingTableBody.innerHTML = '';
   
   try {
       const classesSnapshot = await database.ref('classes').once('value');
       let players = [];
       let currentUserRank = 0;
       let totalPlayers = 0;
       let userTrophyCount = 0;

       if (classesSnapshot.exists()) {
           for (const classSnap of Object.values(classesSnapshot.val())) {
               if (classSnap.students) {
                   for (const [studentId, student] of Object.entries(classSnap.students)) {
                       // Sadece gerekli alanları al
                       players.push({id: studentId,
                           name: student.name || 'Anonim',
                           className: classSnap.name,
                           gameCup: student.gameCup || 0,
                           matchCount: student.duelCredits || 0,
                           photo: student.photo || 'https://via.placeholder.com/50'});

                       if (studentId === selectedStudent.studentId) {
                           userTrophyCount = student.gameCup || 0;
                       }
                   }
               }
           }

           // Sıralama ve limit uygula
           players.sort((a, b) => b.gameCup - a.gameCup);
           totalPlayers = players.length;
           currentUserRank = players.findIndex(p => p.id === selectedStudent.studentId) + 1;
           players = players.slice(0, PLAYER_LIMIT);

           // Cache'e kaydet
           localStorage.setItem('rankingCache', JSON.stringify(players));
           localStorage.setItem('rankingCacheTimestamp', Date.now().toString());

           displayRankingData(players);
           updateUserStats(currentUserRank, totalPlayers, userTrophyCount);

       } else {
           rankingTableBody.innerHTML = '<tr><td colspan="5">Henüz sıralama yapılmadı.</td></tr>';
       }
   } catch (error) {
       console.error("Sıralama yüklenirken hata:", error);
       rankingTableBody.innerHTML = '<tr><td colspan="5">Sıralama yüklenirken bir hata oluştu.</td></tr>';
   }
}

function displayRankingData(players) {
   rankingTableBody.innerHTML = '';
   const topPlayers = players.slice(0, 25);
   const currentUserRank = players.findIndex(p => p.id === selectedStudent.studentId) + 1;
   const userTrophyCount = players.find(p => p.id === selectedStudent.studentId)?.gameCup || 0;

   topPlayers.forEach((player, index) => {
       const tr = document.createElement('tr');
       
       if (index < 3) {
           tr.classList.add(`top-${index + 1}`);
       }

       // Highlight current user's row
       if (player.id === selectedStudent.studentId) {
           tr.classList.add('current-user-row');
       }

       tr.innerHTML = `
           <td class="rank-column">${index + 1}</td>
           <td><img src="${player.photo}" alt="${player.name}" class="ranking-player-photo" 
               onerror="this.src='https://via.placeholder.com/50'"></td>
           <td class="player-name-column"><div class="name-line">${player.name}</div><div class="star-frame">${getStars(player.matchCount || 0)}</div>${getRankHTML(player.matchCount || 0)}</td>
           <td class="class-name-column">${player.className}</td>
           <td class="match-count-column">
   <div class="match-wrapper">
       <span class="match-label">⚔️</span>
       <span class="match-count">${player.matchCount}</span>
   </div>
</td>
<td class="trophy-column">
               <div class="trophy-wrapper">
                   <span class="trophy-icon">🏆</span>
                   <span class="trophy-count">${player.gameCup}</span>
               </div>
           </td>
       `;
       
       rankingTableBody.appendChild(tr);
   });

   // Update user stats with animation
   updateUserStats(currentUserRank, players.length, userTrophyCount);
}

function updateUserStats(rank, total, trophies) {
   const rankValue = document.querySelector('#userRankNumber .rank-value');
   const totalValue = document.querySelector('#totalPlayers .total-value');
   const trophyValue = document.querySelector('#userTrophyCount');

   // Add animation classes
   rankValue.classList.add('stat-update');
   totalValue.classList.add('stat-update');
   trophyValue.classList.add('stat-update');

   // Update values
   rankValue.textContent = rank > 0 ? `#${rank}` : '-';
   totalValue.textContent = total;
   trophyValue.textContent = trophies;

   // Remove animation classes after animation completes
   setTimeout(() => {
       rankValue.classList.remove('stat-update');
       totalValue.classList.remove('stat-update');
       trophyValue.classList.remove('stat-update');
   }, 500);
}

    </script>
<script>
        // Ensure the script runs after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            const kupaSiralamaButton = document.getElementById('kupa-siralama-button');
            const rankingBackButton = document.getElementById('rankingBackButton');
            const rankingPanel = document.getElementById('rankingPanel');

            // Hide the ranking panel initially
            rankingPanel.style.display = 'none';

            // Show the ranking panel when the button is clicked
            if (kupaSiralamaButton) {
                kupaSiralamaButton.addEventListener('click', () => {
                    rankingPanel.style.display = 'flex';
                });
            }

            // Hide the ranking panel when the back button is clicked
            if (rankingBackButton) {
                rankingBackButton.addEventListener('click', () => {
                    rankingPanel.style.display = 'none';
                });
            }
        });












































// Düello Arama butonuna tıklandığında
document.getElementById('findDuelButton').addEventListener('click', () => {
   // Önce mevcut listeyi ve listener'ları temizle
   const availablePlayersList = document.getElementById('availablePlayersList');
   availablePlayersList.innerHTML = '';
   cleanupMatchmakingListeners();
   
   // Matchmaking referansını oluştur
   const matchmakingRef = database.ref(`matchmaking/${selectedStudent.classId}/${selectedStudent.studentId}`);
   
   // Bağlantı koptuğunda kaydı otomatik sil
   matchmakingRef.onDisconnect().remove();
   
   // Öğrenciyi matchmaking listesine ekle
   matchmakingRef.set({
       name: selectedStudent.studentName,
       classId: selectedStudent.classId,
       studentId: selectedStudent.studentId,
       timestamp: firebase.database.ServerValue.TIMESTAMP,
       status: 'searching'
   }).then(() => {
       showMatchmakingScreen();
   });
});

// Eşleştirme ekranını göster
function showMatchmakingScreen() {
   const matchmakingScreen = document.getElementById('matchmakingScreen');
   matchmakingScreen.style.display = 'flex';
   
   // Müsait oyuncuları dinle
   listenForAvailablePlayers();
   
   // Düello kaydı (child_added) oluştuğunda matchmakingScreen'i kapat
   listenForDuelCreation();
}

// Müsait oyuncuları dinle
function listenForAvailablePlayers() {
   const currentClass = selectedStudent.classId;
   const matchmakingRef = database.ref(`matchmaking/${currentClass}`);
   const availablePlayersList = document.getElementById('availablePlayersList');
   
   // Oyuncu listesini takip etmek için Set
   const addedPlayers = new Set();
   
   // Yeni oyuncu eklendiğinde
   matchmakingRef.on('child_added', async (childSnapshot) => {
       const player = childSnapshot.val();
       
       // Eğer oyuncu zaten eklenmişse ekleme
       if (addedPlayers.has(player.studentId)) return;
       
       // Kendimizi listelemeyelim
       if (player.studentId !== selectedStudent.studentId) {
           const inDuelSnap = await database.ref(`classes/${player.classId}/students/${player.studentId}/inDuel`).once('value');
           const inDuel = inDuelSnap.exists() ? inDuelSnap.val() : false;
           
           // Eğer inDuel = false ve status='searching' ise listele
           if (!inDuel && player.status === 'searching') {
               const playerItem = await createPlayerItem(player);
               playerItem.setAttribute('data-player-id', player.studentId);
               availablePlayersList.appendChild(playerItem);
               addedPlayers.add(player.studentId);
           }
       }
   });
   
   // Oyuncu kaldırıldığında
   matchmakingRef.on('child_removed', (oldChildSnapshot) => {
       const removedPlayerId = oldChildSnapshot.val().studentId;
       const playerElement = availablePlayersList.querySelector(`[data-player-id="${removedPlayerId}"]`);
       if (playerElement) {
           playerElement.remove();
           addedPlayers.delete(removedPlayerId);
       }
   });
   
   // Oyuncu durumu değiştiğinde
   matchmakingRef.on('child_changed', async (changedChildSnapshot) => {
       const changedPlayer = changedChildSnapshot.val();
       const playerElement = availablePlayersList.querySelector(`[data-player-id="${changedPlayer.studentId}"]`);
       
       if (changedPlayer.studentId !== selectedStudent.studentId) {
           const inDuelSnap = await database.ref(`classes/${changedPlayer.classId}/students/${changedPlayer.studentId}/inDuel`).once('value');
           const inDuel = inDuelSnap.exists() ? inDuelSnap.val() : false;
           
           if (inDuel || changedPlayer.status !== 'searching') {
               // Oyuncu artık müsait değilse listeden kaldır
               if (playerElement) {
                   playerElement.remove();
                   addedPlayers.delete(changedPlayer.studentId);
               }
           }
       }
   });
}

async function createPlayerItem(player) {
   const div = document.createElement('div');
   div.className = 'player-item';
   
   // Fotoğrafı çek
   const photoSnapshot = await database
     .ref(`classes/${player.classId}/students/${player.studentId}/photo`)
     .once('value');
   const photoUrl = photoSnapshot.exists() ? photoSnapshot.val() : 'https://via.placeholder.com/50';
   
   div.innerHTML = `
       <img src="${photoUrl}" alt="${player.name}" class="player-photo">
       <span class="player-name">${player.name} / ${classNameMap[player.classId]}</span>
       <button class="duel-request-button">
           <i class="duel-icon">⚔️</i>
       </button>
   `;
   
   const duelButton = div.querySelector('.duel-request-button');
   duelButton.addEventListener('click', async () => {
       // Davet gönder
       await sendInvitation({
           studentId: player.studentId,
           name: player.name,
           classId: player.classId,
           photo: photoUrl
       });
       
       // Sadece matchmaking kaydını kaldır ve ekranı kapat
       document.getElementById('matchmakingScreen').style.display = 'none';
       database.ref(`matchmaking/${selectedStudent.classId}/${selectedStudent.studentId}`).remove();
   });
   
   return div;
}

// Matchmaking dinleyicilerini temizle
function cleanupMatchmakingListeners() {
   const currentClass = selectedStudent.classId;
   const matchmakingRef = database.ref(`matchmaking/${currentClass}`);
   matchmakingRef.off();  // Tüm listener'ları temizle
}

// Aramayı iptal et
document.getElementById('cancelSearchButton').addEventListener('click', () => {
   const matchmakingScreen = document.getElementById('matchmakingScreen');
   matchmakingScreen.style.display = 'none';
   mainScreen.style.display = 'flex';
   
   database.ref(`matchmaking/${selectedStudent.classId}/${selectedStudent.studentId}`).remove();
   cleanupMatchmakingListeners();
});

function listenForDuelCreation() {
   // 1) Eğer bu kişi davet EDEN tarafsa
   database.ref('duels')
       .orderByChild('inviter/studentId')
       .equalTo(selectedStudent.studentId)
       .on('child_added', snapshot => {
           const matchmakingScreen = document.getElementById('matchmakingScreen');
           matchmakingScreen.style.display = 'none';
           database.ref(`matchmaking/${selectedStudent.classId}/${selectedStudent.studentId}`).remove();
           cleanupMatchmakingListeners();
       });

   // 2) Eğer bu kişi davet ALAN tarafsa
   database.ref('duels')
       .orderByChild('invited/studentId')
       .equalTo(selectedStudent.studentId)
       .on('child_added', snapshot => {
           const matchmakingScreen = document.getElementById('matchmakingScreen');
           matchmakingScreen.style.display = 'none';
           database.ref(`matchmaking/${selectedStudent.classId}/${selectedStudent.studentId}`).remove();
           cleanupMatchmakingListeners();
       });
}

// Sayfa kapatıldığında ya da yenilendiğinde
window.addEventListener('beforeunload', () => {
   // Eğer matchmaking'de ise kaydı sil
   if (selectedStudent && selectedStudent.classId && selectedStudent.studentId) {
       database.ref(`matchmaking/${selectedStudent.classId}/${selectedStudent.studentId}`).remove();
   }
});


























const CACHE_KEYS = {
    PHOTOS: 'storePhotos',
    CHAMPION: 'championPhotos',
    PURCHASED: 'purchasedPhotos'
};

function getUserSpecificCacheKey(key) {
    return `${key}_${selectedStudent.studentId}`;
}

function saveToCache(key, data) {
    try {
        const userKey = getUserSpecificCacheKey(key);
        localStorage.setItem(userKey, JSON.stringify({
            userId: selectedStudent.studentId,
            data: data,
            timestamp: Date.now()
        }));
    } catch (error) {
        console.error('Cache save error:', error);
    }
}

function getFromCache(key) {
    try {
        const userKey = getUserSpecificCacheKey(key);
        const cached = localStorage.getItem(userKey);
        if (!cached) return null;

        const parsedCache = JSON.parse(cached);
        if (parsedCache.userId !== selectedStudent.studentId) {
            localStorage.removeItem(userKey);
            return null;
        }
        return parsedCache.data;
    } catch (error) {
        console.error('Cache read error:', error);
        return null;
    }
}



// Main photo categories with added cache handling
let photoCategories = { 'DünyaDevleri': [], cesur: [],  TemelKarakterler: [], SüperLig: [], DünyaFutbolcuları: [], KizlarKösesi: [], 'EFSANE': [] };

/**
 * Mağaza kategorilerini Firebase Realtime Database üzerinden çeker.
 * Path: store/profilePhotos/{DünyaDevleri|cesur|sampiyon}/{photoId} -> { url, price, name?, allowedStudents? }
 * Not: championsphoto kısmı ve diğer mağaza işlevleri olduğu gibi korunmuştur.
 */
async function fetchStoreCategoriesFromDB() {
  try {
    const snap = await database.ref('store/profilePhotos').once('value');
    const data = snap.val() || {};
    const norm = (cat) => {
      const o = cat || {};
      return Object.keys(o).map(id => ({
        id,
        url: o[id].url,
        price: o[id].price,
        name: o[id].name || id,
        allowedStudents: o[id].allowedStudents || null
      }));
    };
    photoCategories['DünyaDevleri'] = norm(data['DünyaDevleri']);
    photoCategories.cesur = norm(data.cesur);
    photoCategories.TemelKarakterler = norm(data.TemelKarakterler);
    photoCategories.SüperLig = norm(data.SüperLig);
    photoCategories.DünyaFutbolcuları = norm(data.DünyaFutbolcuları);
    photoCategories.KizlarKösesi = norm(data.KizlarKösesi);
    photoCategories['EFSANE'] = norm(data['EFSANE']);
    try{ renderStoreCategoryButtons(); }catch(e){}
renderStoreCategoryButtons();
  } catch (e) {
    console.error('Store categories fetch error:', e);
  }
}
async function useProfilePhoto(photoUrl) {
    try {
        await database
            .ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/photo`)
            .set(photoUrl);

        ['student-photo', 'profile-icon'].forEach(id => {
            const element = document.getElementById(id);
            if (element) element.src = photoUrl;
        });

        saveToCache('currentUserPhoto', photoUrl);
        await showAlert('✨ Profil fotoğrafı başarıyla değiştirildi!');
    } catch (error) {
        console.error('Fotoğraf değiştirme hatası:', error);
        await showAlert('❌ Fotoğraf değiştirme işlemi başarısız oldu.');
    }
}

async function loadProfilePhotos(category = 'DünyaDevleri') {
  if (!window.selectedStudent) {
    // localStorage fallback
    try { window.selectedStudent = JSON.parse(localStorage.getItem('selectedStudent') || 'null'); } catch(_) {}
  }
  if (!window.selectedStudent || !window.selectedStudent.classId || !window.selectedStudent.studentId) {
    const c = document.getElementById('profilePhotosContainer');
    if (c) c.innerHTML = '<div class="error">Öğrenci seçimi bulunamadı. Lütfen giriş yapın.</div>';
    return;
  }

  // Kategori verileri boşsa DB'den çek
  // Seçilen kategori boşsa verileri DB'den çek (yeni kategoriler için güvenli)
  try {
    if (!photoCategories[category] || !photoCategories[category].length) {
      await fetchStoreCategoriesFromDB();
    }
  } catch (e) { console.warn('Kategori tazeleme uyarısı:', e); }

  if ((!photoCategories['DünyaDevleri'].length && !photoCategories.cesur.length && !photoCategories['EFSANE'].length)) {
    await fetchStoreCategoriesFromDB(); try{ renderStoreCategoryButtons(); }catch(e){} }
const studentRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`);
   const studentSnapshot = await studentRef.once('value');
   const userData = studentSnapshot.val();
   
   document.getElementById('currentDiamonds').textContent = userData.diamond || 0;

   if (category === 'duel') {
       const duelStore = document.getElementById('duelCreditsStore');
       const container = document.getElementById('profilePhotosContainer');
       duelStore.style.display = 'block';
       container.style.display = 'none';

       // Sınırsız hak kontrolü
       if (userData.unlimitedCreditsUntil && userData.unlimitedCreditsUntil > Date.now()) {
           // Tüm butonları devre dışı bırak
           document.querySelectorAll('.credit-package .buy-button').forEach(button => {
               button.disabled = true;
               button.style.opacity = '0.5';
               button.style.cursor = 'not-allowed';
               button.textContent = 'Sınırsız Hak Aktif';
               button.onclick = null;
           });

           // Stats güncelle
           const creditsStats = document.getElementById('credits-stats');
           const creditsValue = document.getElementById('duel-credits-value');
           const daysLeft = Math.ceil((userData.unlimitedCreditsUntil - Date.now()) / (1000 * 60 * 60 * 24));
           
           creditsStats.classList.add('unlimited');
           creditsValue.innerHTML = `<span class="unlimited-badge">${daysLeft}GÜN</span>`;
       }
       return;
   }

   const container = document.getElementById('profilePhotosContainer');
   container.style.display = 'grid';
   document.getElementById('duelCreditsStore').style.display = 'none';
   container.innerHTML = '';

   try {
       let purchasedPhotos = getFromCache(CACHE_KEYS.PURCHASED);
       
       if (!purchasedPhotos) {
           const purchasedRef = database.ref(
               `classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/purchasedPhotos`
           );
           const purchasedSnapshot = await purchasedRef.once('value');
           purchasedPhotos = purchasedSnapshot.val() || {};
           saveToCache(CACHE_KEYS.PURCHASED, purchasedPhotos);
       }

       if (category === 'EFSANE' && (photoCategories['EFSANE']?.length || 0) === 0) {
           container.innerHTML = '<div class="no-champion">Bu kategori sizin için henüz aktif değil</div>';
           return;
       }

       // Kişiye özel görünürlük filtresi
       const visKey = `${selectedStudent.classId}:${selectedStudent.studentId}`;
       (photoCategories[category] || [])
         .filter(p => !p.allowedStudents || p.allowedStudents[visKey])
         .forEach((photo, index) => {
           createPhotoCard(photo, purchasedPhotos, category, container, index);
       });
   } catch (error) {
       console.error('Fotoğraf listesi yükleme hatası:', error);
       container.innerHTML = '<div class="error">Fotoğraflar yüklenirken bir hata oluştu</div>';
   }
}

function createPhotoCard(photo, purchasedPhotos, category, container, index) {
    const div = document.createElement('div');
    div.className = 'profile-photo-item';
    div.style.animationDelay = `${index * 0.1}s`;

    const encodedUrl = btoa(photo.url);
    const isPurchased = purchasedPhotos[encodedUrl];

    div.innerHTML = `
        <img src="${photo.url}" class="profile-photo" alt="${photo.name || 'Avatar'}" onerror="this.style.opacity=0.3">
        <div class="profile-photo-price">
            ${isPurchased 
                ? '<span class="purchased-badge">✓ Satın Alındı</span>'
                : `${photo.price} <span class="diamond-icon">💎</span>`
            }
        </div>
        <button class="profile-photo-button ${isPurchased ? 'use-button' : 'buy-button'}">
            ${isPurchased ? 'Kullan' : 'Satın Al'}
        </button>
    `;

    const button = div.querySelector('.profile-photo-button');
    button.onclick = () => isPurchased 
        ? useProfilePhoto(photo.url) 
        : buyProfilePhoto(photo);

    
    container.appendChild(div);
}

/**
 * Satın alma akışı – DB'den kullanıcıyı okur, elması yeterliyse düşer ve purchasedPhotos'a işaretler.
 */
async function buyProfilePhoto(photo){
  try {
    const studentRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`);
    const snapshot = await studentRef.once('value');
    const userData = snapshot.val() || {};
    const currentDiamonds = userData.diamond || 0;
    const cost = Number(photo.price) || 0;
    if (currentDiamonds < cost){
      await showAlert('Yeterli elmasınız yok!');
      return;
    }
    // Onay
    const ok = await showConfirmation(`${cost} 💎 karşılığında bu görseli satın almak istediğinize emin misiniz?`);
    if(!ok) return;

    // purchasedPhotos anahtarını URL üzerinden btoa ile tutuyoruz (mevcut sistemle uyumlu)
    const encodedUrl = btoa(photo.url);
    const purchasedRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/purchasedPhotos/${encodedUrl}`);

    // Bakiyeden düş ve satın alındı olarak işaretle
    await studentRef.update({ diamond: currentDiamonds - cost });
    await purchasedRef.set(true);

    // Cache güncelle
    const purchasedCache = getFromCache(CACHE_KEYS.PURCHASED) || {};
    purchasedCache[encodedUrl] = true;
    saveToCache(CACHE_KEYS.PURCHASED, purchasedCache);

    document.getElementById('currentDiamonds').textContent = currentDiamonds - cost;
    await showAlert('✅ Satın alındı! Artık bu resmi kullanabilirsiniz.');

    // Bulunduğumuz kategori butonu aktifse yeniden yükleyelim
    const activeBtn = document.querySelector('.category-button.active');
    const cat = activeBtn ? activeBtn.dataset.category : 'DünyaDevleri';
    await loadProfilePhotos(cat);
  } catch(e){
    console.error('Satın alma hatası:', e);
    await showAlert('❌ Satın alma sırasında bir hata oluştu.');
  }
}

document.getElementById('profileCloseButton').addEventListener('click', () => {
    document.getElementById('profileChangeOverlay').style.display = 'none';
});










// === NOVA: Mağaza açılış yardımcıları ===
async function novaOpenStore() {
  const overlay = document.getElementById('profileChangeOverlay');
  if (!overlay) return;
  overlay.style.display = 'flex';
  try { await novaOpenStoreFlow(); } catch(e) { console.error('Store init error', e); }
  try { renderStoreCategoryButtons(); } catch(e) {}
  try { loadProfilePhotos('DünyaDevleri'); } catch(e) { console.warn('loadProfilePhotos yok:', e); } // flex: ortalama aktif
  try { loadProfilePhotos('DünyaDevleri'); } catch(e) { console.warn('loadProfilePhotos çağrısı bulunamadı:', e); }
}

document.addEventListener('DOMContentLoaded', () => {
  // 1) Doğrudan profil küçük görseli varsa ona tıklandığında aç
  const pi = document.getElementById('profile-icon');
  if (pi) {
    pi.style.cursor = 'pointer';
    pi.addEventListener('click', novaOpenStore);
  }

  // 2) Eğer sağ üst mağaza ikonunun spesifik ID'si yoksa,
  //    görünmez bir butonla aynı bölgeyi "tıklanır" hâle getir (UI'ye dokunmadan).
  const ms = document.getElementById('main-screen');
  if (ms) {
    const btn = document.createElement('button');
    btn.setAttribute('aria-label', 'Mağaza');
    btn.style.position = 'absolute';
    btn.style.top = '12px';
    btn.style.right = '12px';
    btn.style.width = '56px';
    btn.style.height = '56px';
    btn.style.borderRadius = '50%';
    btn.style.background = 'transparent';
    btn.style.border = 'none';
    btn.style.cursor = 'pointer';
    btn.style.zIndex = '1000';
    btn.addEventListener('click', novaOpenStore);
    ms.appendChild(btn);
  }
});
// === /NOVA ===


// === NOVA FIX: Dynamic store categories ===
let NOVA_STORE_KEYS = [];

/** Fetch categories and normalize as {cat: [items...]} plus keys array. */
async function novaFetchStoreCategories() {
  const snap = await database.ref('store/profilePhotos').once('value');
  const data = snap.val() || {};
  const norm = (catObj) => {
    const o = catObj || {};
    return Object.keys(o).map(id => ({
      id,
      url: o[id].url,
      price: o[id].price,
      name: o[id].name || id,
      allowedStudents: o[id].allowedStudents || null
    }));
  };

  // Build keys directly from DB to respect custom names
  NOVA_STORE_KEYS = Object.keys(data);
  // Fill photoCategories map used by existing rendering
  photoCategories = {};
  NOVA_STORE_KEYS.forEach(k => { photoCategories[k] = norm(data[k]); });
}

/** Render category buttons using NOVA_STORE_KEYS. */
function novaRenderCategoryButtons() {
  const holder = document.querySelector('.profile-categories');
  if (!holder) return;
  holder.innerHTML = '';
  holder.style.display = 'flex';

  if (!NOVA_STORE_KEYS.length) {
    // fallback visible info
    const span = document.createElement('span');
    span.textContent = 'Kategori bulunamadı';
    holder.appendChild(span);
    return;
  }

  NOVA_STORE_KEYS.forEach((k, idx) => {
    const btn = document.createElement('button');
    btn.className = 'category-button' + (idx === 0 ? ' active' : '');
    btn.dataset.category = k;
    btn.textContent = k; // show exact DB key
    btn.addEventListener('click', () => {
      document.querySelectorAll('.category-button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      loadProfilePhotos(k);
    });
    holder.appendChild(btn);
  });
}

/** Open store flow: fetch -> buttons -> first category list. */
async function novaOpenStoreFlow() {
  await novaFetchStoreCategories();
  novaRenderCategoryButtons();
  const first = NOVA_STORE_KEYS[0] || 'DünyaDevleri';
  await loadProfilePhotos(first);
}
// === /NOVA FIX ===

// Kayıt sistemi için gerekli DOM elementleri
const registerButton = document.getElementById('register-button');
const registrationOverlay = document.getElementById('registrationOverlay');
const closeRegistration = document.getElementById('closeRegistration');
const registerClassSelect = document.getElementById('registerClassSelect');
const registerUsername = document.getElementById('registerUsername');
const registerPassword = document.getElementById('registerPassword');
const registerEmail = document.getElementById('registerEmail');
const submitRegistration = document.getElementById('submitRegistration');
const registrationError = document.getElementById('registrationError');
const verificationOverlay = document.getElementById('verificationOverlay');

// Modal açma/kapama olayları
registerButton.addEventListener('click', () => {
    registrationOverlay.style.display = 'flex';
    loadClassesForRegistration();
});

closeRegistration.addEventListener('click', () => {
    registrationOverlay.style.display = 'none';
    resetRegistrationForm();
});

// Sınıf listesini yükleme fonksiyonu
function loadClassesForRegistration() {
    registerClassSelect.innerHTML = '<option value="">Sınıf Seçin</option>';
    database.ref('classes').once('value').then(snapshot => {
        if (snapshot.exists()) {
            snapshot.forEach(childSnapshot => {
                const classId = childSnapshot.key;
                const className = childSnapshot.val().name;
                const option = document.createElement('option');
                option.value = classId;
                option.textContent = className;
                registerClassSelect.appendChild(option);
            });
        }
    }).catch(error => {
        console.error("Sınıf bilgileri yüklenirken hata:", error);
        registrationError.textContent = 'Sınıf bilgileri yüklenemedi';
    });
}

// Form validasyonu için input olayları
[registerClassSelect, registerUsername, registerPassword, registerEmail].forEach(element => {
    element.addEventListener('input', validateRegistrationForm);
});

// Form validasyon fonksiyonu
function validateRegistrationForm() {
    const username = registerUsername.value.trim();
    const password = registerPassword.value;
    const email = registerEmail.value.trim();
    const classId = registerClassSelect.value;
    let isValid = true;
    let errorMessage = '';

    // Tüm alanların doluluğunu kontrol et
    if (!username || !password || !email || !classId) {
        isValid = false;
        errorMessage = 'Tüm alanları doldurun';
    }
    // Kullanıcı adı uzunluk kontrolü
    else if (username.length > 11) {
        isValid = false;
        errorMessage = 'Kullanıcı adı 11 karakterden uzun olamaz';
    }
    // Şifre kontrolü
    else if (password.length < 6) {
        isValid = false;
        errorMessage = 'Şifre en az 6 karakter olmalı';
    }
    else if (!/(?=.*[A-Za-z])(?=.*\d)/.test(password)) {
        isValid = false;
        errorMessage = 'Şifre en az bir harf ve bir rakam içermeli';
    }
    // Email format kontrolü
    else if (!/\S+@\S+\.\S+/.test(email)) {
        isValid = false;
        errorMessage = 'Geçerli bir e-posta adresi girin';
    }

    submitRegistration.disabled = !isValid;
    registrationError.textContent = errorMessage;
    return isValid;
}

// Kullanıcı adı müsaitlik kontrolü
async function isUsernameAvailable(username, classId) {
    try {
        const snapshot = await database.ref(`classes/${classId}/students`)
            .orderByChild('name')
            .equalTo(username)
            .once('value');
        return !snapshot.exists();
    } catch (error) {
        console.error("Kullanıcı adı kontrolünde hata:", error);
        throw error;
    }
}

// Kayıt formu gönderme işlemi
submitRegistration.addEventListener('click', async () => {
    if (!validateRegistrationForm()) return;

    const username = registerUsername.value.trim();
    const password = registerPassword.value;
    const email = registerEmail.value.trim();
    const classId = registerClassSelect.value;

    try {
        // Kullanıcı adı müsaitlik kontrolü
        const usernameAvailable = await isUsernameAvailable(username, classId);
        if (!usernameAvailable) {
            registrationError.textContent = 'Bu kullanıcı adı zaten kullanılıyor';
            return;
        }

        // Firebase Authentication ile kullanıcı oluştur
        const userCredential = await (auth ? auth : null).createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // E-posta doğrulama gönder
        await user.sendEmailVerification();

        // Veritabanına kullanıcı bilgilerini kaydet
        await database.ref(`classes/${classId}/students/${user.uid}`).set({
            name: username,
            password: password,
            email: email,
	    duelCredits: 300,
            diamond: 1500,
            photo: "https://cdn.pixabay.com/photo/2025/01/08/21/09/giraffe-9320109_640.jpg",
            gameCup: 0,
            inDuel: false,
            lastDiamondUpdate: firebase.database.ServerValue.TIMESTAMP,
            purchasedPhotos: {
                "aHR0cHM6Ly9zLmNhZmViYXphYXIuaXIvaW1hZ2VzL2ljb25zL2NvbS50cnRjb2N1ay5pYmktNzQzNDZkNzktOGNjMS00YTFlLTk5NDktZWEyNTQxZjg5YTExXzUxMng1MTIucG5nP3gtaW1nPXYxL3Jlc2l6ZSxoXzI1Nix3XzI1Nixsb3NzbGVzc19mYWxzZS9vcHRpbWl6ZQ==": true
            }
        });

        // Kayıt formunu kapat, doğrulama ekranını göster
        registrationOverlay.style.display = 'none';
        verificationOverlay.style.display = 'flex';
        
        // 5 saniye sonra doğrulama ekranını kapat
        setTimeout(() => {
            verificationOverlay.style.display = 'none';
        }, 5000);

        resetRegistrationForm();

    } catch (error) {
        console.error("Kayıt işleminde hata:", error);
        registrationError.textContent = error.message;
    }
});

// Form sıfırlama fonksiyonu
function resetRegistrationForm() {
    registerUsername.value = '';
    registerPassword.value = '';
    registerEmail.value = '';
    registerClassSelect.value = '';
    registrationError.textContent = '';
    submitRegistration.disabled = true;
}

// E-posta doğrulama durumu kontrolü
(auth ? auth : null).onAuthStateChanged((user) => {
    if (user && !user.emailVerified) {
        user.reload().then(() => {
            if (user.emailVerified) {
                verificationOverlay.style.display = 'none';
            }
        });
    }
});









document.querySelectorAll('.category-button').forEach(button => {
    button.addEventListener('click', () => {
        // Aktif kategoriyi güncelle
        document.querySelectorAll('.category-button').forEach(b => b.classList.remove('active'));
        button.classList.add('active');
        
        // Doğru içeriği göster
        const duelStore = document.getElementById('duelCreditsStore');
        const photosContainer = document.getElementById('profilePhotosContainer');
        
        if (button.dataset.category === 'duel') {
            duelStore.style.display = 'block';
            photosContainer.style.display = 'none';
        } else {
            duelStore.style.display = 'none';
            photosContainer.style.display = 'grid';
            loadProfilePhotos(button.dataset.category);
        }
    });
});

// Düello kredisi satın alma fonksiyonu
async function purchaseCredits(amount, cost) {
    // Satın almaya başlamadan önce onay soruyoruz
    const confirmed = await showConfirmation("Bu düello biletini satın almak istediğinizden emin misiniz?");
    if (!confirmed) return;
    
    try {
        const studentRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`);
        const snapshot = await studentRef.once('value');
        const userData = snapshot.val();
        const currentDiamonds = userData.diamond || 0;
        const currentCredits = userData.duelCredits || 0;

        if (currentDiamonds < cost) {
            await showAlert('Yeterli elmasınız yok!');
            return;
        }

        await studentRef.update({
            diamond: currentDiamonds - cost,
            duelCredits: currentCredits + amount
        });

        // Ana ekrandaki değerleri hemen güncelleyelim
        document.getElementById('currentDiamonds').textContent = currentDiamonds - cost;
        document.getElementById('duel-credits-value').textContent = currentCredits + amount;
        
        await showAlert('Düello hakkı satın alma başarılı!');
        
    } catch (error) {
        console.error('Satın alma hatası:', error);
        await showAlert('Satın alma işlemi başarısız oldu!');
    }
}


async function purchaseUnlimited(cost) {
    // Satın almaya başlamadan önce kullanıcıdan onay alalım.
    const confirmed = await showConfirmation("Bu ürünü satın almak istediğinizden emin misiniz?");
    if (!confirmed) {
        return;
    }
    
    try {
        const studentRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`);
        const snapshot = await studentRef.once('value');
        const userData = snapshot.val();
        const currentDiamonds = userData.diamond || 0;

        if (currentDiamonds < cost) {
            await showAlert('Yeterli elmasınız yok!');
            return;
        }

        const thirtyDaysInMs = 30 * 24 * 60 * 60 * 1000;
        // Yeni sürenin bitiş tarihini hesaplıyoruz.
        const newUnlimitedUntil = Date.now() + thirtyDaysInMs;
        
        await studentRef.update({
            diamond: currentDiamonds - cost,
            unlimitedCreditsUntil: newUnlimitedUntil
        });

        document.getElementById('currentDiamonds').textContent = currentDiamonds - cost;
        const creditsStats = document.getElementById('credits-stats');
        const creditsValue = document.getElementById('duel-credits-value');
       
        creditsStats.classList.add('unlimited');
        // Yeni süreye göre kaç gün kalacağını hesaplayıp görüntülüyoruz.
        creditsValue.innerHTML = `<span class="unlimited-badge">${Math.ceil((newUnlimitedUntil - Date.now())/(1000*60*60*24))}GÜN</span>`;

        // Tüm düello paketi butonlarını devre dışı bırakıyoruz.
        const allPackageButtons = document.querySelectorAll('.credit-package .buy-button');
        allPackageButtons.forEach(button => {
            button.disabled = true;
            button.style.opacity = '0.5';
            button.style.cursor = 'not-allowed';
            button.textContent = 'Sınırsız Hak Aktif';
            button.onclick = null;
        });

        await showAlert('✨ Sınırsız düello hakkı aktifleştirildi!');
       
    } catch (error) {let chosen = shuffleArray(allQuestions).slice(0, 10);
        console.error('Satın alma hatası:', error);
        await showAlert('Satın alma işlemi başarısız oldu!');
    }
}











    </script>
<script>
// Ceza sistemi KALDIRILDI: Nova


// --- Nova: Yıldız yardımcıları ---
function getStars(count){
    let n = 0;
    if (count >= 100 && count < 300) n = 1;
    else if (count >= 300 && count < 500) n = 2;
    else if (count >= 500 && count < 800) n = 3;
    else if (count >= 800 && count < 1000) n = 4;
    else if (count >= 1000) n = 5;

    if (n === 0) return '';
    const bright = (n >= 3) ? ' bright' : '';
    const flame = (n === 5) ? ' flame' : '';
    let html = '<span class="star-badges">';
    for (let i=0;i<n;i++){
        const extra = (n === 5) ? flame : bright;
        html += `<span class="star${extra}">⭐</span>`;
    }
    html += '</span>';
    return html;
}


// --- Nova: Rank helpers ---
function _starLevelFromCount(count){
    let n = 0;
    if (count >= 100 && count < 300) n = 1;
    else if (count >= 300 && count < 500) n = 2;
    else if (count >= 500 && count < 800) n = 3;
    else if (count >= 800 && count < 1000) n = 4;
    else if (count >= 1000) n = 5;
    return n;
}
function _rankTextFromLevel(n){
    switch(n){
        case 1: return 'Çırak';
        case 2: return 'Gözcü';
        case 3: return 'Lider';
        case 4: return 'Kaptan';
        case 5: return 'PRO';
        default: return 'acemi';
    }
}
function getRankHTML(count){
    const lvl = _starLevelFromCount(Number(count)||0);
    const txt = _rankTextFromLevel(lvl);
    return `<div class="rank-label rank-${lvl}">${txt}</div>`;
}
</script>
<script>
(function(){
  function ensureBanner(container){
    if(!container) return null;
    let banner = container.querySelector('.resimli-soru-banner');
    if(!banner){
      banner = document.createElement('div');
      banner.className = 'resimli-soru-banner';
      banner.textContent = '📷 RESİMLİ SORU';
      container.insertBefore(banner, container.firstChild);
    }
    return banner;
  }

  function containerHasImage(container){
    if(!container) return false;
    // 1) Any <img> inside (regardless of class)
    if(container.querySelector('img')) return true;
    // 2) Any element with background-image url()
    const nodes = container.querySelectorAll('*');
    for(const el of nodes){
      const bg = getComputedStyle(el).backgroundImage;
      if(bg && bg !== 'none' && bg.includes('url(')) return true;
      // data attributes commonly used
      if(el.dataset){
        if(el.dataset.info || el.dataset.image || el.dataset.img) return true;
      }
    }
    // 3) Try global question object patterns
    try {
      if(window.currentQuestion){
        const cq = window.currentQuestion;
        if(cq.info || (cq.question && cq.question.info)) return true;
      }
      if(window.activeQuestion && (activeQuestion.info || (activeQuestion.question && activeQuestion.question.info))) return true;
    } catch(e){}
    return false;
  }

  function updateAllBanners(){
    document.querySelectorAll('.question-container').forEach(container => {
      const banner = ensureBanner(container);
      const hasImg = containerHasImage(container);
      banner.style.display = hasImg ? 'block' : 'none';
    });
  }

  // Public hook so you can call after DB fetch
  window.onNewQuestionLoaded = function(){ updateAllBanners(); };

  // Initial
  document.addEventListener('DOMContentLoaded', updateAllBanners, {once:true});

  // Observe DOM changes (new questions, attribute changes incl. src/style)
  const obs = new MutationObserver(() => { updateAllBanners(); });
  obs.observe(document.documentElement, {subtree:true, childList:true, attributes:true, attributeFilter:['src','style','data-info','data-image','data-img']});

  // Fallback timer (cheap)
  setInterval(updateAllBanners, 1000);
})();
</script>
<script>
function safeShowAlert(msg){
  try{
    if (typeof showAlert === 'function') { showAlert(msg); }
    else { window.alert(msg); }
  }catch(e){ try{ window.alert(msg); }catch(_){} }
}

function openDiamondExchangeModal(){
  try{
    const m = document.getElementById('diamondExchangeModal');
    if(!m){ safeShowAlert('Takas penceresi yüklenemedi.'); return; }
    m.style.display = 'block';
    refreshExchangeModalStats();
  }catch(e){ console.error(e); }
}
function closeDiamondExchangeModal(){
  const m = document.getElementById('diamondExchangeModal');
  if(m) m.style.display = 'none';
}

async function refreshExchangeModalStats(){
  try{
    if(!window.selectedStudent || !window.database) return;
    const ref = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`);
    const snap = await ref.once('value');
    if(!snap.exists()) return;
    const data = snap.val() || {};
    const el = document.getElementById('exchange-current-credits');
    if(el) el.textContent = `Mevcut Kredin: ${data.duelCredits || 0}`;
  }catch(e){ console.error('refreshExchangeModalStats:', e); }
}

// showAlert tarzı onay penceresi: showAlertConfirm varsa onu kullan, yoksa Nova modal
async function safeShowConfirm(msg){
  try{
    if (typeof showAlertConfirm === 'function'){
      return await showAlertConfirm(msg);
    }
  }catch(e){}
  return await new Promise((resolve)=>{
    try{
      let ov = document.getElementById('novaConfirmOverlay');
      if(!ov){
        // Dinamik olarak oluştur (ilk kullanımda)
        const tpl = document.createElement('div');
        tpl.innerHTML = `
<div id="novaConfirmOverlay" style="position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.55);display:flex;align-items:flex-start;justify-content:center;">
  <div style="max-width:420px;margin:12vh auto;background:#0b1220;border:2px solid #1f2a44;border-radius:16px;box-shadow: 0 6px 18px rgba(0,0,0,.5);padding:18px;width:calc(100% - 40px);">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div style="font-size:18px;font-weight:800;color:#e5e7eb;">Onay Gerekli</div>
      <button id="novaConfirmClose" aria-label="Kapat"
              style="background:transparent;border:none;color:#94a3b8;font-size:20px;cursor:pointer;">✖</button>
    </div>
    <div id="novaConfirmMessage" style="margin:12px 0 16px;font-size:14px;line-height:1.4;color:#cbd5e1;white-space:pre-line;"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button id="novaConfirmCancel" style="background:#1f2937;color:#e5e7eb;border:1px solid #334155;border-radius:10px;padding:8px 14px;font-weight:700;cursor:pointer;">
        Vazgeç
      </button>
      <button id="novaConfirmOk" style="background:linear-gradient(135deg,#0ea5e9,#2563eb);color:#fff;border:none;border-radius:10px;padding:8px 14px;font-weight:800;cursor:pointer;">
        Onayla
      </button>
    </div>
  </div>
</div>`;
        document.body.appendChild(tpl.firstElementChild);
      }
      ov = document.getElementById('novaConfirmOverlay');
      const msgEl = document.getElementById('novaConfirmMessage');
      const okBtn = document.getElementById('novaConfirmOk');
      const cancelBtn = document.getElementById('novaConfirmCancel');
      const closeBtn = document.getElementById('novaConfirmClose');
      msgEl.textContent = msg;
      ov.style.display = 'flex';
      const cleanup = () => {
        ov.style.display = 'none';
        okBtn.onclick = null;
        cancelBtn.onclick = null;
        closeBtn.onclick = null;
        window.removeEventListener('keydown', onKey);
        ov.onclick = null;
      };
      const onKey = (e) => { if (e.key === 'Escape'){ cleanup(); resolve(false); } };
      okBtn.onclick = () => { cleanup(); resolve(true); };
      cancelBtn.onclick = () => { cleanup(); resolve(false); };
      closeBtn.onclick = () => { cleanup(); resolve(false); };
      ov.onclick = (e) => { if (e.target === ov){ cleanup(); resolve(false); } };
      window.addEventListener('keydown', onKey);
    }catch(e){ resolve(window.confirm(msg)); }
  });
}

async function handleDiamondExchangeModal(){
  try{
    const qtyEl = document.getElementById('exchange-count-input');
    let qty = parseInt(qtyEl && qtyEl.value ? qtyEl.value : '0', 10);
    if(!Number.isFinite(qty) || qty < 1){
      safeShowAlert('Lütfen geçerli bir adet giriniz (>=1).');
      return;
    }
    // Ön okuma: yeterli kredi var mı?
    const ref = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`);
    const beforeSnap = await ref.once('value');
    const before = beforeSnap.val() || {};
    const have = before.duelCredits || 0;
    if (have < qty){
      safeShowAlert('Yetersiz düello kredisi.');
      return;
    }
    const ok = await safeShowConfirm(`Seçilen: ${qty} kredi → ${qty*5} 💎
Emin misiniz?`);
    if(!ok) return;

    // Transaction ile uygula
    await ref.transaction((user)=>{
      if(!user) return user;
      const current = user.duelCredits || 0;
      if(current < qty){ return user; } // güvenlik
      const maxDiamond = 25000;
      const gain = qty * 5;
      user.duelCredits = current - qty;
      user.diamond = Math.min((user.diamond || 0) + gain, maxDiamond);
      user.lastDiamondUpdate = Date.now();
      return user;
    }, function(err, committed, snap){
      if(err){ safeShowAlert('Bir hata oluştu.'); console.error(err); return; }
      const after = snap && snap.val ? snap.val() : null;
      if(!after){ safeShowAlert('Bir hata oluştu.'); return; }
      const deltaCredits = have - (after.duelCredits || 0);
      if(deltaCredits < qty){
        safeShowAlert('İşlem gerçekleştirilemedi. Lütfen tekrar deneyin.');
        return;
      }
      const diamondValueEl = document.getElementById('diamond-value');
      const diamondHeaderEl = document.getElementById('currentDiamonds');
      const creditsUIEl = document.getElementById('duel-credits-value');
      if (diamondValueEl) diamondValueEl.textContent = after.diamond || 0;
      if (diamondHeaderEl) diamondHeaderEl.textContent = after.diamond || 0;
      if (creditsUIEl) creditsUIEl.textContent = after.unlimitedCreditsUntil && after.unlimitedCreditsUntil > Date.now()
        ? `${Math.ceil((after.unlimitedCreditsUntil - Date.now()) / (1000*60*60*24))}Gün`
        : (after.duelCredits || 0);
      refreshExchangeModalStats();
      setTimeout(()=>{ safeShowAlert('Takas tamamlandı! ✨'); }, 30);
    });
  }catch(e){
    console.error('handleDiamondExchangeModal error:', e);
    safeShowAlert('Beklenmeyen bir hata oluştu.');
  }
}
</script>
<script>

// === NOVA: Sürpriz Kutu Mantığı (her 5 düello) ===
let sbListenersAttached = false;
async function initSurpriseBox(){
  try{
    if(!selectedStudent?.studentId) return;
    const box = document.getElementById('surprise-box');
    const counterEl = document.getElementById('surprise-box-counter');
    if(!box || !counterEl) return;

    // Realtime listen user's duelCredits + openedCount
    const userRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`);
    const updateUI = (snap)=>{
      const data = snap.val() || {};
      const totalMatches = data.duelCredits || 0; // toplam maç
      const opened = data.surpriseOpenedCount || 0; // bugüne kadar açılan kutu sayısı
      const eligible = Math.floor(totalMatches / 5) > opened;
      const rem = (5 - (totalMatches % 5)) % 5; // 0..4

      counterEl.textContent = eligible ? "Hazır!" : `Kalan : ${rem===0?5:rem}`;
      box.classList.toggle('active', eligible);
      box.classList.toggle('locked', !eligible);
    };
    userRef.on('value', updateUI);

    if(!sbListenersAttached){
      sbListenersAttached = true;
      box.addEventListener('click', async ()=>{
        const snap = await database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`).once('value');
        const data = snap.val() || {};
        const totalMatches = data.duelCredits || 0;
        const opened = data.surpriseOpenedCount || 0;
        const eligible = Math.floor(totalMatches / 5) > opened;
        if(!eligible){ await showAlert("🔒 Bu kutu için yeterli maçınız yok."); return; }

        // RNG — dağılım: %5→500, %10→100, %30→50, %50→30, aksi 10 (garanti alt ödül)
        const r = Math.random() * 100;
        let reward = 10;
        if(r < 5){ reward = 200; }
        else if(r < 15){ reward = 100; }
        else if(r < 45){ reward = 50; }
        else if(r < 95){ reward = 30; }
        // aksi halde 10

        // DB update (atomic-ish)
        const userRef = database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}`);
        await userRef.transaction(u => {
          if(!u) u = {};
          const cur = u.diamond || 0;
          const opened = u.surpriseOpenedCount || 0;
          const canOpen = Math.floor((u.duelCredits||0)/5) > opened;
          if(!canOpen) return u; // guard
          u.diamond = cur + reward;
          u.surpriseOpenedCount = opened + 1;
          u.lastSurpriseAt = Date.now();
          return u;
        });

        // Fancy animation overlay
        playSurpriseAnimation(reward);

        // UI update will come via the 'value' listener; also refresh diamond UI
        document.getElementById('diamond-value')?.textContent && updateDiamondCount?.();
        await showAlert(`🎁 Tebrikler! ${reward} 💎 kazandınız!`);
      });
    }
  }catch(e){ console.error("Sürpriz kutu init hatası:", e); }
}

function playSurpriseAnimation(amount){
  const overlay = document.createElement('div');
  overlay.className = 'reward-overlay';
  const panel = document.createElement('div');
  panel.className = 'reward-chest';
  const title = document.createElement('div');
  title.className = 'reward-caption';
  title.textContent = 'Sürpriz Kutu';
  const amt = document.createElement('div');
  amt.className = 'reward-amount';
  amt.textContent = `+${amount} 💎`;
  const ok = document.createElement('button');
  ok.textContent = 'Tamam';
  ok.className = 'start-game-button active';
  ok.style.marginTop = '6px';
  ok.addEventListener('click', ()=> document.body.removeChild(overlay));

  panel.appendChild(title);
  panel.appendChild(amt);
  panel.appendChild(ok);
  overlay.appendChild(panel);
  document.body.appendChild(overlay);

  // particles
  for(let i=0;i<26;i++){
    const p = document.createElement('div');
    p.className = 'particle';
    p.textContent = i%3===0 ? '💎' : (i%3===1 ? '✨' : '🪙');
    const x = window.innerWidth/2, y = window.innerHeight/2;
    p.style.left = x+'px'; p.style.top = y+'px';
    document.body.appendChild(p);
    const angle = (Math.random()*Math.PI*2);
    const dist = 120 + Math.random()*220;
    const dx = Math.cos(angle)*dist;
    const dy = Math.sin(angle)*dist;
    p.animate([
      { transform:`translate(-50%,-50%) translate(0,0) scale(1)`, opacity:1 },
      { transform:`translate(-50%,-50%) translate(${dx}px, ${dy}px) scale(.6)`, opacity:0 }
    ], { duration: 1100 + Math.random()*600, easing:'ease-out'}).onfinish = ()=> p.remove();
  }
}
// === /NOVA: Sürpriz Kutu ===

// === NOVA: Maç sayacını güvenli +1 (çift sayımı önle) ===
async function novaSafeIncrementMatchCountOnce(){
  try{
    if(!currentDuelRef) return;
    const flagRef = currentDuelRef.child('matchCountUpdated');
    const flag = await flagRef.once('value');
    if(flag.exists() && flag.val() === true) return; // already updated by someone

    const dSnap = await currentDuelRef.once('value');
    const d = dSnap.val() || {};
    const players = [
      d.inviter ? {id: d.inviter.studentId, classId: d.inviter.classId} : null,
      d.invited ? {id: d.invited.studentId, classId: d.invited.classId} : null,
    ].filter(Boolean);

    await Promise.all(players.map(pl => 
      database.ref(`classes/${pl.classId}/students/${pl.id}/duelCredits`).transaction(v => (v||0)+1)
    ));
    await flagRef.set(true);

    // update local UI if this user is one of them
    if(players.find(p=>p.id===selectedStudent.studentId)){
      const el = document.getElementById('duel-credits-value');
      if(el){ el.textContent = (parseInt(el.textContent||'0',10) + 1).toString(); }
    }
  }catch(e){ console.error("novaSafeIncrementMatchCountOnce error:", e); }
}

</script>
<script id="nova-defer-init">
(function(){
  var idle = window.requestIdleCallback || function(cb){ return setTimeout(cb,0); };
  idle(function(){
    // Non-critical: activate subtle pulses only for active surprise box
    var sb = document.getElementById('surprise-box');
    if(sb && sb.classList.contains('active')){
      sb.style.animationPlayState = 'running';
    }
  });
  // Prevent audio fetching until first user gesture
  function primeAudio(){
    ['duelBackgroundMusic','winnerMusic','singlePlayerQuestionMusic'].forEach(function(id){
      var el = document.getElementById(id);
      if(el){ try{ el.load(); }catch(e){} }
    });
    document.removeEventListener('click', primeAudio);
    document.removeEventListener('touchstart', primeAudio);
  }
  document.addEventListener('click', primeAudio, {once:true});
  document.addEventListener('touchstart', primeAudio, {once:true});
})();
</script>
<script>

// === Nova: Single-player Explanation Feature (v2) ===
function escapeHTML(str){
  if (typeof str !== 'string') return '';
  return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}
function getTextIfNotUrl(s){
  if(!s || typeof s !== 'string') return '';
  if(/^https?:\/\/.*\.(png|jpg|jpeg|gif|webp|svg)$/i.test(s)) return '';
  return s;
}
function showExplanationAndNext(){
  try{
    const currentQuestion = gameQuestions[currentQuestionIndex];
    const expl = document.getElementById('explanation-container');
    if(!expl){ proceedToNextQuestion(); return; }
    const correctText = currentQuestion && currentQuestion.correct ? String(currentQuestion.correct) : '';
    const maybeExplanation = getTextIfNotUrl(currentQuestion && (currentQuestion.explanation || currentQuestion.aciklama || currentQuestion["açıklama"] || currentQuestion.info));
    expl.innerHTML = `
      <div class="explanation-card">
        <div class="explanation-title">Açıklama</div>
        <div class="explanation-correct">✅ <strong>Doğru Cevap:</strong> ${escapeHTML(correctText)}</div>
        ${maybeExplanation ? `<div class="explanation-text">${escapeHTML(maybeExplanation)}</div>` : ``}
        <button id="next-question-button" class="next-question-button">Sonraki Soru</button>
      </div>`;
    expl.style.display = 'block';
    const nxt = document.getElementById('next-question-button');
    if(nxt){
      nxt.onclick = function(){
        expl.style.display='none';
        expl.innerHTML='';
        proceedToNextQuestion();
      };
    }
  }catch(e){
    console.error('showExplanationAndNext error', e);
    proceedToNextQuestion();
  }
}

</script>
<!-- Nova: Ders Videosu Ekranı (Single Player) -->
<div class="lesson-video-screen" id="lesson-video-screen">
<div class="lesson-video-header">
<div class="lesson-pill" id="lesson-video-breadcrumb">Ders &amp; Konu</div>
<div class="video-title" id="lesson-video-title">Ders Videosu</div>
</div>
<div class="video-frame">
<iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="" id="lesson-video-iframe" src="" title="Ders Videosu"></iframe>
</div>
<div class="lesson-video-actions">
<button class="lesson-video-back" id="lesson-video-back">Geri</button>
</div>
</div>
<!-- Nova: RTDB Adapter for Lesson Video URL (supports Firebase v8 & v9) -->
<script>
(function(){
  // Guard: don't overwrite if exists
  if (window.DB && typeof window.DB.getLessonVideoUrl === 'function') return;

  // helper to safely get selection texts
  function getSel(){
    var s = window.__novaSelection__ || {};
    return {
      classText: (s.classText || '').trim(),
      subjectText: (s.subjectText || '').trim(),
      topicText: (s.topicText || '').trim(),
      topicId: (s.topicId || '').trim()
    };
  }

  async function readWithV9(){
    try{
      if (!window.firebaseV9DatabaseLoaded) return null; // sentinel set below
      const db = window.firebaseV9DatabaseLoaded;
      const { get, ref } = window.firebaseV9DatabaseAPI;
      const sel = getSel();

      // 1) topicId araması: championData/headings/*/lessons/*/topics/$topicId/videoUrl
      if (sel.topicId){
        const hSnap = await get(ref(db, 'championData/headings'));
        if (hSnap.exists()){
          const headings = hSnap.val();
          for (const hId in headings){
            const lessons = (headings[hId] && headings[hId].lessons) || {};
            for (const lId in lessons){
              const topics = (lessons[lId] && lessons[lId].topics) || {};
              if (topics[sel.topicId] && typeof topics[sel.topicId].videoUrl === 'string' && topics[sel.topicId].videoUrl){
                return topics[sel.topicId].videoUrl;
              }
            }
          }
        }
      }

      // 2) isim tabanlı lookup
      if (sel.subjectText && sel.topicText){
        const p = `lessonVideoLookup/${sel.subjectText}/${sel.topicText}`;
        const urlSnap = await get(ref(db, p));
        if (urlSnap.exists() && typeof urlSnap.val() === 'string' && urlSnap.val()){
          return urlSnap.val();
        }
      }
      return null;
    }catch(e){ console.warn('V9 adapter error:', e); return null; }
  }

  async function readWithV8(){
    try{
      if (!(window.firebase && firebase.database)) return null;
      var rdb = firebase.database();
      var sel = getSel();

      if (sel.topicId){
        var hSnap = await rdb.ref('championData/headings').get();
        if (hSnap.exists()){
          var headings = hSnap.val();
          for (var hId in headings){
            var lessons = (headings[hId] && headings[hId].lessons) || {};
            for (var lId in lessons){
              var topics = (lessons[lId] && lessons[lId].topics) || {};
              if (topics[sel.topicId] && typeof topics[sel.topicId].videoUrl === 'string' && topics[sel.topicId].videoUrl){
                return topics[sel.topicId].videoUrl;
              }
            }
          }
        }
      }

      if (sel.subjectText && sel.topicText){
        var urlSnap = await rdb.ref('lessonVideoLookup/' + sel.subjectText + '/' + sel.topicText).get();
        if (urlSnap.exists() && typeof urlSnap.val() === 'string' && urlSnap.val()){
          return urlSnap.val();
        }
      }
      return null;
    }catch(e){ console.warn('V8 adapter error:', e); return null; }
  }

  // Expose adapter
  window.DB = window.DB || {};
  window.DB.getLessonVideoUrl = async function(classId, subjectId, topicId){
    // try v9 then v8
    var url = await readWithV9();
    if (url) return url;
    url = await readWithV8();
    return url;
  };

  // Try to detect Firebase v9 Database from existing scripts (if imported as module elsewhere)
  // Allow external code to set these globals:
  //   window.firebaseV9DatabaseLoaded = getDatabase()
  //   window.firebaseV9DatabaseAPI = { get, ref }
})();
</script>
<script>
// === Nova: Ders Videosu Akışı ===
(function(){
  const byId = (id)=>document.getElementById(id);
  const screenSinglePlayer = byId('single-player-game-screen') || byId('single-player-screen');
  const scoreContainer = byId('score-container');
  const videoScreen = byId('lesson-video-screen');
  const videoIframe = byId('lesson-video-iframe');
  const btnOpen = byId('lesson-video-button');
  const btnBack = byId('lesson-video-back');

  // Persist the selected class/subject/topic at game start (non-invasive, additive)
  const startBtn = byId('start-game-button');
  if (startBtn) {
    startBtn.addEventListener('click', () => {
      try {
        const cls = byId('class-select'); const sub = byId('subject-select'); const top = byId('topic-select');
        window.__novaSelection__ = {
          classId: cls && cls.value || '',
          subjectId: sub && sub.value || '',
          topicId: top && top.value || '',
          classText: cls && cls.options && cls.selectedIndex >= 0 ? cls.options[cls.selectedIndex].textContent.trim() : '',
          subjectText: sub && sub.options && sub.selectedIndex >= 0 ? sub.options[sub.selectedIndex].textContent.trim() : '',
          topicText: top && top.options && top.selectedIndex >= 0 ? top.options[top.selectedIndex].textContent.trim() : ''
        };
      } catch(e){ /* noop */ }
    }, { passive: true });
  }

  // Demo resolver — replace with DB integration later
  async function resolveLessonVideoUrl() {
    // 1) If an external DB adapter exists, prefer it
    if (window.DB && typeof window.DB.getLessonVideoUrl === 'function') {
      try {
        const s = window.__novaSelection__ || {};
        const url = await window.DB.getLessonVideoUrl(s.classId, s.subjectId, s.topicId);
        if (url) return url;
      } catch(e){ console.warn('DB.getLessonVideoUrl error:', e); }
    }
    // 2) Optional: look for a data attribute on topic-select option (e.g., data-video)
    try {
      const top = byId('topic-select');
      if (top && top.selectedIndex >= 0) {
        const opt = top.options[top.selectedIndex];
        const dataUrl = opt ? (opt.getAttribute('data-video') || opt.dataset.video) : '';
        if (dataUrl) return dataUrl;
      }
    } catch(e){ /* ignore */ }

    // 3) Demo static mapping (placeholder). Update/remove when DB is ready.
    const s = window.__novaSelection__ || {};
    const key = [s.classText, s.subjectText, s.topicText].map(v => (v||'').trim()).join(' | ');
    const DEMO = {
      "3. Sınıf | Matematik | Kesirler": "https://www.youtube.com/embed/AF8sDRXk2eY",
      "3. Sınıf | Türkçe | Noktalama İşaretleri": "https://www.youtube.com/embed/0B6l8yJqVnA"
    };
    return DEMO[key] || null;
  }

  function showOnly(el){
    // Hide main containers we might be in
    const ids = [
      'single-player-screen','single-player-game-screen',
      'duel-selection-screen','duel-game-screen','rankingPanel'
    ];
    ids.forEach(i => { const e = byId(i); if (e) e.style.display = 'none'; });
    if (el) el.style.display = 'flex';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function closeVideoScreen(){
    // Return user back to the results (score) screen if available, else main single-player screen
    if (videoIframe) videoIframe.src = '';
    if (scoreContainer && screenSinglePlayer) {
      // Show results container within the single player game screen
      const sp = byId('single-player-game-screen');
      if (sp) sp.style.display = 'flex';
      if (scoreContainer) scoreContainer.style.display = 'flex';
    } else {
      const spScreen = byId('single-player-screen');
      if (spScreen) spScreen.style.display = 'flex';
    }
    if (videoScreen) videoScreen.style.display = 'none';
  }

  async function openVideo(){
    try{
      const url = await resolveLessonVideoUrl();
      const sel = window.__novaSelection__ || {};
      const crumb = byId('lesson-video-breadcrumb');
      const title = byId('lesson-video-title');
      if (crumb) {
        const parts = [sel.classText, sel.subjectText, sel.topicText].filter(Boolean);
        crumb.textContent = parts.length ? parts.join(' • ') : 'Ders & Konu';
      }
      if (title) title.textContent = 'Ders Videosu';
      if (!url){
        if (typeof window.showAlert === 'function') {
          window.showAlert('Bu ders için video URL’si henüz tanımlı değil. Veritabanına eklendiğinde buradan izlenebilecek.');
        } else {
          alert('Bu ders için video URL’si henüz tanımlı değil. Veritabanına eklendiğinde buradan izlenebilecek.');
        }
        return;
      }
      // Ensure it is an embeddable YouTube URL
      let embedUrl = url.trim();
      if (embedUrl.includes('watch?v=')) {
        embedUrl = embedUrl.replace('watch?v=', 'embed/');
      }
      // Basic safety: only allow youtube/embed for now
      const ok = /^https:\/\/www\.youtube\.com\/embed\//.test(embedUrl) || /^https:\/\/youtube\.com\/embed\//.test(embedUrl);
      if (!ok){
        // attempt to coerce youtu.be
        if (embedUrl.includes('youtu.be/')) {
          const vid = embedUrl.split('youtu.be/')[1].split(/[?&#]/)[0];
          embedUrl = 'https://www.youtube.com/embed/' + vid;
        }
      }
      if (videoIframe) videoIframe.src = embedUrl;
      showOnly(videoScreen);
    }catch(err){
      console.error(err);
      if (typeof window.showAlert === 'function') window.showAlert('Video yüklenirken bir hata oluştu.');
      else alert('Video yüklenirken bir hata oluştu.');
    }
  }

  if (btnOpen) btnOpen.addEventListener('click', openVideo);
  if (btnBack) btnBack.addEventListener('click', closeVideoScreen);

  // Expose minimal API for future DB wiring
  window.NovaLessonVideo = {
    open: openVideo,
    close: closeVideoScreen,
    setUrl: (url)=>{ if (videoIframe) videoIframe.src = url; }
  };
  try{ window.addEventListener('nova:open-lesson-video', function(){ try{ openVideo(); }catch(_){} }); }catch(_){}
})();
// === End Nova ===
</script>
<!-- Nova: precise duel analytics hook (wraps updateDuelScore) -->
<script>
(function(){
  function getDb(){ try{ if (window.database && database.ref) return database; }catch(_){}
                   try{ if (window.firebase && firebase.database) return firebase.database(); }catch(_){}
                   return null; }
  function sid(){ try{ return selectedStudent && selectedStudent.studentId; }catch(_){ return null; } }
  function writeSession(d, s){
    try{
      var sessId = localStorage.getItem('novaSessId');
      if(!sessId){ sessId = Math.random().toString(36).slice(2); localStorage.setItem('novaSessId', sessId); }
      if(!localStorage.getItem('novaSessStarted_'+sessId)){
        d.ref('analytics/sessions/'+s+'/'+sessId).set({ startedAt: Date.now(), userAgent: navigator.userAgent||'' });
        localStorage.setItem('novaSessStarted_'+sessId,'1');
        window.addEventListener('beforeunload', function(){ try{ d.ref('analytics/sessions/'+s+'/'+sessId).update({ endedAt: Date.now() }); }catch(_){}});
      }
    }catch(_){}
  }
  function logDuel(d, s, won, opp){
    const base = d.ref('analytics/duels/'+s);
    base.child('played').transaction(c => (c||0)+1);
    (won ? base.child('wins') : base.child('losses')).transaction(c => (c||0)+1);
    base.child('last').set({ at: Date.now(), winner: (won ? s : (opp||null)), loser: (won ? (opp||null) : s) });
  }
  // run once when available
  var iv = setInterval(function(){
    var d=getDb(), s=sid();
    if(!d||!s) return;
    clearInterval(iv);
    writeSession(d,s);

    if (typeof window.updateDuelScore === 'function' && !window.__novaPatchedUpdateDuelScore){
      const orig = window.updateDuelScore;
      window.updateDuelScore = async function(type, data){
        const res = await orig.apply(this, arguments);
        try{
          const d2=getDb(), s2=sid(); if(!d2||!s2) return res;
          let meWon = null, opp = null;
          if (type === 'GAME_END'){
            meWon = (data && data.winnerId === s2) ? true : (data && data.loserId === s2) ? false : null;
            opp = (data && (data.winnerId === s2 ? data.loserId : data.winnerId)) || null;
          } else if (type === 'TIME_OUT'){
            meWon = (data && data.invitedId === s2) ? true : (data && data.inviterId === s2) ? false : null;
            opp = (data && (data.invitedId === s2 ? data.inviterId : data.invitedId)) || null;
          } else if (type === 'DISCONNECTED'){
            const leftId = data && (data.leftStudentId || data.leftId || data.disconnectedStudentId);
            if (leftId){ meWon = (leftId !== s2); opp = leftId; }
          }
          if (meWon !== null){ logDuel(d2, s2, meWon, opp); }
        }catch(e){ console.warn('nova duel hook fail', e); }
        return res;
      };
      window.__novaPatchedUpdateDuelScore = true;
    }
  }, 400);
})();
</script>
<!-- Nova: Topic performance logger (<=4 correct -> record, keep last 25) -->
<script>
(function(){
  function db(){ try{ if (window.database && database.ref) return database; }catch(_){}
                 try{ if (window.firebase && firebase.database) return firebase.database(); }catch(_){}
                 return null; }
  function sid(){ try{ return selectedStudent && selectedStudent.studentId; }catch(_){ return null; } }
  async function pushTopicPerf(topic, total, wrong){
    try{
      const d=db(), s=sid(); if(!d||!s) return;
      const rec = { at: Date.now(), topic: topic||'-', total: Number(total||0), wrong: Number(wrong||0) };
      const refBase = d.ref('analytics/topicPerf/'+s);
      const key = (await refBase.push(rec)).key;
      refBase.once('value').then(snap=>{
        try{
          const list = [];
          snap.forEach(ch => list.push({k: ch.key, at: ch.val()?.at || 0}));
          list.sort((a,b)=>a.at-b.at);
          while(list.length>25){
            const del = list.shift();
            d.ref('analytics/topicPerf/'+s+'/'+del.k).remove();
          }
        }catch(_){}
      });
    }catch(e){ console.warn('topic perf write fail', e); }
  }
  window.novaLogTopicPerf = function(topicKey, totalAsked, correctCount){
    try{
      const total = Number(totalAsked||0), correct = Number(correctCount||0);
      const wrong = Math.max(0, total - correct);
      if (correct <= 4) pushTopicPerf(topicKey||'-', total, wrong);
    }catch(_){}
  };
  var iv = setInterval(function(){
    if (typeof window.updateDuelScore !== 'function') return;
    clearInterval(iv);
    const orig = window.updateDuelScore;
    window.updateDuelScore = async function(type, data){
      const res = await orig.apply(this, arguments);
      try{
        const topic = data?.topicKey || data?.topicName || data?.topic || data?.lessonTopic || null;
        let total = data?.totalQuestions ?? data?.questionCount ?? data?.stats?.asked ?? null;
        let correct = data?.correct ?? data?.correctCount ?? data?.stats?.correct ?? null;
        if ((total!=null && correct!=null) && Number(correct) <= 4){
          const wrong = Math.max(0, Number(total)-Number(correct));
          pushTopicPerf(topic, total, wrong);
        }
      }catch(_){}
      return res;
    };
  }, 300);
})();
</script>
<script>
// === Nova Patch: Store Category Ordering & Colors ===
(function() {
  // Normalize Turkish variants and DB keys to display names we want
  function normalize(name) {
    if (!name) return "";
    const n = (""+name).trim();
    // Map common variants -> canonical labels
    const map = {
      "KizlarKösesi": "Kızlarköşesi",
      "KizlarKosesi": "Kızlarköşesi",
      "KızlarKösesi": "Kızlarköşesi",
      "KIZLARKÖŞESİ": "Kızlarköşesi",
      "KızlarKöşesi": "Kızlarköşesi",
      "KIZLARKOŞESİ": "Kızlarköşesi",
      "SüperLig": "Süperlig",
      "SÜPERLİG": "Süperlig",
      "SÜPERLİG": "Süperlig",
      "Dünya Devleri": "DünyaDevleri",
      "DÜNYADEVLERİ": "DünyaDevleri"
    };
    return map[n] || n;
  }

  const DESIRED_ORDER = ["TemelKarakterler","Kızlarköşesi","Süperlig","DünyaDevleri","EFSANE"];

  // Keep a reference to existing function (if any)
  const _oldRender = (typeof window.renderStoreCategoryButtons === "function") ? window.renderStoreCategoryButtons : null;

  // Override with strict deterministic renderer
  window.renderStoreCategoryButtons = function renderStoreCategoryButtons() {
    const area = document.querySelector('.profile-categories');
    if (!area) return;

    // Determine available categories from global photoCategories if present, otherwise use a fallback set
    let available = [];
    try {
      if (window.photoCategories && typeof window.photoCategories === 'object') {
        available = Object.keys(window.photoCategories);
      }
    } catch (e) {}

    if (!available.length) {
      available = ["TemelKarakterler","Kızlarköşesi","Süperlig","DünyaDevleri","EFSANE"];
    }

    // Build a normalized lookup: normalizedName -> originalKey
    const normToOrig = new Map();
    available.forEach(k => {
      const norm = normalize(k);
      if (!normToOrig.has(norm)) normToOrig.set(norm, k);
    });

    // Compose the final ordered list:
    // 1) take desired ones in the exact order if present
    const final = [];
    DESIRED_ORDER.forEach(label => {
      if (normToOrig.has(label)) final.push({display: label, key: normToOrig.get(label)});
    });

    // 2) append any other categories except duplicates, with EFSANE guaranteed last
    const used = new Set(final.map(x => x.key));
    const extras = [];
    normToOrig.forEach((orig, norm) => {
      if (!used.has(orig) && DESIRED_ORDER.indexOf(norm) === -1) {
        // keep extras for later (after EFSANE)
        extras.push({display: norm, key: orig});
      }
    });

    // If EFSANE was included earlier, ensure it's the last item by moving it to the end
    const eIndex = final.findIndex(x => normalize(x.display) === "EFSANE");
    if (eIndex > -1) {
      const e = final.splice(eIndex,1)[0];
      // push extras first, then efsane
      // But the user's spec says EFSANE should appear last overall; keep extras before it.
      final.push(...extras, e);
    } else {
      // No EFSANE among desired—append extras at end
      final.push(...extras);
    }

    // Render buttons
    area.style.display = 'flex';
    area.innerHTML = '';

    final.forEach((item, idx) => {
      const btn = document.createElement('button');
      btn.className = 'category-button' + (idx === 0 ? ' active' : '');
      // Use display label for consistency, but keep original key for data-category-raw
      btn.dataset.category = item.display;           // for styling via attribute
      btn.dataset.categoryRaw = item.key;            // for loader
      btn.textContent = item.display;
      btn.addEventListener('click', () => {
        document.querySelectorAll('.category-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const duelStore = document.getElementById('duelCreditsStore');
        const photosContainer = document.getElementById('profilePhotosContainer');
        const target = btn.dataset.categoryRaw || btn.dataset.category;
        if (duelStore && photosContainer) {
          if (target === 'duel') {
            duelStore.style.display='block'; 
            photosContainer.style.display='none';
          } else {
            duelStore.style.display='none'; 
            photosContainer.style.display='grid';
          }
        }
        // call existing loader if present
        if (typeof window.loadProfilePhotos === 'function') {
          window.loadProfilePhotos(target);
        }
      });
      area.appendChild(btn);
    });
  };

  // Style hook: add a mutation after DOM ready to ensure colors apply even if app lazy-renders
  document.addEventListener('DOMContentLoaded', function(){
    try { window.renderStoreCategoryButtons(); } catch(e){ if (typeof _oldRender === 'function') try{ _oldRender(); }catch(_){} }
  });
})();
</script>
<style>
/* === Nova Patch: Category Button Visuals === */
.profile-categories {
  display: flex;
  flex-wrap: nowrap;
  gap: 10px;
  overflow-x: auto;
  padding: 6px 2px;
}
.profile-categories::-webkit-scrollbar { height: 8px; }
.profile-categories::-webkit-scrollbar-thumb { background: rgba(0,0,0,.15); border-radius: 8px; }

.category-button {
  background: #f3f4f6;
  color: #111827;
  border: 2px solid transparent;
  border-radius: 12px;
  padding: 10px 14px;
  font-weight: 800;
  letter-spacing: .2px;
  cursor: pointer;
  transition: transform .18s ease, box-shadow .25s ease, background .2s ease, color .2s ease;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
  white-space: nowrap;
}
.category-button:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,.12); }
.category-button.active { outline: none; border-color: rgba(0,0,0,.15); transform: translateY(-1px) scale(1.02); }

/* Kızlarköşesi -> pembe */
.category-button[data-category="Kızlarköşesi"] {
  background: #ff69b4;
  color: #fff;
  text-shadow: 0 1px 0 rgba(0,0,0,.2);
}

/* Süperlig & varyasyonları ile DünyaDevleri -> futbol yeşili */
.category-button[data-category="Süperlig"],
.category-button[data-category="SüperLig"],
.category-button[data-category="DünyaDevleri"] {
  background: #228B22; /* forest green */
  color: #fff;
  text-shadow: 0 1px 0 rgba(0,0,0,.25);
}

/* EFSANE özel: hafif vurgu ama kullanıcı istemediği için animasyon eklemedik */
.category-button[data-category="EFSANE"] {
  background: linear-gradient(135deg, #111827, #374151);
  color: #fff;
}
</style>
<script>
// === Nova Audio Guard v1 ===
(function(){
  try{
    window.__novaAudios = window.__novaAudios || new Set();

    const _Audio = window.Audio;
    if (_Audio && !_Audio.__novaWrapped){
      const NovaAudio = function(...args){
        const inst = new _Audio(...args);
        try { window.__novaAudios.add(inst); } catch(_){}
        return inst;
      };
      NovaAudio.prototype = _Audio.prototype;
      Object.setPrototypeOf(NovaAudio, _Audio);
      window.Audio = NovaAudio;
      window.Audio.__novaWrapped = true;
    }

    // Track <audio> elements too
    function collectTagAudios(){
      document.querySelectorAll('audio').forEach(a=>{ try{ window.__novaAudios.add(a); }catch(_){} });
    }
    collectTagAudios();
    const obs = new MutationObserver(collectTagAudios);
    obs.observe(document.documentElement, {subtree:true, childList:true});

    window.stopAllGameAudio = function(){
      collectTagAudios();
      (window.__novaAudios ? Array.from(window.__novaAudios) : []).forEach(a=>{
        try{ a.pause(); a.currentTime = 0; }catch(_){}
      });
    };

    // When single player "score-container" is shown, stop audio
    function installResultObserver(){
      const target = document.querySelector('.single-player-game-container') || document.body;
      const mo = new MutationObserver(()=>{
        document.querySelectorAll('.score-container').forEach(el=>{
          const style = window.getComputedStyle(el);
          if (style.display !== 'none' && el.offsetParent !== null){
            window.stopAllGameAudio();
          }
        });
      });
      mo.observe(target, {subtree:true, attributes:true, attributeFilter:['style','class'], childList:true});
    }
    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', installResultObserver);
    } else {
      installResultObserver();
    }
  }catch(e){ console.warn('Nova Audio Guard init error', e); }
})();
// === End Nova Audio Guard v1 ===
</script>
<script>

/* ==== NOVA PREMIUM v3 (yalnızca ek JS) ==== */
(function(){
  'use strict';
  function save(k,v){ try{ sessionStorage.setItem(k, JSON.stringify(v)); }catch(_){ } }
  function load(k,f){ try{ var s=sessionStorage.getItem(k); return s?JSON.parse(s):f; }catch(_){ return f; } }
  var WRONG_KEY='wrongAnswers', MAX_LIST=8;

  document.addEventListener('click', function(ev){
    try{
      var t=ev.target;
      if (t && !(t.classList&&t.classList.contains('option-button'))){ t=t.closest?t.closest('.option-button'):null; }
      if (!t) return;
      setTimeout(function(){
        try{
          var container=document.querySelector('.single-player-game-container, .duel-game-container')||document;
          var qEl=container.querySelector('.question-text');
          var expEl=document.querySelector('#explanation-container, .explanation-container');
          var chosenText=(t.textContent||'').trim();
          var correctBtn=null, btns=container.querySelectorAll('.option-button');
          for (var i=0;i<btns.length;i++){ var b=btns[i]; if (b.classList.contains('correct') || b.getAttribute('data-correct')==='true'){ correctBtn=b; break; } }
          var isWrong=t.classList.contains('wrong') || t.getAttribute('data-correct')==='false';
          if (isWrong && correctBtn){
            var item={ q:qEl?(qEl.textContent||'').trim():'', chosen:chosenText, correct:(correctBtn.textContent||'').trim(), exp: expEl?(expEl.textContent||'').trim():'' };
            var list=load(WRONG_KEY,[]);
            var dup=false; for (var j=0;j<list.length;j++){ if(list[j].q===item.q && list[j].chosen===item.chosen){ dup=true; break; } }
            if (!dup){ list.push(item); save(WRONG_KEY,list); }
          }
        }catch(_){}
      },300);
    }catch(_){}
  }, true);

  function bindReset(){
    try{
      var startBtn=document.querySelector('#start-game-button');
      if (startBtn && !startBtn.__novaBound){ startBtn.__novaBound=true; startBtn.addEventListener('click', function(){ try{ sessionStorage.removeItem(WRONG_KEY);}catch(_){}}); }
    }catch(_){}
  }
  bindReset(); new MutationObserver(bindReset).observe(document.documentElement,{childList:true,subtree:true});

  function isVisible(el){ if(!el) return false; var s=window.getComputedStyle(el); return s && s.display!=='none' && s.visibility!=='hidden' && (el.offsetParent!==null || s.position==='fixed'); }
  function numberOr(s,f){ var m=(s||'').match(/(\d+[.,]?\d*)/g); if(!m) return f; var n=parseFloat(m[m.length-1].replace(',','.')); return isFinite(n)?n:f; }

  function extractMetrics(){
    var total=0, correct=0, pct=0;
    try{ var scEl=document.querySelector('#score'); if(scEl){ var t=(scEl.textContent||'').trim(); var frac=t.match(/(\d+)\s*\/\s*(\d+)/); if(frac){ correct=parseInt(frac[1],10); total=parseInt(frac[2],10);} var per=t.match(/%?\s*(\d{1,3})(?:[.,](\d+))?\s*%/); if(per){ pct=parseFloat(per[1]+(per[2]?'.'+per[2]:'')); } } }catch(_){}
    try{ if(!total){ var qn=document.querySelector('#question-number, .question-number'); if(qn){ var f=(qn.textContent||'').match(/(\d+)\s*\/\s*(\d+)/); if(f){ total=parseInt(f[2],10);} } } }catch(_){}
    try{ if(!pct){ var sm=document.querySelector('#score-message, .score-message'); if(sm){ pct=numberOr(sm.textContent,0);} } }catch(_){}
    if(!pct && total){ pct=Math.round((correct/Math.max(1,total))*100); }
    if(!correct && pct && total){ correct=Math.round((pct/100)*total); }
    if(!total||total<0) total=Math.max(total,correct,0);
    if(total && correct>total) correct=total;
    if(!isFinite(pct)) pct=0;
    return {total:total||0, correct:correct||0, pct:Math.max(0,Math.min(100,Math.round(pct)))};
  }

  function computeBadge(p){ if(p>=90) return {name:'ELMAS',emoji:'💎'}; if(p>=75) return {name:'ALTIN',emoji:'🥇'}; if(p>=50) return {name:'GÜMÜŞ',emoji:'🥈'}; return {name:'BRONZ',emoji:'🥉'}; }

  function ensurePremiumUI(scoreBox){
    if (!document.getElementById('premium-summary')){
      var host=document.createElement('div'); host.id='premium-summary';
      host.innerHTML='' +
        '<div class="metric-grid" aria-label="Öğrenme Özeti Metrikleri">'+
          '<div class="metric" role="group" aria-label="Doğru"><div class="label">Doğru</div><div class="value" id="metric-correct">0</div></div>'+
          '<div class="metric" role="group" aria-label="Toplam"><div class="label">Toplam</div><div class="value" id="metric-total">0</div></div>'+
          '<div class="metric" role="group" aria-label="Yüzde"><div class="label">Yüzde</div><div class="value" id="metric-pct">0%</div></div>'+
        '</div>'+
        '<div class="viz" aria-label="Görsel Özet">'+
          '<div class="gauge" aria-hidden="false">'+
            '<svg viewBox="0 0 120 120" aria-label="Başarı göstergesi">'+
              '<circle cx="60" cy="60" r="54" stroke="#e5e7eb" stroke-width="12" fill="none"></circle>'+
              '<circle id="gauge-bar" cx="60" cy="60" r="54" stroke="#111827" stroke-width="12" fill="none" stroke-linecap="round" stroke-dasharray="339.292" stroke-dashoffset="339.292" transform="rotate(-90 60 60)"></circle>'+
            '</svg>'+
            '<div class="pct" id="gauge-pct">0%</div>'+
          '</div>'+
          '<div class="badge" id="badge-box"><div class="badge-title">Rozet</div><div class="badge-value" id="badge-value">—</div></div>'+
        '</div>'+
        '<div class="wrong-block" aria-live="polite"><h4>Yanlış Soru Özeti</h4><div class="wrong-list" id="wrong-list"></div></div>'+
        '<div class="actions">'+
          '<button class="btn btn-primary" id="act-restart" title="Yeniden başlat">Tekrar Oyna</button>'+
          '<button class="btn btn-accent" id="act-review" title="Yanlışları incele">Yanlışları Tekrarla</button>'+
          '<button class="btn btn-outline" id="act-lesson" title="Ders videosunu aç">Ders Videosu</button>'+
          '<button class="btn btn-outline" id="act-print" title="Yazdır veya PDF kaydet">Yazdır/PDF</button>'+
        '</div>';
      scoreBox.appendChild(host);

      var modal=document.createElement('div'); modal.id='premium-modal';
      modal.innerHTML=''+'<div class="box" role="dialog" aria-modal="true" aria-labelledby="pm-title">'+
        '<button class="close" id="pm-close" aria-label="Kapat">Kapat</button>'+
        '<h3 id="pm-title">Yanlışların İncelemesi</h3>'+
        '<div id="pm-body"></div></div>';
      document.body.appendChild(modal);

      var restart=document.getElementById('act-restart');
      if (restart){ restart.addEventListener('click', function(){ try{ var back=document.querySelector('#final-back-button'); if(back) back.click(); else { var start=document.querySelector('#start-game-button'); if(start) start.click(); } }catch(_){ } }); }
      var review=document.getElementById('act-review');
      if (review){ review.addEventListener('click', function(){ try{ var list=load(WRONG_KEY,[]), body=document.getElementById('pm-body'); body.innerHTML=''; for (var i=0;i<list.length;i++){ var it=list[i]; var card=document.createElement('div'); card.className='wrong-card'; card.innerHTML='' + '<div class="q"><span class="qid">'+(i+1)+'</span><span>Soru:</span>&nbsp;'+(it.q||'')+'</div>' + '<div class="divider"></div>' + '<div class="row"><span class="k">Seçimin:</span>'+(it.chosen||'')+'</div>' + '<div class="row"><span class="k">Doğru Cevap:</span>'+(it.correct||'')+'</div>' + '<div class="row"><span class="k">Açıklama:</span>'+(it.exp||'')+'</div>'; body.appendChild(card);} document.getElementById('premium-modal').style.display='flex'; }catch(_){} }); }
      var pmc=document.getElementById('pm-close'); if (pmc){ pmc.addEventListener('click', function(){ document.getElementById('premium-modal').style.display='none'; }); }
      var lesson=document.getElementById('act-lesson'); if (lesson){ lesson.addEventListener('click', function(){ try{ var btn=document.querySelector('#lesson-video-button'); if(btn) btn.click(); }catch(_){} }); }
      var printBtn=document.getElementById('act-print'); if (printBtn){ printBtn.addEventListener('click', function(){ try{ window.print(); }catch(_){} }); }
    }
  }

  function confettiBurst(){ try{ var c=document.createElement('canvas'); c.width=window.innerWidth; c.height=window.innerHeight; c.style.cssText='position:fixed;inset:0;pointer-events:none;z-index:999998'; document.body.appendChild(c); var ctx=c.getContext('2d'); var parts=[],N=120; for (var i=0;i<N;i++){ parts.push({x:Math.random()*c.width,y:-20-Math.random()*c.height*0.3,vx:(Math.random()-0.5)*2,vy:2+Math.random()*3,s:4+Math.random()*6,a:Math.random()*Math.PI*2}); } var t0=Date.now(); (function tick(){ var dt=(Date.now()-t0)/1000; ctx.clearRect(0,0,c.width,c.height); for (var i=0;i<parts.length;i++){ var p=parts[i]; p.x+=p.vx; p.y+=p.vy; p.a+=0.1; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a); ctx.fillStyle='hsl('+(i*17%360)+',85%,60%)'; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.restore(); } if (dt<1.5) requestAnimationFrame(tick); else document.body.removeChild(c); })(); }catch(_){} }

  function animateGauge(pct){ try{ var circ=2*Math.PI*54; var bar=document.getElementById('gauge-bar'); var txt=document.getElementById('gauge-pct'); var start=0,end=Math.max(0,Math.min(100,pct)); var t0=performance.now(); function step(now){ var k=Math.min(1,(now-t0)/800); var val=Math.round(start+(end-start)*k); if(bar) bar.style.strokeDashoffset=(circ*(1-val/100)).toFixed(3); if(txt) txt.textContent=val+'%'; if(k<1) requestAnimationFrame(step); } requestAnimationFrame(step);}catch(_){} }

  function fillWrongPreview(){ try{ var list=load(WRONG_KEY,[]); var box=document.getElementById('wrong-list'); if(!box) return; box.innerHTML=''; var lim=Math.min(MAX_LIST,list.length); for (var i=0;i<lim;i++){ var it=list[i]; var card=document.createElement('div'); card.className='wrong-card'; card.innerHTML='' + '<div class="q"><span class="qid">'+(i+1)+'</span><span>Soru:</span>&nbsp;'+(it.q||'')+'</div>' + '<div class="divider"></div>' + '<div class="row"><span class="k">Seçimin:</span>'+(it.chosen||'')+'</div>' + '<div class="row"><span class="k">Doğru Cevap:</span>'+(it.correct||'')+'</div>' + '<div class="row"><span class="k">Açıklama:</span>'+(it.exp||'')+'</div>'; box.appendChild(card);} }catch(_){} }

  function renderPremium(){
    try{
      var sc=document.querySelector('#score-container, .score-container'); if(!sc) return;
      ensurePremiumUI(sc);
      var M=extractMetrics();
      var mc=document.getElementById('metric-correct'); if(mc) mc.textContent=M.correct;
      var mt=document.getElementById('metric-total'); if(mt) mt.textContent=M.total || (M.correct>0?M.correct:0);
      var mp=document.getElementById('metric-pct'); if(mp) mp.textContent=M.pct+'%';
      animateGauge(M.pct);
      var badge=computeBadge(M.pct); var bv=document.getElementById('badge-value'); if(bv) bv.textContent=badge.emoji+' '+badge.name;
      if (M.pct>=75){ confettiBurst(); }
      fillWrongPreview();
      var host=document.getElementById('premium-summary'); if(host){ host.style.display='flex'; }
    }catch(_){}
  }

  function watchScoreVisibility(){
    var sc=document.querySelector('#score-container, .score-container'); if(!sc) return;
    var lastVisible=false;
    function check(){ var vis=isVisible(sc); if (vis && !lastVisible){ setTimeout(renderPremium,100); } lastVisible=vis; }
    check(); var obs=new MutationObserver(check); obs.observe(sc,{attributes:true,childList:true,subtree:true}); window.addEventListener('resize',check);
  }

  try{ if (document.readyState==='complete' || document.readyState==='interactive'){ watchScoreVisibility(); } else { document.addEventListener('DOMContentLoaded', watchScoreVisibility); } }catch(_){}
})();

</script>
<script id="nova-kids-login-js">
(function(){
  const root = document.getElementById('student-selection-screen');
  if(!root) return;
  const cls = document.getElementById('selection-class-select');
  const user = document.getElementById('selection-name-input');
  const pass = document.getElementById('student-password-input');
  const login = document.getElementById('login-button');
  const err = document.getElementById('student-selection-error');
  const eye = document.getElementById('togglePwd');

  // Şifre göster/gizle
  eye?.addEventListener('click', () => {
    const type = pass.type === 'password' ? 'text' : 'password';
    pass.type = type;
    eye.textContent = type === 'password' ? '👁️' : '🙈';
  });

  function validate(){
    const ok = (cls?.value || '').trim() !== '' &&
               (user?.value || '').trim().length >= 2 &&
               (pass?.value || '').trim().length >= 4;
    login.disabled = !ok;
    login.classList.toggle('active', ok);
    if(ok) err.textContent = '';
  }
  ['change','input'].forEach(ev => {
    cls?.addEventListener(ev, validate);
    user?.addEventListener(ev, validate);
    pass?.addEventListener(ev, validate);
  });
  validate();

  // Enter ile giriş
  [cls,user,pass].forEach(el => el?.addEventListener('keydown', e => {
    if(e.key === 'Enter' && !login.disabled){ e.preventDefault(); login.click(); }
  }));

  // Beni hatırla
  const remember = document.getElementById('rememberMe');
  try{
    const saved = JSON.parse(localStorage.getItem('duello_login_pref')||'{}');
    if(saved.user) user.value = saved.user;
    if(saved.cls) { for(const o of cls.options){ if(o.value === saved.cls){ cls.value = saved.cls; break; } } }
    if('rem' in saved) remember.checked = !!saved.rem;
  }catch(_){}
  function persist(){
    try{
      localStorage.setItem('duello_login_pref', JSON.stringify({
        user: remember.checked ? user.value : '',
        cls: remember.checked ? cls.value : '',
        rem: remember.checked
      }));
    }catch(_){}
  }
  remember?.addEventListener('change', persist);
  [cls,user,pass].forEach(el => el?.addEventListener('input', persist));

  // Giriş click -> uygulamanın mevcut akışına CustomEvent
  login?.addEventListener('click', () => {
    const payload = {
      classId: (cls?.value || '').trim(),
      username: (user?.value || '').trim(),
      password: (pass?.value || '').trim()
    };
    if(!payload.classId || !payload.username || !payload.password){
      err.textContent = 'Lütfen tüm alanları doldurun.';
      return;
    }
    document.dispatchEvent(new CustomEvent('duello:loginAttempt', { detail: payload }));
  });

  // Dıştan hata yazdırmak için
  document.addEventListener('duello:loginError', e => {
    err.textContent = e.detail?.message || 'Giriş başarısız.';
  });

  // Şifremi unuttum delege
  document.getElementById('forgot')?.addEventListener('click', () => {
    document.dispatchEvent(new Event('duello:forgotPassword'));
  });
})();
</script>
<!-- === Nova: Premium Bitiş Özeti (HTML v3) === -->
<div aria-live="polite" id="nova-summary">
<div class="nz-row">
<div class="nz-card">
<div class="nz-kpi"><span class="label">Doğru</span><span class="value ok" id="nz-kpi-correct">0</span></div>
</div>
<div class="nz-card">
<div class="nz-kpi"><span class="label">Toplam</span><span class="value" id="nz-kpi-total">0</span></div>
</div>
<div class="nz-card">
<div class="nz-kpi"><span class="label">Yüzde</span><span class="value" id="nz-kpi-rate">0%</span></div>
</div>
</div>
<div class="nz-gauge">
<canvas aria-label="Başarı göstergesi" height="240" id="nzGauge" role="img" width="240"></canvas>
<div class="nz-badge" id="nzBadge">BRONZ</div>
</div>
<div class="nz-row">
<div class="nz-card" style="flex:1 1 100%">
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:8px">
<strong style="font-size:1.05rem"></strong>
<div class="nz-actions">
<button class="nz-btn nz-primary" id="nzRepeatBtn">Yanlışları Tekrar Et</button>
<button class="nz-btn nz-secondary" id="nzVideoBtn">Ders Videosu</button>
</div>
</div>
<div class="nz-wrong-list" id="nzWrongList"></div>
</div>
</div>
</div>
<!-- Modal -->
<div id="nova-modal">
<div class="modal-card">
<div class="modal-header">
<div class="modal-title">Tüm Yanlışlar</div>
<button class="modal-close" onclick="document.getElementById('nova-modal').style.display='none'">Kapat</button>
</div>
<div class="modal-list" id="nzModalList"></div>
</div>
</div>
<!-- === Nova: Premium Bitiş Özeti (JS v3) === -->
<script>
(function(){
  // Helper: escape HTML
  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, m=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function cleanupExplanation(s){
    return String(s||'').replace(/^\s*Açıklama[:：]\s*/i,'').trim();
  }
  // Robust question finder
  function findQuestionText(){
    const root = document.querySelector('.question-container, #question-container, .soru-container, .quiz-question, .game-question, .question-area, .questionWrap, .question-wrapper') || document;
    const selectors = [
  '.question-actual-text',
  '.question-text', '.question-title', '.question', '#question', '#question-text',
  '.soru-text', '.soruMetni', '.soru', '.prompt', '.quiz-question h2', '.quiz-question h3'
];
    for (const sel of selectors){
      const el = root.querySelector(sel);
      if (el && (el.innerText||el.textContent||'').trim().length>8){
        return (el.innerText||el.textContent).trim();
      }
    }
    // Fallback: take the longest textual node inside root but not within options
    const options = new Set(Array.from(root.querySelectorAll('.options, .choices, .answers, .option, .option-button, button, .answer-option, .choice, .secenek'))
      .map(e=>e));
    function isInsideInfo(node){
  try { return node && node.closest && node.closest('.question-info-text'); }
  catch(_) { return null; }
}
function isInsideOptions(node){
      let p=node; while(p){ if(options.has(p)) return true; p=p.parentNode; }
      return false;
    }
    let longest='';
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
    while (walker.nextNode()){
      const txt = (walker.currentNode.nodeValue||'').trim();
      if (txt.length>8 && txt.length<400 && !isInsideOptions(walker.currentNode.parentNode)){
        if (txt.length>longest.length) longest=txt;
      }
    }
    return longest || 'Soru metni bulunamadı';
  }

  // ====== Data tracker ======
  const NovaTracker = (function(){
    const state = { items: [], total:0, correctCount:0, finished:false };
    // === Nova: Reset wrong-answers tracker for each NEW game ===
    function resetTrackerState(){
      state.items = [];
      state.total = 0;
      state.correctCount = 0;
      state.finished = false;
    }
    // Capture clicks on start buttons to reset before a new game begins
    document.addEventListener('click', function(ev){
      var t = ev.target && (ev.target.closest ? ev.target.closest('#start-game-button, .start-game-button, .single-start-button, #startSinglePlayerButton, .start-button, #startButton') : null);
      if (t) { try{ resetTrackerState(); }catch(_){} }
    }, true);
    // Wrap common start functions as extra safety
    ;(function wrapStarts(names){
      (names||[]).forEach(function(name){
        try{
          var fn = window[name];
          if (typeof fn === 'function' && !fn.__novaResetWrap){
            var orig = fn;
            window[name] = function(){
              try{ resetTrackerState(); }catch(_){}
              return orig.apply(this, arguments);
            };
            window[name].__novaResetWrap = true;
          }
        }catch(_){}
      });
    })(['startGame','startSinglePlayer','startCountdown','startNow']);
    
    document.addEventListener('click', function(e){
      const btn = e.target.closest('.option-button, .answer-option, .option, .choice');
      if(!btn) return;
      setTimeout(()=>{
        try {
          const qText = findQuestionText();
          const opts = Array.from(document.querySelectorAll('.option-button, .answer-option, .option, .choice'));
          const correctBtn = opts.find(b => b.classList.contains('correct') || b.dataset.correct==='true');
          const chosenText = (btn.innerText||btn.textContent||'').trim();
          const correctText = (correctBtn && (correctBtn.innerText||correctBtn.textContent||'').trim()) || '';
          const expEl = document.querySelector('.explanation-text, .explanation-container, .explanation-card, #explanation, .explanation');
          const explanation = cleanupExplanation((expEl && (expEl.innerText||expEl.textContent)||'').trim());
          const isCorrect = btn.classList.contains('correct') || (btn===correctBtn);

          state.total += 1;
          if(isCorrect){ state.correctCount += 1; }
          else { (function(){
  const infoImgEl = document.querySelector('.question-info-image');
  const infoTextEl = document.querySelector('.question-info-text');
  const infoImage = infoImgEl ? infoImgEl.src : '';
  const infoText = (!infoImgEl && infoTextEl) ? ((infoTextEl.innerText||infoTextEl.textContent)||'').trim() : '';
  state.items.push({ q:qText, chosen:chosenText, correct:correctText, explanation, infoImage, infoText, isCorrect:false });
})(); }
        } catch(err){ console.warn('NovaTracker capture error:', err); }
      }, 250);
    }, true);

    function getBadge(rate){ if(rate>=90) return 'ELMAS'; if(rate>=75) return 'ALTIN'; if(rate>=60) return 'GÜMÜŞ'; return 'BRONZ'; }

    function drawGauge(rate){
      const canvas = document.getElementById('nzGauge'); if(!canvas) return;
      const ctx = canvas.getContext('2d'); const w=canvas.width, h=canvas.height; const cx=w/2, cy=h/2, r=Math.min(w,h)/2-10;
      ctx.clearRect(0,0,w,h);
      ctx.lineWidth=16; ctx.strokeStyle='#e5e7eb'; ctx.beginPath(); ctx.arc(cx,cy,r,Math.PI,2*Math.PI); ctx.stroke();
      const end=Math.PI+(rate/100)*Math.PI; ctx.strokeStyle= rate>=75 ? '#10b981' : (rate>=60 ? '#f59e0b' : '#ef4444');
      ctx.beginPath(); ctx.arc(cx,cy,r,Math.PI,end); ctx.stroke();
      ctx.fillStyle='#111827'; ctx.font='800 28px system-ui,Segoe UI,Roboto'; ctx.textAlign='center'; ctx.fillText(`${Math.round(rate)}%`,cx,cy+8);
    }

    function renderSummary(){
      const wrap=document.getElementById('nova-summary'); if(!wrap) return;
      const {total, correctCount, items}=state; const rate= total>0 ? (correctCount/total)*100 : 0;
      const rateEl=document.getElementById('nz-kpi-rate');
      document.getElementById('nz-kpi-correct').textContent=String(correctCount);
      document.getElementById('nz-kpi-total').textContent=String(total);
      rateEl.textContent=`${Math.round(rate)}%`;
      rateEl.className = rate>=75 ? 'value ok' : (rate>=60 ? 'value warn' : 'value bad');
      drawGauge(rate); document.getElementById('nzBadge').textContent=getBadge(rate);

      const list=document.getElementById('nzWrongList'); list.innerHTML='';
      items.slice(0,8).forEach((it,idx)=>{
        const div=document.createElement('div'); div.className='nz-item';
        div.innerHTML=`
          <div class="nz-q">${idx+1}. ${escapeHtml(it.q)}</div>
          ${it.infoImage ? `<div class="nz-info"><img class="nz-info-img" src="${escapeHtml(it.infoImage)}" alt="Öncül"/></div>` : (it.infoText ? `<div class="nz-info nz-info-text">${escapeHtml(it.infoText)}</div>` : ``)}
          <div class="nz-pair"><span class="nz-pill nz-you">Senin Cevabın</span><span>${escapeHtml(it.chosen||'-')}</span></div>
          <div class="nz-pair"><span class="nz-pill nz-true">Doğru Cevap</span><span>${escapeHtml(it.correct||'-')}</span></div>
          ${it.explanation?`<div class="nz-exp">${escapeHtml(it.explanation)}</div>`:''}
        `;
        list.appendChild(div);
      });
      wrap.classList.add('nz-show');
    }

    function openModal(){
      const modal=document.getElementById('nova-modal'); const list=document.getElementById('nzModalList');
      list.innerHTML='';
      state.items.forEach((it,idx)=>{
        const div=document.createElement('div'); div.className='nz-item';
        div.innerHTML=`
          <div class="nz-q">${idx+1}. ${escapeHtml(it.q)}</div>
          ${it.infoImage ? `<div class="nz-info"><img class="nz-info-img" src="${escapeHtml(it.infoImage)}" alt="Öncül"/></div>` : (it.infoText ? `<div class="nz-info nz-info-text">${escapeHtml(it.infoText)}</div>` : ``)}
          <div class="nz-pair"><span class="nz-pill nz-you">Senin Cevabın</span><span>${escapeHtml(it.chosen||'-')}</span></div>
          <div class="nz-pair"><span class="nz-pill nz-true">Doğru Cevap</span><span>${escapeHtml(it.correct||'-')}</span></div>
          ${it.explanation?`<div class="nz-exp">${escapeHtml(it.explanation)}</div>`:''}
        `;
        list.appendChild(div);
      });
      modal.style.display='flex';
    }

    return { state, renderSummary, openModal };
  })();

  // Observe score container visibility
  function observeScoreContainer(){
    const sc=document.querySelector('.score-container, #score-container');
    if(!sc) return;
    const obs=new MutationObserver(()=>{
      const visible=(getComputedStyle(sc).display!=='none' && sc.offsetParent!==null) || sc.classList.contains('show') || sc.classList.contains('active');
      if(visible && !NovaTracker.state.finished){
        NovaTracker.state.finished=true;
        mountSummary(sc);
        
        try {
          var backBtn = document.getElementById('result-back-btn');
          if (backBtn) { backBtn.style.display = 'inline-flex'; }
        } catch(_) {}
        // Also remove legacy area if present
        const wb=document.querySelector('.wrong-block'); if(wb) wb.style.display='none';
        const actLesson=document.getElementById('act-lesson'); if(actLesson) actLesson.style.display='none';
        const actReview=document.getElementById('act-review'); if(actReview) actReview.style.display='none';
        const actPrint=document.getElementById('act-print'); if(actPrint) actPrint.style.display='none';
        const lessonBtn=document.getElementById('lesson-video-button'); if(lessonBtn) lessonBtn.style.display='none';
        NovaTracker.renderSummary();
      }
    });
    obs.observe(sc,{attributes:true,attributeFilter:['style','class']});
  }
  function mountSummary(sc){
    const nova=document.getElementById('nova-summary');
    if(nova){ sc.insertAdjacentElement('afterend', nova); }
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    const sc=document.querySelector('.score-container, #score-container');
    const nova=document.getElementById('nova-summary'); if(sc && nova){ sc.insertAdjacentElement('afterend', nova); }
    observeScoreContainer();

    const rpt=document.getElementById('nzRepeatBtn');
    const vid=document.getElementById('nzVideoBtn');
    if(rpt) rpt.addEventListener('click', NovaTracker.openModal);
    if(vid) vid.addEventListener('click', ()=>{
      // Prefer native lesson video action if present
      try{ document.getElementById('lesson-video-button')?.click(); }catch(_){}
      // Direct Nova fallback (NEW clears legacy btn)
      try{ if (window.NovaLessonVideo && typeof window.NovaLessonVideo.open==='function'){ window.NovaLessonVideo.open(); } }catch(_){}
      // Fire integration event with analysis payload
      try{ window.dispatchEvent(new CustomEvent('nova:open-lesson-video', { detail: { tracker: 'nova', data: (window.NovaTracker && window.NovaTracker.state) || null } })); }catch(_){}
    });
  });
})();
</script>
<!-- === Nova: Responsive & Symmetric Layout Patch (v4 CSS) === -->
<style>
/* Global box model for symmetry */
*, *::before, *::after { box-sizing: border-box; }

/* Nova container sizing */
#nova-summary{display:none;flex-direction:column;gap:18px;width:100%;max-width:1100px;margin:0 auto;padding:0 12px}
#nova-summary.nz-show{display:flex;}

/* KPI row uses grid for perfect symmetry */
.nz-row{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
@media (max-width:768px){
  .nz-row{grid-template-columns:1fr}
}

/* Wrong list: responsive auto-fit */
.nz-wrong-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:14px}
@media (max-width:768px){
  .nz-wrong-list{grid-template-columns:1fr}
}

/* Cards tightened to avoid overflow */
.nz-card{min-width:0}

/* Gauge centers nicely */
.nz-gauge{margin:0 auto;width:100%;max-width:560px}
.nz-gauge canvas{width:100%;height:auto;aspect-ratio:1/1;}

/* Buttons wrap well */
.nz-actions{flex-wrap:wrap;justify-content:flex-end}
</style>
<!-- === Nova: Score Container Replace & Strict Single-UI (v4 JS) === -->
<script>
(function(){
  // When score container becomes visible, move nova-summary INSIDE it and clear others
  function mountStrictlyInside(sc){
    const nova=document.getElementById('nova-summary');
    if(!nova) return;
    // wipe everything else so legacy UI disappears
    try { sc.innerHTML=''; } catch(_){}
    sc.appendChild(nova);
  }

  function observeAndMount(){
    const sc=document.querySelector('.score-container, #score-container');
    if(!sc) return;
    const once=()=>{
      mountStrictlyInside(sc);
      if(!window.__novaStrictMounted){
        window.__novaStrictMounted=true;
      }
    };
    // If already visible now, mount immediately
    const visible=(getComputedStyle(sc).display!=='none' && sc.offsetParent!==null) || sc.classList.contains('show') || sc.classList.contains('active');
    if(visible) once();
    const obs=new MutationObserver(()=>{
      const vis=(getComputedStyle(sc).display!=='none' && sc.offsetParent!==null) || sc.classList.contains('show') || sc.classList.contains('active');
      if(vis) once();
    });
    obs.observe(sc,{attributes:true,attributeFilter:['style','class']});
  }
  window.addEventListener('DOMContentLoaded', observeAndMount);
})();
</script>
<!-- === Nova: Overlap Fix & Typography Tune (v5 CSS) === -->
<style>
/* Safe container spacing to avoid overlaps */
#nova-summary{gap:20px;padding:12px 16px}

/* KPI cards: ensure consistent height */
.nz-card{display:flex;flex-direction:column;justify-content:center;min-height:64px}

/* Gauge block: fixed max width & height with internal centering */
.nz-gauge{width:100%;max-width:520px;min-height:260px;padding:14px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.nz-gauge canvas{max-width:480px;max-height:240px;width:100%;height:auto}
.nz-badge{position:absolute;bottom:14px}

/* Wrong list typography: readable but compact to avoid giant texts */
.nz-q{font-size:1rem;line-height:1.45}
.nz-pair{font-size:.95rem;line-height:1.4}
.nz-exp{font-size:.95rem;line-height:1.45}

/* Card shadows and borders consistent */
.nz-item{border-left-width:6px}

/* Ensure summary blocks have spacing from page edges inside #score-container */
#score-container, .score-container{padding:8px 0 !important}
</style>
<!-- === Nova: Question Stem Support & Safer Canvas Size (v5 JS) === -->
<script>
(function(){
  // Extend findQuestionText to include stem/öncül
  function _getText(el){ return (el && (el.innerText||el.textContent)||'').trim(); }
  window.__novaFindQuestionText = function(){
    const root = document.querySelector('.question-container, #question-container, .soru-container, .quiz-question, .game-question, .question-area, .questionWrap, .question-wrapper') || document;
    const qSelectors = [
      '.question-text', '.question-title', '.question', '#question', '#question-text',
      '.soru-text', '.soruMetni', '.soru', '.prompt', '.quiz-question h2', '.quiz-question h3'
    ];
    const stemSelectors = [
      '.question-stem', '.question-preamble', '.question-desc', '.stem', '.preamble',
      '.oncul', '.öncül', '.soru-oncul', '.soru-öncül', '.kok', '.kök', '.soru-koku', '.soru-kök'
    ];
    let stem='';
    for(const sel of stemSelectors){
      const el = root.querySelector(sel);
      if(el && _getText(el).length>3){ stem = _getText(el); break; }
    }
    let q='';
    for(const sel of qSelectors){
      const el = root.querySelector(sel);
      if(el && _getText(el).length>5){ q=_getText(el); break; }
    }
    if(!q){
      // Fallback longest text (excluding options)
      const options = new Set(Array.from(root.querySelectorAll('.options, .choices, .answers, .option, .option-button, button, .answer-option, .choice, .secenek')));
      function isInsideOptions(node){ let p=node; while(p){ if(options.has(p)) return true; p=p.parentNode; } return false; }
      let longest=''; const walker=document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
      while(walker.nextNode()){
        const txt=(walker.currentNode.nodeValue||'').trim();
        if(txt.length>8 && txt.length<400 && !isInsideOptions(walker.currentNode.parentNode)){ if(txt.length>longest.length) longest=txt; }
      }
      q = longest;
    }
    return (stem ? (stem + ' — ' + q) : q) || 'Soru metni bulunamadı';
  };

  // Use safer canvas size based on container width
  function _sizeGauge(){
    const cvs=document.getElementById('nzGauge');
    if(!cvs) return;
    const box=cvs.parentElement;
    const w=Math.min(480, Math.max(260, Math.floor(box.clientWidth*0.9)));
    cvs.width=w; cvs.height=w;
  }
  window.addEventListener('resize', _sizeGauge);

  // Patch tracker to call new finder and resizer
  const oldInit = window.addEventListener;
  window.addEventListener = function(type, listener, opts){
    if(type==='DOMContentLoaded'){
      const wrapped = function(e){
        try{ _sizeGauge(); }catch(_){}
        return listener && listener(e);
      };
      return oldInit.call(window, type, wrapped, opts);
    }
    return oldInit.call(window, type, listener, opts);
  };

  // Monkey-patch global NovaTracker if exists to use new finder
  const patchInterval = setInterval(()=>{
    try{
      if(typeof window.NovaTracker!=='undefined' && window.NovaTracker._useNewFinder!==true){
        const NT = window.NovaTracker;
        const orig = NT;
        // Replace only the text finder via closure trick
        document.addEventListener('click', function(e){
          const btn = e.target.closest('.option-button, .answer-option, .option, .choice');
          if(!btn) return;
          setTimeout(()=>{
            try{
              const qText = window.__novaFindQuestionText();
              // We won't duplicate; original listener already pushes item.
              // This is just to ensure when original fails; we could store last question globally
              window.__novaLastQuestion = qText;
            }catch(_){}
          }, 150);
        }, true);
        NT._useNewFinder = true;
        clearInterval(patchInterval);
      }
    }catch(_){}
  }, 200);
})();
</script>
<!-- === Nova: Gauge Redraw & Video CTA Styling (v6 CSS) === -->
<style>
/* Extra spacing so lists never collide with gauge */
#nova-summary .nz-gauge{margin-top:6px;margin-bottom:6px}

/* Eye-catching "Ders Videosu" */
#nzVideoBtn{
  background: linear-gradient(135deg,#111827 0%, #1f2937 50%, #0f172a 100%);
  color:#fff; border:0; position:relative; overflow:hidden;
}
#nzVideoBtn::after{
  content:""; position:absolute; inset:0;
  background: radial-gradient(120% 120% at 0% 0%, rgba(255,255,255,.18), transparent 50%);
  pointer-events:none; mix-blend:overlay;
}
#nzVideoBtn .nz-cta-icon{margin-right:8px;display:inline-block;transform:translateY(2px)}
@keyframes pulseCTA{0%{box-shadow:0 0 0 0 rgba(16,185,129,.45)}70%{box-shadow:0 0 0 14px rgba(16,185,129,0)}100%{box-shadow:0 0 0 0 rgba(16,185,129,0)}}
#nzVideoBtn{animation:pulseCTA 2.4s ease-out infinite;border-radius:12px}
</style>
<!-- === Nova: Mount Redraw & Robust Percentage (v6 JS) === -->
<script>
(function(){
  function ensureGaugeRedraw(){
    try{
      const cvs=document.getElementById('nzGauge');
      if(!cvs) return;
      // Recompute canvas intrinsic size based on container
      const box=cvs.parentElement;
      const w=Math.min(520, Math.max(260, Math.floor(box.clientWidth*0.9)));
      cvs.width=w; cvs.height=w;
      // If NovaTracker available, force render
      if(window.NovaTracker && typeof window.NovaTracker.renderSummary==='function'){
        window.NovaTracker.renderSummary();
      }
    }catch(_){}
  }

  // Hook into strict mount function if present
  const tryHook = setInterval(()=>{
    try{
      const sc=document.querySelector('.score-container, #score-container');
      const nova=document.getElementById('nova-summary');
      if(sc && nova && nova.parentElement===sc){
        clearInterval(tryHook);
        setTimeout(ensureGaugeRedraw, 50);
        window.addEventListener('resize', ensureGaugeRedraw);
      }
    }catch(_){}
  }, 120);

  // Make the KPI "Yüzde" always show a value even when total=0
  const safeRate = setInterval(()=>{
    try{
      const rateEl=document.getElementById('nz-kpi-rate');
      if(rateEl && !rateEl.textContent.trim()){
        rateEl.textContent='0%';
        rateEl.className='value bad';
      }
    }catch(_){}
  }, 300);

  // Decorate Video button with icon text
  window.addEventListener('DOMContentLoaded', ()=>{
    const v=document.getElementById('nzVideoBtn');
    if(v && !v.dataset.decorated){
      v.dataset.decorated='1';
      v.innerHTML = '<span class="nz-cta-icon">▶</span>Ders Videosu';
    }
  });
})();
</script>
<!-- === Nova v7 CSS: Compact Gauge, Hide Bottom Gauge, CTA, Layout === -->
<style>
/* Hide large gauge block entirely */
.nz-gauge{display:none !important}

/* Compact gauge card */
.nz-compact-card{display:flex;align-items:center;justify-content:center;min-height:120px}
#nzGaugeMini{width:160px;height:160px;max-width:100%;}
.nz-badge-mini{position:absolute;bottom:6px;left:50%;transform:translateX(-50%);font-weight:800;padding:4px 8px;border-radius:999px;border:2px solid #111827;background:#f8fafc;color:#111827}

/* Actions row: add Play Again primary button on the left */
.nz-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between}
.nz-left-actions{display:flex;gap:10px;flex-wrap:wrap}
#nzPlayBtn{background:#111827;color:#fff;border:0}
/* Make KPI row 4 cards on desktop */
#nova-summary .nz-row{grid-template-columns:repeat(4,1fr)}
@media (max-width:900px){ #nova-summary .nz-row{grid-template-columns:repeat(2,1fr)} }
@media (max-width:640px){ #nova-summary .nz-row{grid-template-columns:1fr} }

/* CTA button styling (keep from v6) */
#nzVideoBtn{
  background: linear-gradient(135deg,#111827 0%, #1f2937 50%, #0f172a 100%);
  color:#fff; border:0; position:relative; overflow:hidden;border-radius:12px
}
#nzVideoBtn::after{
  content:""; position:absolute; inset:0;
  background: radial-gradient(120% 120% at 0% 0%, rgba(255,255,255,.18), transparent 50%);
  pointer-events:none; mix-blend:overlay;
}
#nzVideoBtn .nz-cta-icon{margin-right:8px;display:inline-block;transform:translateY(2px)}
@keyframes pulseCTA{0%{box-shadow:0 0 0 0 rgba(16,185,129,.45)}70%{box-shadow:0 0 0 14px rgba(16,185,129,0)}100%{box-shadow:0 0 0 0 rgba(16,185,129,0)}}
#nzVideoBtn{animation:pulseCTA 2.4s ease-out infinite}
</style>
<!-- === Nova v7 JS: Compact Gauge, Play Again, Stronger Video Open, Percent Fix === -->
<script>
(function(){
  // Helpers
  function escapeHtml(s){return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
  function q(sel,root=document){return root.querySelector(sel);}
  function qa(sel,root=document){return Array.from(root.querySelectorAll(sel));}

  // Build compact gauge card dynamically (after summary exists)
  function ensureCompactGauge(){
    const topRow=q('#nova-summary .nz-row'); if(!topRow) return;
    if(!q('#nzGaugeMini')){
      const card=document.createElement('div'); card.className='nz-card nz-compact-card';
class="nz-badge-mini">BRONZ</div></div>`;
      topRow.appendChild(card);
    }
  }

  // Draw gauge on either mini or legacy id
  function drawGauge(rate){
    const canvas = q('#nzGaugeMini') || q('#nzGauge');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    const cx = w/2, cy = h/2, r = Math.min(w,h)/2 - 10;
    ctx.clearRect(0,0,w,h);
    ctx.lineWidth = 16;
    // Back arc
    ctx.strokeStyle = '#e5e7eb';
    ctx.beginPath(); ctx.arc(cx, cy, r, Math.PI, 2*Math.PI); ctx.stroke();
    // Value arc
    const end = Math.PI + (Math.max(0, Math.min(100, rate))/100)*Math.PI;
    ctx.strokeStyle = rate>=75 ? '#10b981' : (rate>=60 ? '#f59e0b' : '#ef4444');
    ctx.beginPath(); ctx.arc(cx, cy, r, Math.PI, end); ctx.stroke();
    // Text
    ctx.fillStyle = '#111827'; ctx.font = '800 28px system-ui,Segoe UI,Roboto'; ctx.textAlign='center';
    ctx.fillText(`${Math.round(rate)}%`, cx, cy+8);
  }

  function getBadge(rate){ if(rate>=90) return 'ELMAS'; if(rate>=75) return 'ALTIN'; if(rate>=60) return 'GÜMÜŞ'; return 'BRONZ'; }

  // Strong opener for lesson video
  function openLessonVideo(payload){
    // 1) Try explicit id
    const byId = q('#lesson-video-button');
    if(byId){ if(byId.tagName==='A' && byId.href){ window.open(byId.href,'_blank'); return; } byId.click(); return; }
    // 2) Try anchor candidates with href
    const link = qa('a[href*="youtube"],a[href*="video"],a[data-lesson],a[data-video],.lesson-video a,.ders-video a').find(a=>a.href);
    if(link){ window.open(link.href,'_blank'); return; }
    // 3) Try button candidates
    const btn = q('.lesson-video, .ders-video, button[data-lesson], button[data-video], button[id*="video"], button[onclick*="video"]');
    if(btn){ btn.click(); return; }
    // 4) Try text-based match on buttons/links
    const elems = qa('a,button'); 
    const t = (el)=> (el.textContent||'').toLowerCase().replace(/\s+/g,' ');
    const hit = elems.find(el=> t(el).includes('ders videosu') || t(el).includes('video'));
    if(hit){ if(hit.tagName==='A' && hit.href){ window.open(hit.href,'_blank'); return; } hit.click(); return; }
    // 5) Fallback: emit event for host app
    try{ window.dispatchEvent(new CustomEvent('nova:open-lesson-video', { detail: payload })); }catch(_){}
    // 6) Last resort: ask host to bind or show message
    alert('Ders videosu bağlantısı bulunamadı. Lütfen sayfada #lesson-video-button ya da bir video bağlantısı tanımlayın.');
  }

  // Play again handler
  function clickPlayAgain(){
    // Prefer known ids/classes
    let el = q('#play-again, .play-again, #btn-retry, .btn-retry, .retry, #retry, .again, #again, #btnTekrar');
    if(!el){
      const candidates = qa('button,a');
      el = candidates.find(x=> (x.textContent||'').trim().toLowerCase().includes('tekrar oyna') || (x.textContent||'').toLowerCase().includes('yeniden'));
    }
    if(el){ if(el.tagName==='A' && el.href){ window.location.href = el.href; } else { el.click(); } }
    else { location.reload(); }
  }

  // Patch existing NovaTracker render to update mini gauge & badges + inject Play Again button above wrong summary
  const patcher = setInterval(()=>{
    try{
      // Ensure compact gauge card exists
      ensureCompactGauge();
      // Wire action buttons row: left side "Tekrar Oyna"
      const actionsRow = q('#nzWrongList')?.parentElement?.querySelector('.nz-actions');
      if(actionsRow && !q('#nzPlayBtn')){
        const leftWrap = document.createElement('div'); leftWrap.className='nz-left-actions';
        leftWrap.innerHTML = `<button id="nzPlayBtn" class="nz-btn nz-primary">Tekrar Oyna</button>`;
        actionsRow.prepend(leftWrap);
        q('#nzPlayBtn').addEventListener('click', clickPlayAgain);
      }
      // Wire "Ders Videosu" button robustly
      const v = q('#nzVideoBtn'); if(v && !v.dataset.bound){ v.dataset.bound='1'; v.addEventListener('click', ()=>openLessonVideo({source:'nova'})); }

      // Monkey-patch renderSummary to also update mini
      if(window.NovaTracker && !window.NovaTracker.__v7patched){
        const orig = window.NovaTracker.renderSummary;
        window.NovaTracker.renderSummary = function(){
          const res = orig.apply(window.NovaTracker, arguments);
          // update rate text class & draw mini gauge
          try{
            const total = window.NovaTracker.state.total || 0;
            const correct = window.NovaTracker.state.correctCount || 0;
            const rate = total>0 ? (correct/total)*100 : 0;
            drawGauge(rate);
            const badge = getBadge(rate);
            const mini = q('#nzBadgeMini'); if(mini) mini.textContent = badge;
          }catch(_){}
          return res;
        };
        window.NovaTracker.__v7patched = true;
      }
      // First-time draw if possible
      if(window.NovaTracker && window.NovaTracker.state){
        const t = window.NovaTracker.state.total||0;
        const c = window.NovaTracker.state.correctCount||0;
        const rate = t>0 ? (c/t)*100 : 0;
        drawGauge(rate);
        const mini = q('#nzBadgeMini'); if(mini) mini.textContent = getBadge(rate);
        const rateEl = q('#nz-kpi-rate'); if(rateEl && !rateEl.textContent.trim()) rateEl.textContent='0%';
      }
      clearInterval(patcher);
    }catch(_){}
  }, 150);
})();
</script>
<script>
/* === NOVA PREMIUM JS: End Screen Builder & Dedupe === */
(function(){
  const byText = (root, text) => {
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, null);
    const result = [];
    while (walker.nextNode()) {
      const el = walker.currentNode;
      if (el.textContent && el.textContent.trim().toLowerCase() === text.toLowerCase()) result.push(el);
    }
    return result;
  };

  const findButtonsByLabel = (root, label) => {
    const btns = Array.from(root.querySelectorAll('button, a'));
    return btns.filter(b => (b.textContent || '').trim().toLowerCase() === label.toLowerCase());
  };

  const percentToBadge = (p) => {
    if (p >= 90) return { cls: 'elmas', label: 'ELMAS' };
    if (p >= 75) return { cls: 'altin', label: 'ALTIN' };
    if (p >= 60) return { cls: 'gumus', label: 'GÜMÜŞ' };
    return { cls: 'bronz', label: 'BRONZ' };
  };

  const buildGauge = (percent) => {
    const p = Math.max(0, Math.min(100, Math.round(percent || 0)));
    const r = 90, c = 2 * Math.PI * r;
    const filled = c * (p / 100);
    const empty = c - filled;
    return `
      <div class="nova-gauge">
        <svg viewBox="0 0 220 220">
          <defs>
            <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0%" stop-color="#8b5cf6"/>
              <stop offset="100%" stop-color="#6366f1"/>
            </linearGradient>
          </defs>
          <circle cx="110" cy="110" r="${r}" fill="none" stroke="#e5e7eb" stroke-width="16" />
          <circle cx="110" cy="110" r="${r}" fill="none" stroke="url(#g)" stroke-linecap="round"
            stroke-width="16" stroke-dasharray="${filled} ${empty}" transform="rotate(-90 110 110)" />
        </svg>
        <div class="center">
          <div class="percent">${p}%</div>
          <div class="label">Başarı</div>
        </div>
      </div>`;
  };

  const enhance = () => {
    const sc = document.querySelector('#score-container, .score-container');
    if (!sc || getComputedStyle(sc).display === 'none') return;

    // Try to infer metrics from existing DOM or globals
    let total = window.totalQuestions || window.toplamSoru || null;
    let correct = window.correctAnswers || window.dogruSayisi || null;
    let percent = window.successPercent || window.yuzde || null;

    // Fallback: parse from any elements that look like numbers
    const numFrom = (sel) => {
      const el = sc.querySelector(sel);
      if (!el) return null;
      const m = (el.textContent||'').match(/\d+(?:[\.,]\d+)?/);
      return m ? Number(m[0].replace(',', '.')) : null;
    };
    if (total == null) total = numFrom('[data-total], .total, .toplam, .metric-total');
    if (correct == null) correct = numFrom('[data-correct], .correct, .dogru, .metric-correct');
    if (percent == null){
      percent = numFrom('[data-percent], .percent, .yuzde, .metric-percent');
      if (percent == null && total && (correct!=null)) percent = Math.round((correct/total)*100);
    }

    // Dedupe "Tekrar Oyna" buttons: keep the bottom-most
    const allReplay = findButtonsByLabel(sc, 'Tekrar Oyna');
    if (allReplay.length > 1){
      // sort by vertical position
      const sorted = [...allReplay].sort((a,b)=> (a.getBoundingClientRect().top)-(b.getBoundingClientRect().top));
      // keep the last (bottom-most)
      const keeper = sorted[sorted.length-1];
      sorted.slice(0,-1).forEach(x=> x.classList.add('nova-dedupe-hide'));
      keeper.classList.add('tekrar-oyna'); // style enhancer
    }else if(allReplay.length === 1){
      allReplay[0].classList.add('tekrar-oyna');
    }

    // Remove duplicate percentage/progress widgets commonly seen
    const dupSelectors = [
      '.progress-bar', '.progress', '.gauge', '.circle', '.meter',
      '.stats-item', '.student-stats', '.trophy', '.trophy-container'
    ];
    let seenOnce = false;
    dupSelectors.forEach(sel=>{
      const nodes = sc.querySelectorAll(sel);
      if (nodes.length){
        nodes.forEach((n,i)=>{
          if (!seenOnce){ seenOnce = true; return; }
          n.classList.add('nova-dedupe-hide');
        });
      }
    });

    // Build a premium wrapper on top (non-destructive): prepend
    const wrapper = document.createElement('div');
    wrapper.className = 'nova-end-wrapper';
    // Left: metrics card with single gauge
    const badge = percentToBadge(percent||0);
    wrapper.innerHTML = `
      <div class="nova-card">
        <div class="nova-top">
          ${buildGauge(percent||0)}
          <div class="nova-metrics">
            <div class="metric">
              <div class="kpi">${correct != null ? correct : '-'}</div>
              <div class="name">Doğru</div>
            </div>
            <div class="metric">
              <div class="kpi">${total != null ? total : '-'}</div>
              <div class="name">Toplam</div>
            </div>
            <div class="metric">
              <div class="kpi">${percent != null ? Math.round(percent) : '-' }%</div>
              <div class="name">Yüzde</div>
            </div>
          </div>
        </div>
        <div class="nova-badge ${badge.cls}" title="Başarı Rozeti">${badge.label}</div>
      </div>
      <div class="nova-card nova-wrongs">
        <div class="title">Yanlış Soru Özeti</div>
        <div class="subtitle">Yanlış cevapladığın sorular burada listelenir. (Varolan içerik korunur)</div>
        <div class="nova-wrong-list" id="novaWrongListHook"></div>
      </div>
    `;

    // Insert at top if not already present
    if (!sc.querySelector('.nova-end-wrapper')){
      sc.prepend(wrapper);
    }

    // Try to surface existing wrong items into our list (non-destructive copy)
    const hook = sc.querySelector('#novaWrongListHook');
    if (hook){
      // Heuristics: find wrong answer blocks
      const candidates = sc.querySelectorAll('.wrong, .yanlis, .wrong-item, .yanlis-item, .explanation-card, .explanation-text');
      if (candidates.length){
        candidates.forEach((c, idx)=>{
          // Extract lines for question / your answer / correct / explanation if present
          const txt = (c.innerText||'').trim().replace(/\s+/g,' ');
          if (!txt) return;
          const item = document.createElement('div');
          item.className = 'nova-wrong-item';
          item.innerHTML = \`
            <div class="q">\${txt.split('. ').slice(0,1)[0]}</div>
            <div class="row">
              <div><span class="lbl">Senin Cevabın</span><span class="val">—</span></div>
              <div><span class="lbl">Doğru Cevap</span><span class="val">—</span></div>
            </div>
          \`;
          hook.appendChild(item);
        });
      }else{
        // If nothing found, keep area empty but visible
        hook.innerHTML = '<div class="nova-wrong-item"><div class="q">Harika! Listeleyecek yanlış yok.</div></div>';
      }
    }

    // Align the final existing replay button in a dedicated CTA row (if exists)
    const keeper = sc.querySelector('.tekrar-oyna');
    if (keeper){
      // Move keeper to the bottom CTA area visually
      const cta = document.createElement('div');
      cta.className = 'nova-cta';
      keeper.parentElement && keeper.parentElement.removeChild(keeper);
      cta.appendChild(keeper);
      sc.appendChild(cta);
    }
  };

  // Observe visibility/state changes
  const runWhenVisible = () => {
    try{
      enhance();
    }catch(e){ console.warn('NOVA premium end-screen enhance failed:', e); }
  };

  const mo = new MutationObserver(runWhenVisible);
  mo.observe(document.documentElement, { attributes: true, childList: true, subtree: true });

  // Also run after load + slight delay
  window.addEventListener('load', ()=> setTimeout(runWhenVisible, 300));
})();
</script>
<!-- === NOVA PATCH: Single Player Result Ring & Badge Cleanup === -->
<script>
(function(){
  function ensureNovaStyles(){
    if(document.getElementById('novaGradientDefs')) return;
    const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('width','0'); svg.setAttribute('height','0'); svg.style.position='absolute';
    svg.innerHTML = '<defs id="novaGradientDefs">' +
      '<linearGradient id="novaGrad" x1="0%" y1="0%" x2="100%" y2="0%">' +
      '<stop offset="0%" stop-color="#6EE7F9"/>' +
      '<stop offset="50%" stop-color="#A78BFA"/>' +
      '<stop offset="100%" stop-color="#F472B6"/>' +
      '</linearGradient>' +
    '</defs>';
    document.body.appendChild(svg);
  }

  function tryGetTotals(){
    let score = 0, total = 10;
    // Common globals
    if (typeof window.score === 'number') score = window.score;
    if (typeof window.singleScore === 'number') score = window.singleScore;
    if (typeof window.totalQuestions === 'number') total = window.totalQuestions;
    if (Array.isArray(window.questions)) total = window.questions.length;
    // Fallbacks from DOM
    const domScore = document.querySelector('.single-player-game-container .score-container .game-cup-score, .single-player-game-container .score-container .final-score, .single-player-game-container .score-container [data-score]');
    if (domScore){
      const n = parseInt(domScore.textContent,10);
      if(!isNaN(n)) score = n;
    }
    // Sensible clamp
    score = Math.max(0, score);
    total = Math.max(1, total);
    return {score, total, percent: Math.round((score/total)*100)};
  }

  function removeBadges(scope){
    const selectors = [
      '.trophy','.trophy-container','.trophy-inner','.game-cup-image','.game-cup-score','.kupa','.kupa-siralama',
      '.medal','.badge','.rozet','.winner-message'
    ];
    selectors.forEach(sel => scope.querySelectorAll(sel).forEach(el=>el.remove()));
    // Remove nodes whose visible text is a medal word
    const words = /(bronze|silver|gold|gümüş|altın|bronz|rozet)/i;
    scope.querySelectorAll('*').forEach(el=>{
      try{
        const t = (el.textContent||'').trim();
        if(t && words.test(t) && el.children.length===0) el.remove();
      }catch(_){}
    });
  }

  function renderRing(){
    const scope = document.querySelector('.single-player-game-container .score-container');
    if(!scope) return;
    removeBadges(scope);
    // Avoid duplicates
    if(scope.querySelector('#novaCircular')) return;
    ensureNovaStyles();
    const {percent} = tryGetTotals();
    const radius = 94/2; // since we use viewBox 0 0 120 120, use r=54
    const r = 54, c = 2*Math.PI*r;
    const wrap = document.createElement('div');
    wrap.id = 'novaCircular';
    wrap.className = 'nova-circular-wrap';
    wrap.innerHTML = `
      <svg class="nova-circular nova-ring-glow" viewBox="0 0 120 120">
        <circle class="nova-track" cx="60" cy="60" r="${r}"></circle>
        <circle class="nova-progress" cx="60" cy="60" r="${r}" stroke="url(#novaGrad)" stroke-dasharray="${c}" stroke-dashoffset="${c}"></circle>
      </svg>
      <div class="nova-percent-text">0%</div>
    `;
    scope.prepend(wrap);
    // Animate
    requestAnimationFrame(function(){
      const prog = wrap.querySelector('.nova-progress');
      const txt = wrap.querySelector('.nova-percent-text');
      const target = Math.max(0, Math.min(100, percent));
      const start = performance.now();
      const duration = 1000;
      const cLen = c;
      function tick(now){
        const t = Math.min(1, (now-start)/duration);
        const val = Math.round(target * t);
        prog.style.strokeDashoffset = String(cLen - (val/100)*cLen);
        txt.textContent = val + '%';
        if(t < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    });
  }

  // Patch endGame so ring renders exactly when results appear
  function attach(){
    if(typeof window.endGame === 'function' && !window.endGame.__novaPatched){
      const orig = window.endGame;
      window.endGame = function(){
        const ret = orig.apply(this, arguments);
        setTimeout(renderRing, 50);
        return ret;
      };
      window.endGame.__novaPatched = true;
    }
    // Also observe DOM in case results are shown other ways
    const obs = new MutationObserver(function(muts){
      if (document.querySelector('.single-player-game-container .score-container')?.style.display !== 'none'){
        renderRing();
      }
    });
    obs.observe(document.body, {childList:true, subtree:true, attributes:true, attributeFilter:['style','class']});
  }

  document.addEventListener('DOMContentLoaded', attach);
  window.addEventListener('load', renderRing);
})();
</script>
<!-- === NOVA PATCH END === -->

<script>
(function(){
  function ensureBackWiring(){
    var btn = document.getElementById('result-back-btn');
    if(!btn || btn.dataset.bound) return;
    btn.dataset.bound = '1';
    btn.addEventListener('click', function(){
      // Try to simulate "Tek Kişilik Oyun" button click
      try {
        var single = document.querySelector('.single-player');
        if (single) { single.click(); return; }
      } catch(e){}
      // Fallback: navigate to main screen if app exposes api
      try { window.dispatchEvent(new CustomEvent('nova:go-single')); } catch(_) {}
    });
  }

  function toggleBackByScore(){
    var sc = document.querySelector('.score-container, #score-container');
    var backBtn = document.getElementById('result-back-btn');
    if(!backBtn) return;
    var visible = sc && ((getComputedStyle(sc).display!=='none' && sc.offsetParent!==null) || sc.classList.contains('show') || sc.classList.contains('active'));
    backBtn.style.display = visible ? 'inline-flex' : 'none';
  }

  // Observe score container if MutationObserver wasn't already wired elsewhere
  var sc = document.querySelector('.score-container, #score-container');
  if (sc && typeof MutationObserver !== 'undefined'){
    var obs = new MutationObserver(toggleBackByScore);
    obs.observe(document.body, {attributes:true,childList:true,subtree:true});
  }

  // Initial
  document.addEventListener('DOMContentLoaded', function(){
    ensureBackWiring();
    toggleBackByScore();
  });
  window.addEventListener('load', function(){
    ensureBackWiring();
    toggleBackByScore();
  });
})();
</script>


<!-- Nova v5b: Teacher Advice Card -->
<script>
(function(){
  function clamp(x){ return Math.max(0, Math.min(100, Math.round(x))); }

  function inferPercent(){
    var s = (typeof window.singleScore === 'number') ? window.singleScore : (typeof window.score === 'number' ? window.score : null);
    var t = (typeof window.totalQuestions === 'number') ? window.totalQuestions : (typeof window.toplamSoru === 'number' ? window.toplamSoru : null);
    if (typeof s === 'number' && typeof t === 'number' && t > 0) return clamp(100 * s / t);

    var el = document.getElementById('score');
    if (el){
      var ds = el.getAttribute('data-score');
      var dt = el.getAttribute('data-total') || el.getAttribute('data-toplam');
      if (ds && !isNaN(ds)){
        var v = Number(ds);
        if (dt && !isNaN(dt) && Number(dt) > 0) return clamp(100 * v / Number(dt));
        if (v <= 100) return clamp(v);
      }
      var txt = (el.textContent || '').trim();
      var m01 = txt.match(/(\d{1,3})\s*\/\s*(\d{1,3})/);
      if (m01){ return clamp(100 * Number(m01[1]) / Number(m01[2]||1)); }
      var m02 = txt.match(/(\d{1,3})\s*%/);
      if (m02){ return clamp(Number(m02[1])); }
    }

    var pNode = document.querySelector('#score-container .percent, #score-container .nova-percent-text');
    if (pNode){
      var m = (pNode.textContent||'').match(/(\d{1,3})\s*%/);
      if (m) return clamp(Number(m[1]));
    }

    var sc = document.getElementById('score-container');
    if (sc){
      var walker = document.createTreeWalker(sc, NodeFilter.SHOW_TEXT, null, false);
      var texts = [];
      while (walker.nextNode()) { texts.push(walker.currentNode.nodeValue); }
      var joined = texts.join(' ');
      var m2 = joined.match(/(\d{1,3})\s*%/);
      if (m2) return clamp(Number(m2[1]));
    }
    return null;
  }

  function getAdvice(p){
    if (p >= 0 && p < 30) {
      return "Bu sonuç hedefinin çok altında. Şimdi odaklanıp düzenli çalışmaya başlıyoruz; toparlayacağına güveniyorum. İlk işin yukarıdaki ders videosu butonuna basarak  dersimizin videosunu seyretmek, daha sonra da yanlış yaptığın soruları dikkatlice inceleyi unutma.";
    } else if (p >= 30 && p < 60) {
      return "Orta seviyenin altındasın. Eksikleri kapatmak için düzenli çalışman şart. Yukarıdan dersin videosunu seyredip yanlışlara bakman faydalı olacaktır.";
    } else if (p >= 60 && p < 90) {
      return "İyi bir seviye; dikkatini koruyup çalışmayı sürdürürsen daha yukarı çıkarsın. Yanlış yaptığın sorulara bakmayı ihmal etme.";
    } else if (p >= 90 && p <= 100) {
      return "Şampiyon sen harikasın ; çalışmanı bırakma, seviyeni sabitle , bu konuda gerçekten şahanesin.";
    }
    return "";
  }

  function ensureCard(){
    var sc = document.getElementById('score-container');
    if (!sc || getComputedStyle(sc).display === 'none') return null;
    var card = document.getElementById('teacher-advice-card');
    if (!card){
      card = document.createElement('div');
      card.id = 'teacher-advice-card';
      card.className = 'advice-card';
      card.innerHTML = '<div class="advice-title">ÖĞRETMENİNDEN TAVSİYE 😊</div><div class="advice-text" id="teacher-advice-text"></div>';
      var ring = sc.querySelector('.percent, .nova-percent-text, .nova-circular-wrap');
      var anchor = document.getElementById('score-message');
      if (ring && ring.parentNode) {
        var parent = ring.closest ? (ring.closest('#score-container') || ring.parentNode) : ring.parentNode;
        parent.parentNode.insertBefore(card, parent.nextSibling);
      } else if (anchor && anchor.parentNode) {
        anchor.parentNode.insertBefore(card, anchor.nextSibling);
      } else {
        sc.appendChild(card);
      }
    }
    return card;
  }

  function render(){
    var card = ensureCard();
    if (!card) return;
    var p = inferPercent();
    if (p == null) return;
    var text = document.getElementById('teacher-advice-text');
    if (text) text.textContent = getAdvice(p);
  }

  function boot(){
    render();
    setTimeout(render, 200);
    setTimeout(render, 600);
    setTimeout(render, 1200);
    var start = Date.now();
    var iv = setInterval(function(){
      render();
      if (Date.now() - start > 10000) clearInterval(iv);
    }, 500);
  }

  try{
    if (typeof window.endGame === 'function' && !window.endGame.__adviceV5b){
      var orig = window.endGame;
      window.endGame = function(){
        var r = orig.apply(this, arguments);
        setTimeout(boot, 50);
        return r;
      };
      window.endGame.__adviceV5b = true;
    }
  }catch(e){}

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
})();

// === Nova Duel Result Decorator v2 ===
(function(){
  function launchConfetti(durationMs){
    try{
      const old = document.getElementById('duel-confetti');
      if (old) old.remove();
      const c = document.createElement('canvas');
      c.id = 'duel-confetti';
      document.body.appendChild(c);
      const ctx = c.getContext('2d');
      let W= c.width = window.innerWidth, H = c.height = window.innerHeight;
      const pieces = Array.from({length: Math.min(220, Math.floor(W/6))}, (_,i)=> ({
        x: Math.random()*W, y: -20 - Math.random()*H*0.6,
        r: 4+Math.random()*6, // radius
        vx: -1+Math.random()*2, vy: 1+Math.random()*2.5 + 2,
        rot: Math.random()*Math.PI, vr: -0.1+Math.random()*0.2,
        s: Math.random()>.5?1:-1 // spin dir
      }));
      const colors = [[34,197,94],[16,185,129],[132,204,22],[250,204,21]];
      let rafId, start=performance.now();
      function loop(t){
        ctx.clearRect(0,0,W,H);
        for(const p of pieces){
          p.x += p.vx; p.y += p.vy; p.rot += p.vr;
          if (p.y - p.r > H){ p.y = -20; p.x = Math.random()*W; }
          const cidx = (p.r%colors.length)|0; const col = colors[cidx];
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillStyle = `rgba(${col[0]},${col[1]},${col[2]},${0.9})`;
          ctx.fillRect(-p.r, -p.r*0.6, p.r*2, p.r*1.2);
          ctx.restore();
        }
        if (t - start < durationMs) rafId = requestAnimationFrame(loop);
        else { cancelAnimationFrame(rafId); c.remove(); }
      }
      rafId = requestAnimationFrame(loop);
      window.addEventListener('resize', ()=>{ W= c.width = innerWidth; H = c.height = innerHeight; });
    }catch(e){ console.warn('Confetti failed', e); }
  }

  window.novaDecorateDuelResult = function(outcome){
    try{
      const inviterBox = document.getElementById('duel-player-inviter-score');
      const invitedBox = document.getElementById('duel-player-invited-score');
      inviterBox && inviterBox.classList.remove('winner','loser','tie');
      invitedBox && invitedBox.classList.remove('winner','loser','tie');

      const root = document.getElementById('duel-game-screen');
      root && root.classList.remove('duel-final-theme-win','duel-final-theme-lose','duel-final-theme-tie');

      if (outcome === 'inviterWin'){
        inviterBox && inviterBox.classList.add('winner');
        invitedBox && invitedBox.classList.add('loser');
        root && root.classList.add('duel-final-theme-win');
        launchConfetti(3500);
      } else if (outcome === 'invitedWin'){
        invitedBox && invitedBox.classList.add('winner');
        inviterBox && inviterBox.classList.add('loser');
        root && root.classList.add('duel-final-theme-win');
        launchConfetti(3500);
      } else {
        inviterBox && inviterBox.classList.add('tie');
        invitedBox && invitedBox.classList.add('tie');
        root && root.classList.add('duel-final-theme-tie');
      }
    }catch(e){ console.warn(e); }
  };
})();
// === End Nova ===

</script>

<!-- NOVA_DUEL_ENHANCEMENTS_START -->
<script>
(function(){
  // Helper: once dom ready
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));
    const gameScreen = $('#duel-game-screen');

    // Topbar add (non-breaking)
    function ensureTopbar(){
      if(!gameScreen) return;
      if($('#nova-duel-topbar')) return;
      const top = document.createElement('div');
      top.className = 'duel-topbar';
      top.id = 'nova-duel-topbar';
      top.innerHTML = '<div class="duel-topbar-inner">        <div class="pname" id="tb-left">-</div>        <div class="vs">⚔️</div>        <div class="pname" id="tb-right">-</div>      </div>';
      gameScreen.prepend(top);
      top.style.display = 'block';
    }

    // Intro overlay create once
    function ensureIntro(){
      if($('#nova-duel-intro')) return $('#nova-duel-intro');
      const ov = document.createElement('div');
      ov.className = 'duel-intro-overlay';
      ov.id = 'nova-duel-intro';
      ov.innerHTML = `
       <div class="duel-intro-stage">
        <div class="duel-countdown">DÜELLO BAŞLIYOR: <span class="count-num" id="introCount">3</span></div>
        <svg class="swords" viewBox="0 0 512 512" aria-hidden="true">
          <path d="M352 16l-64 64 32 32 64-64-32-32zm-96 96L80 288l-32 96 96-32 176-176-64-64zM96 368l48-16-32-32-16 48zm224-144l64 64 128-128-64-64-128 128z" fill="#f5f5f5"/>
          <path d="M184 296l32 32 16-16-32-32-16 16z" fill="#e5e7eb"/>
        </svg>
        <div class="duel-side left">
          <img class="duel-intro-photo" id="introLPhoto" src=""/>
          <div class="duel-intro-name" id="introLName">Oyuncu 1</div>
        </div>
        <div class="duel-side right">
          <img class="duel-intro-photo" id="introRPhoto" src=""/>
          <div class="duel-intro-name" id="introRName">Oyuncu 2</div>
        </div>
        <div class="duel-vs-wrap"><div class="duel-vs-badge">VS</div></div>
       </div>`;
      document.body.appendChild(ov);
      return ov;
    }

    // Mutation observer: when duel screen becomes visible -> run intro once
    let introPlayedThisRound = false;
    function playIntroIfNeeded(){
      if(introPlayedThisRound) return;
      if(!gameScreen) return;
      const visible = window.getComputedStyle(gameScreen).display !== 'none';
      if(!visible) return;

      ensureTopbar();
      const ov = ensureIntro();
      // Pull names/photos from existing DOM (fallback safe)
      const lName = ($('#duel-player-inviter-name')?.textContent || $('#duel-inviter-name')?.textContent || 'Oyuncu 1').trim();
      const rName = ($('#duel-player-invited-name')?.textContent || $('#duel-invited-name')?.textContent || 'Oyuncu 2').trim();
      const lPhoto = ($('#duel-player-inviter-photo') || $('#duel-inviter-photo'))?.getAttribute('src') || '';
      const rPhoto = ($('#duel-player-invited-photo') || $('#duel-invited-photo'))?.getAttribute('src') || '';

      $('#introLName').textContent = lName || 'Oyuncu 1';
      $('#introRName').textContent = rName || 'Oyuncu 2';
      if(lPhoto) $('#introLPhoto').src = lPhoto;
      if(rPhoto) $('#introRPhoto').src = rPhoto;
      $('#tb-left').textContent = lName || 'Oyuncu 1';
      $('#tb-right').textContent = rName || 'Oyuncu 2';

      ov.style.display = 'flex';
      // countdown 3-2-1
      const cnt = $('#introCount');
      let n = 3;
      const tick = setInterval(()=>{
        n -= 1;
        if(n<=0){
          clearInterval(tick);
          // dismiss overlay and start
          ov.classList.add('dismissed');
          ov.style.display = 'none';
          introPlayedThisRound = true;
          animateQuestionNow();
        } else {
          cnt.textContent = String(n);
          cnt.classList.remove('count-num'); void cnt.offsetWidth; cnt.classList.add('count-num');
        }
      }, 800);
    }

    // Observe gameScreen display change
    if(gameScreen){
      const obs = new MutationObserver(()=>playIntroIfNeeded());
      obs.observe(gameScreen, { attributes:true, attributeFilter:['style','class'] });
      // Also run on initial
      setTimeout(playIntroIfNeeded, 300);
    }

    // Animate question when text changes
    function animateQuestionNow(){
      const qc = $('#duel-game-screen .question-container');
      if(qc){ qc.classList.remove('duel-animate'); void qc.offsetWidth; qc.classList.add('duel-animate'); }

      // add subtle ring on options
      $$('#duel-options-container .option-button').forEach(btn=>{
        if(!btn.querySelector('.ring')){
          const r = document.createElement('span'); r.className='ring'; btn.appendChild(r);
        }
      });
    }

    const qText = $('#duel-question-text');
    if(qText){
      const mo = new MutationObserver(()=>animateQuestionNow());
      mo.observe(qText, { childList:true, characterData:true, subtree:true });
    }

    // Enhance click feedback without breaking existing logic
    document.addEventListener('click', function(e){
      const t = e.target.closest('.option-button');
      if(!t) return;
      // particles
      for(let i=0;i<12;i++){
        const p = document.createElement('div');
        p.className='tap-pop';
        document.body.appendChild(p);
        const x = (e.clientX||0), y=(e.clientY||0);
        const ang = Math.random()*Math.PI*2, dist = 40+Math.random()*60;
        const tx = Math.cos(ang)*dist, ty = Math.sin(ang)*dist;
        const dur = 450 + Math.random()*400;
        p.style.left = (x-4)+'px'; p.style.top = (y-4)+'px';
        p.animate([
          { transform:`translate(0,0) scale(1)`, opacity:1 },
          { transform:`translate(${tx}px,${ty}px) scale(.6)`, opacity:0 }
        ], { duration: dur, easing:'cubic-bezier(.22,.61,.36,1)' }).onfinish = ()=>p.remove();
      }
    }, true);

    // Winner confetti when final container shows
    const finalC = $('#duel-final-container');
    function spawnConfetti(){
      for(let i=0;i<120;i++){
        const c = document.createElement('div');
        c.className='confetti';
        const hue = Math.floor(Math.random()*360);
        c.style.background = `hsl(${hue} 80% 55%)`;
        c.style.left = Math.floor(Math.random()*100)+'vw';
        c.style.setProperty('--tx', (Math.random()*60-30)+'vw');
        c.style.setProperty('--rot', (Math.random()*720-360)+'deg');
        c.style.setProperty('--dur', (1200+Math.random()*2200)+'ms');
        document.body.appendChild(c);
        setTimeout(()=>c.remove(), 4000);
      }
    }
    if(finalC){
      const fo = new MutationObserver(()=>{
        const visible = window.getComputedStyle(finalC).display !== 'none';
        if(visible) spawnConfetti();
      });
      fo.observe(finalC, { attributes:true, attributeFilter:['style','class'] });
    }

    // Public API for your code (optional, safe no-op if unused)
    window.NovaDuelFX = {
      resetRound:function(){ introPlayedThisRound=false; },
      playIntroNow: function(){ playIntroIfNeeded(); },
      animateQuestion: function(){ animateQuestionNow(); }
    };
  });
})();
</script>
<!-- NOVA_DUEL_ENHANCEMENTS_END -->


<!-- === NOVA: Duel Dark Theme & FX (non-destructive add-on) === -->
<style id="nova-duel-dark-style">
/* Base dark space backdrop toggled when duel screen is active */
body.nova-dark-duel {
  background: radial-gradient(1200px 800px at 50% 10%, #0f172a 0%, #0b1020 40%, #050811 70%, #000 100%) !important;
  transition: background 500ms ease;
  color: #e5e7eb;
}

/* Make primary duel container transparent so the starfield shows */
.nova-dark-duel .duel-game-container {
  background: transparent !important;
  box-shadow: none !important;
}

/* Readability-first card for the question */
.nova-dark-duel .question-container {
  background: rgba(17, 24, 39, 0.92) !important;  /* slate-900 */
  border: 2px solid #3b82f6 !important;           /* blue-500 */
  border-radius: 14px !important;
  color: #eaf2ff !important;
  text-shadow: 0 2px 6px rgba(0,0,0,.65);
}

/* Question text contrast */
.nova-dark-duel .question-text {
  color: #eaf2ff !important;
  text-shadow: 0 2px 6px rgba(0,0,0,.65);
  font-size: 1.18em !important;
  line-height: 1.35 !important;
}

/* Options: high-contrast dark pill buttons */
.nova-dark-duel .option-button {
  background: linear-gradient(180deg,#1f2937,#111827) !important; /* gray-800 to 900 */
  color: #f8fafc !important; /* slate-50 */
  border: 2px solid #334155 !important; /* slate-700 */
  box-shadow: 0 8px 16px rgba(0,0,0,.35) !important;
  font-weight: 800 !important;
  letter-spacing: .25px;
}
.nova-dark-duel .option-button:hover {
  background: linear-gradient(180deg,#334155,#1f2937) !important;
  transform: translateY(-2px) scale(1.02) !important;
  box-shadow: 0 14px 28px rgba(0,0,0,.5) !important;
}
.nova-dark-duel .option-button.correct {
  background: linear-gradient(180deg,#16a34a,#065f46) !important; /* green */
  border-color: #22c55e !important;
  text-shadow: 0 0 10px rgba(34,197,94,.7);
}
.nova-dark-duel .option-button.wrong {
  background: linear-gradient(180deg,#b91c1c,#7f1d1d) !important; /* red */
  border-color: #ef4444 !important;
  text-shadow: 0 0 10px rgba(239,68,68,.6);
}

/* Timer & progress for dark mode */
.nova-dark-duel .progress-bar {
  background: #0b1220 !important;
  border: 1px solid #1f2937 !important;
}
.nova-dark-duel .progress-bar-inner {
  background: linear-gradient(90deg,#22c55e,#84cc16) !important;
}
.nova-dark-duel .timer {
  color: #fca5a5 !important;
  text-shadow: 0 0 8px rgba(252,165,165,.6);
}

/* Players info cards get subtle glow */
.nova-dark-duel .duel-player-score {
  background: rgba(2,6,23,.75) !important;
  box-shadow: inset 0 0 0 1px rgba(59,130,246,.35), 0 10px 30px rgba(0,0,0,.6) !important;
  color: #e5e7eb;
}

/* Remove any top-side duel indicator banners/texts (without touching scores) */
.nova-hidden-banner { display: none !important; }

/* Starfield overlay */
#nova-starfield, #nova-nebula {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 0;
}
#nova-starfield {
  background-image:
    radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.7) 0, rgba(255,255,255,0) 60%),
    radial-gradient(1.5px 1.5px at 70% 20%, rgba(255,255,255,.8) 0, rgba(255,255,255,0) 60%),
    radial-gradient(1.2px 1.2px at 40% 80%, rgba(255,255,255,.6) 0, rgba(255,255,255,0) 60%),
    radial-gradient(1.8px 1.8px at 85% 60%, rgba(255,255,255,.75) 0, rgba(255,255,255,0) 60%);
  animation: novaTwinkle 4s infinite alternate ease-in-out;
  opacity: .6;
}
#nova-nebula {
  background: radial-gradient(800px 400px at 30% 60%, rgba(59,130,246,.15), transparent 50%),
              radial-gradient(700px 350px at 70% 30%, rgba(147,51,234,.12), transparent 50%);
  filter: blur(2px);
  opacity: .9;
  animation: novaDrift 18s infinite alternate ease-in-out;
}
@keyframes novaTwinkle {
  0% { opacity: .35; transform: translateY(0px); }
  100% { opacity: .7; transform: translateY(-6px); }
}
@keyframes novaDrift {
  0% { transform: translateX(-10px) translateY(0); }
  100% { transform: translateX(10px) translateY(-6px); }
}

/* Center-screen feedback banner */
#nova-judge {
  position: fixed;
  left: 50%;
  top: 40%;
  transform: translate(-50%, -50%) scale(.9);
  padding: 14px 22px;
  border-radius: 14px;
  font-weight: 900;
  font-size: clamp(28px, 4vw, 54px);
  letter-spacing: .8px;
  color: #fff;
  text-shadow: 0 4px 20px rgba(0,0,0,.6);
  box-shadow: 0 10px 40px rgba(0,0,0,.35);
  z-index: 999999;
  opacity: 0;
  pointer-events: none;
}
#nova-judge.nova-show {
  animation: novaJudgeIn .25s ease-out forwards, novaJudgeHold 1.2s ease .25s forwards, novaJudgeOut .35s ease 1.45s forwards;
}
#nova-judge.nova-correct {
  background: linear-gradient(135deg,#16a34a,#22c55e);
  border: 2px solid rgba(34,197,94,.7);
}
#nova-judge.nova-wrong {
  background: linear-gradient(135deg,#b91c1c,#ef4444);
  border: 2px solid rgba(239,68,68,.7);
}
@keyframes novaJudgeIn { from{opacity:0; transform: translate(-50%,-50%) scale(.6) rotate(-8deg);} to{opacity:1; transform: translate(-50%,-50%) scale(1) rotate(0deg);} }
@keyframes novaJudgeHold { from{transform: translate(-50%,-50%) scale(1);} to{transform: translate(-50%,-50%) scale(1);} }
@keyframes novaJudgeOut { from{opacity:1; transform: translate(-50%,-50%) scale(1);} to{opacity:0; transform: translate(-50%,-70%) scale(.94);} }

/* Upgraded +1 animation: arcs toward nearest score and emits star particles */
.nova-plus {
  position: fixed;
  font-weight: 900;
  font-size: clamp(26px, 3.5vw, 44px);
  color: #22c55e;
  text-shadow: 0 0 15px rgba(34,197,94,.75);
  z-index: 999999;
  pointer-events: none;
  transform: translate(-50%,-50%);
  animation: novaPlusFloat 1.2s forwards cubic-bezier(.2,.7,.2,1);
}
@keyframes novaPlusFloat {
  0%   { opacity: 0; transform: translate(-50%,-50%) scale(.7) rotate(-8deg); }
  10%  { opacity: 1; transform: translate(-50%,-50%) scale(1.1) rotate(0deg); }
  60%  { opacity: .9; transform: translate(var(--dx, 140px), var(--dy, -180px)) scale(1.2) rotate(8deg); }
  100% { opacity: 0; transform: translate(var(--tx, 300px), var(--ty, -320px)) scale(.85) rotate(12deg); }
}
.nova-star {
  position: fixed;
  width: 8px; height: 8px;
  background: #fff;
  border-radius: 50%;
  box-shadow: 0 0 10px rgba(255,255,255,.9), 0 0 20px rgba(59,130,246,.6);
  pointer-events: none;
  z-index: 999998;
  animation: novaStarOut .9s forwards ease-out;
}
@keyframes novaStarOut {
  from { opacity: .95; transform: translate(0,0) scale(1); }
  to   { opacity: 0; transform: translate(var(--sx, 80px), var(--sy, -120px)) scale(.2); }
}

/* Ensure any accidental black text in dark theme is light */
.nova-dark-duel * {
  color-scheme: dark;
}
.nova-dark-duel .question-container *,
.nova-dark-duel .options-container * {
  color: inherit;
}
</style>

<script id="nova-duel-dark-script">
(function(){
  const d = document;

  function ensureOnce(id, create) {
    if (!d.getElementById(id)) {
      const el = create();
      d.body.appendChild(el);
    }
    return d.getElementById(id);
  }

  function activateDarkIfDuelVisible(){
    const duel = d.querySelector('.duel-game-container');
    if (!duel) return;
    const visible = getComputedStyle(duel).display !== 'none';
    d.body.classList.toggle('nova-dark-duel', visible);
    // Layer starfield under everything
    if (visible) {
      ensureOnce('nova-starfield', () => {
        const sf = d.createElement('div');
        sf.id = 'nova-starfield';
        return sf;
      });
      ensureOnce('nova-nebula', () => {
        const nb = d.createElement('div');
        nb.id = 'nova-nebula';
        return nb;
      });
      ensureOnce('nova-judge', () => {
        const j = d.createElement('div');
        j.id = 'nova-judge';
        j.textContent = '';
        return j;
      });

      // Try to hide redundant duel banner texts at top (without touching scores)
      const candidates = Array.from(d.querySelectorAll('.duel-game-container h1, .duel-game-container h2, .duel-game-container .duel-title, .duel-game-container .duel-banner, [data-duel-indicator]'));
      candidates.forEach(el => {
        const t = (el.textContent || '').toLowerCase();
        if (/(düello|duello).*başladı|iki.*oyuncu/.test(t)) el.classList.add('nova-hidden-banner');
      });
    }
  }

  // Observe duel container visibility changes
  const obs = new MutationObserver(()=> activateDarkIfDuelVisible());
  obs.observe(d.documentElement, { attributes:true, childList:true, subtree:true });
  window.addEventListener('load', activateDarkIfDuelVisible);

  // Detect answer result by watching class changes on option buttons
  const optionObs = new MutationObserver((mutations)=>{
    mutations.forEach(m => {
      if (m.type === 'attributes' && m.attributeName === 'class' && m.target.classList) {
        const btn = m.target;
        if (btn.classList.contains('option-chosen')) {
          if (btn.classList.contains('correct')) {
            showJudge(true);
            runPlusToMyScore(btn);
          } else if (btn.classList.contains('wrong')) {
            showJudge(false);
          }
        }
      }
    });
  });

  function hookOptions(){
    d.querySelectorAll('.option-button').forEach(btn => {
      optionObs.observe(btn, { attributes:true, attributeFilter:['class'] });
    });
  }
  // Initial hook + observe future questions
  hookOptions();
  const listObs = new MutationObserver(()=> hookOptions());
  const root = d.querySelector('.duel-game-container') || d.body;
  listObs.observe(root, { childList:true, subtree:true });

  function showJudge(isCorrect){
    const el = d.getElementById('nova-judge');
    if (!el) return;
    el.textContent = isCorrect ? 'SÜPER DOĞRU!' : 'YANLIŞ!';
    el.classList.remove('nova-show','nova-correct','nova-wrong');
    el.offsetHeight; // reflow
    el.classList.add('nova-show', isCorrect ? 'nova-correct' : 'nova-wrong');
  }

  function runPlusToMyScore(sourceBtn){
    try {
      const rect = sourceBtn.getBoundingClientRect();
      const sx = rect.left + rect.width/2;
      const sy = rect.top + rect.height/2;

      const counters = Array.from(d.querySelectorAll('.duel-player-correct-count'));
      if (!counters.length) return spawnPlus(sx, sy, sx+260, sy-240);

      // pick nearest counter center
      const centers = counters.map(el => {
        const r = el.getBoundingClientRect();
        return { el, x: r.left + r.width/2, y: r.top + r.height/2 };
      });
      let best = centers[0];
      let bestDist = (best.x - sx)**2 + (best.y - sy)**2;
      for (let i=1;i<centers.length;i++){
        const c = centers[i];
        const d2 = (c.x - sx)**2 + (c.y - sy)**2;
        if (d2 < bestDist) { best = c; bestDist = d2; }
      }
      spawnPlus(sx, sy, best.x, best.y);
    } catch(e){ /* fail silently */ }
  }


function runPlusToMyScore(sourceBtn){
  try {
    const rect = sourceBtn.getBoundingClientRect();
    const sx = rect.left + rect.width/2;
    const sy = rect.top + rect.height/2;

    // inviter = sol HUD, invited = sağ HUD
    const localIsInviter = (typeof window.isInviter !== 'undefined')
      ? !!window.isInviter
      : (typeof isInviter !== 'undefined' ? !!isInviter : null);

    let targetEl = null;
    if (localIsInviter !== null) {
      targetEl = document.getElementById(localIsInviter ? 'novaLeftCount' : 'novaRightCount');
    }

    // HUD görünmüyorsa alttaki sayaçlara düş
    if (!targetEl || getComputedStyle(targetEl).display === 'none') {
      targetEl = document.getElementById(localIsInviter ? 'inviter-correct-count' : 'invited-correct-count');
    }

    if (!targetEl) {
      // En son çare: en yakın hedef
      const counters = Array.from(document.querySelectorAll('.duel-player-correct-count, .nova-hp-count'));
      if (!counters.length){ spawnPlus(sx, sy, sx+260, sy-240); return; }
      let best = counters[0], bestd2 = Infinity;
      counters.forEach(el => {
        const r = el.getBoundingClientRect();
        const x = r.left + r.width/2, y = r.top + r.height/2;
        const d2 = (x - sx) * (x - sx) + (y - sy) * (y - sy);
        if (d2 < bestd2) { bestd2 = d2; best = el; }
      });
      const r = best.getBoundingClientRect();
      spawnPlus(sx, sy, r.left + r.width/2, r.top + r.height/2);
      return;
    }

    const tr = targetEl.getBoundingClientRect();
    spawnPlus(sx, sy, tr.left + tr.width/2, tr.top + tr.height/2);
  } catch (e) { /* silent */ }
}




  function spawnPlus(sx, sy, tx, ty){
    const plus = d.createElement('div');
    plus.className = 'nova-plus';
    plus.textContent = '+1';

    const dx = (sx - window.innerWidth/2) * -1 + (tx - sx) * .45;
    const dy = (sy - window.innerHeight/2) * -1 + (ty - sy) * .45;
    plus.style.left = sx + 'px';
    plus.style.top  = sy + 'px';
    plus.style.setProperty('--dx', dx+'px');
    plus.style.setProperty('--dy', dy+'px');
    plus.style.setProperty('--tx', (tx - sx) + 'px');
    plus.style.setProperty('--ty', (ty - sy) + 'px');

    d.body.appendChild(plus);
    // star particles
    for (let i=0;i<18;i++){
      const star = d.createElement('div');
      star.className = 'nova-star';
      star.style.left = sx + 'px';
      star.style.top = sy + 'px';
      const ang = Math.random()*Math.PI*2;
      const dist = 60 + Math.random()*140;
      const sxv = Math.cos(ang)*dist;
      const syv = Math.sin(ang)*dist * -1; // bias upward
      star.style.setProperty('--sx', sxv+'px');
      star.style.setProperty('--sy', syv+'px');
      d.body.appendChild(star);
      setTimeout(()=> star.remove(), 900);
    }
    setTimeout(()=> plus.remove(), 1300);
  }

})();
</script>
<!-- === /NOVA add-on === -->

<!-- === NOVA: Space Upgrade v2 === -->
<style id="nova-duel-space-upgrade-style">
/* More colorful, kid-friendly space vibe on question screen */
.nova-dark-duel .question-container {
  background: radial-gradient(120% 160% at 20% 10%, rgba(30,58,138,.85) 0%, rgba(17,24,39,.92) 40%, rgba(15,23,42,.94) 100%) !important;
  border-image: linear-gradient(90deg,#60a5fa,#a78bfa,#22c55e) 1 !important;
  border-width: 2px !important;
  position: relative;
  overflow: hidden;
}

/* Soft rotating ring around the question */
.nova-dark-duel .question-container::before {
  content: "";
  position: absolute;
  inset: -25%;
  background: conic-gradient(from 0deg, rgba(99,102,241,.18), rgba(34,197,94,.08), rgba(96,165,250,.16), rgba(99,102,241,.18));
  filter: blur(22px);
  animation: novaRingSpin 24s linear infinite;
  pointer-events: none;
  z-index: 0;
}
.nova-dark-duel .question-container > * { position: relative; z-index: 1; }

@keyframes novaRingSpin {
  to { transform: rotate(360deg); }
}

/* Aurora ribbon overlay for the whole duel view */
#nova-aurora {
  position: fixed; inset: 0; pointer-events: none; z-index: 1;
  background:
    radial-gradient(60% 40% at 70% 20%, rgba(168,85,247,.10), transparent 60%),
    radial-gradient(40% 30% at 20% 70%, rgba(34,197,94,.10), transparent 60%),
    radial-gradient(35% 25% at 50% 50%, rgba(59,130,246,.10), transparent 60%);
  mix-blend-mode: screen;
  animation: novaAuroraPulse 12s ease-in-out infinite alternate;
}
@keyframes novaAuroraPulse {
  0% { filter: hue-rotate(0deg) saturate(1); opacity:.65; transform: translateY(0); }
  100% { filter: hue-rotate(25deg) saturate(1.2); opacity:.9; transform: translateY(-6px); }
}

/* Cute planets (decor only) */
.nova-planet {
  position: fixed; pointer-events: none; z-index: 1;
  width: 120px; height: 120px; border-radius: 50%;
  background: radial-gradient(circle at 35% 35%, #fff 0%, #f0f9ff 8%, #60a5fa 20%, #1f2937 70%);
  box-shadow: inset -15px -18px 40px rgba(0,0,0,.45), 0 8px 40px rgba(59,130,246,.35);
  opacity: .85;
}
#nova-planet-1 { left: 4%; top: 12%; animation: novaPlanetDrift 22s ease-in-out infinite alternate; }
#nova-planet-2 { right: 6%; bottom: 10%; width: 90px; height: 90px; animation: novaPlanetDrift 26s ease-in-out infinite alternate-reverse; }

@keyframes novaPlanetDrift {
  0% { transform: translate(0,0) rotate(0deg) }
  100% { transform: translate(10px,-8px) rotate(6deg) }
}

/* Shooting comets */
.nova-comet {
  position: fixed; pointer-events: none; z-index: 2;
  width: 220px; height: 2px;
  background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.95), rgba(96,165,250,.0));
  filter: drop-shadow(0 0 10px rgba(255,255,255,.9)) drop-shadow(0 0 22px rgba(96,165,250,.8));
  transform: rotate(-25deg);
  opacity: .0;
  animation: novaComet 1.8s ease-out forwards;
}
@keyframes novaComet {
  0% { opacity: 0; transform: translate(20vw,-10vh) rotate(-25deg) scale(.9); }
  10% { opacity: .9; }
  100% { opacity: 0; transform: translate(-30vw, 60vh) rotate(-25deg) scale(1.05); }
}

/* Keep star/nebula layers underneath aurora & planets */
#nova-starfield, #nova-nebula { z-index: 0; }

/* Hide "oyuncu 1 vs oyuncu 2" row cleanly */
.nova-hide-vs { display: none !important; }
</style>

<script id="nova-duel-space-upgrade-script">
(function(){
  const d = document;

  function ensureOnce(id, create) {
    if (!d.getElementById(id)) {
      const el = create();
      d.body.appendChild(el);
    }
    return d.getElementById(id);
  }

  function spaceDecorOn(){
    ensureOnce('nova-aurora',()=>{ const a=d.createElement('div'); a.id='nova-aurora'; return a; });
    ensureOnce('nova-planet-1',()=>{ const p=d.createElement('div'); p.id='nova-planet-1'; p.className='nova-planet'; return p; });
    ensureOnce('nova-planet-2',()=>{ const p=d.createElement('div'); p.id='nova-planet-2'; p.className='nova-planet'; return p; });

    // Launch a single comet interval once
    if (!window.__novaCometInterval){
      window.__novaCometInterval = setInterval(()=>{
        const c = d.createElement('div');
        c.className = 'nova-comet';
        // randomize start offset a bit
        const rx = Math.random()*40; // vw
        const ry = Math.random()*20; // vh
        c.style.left = (60+rx) + 'vw';
        c.style.top  = (-5-ry) + 'vh';
        d.body.appendChild(c);
        setTimeout(()=> c.remove(), 2000);
      }, 2600);
    }
  }

  function hidePlayersVs(){
    const container = d.querySelector('.duel-game-container');
    if(!container) return;
    const candidates = Array.from(container.querySelectorAll('.vs-row, .players-vs, .duel-vs, [data-vs], h1, h2, .header, .top, .title, .subtitle, .row, div, span'));
    candidates.forEach(el=>{
      try{
        const txt = (el.textContent||'').toLowerCase().replace(/\s+/g,' ');
        if (/oyuncu\s*1.*vs.*oyuncu\s*2/.test(txt) || (/vs/.test(txt) && /oyuncu/.test(txt))) {
          el.classList.add('nova-hide-vs');
        }
      }catch(_){}
    });
  }

  function activate(){
    const duel = d.querySelector('.duel-game-container');
    if (!duel) return;
    const visible = getComputedStyle(duel).display !== 'none';
    if (visible){
      spaceDecorOn();
      hidePlayersVs();
    }
  }

  const obs = new MutationObserver(()=> activate());
  obs.observe(d.documentElement,{subtree:true,childList:true,attributes:true});
  window.addEventListener('load', activate);
})();
</script>
<!-- === /NOVA Space Upgrade v2 === -->

<script>
// === NOVA VS HUD logic ===
(function(){
  function clamp(v,min,max){ return v<min?min:(v>max?max:v); }
  window.novaInitDuelHud = function(data){
    try{
      const hud = document.getElementById('nova-vs-hud');
      if(!hud) return;
      document.getElementById('novaLeftName').textContent  = (data && data.inviter && data.inviter.name) ? data.inviter.name : 'Oyuncu 1';
      document.getElementById('novaRightName').textContent = (data && data.invited && data.invited.name) ? data.invited.name : 'Oyuncu 2';
      document.getElementById('novaLeftHP').style.width = '50%';
      document.getElementById('novaRightHP').style.width = '50%';
      try{ document.getElementById('novaLeftCount').textContent='0'; document.getElementById('novaRightCount').textContent='0'; }catch(e){}
    }catch(e){ console.warn('HUD init error', e); }
  };
  window.novaUpdateDuelHud = function(leftScore, rightScore, leftOld, rightOld){
    try{
      const left = document.getElementById('novaLeftHP');
      const right = document.getElementById('novaRightHP');
      if(!left || !right) return;
      const diff = (Number(leftScore)||0) - (Number(rightScore)||0);
      const leftPct = Math.max(0, Math.min(100, 50 + diff*5));
      const rightPct = 100 - leftPct;
      left.style.width  = leftPct + '%';
      right.style.width = rightPct + '%';
      const lc = document.getElementById('novaLeftCount'); const rc = document.getElementById('novaRightCount');
      if(lc) lc.textContent = String(leftScore||0);
      if(rc) rc.textContent = String(rightScore||0);
      const leftGain  = (Number(leftScore)||0)  > (Number(leftOld)||0);
      const rightGain = (Number(rightScore)||0) > (Number(rightOld)||0);
      const leftEl  = document.querySelector('.nova-hud-side.left .nova-hp');
      const rightEl = document.querySelector('.nova-hud-side.right .nova-hp');
      if(leftEl && rightEl){
        if(leftGain && !rightGain){ leftEl.classList.add('nova-boost'); rightEl.classList.add('nova-hit');
          setTimeout(()=>{ leftEl.classList.remove('nova-boost'); rightEl.classList.remove('nova-hit'); }, 800);
        }else if(rightGain && !leftGain){ rightEl.classList.add('nova-boost'); leftEl.classList.add('nova-hit');
          setTimeout(()=>{ rightEl.classList.remove('nova-boost'); leftEl.classList.remove('nova-hit'); }, 800);
        }else{
          [leftEl,rightEl].forEach(el=>{ el.classList.add('nova-boost'); setTimeout(()=>el.classList.remove('nova-boost'), 600); });
        }
      }
    }catch(e){ console.warn('HUD update error', e); }
  };
})();
// === /NOVA VS HUD logic ===
</script>

<script id="nova-matchmaking-boot">
(function(){
  function byId(id){ return document.getElementById(id); }
  const mm = byId('matchmakingScreen');
  if (mm && !mm.classList.contains('nova-duel-arena')){
    mm.classList.add('nova-duel-arena');
  }
  // Ensure content card has proper class (not strictly necessary but future-proof)
  try{
    const card = mm.querySelector('.matchmaking-content');
    if (card) card.classList.add('nova-matchmaking-card');
  }catch(_){}
  // ESC to cancel
  document.addEventListener('keydown', function(ev){
    if (ev.key === 'Escape'){
      const mm = byId('matchmakingScreen');
      if (mm && getComputedStyle(mm).display !== 'none'){
        const btn = byId('cancelSearchButton');
        if (btn) btn.click();
      }
    }
  });
})();
</script>


<script id="nova-duel-start-init">
(function(){
  try{
    var container = document.querySelector('.duel-selection-container');
    if(!container) return;
    // VS badge
    if(!container.querySelector('.nova-vs-badge')){
      var vs = document.createElement('div');
      vs.className = 'nova-vs-badge';
      container.appendChild(vs);
    }
    // Corner orbs (behind UI)
    if(!container.querySelector('.nova-corner-orb.a')){
      var oa = document.createElement('div'); oa.className = 'nova-corner-orb a';
      var ob = document.createElement('div'); ob.className = 'nova-corner-orb b';
      container.appendChild(oa); container.appendChild(ob);
    }
  }catch(e){ /* silent */ }
})();
</script>


    <!-- NOVA_RESULT_SCRIPT_START -->
    <script>
    (function(){
      function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }

      function countUp(el, target){
        target = Math.max(0, parseInt(target||0,10));
        const start = 0; const dur = 700;
        const t0 = performance.now();
        function tick(now){
          const p = Math.min(1, (now - t0)/dur);
          const val = Math.round(start + (target-start)*p);
          el.textContent = String(val);
          el.style.animation = 'novaCount .4s ease';
          if(p < 1) requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      }

      function buildResultUI(){
        const root = document.getElementById('duel-final-container');
        if(!root || root.dataset.enhanced) return;
        // pull data from existing DOM (non-breaking)
        const invBox = document.getElementById('duel-player-inviter-score');
        const inBox  = document.getElementById('duel-player-invited-score');
        if(!invBox || !inBox) return;

        const inviter = {
          name: (document.getElementById('duel-player-inviter-name')||{}).textContent || 'Oyuncu 1',
          photo: (document.getElementById('duel-player-inviter-photo')||{}).src || '',
          score: parseInt((document.getElementById('inviter-correct-count')||{}).textContent||'0', 10)
        };
        const invited = {
          name: (document.getElementById('duel-player-invited-name')||{}).textContent || 'Oyuncu 2',
          photo: (document.getElementById('duel-player-invited-photo')||{}).src || '',
          score: parseInt((document.getElementById('invited-correct-count')||{}).textContent||'0', 10)
        };

        const inviterWin = invBox.classList.contains('winner');
        const invitedWin = inBox.classList.contains('winner');
        const isTie = !inviterWin && !invitedWin;

        const winner = inviterWin ? inviter : (invitedWin ? invited : null);
        const loser  = inviterWin ? invited : inviter;

        // keep original message & back button if present
        const backBtn = document.getElementById('duel-final-back-button');
        const msgEl = document.getElementById('winner-message');
        if(msgEl) msgEl.style.display = 'none'; // we'll show a richer header

        // Build card
        const wrap = document.createElement('div');
        wrap.className = 'nova-duel-result';

        const card = document.createElement('div');
        card.className = 'nova-result-card';

        // Hero section
        const hero = document.createElement('div');
        hero.className = 'nova-hero';

        const crown = document.createElement('div');
        crown.className = 'crown';
        crown.textContent = isTie ? '🤝' : '👑';

        const title = document.createElement('div');
        title.className = 'winner-name';
        title.textContent = isTie ? 'Berabere!' : (winner ? winner.name : 'Kazanan');

        const subtitle = document.createElement('div');
        subtitle.className = 'subtitle';
        subtitle.textContent = isTie ? 'Harika mücadele!'
          : 'Tebrikler! Müthiş bir galibiyet.';

        hero.appendChild(crown);
        hero.appendChild(title);
        hero.appendChild(subtitle);

        // Scoreboard
        const board = document.createElement('div');
        board.className = 'nova-scoreboard';

        function playerCard(p, isWinner){
          const el = document.createElement('div');
          el.className = 'nova-player ' + (isTie ? 'tie' : (isWinner ? 'winner' : 'loser'));
          el.innerHTML = `
            <img class="nova-avatar" src="${p.photo||''}" alt="Oyuncu"/>
            <div class="nova-names">
              <div class="nm">${p.name}</div>
              <div class="rk">${isTie ? 'Berabere' : (isWinner ? 'Kazanan' : 'Rakip')}</div>
            </div>
            <div class="nova-score">0</div>
          `;
          return el;
        }

        const left  = playerCard(inviter, inviterWin && !isTie);
        const right = playerCard(invited, invitedWin && !isTie);
        const vs = document.createElement('div'); vs.className = 'nova-vs'; vs.textContent = 'VS';

        board.appendChild(left);
        board.appendChild(vs);
        board.appendChild(right);

        // Actions
        const actions = document.createElement('div');
        actions.className = 'nova-actions';

        // Reuse existing back button node to keep its event listener
        if(backBtn){
          backBtn.classList.add('nova-btn','secondary');
          backBtn.textContent = 'Ana Menü';
          actions.appendChild(backBtn);
        }

        // Append assembled nodes
        card.appendChild(hero);
        card.appendChild(board);
        card.appendChild(actions);
        wrap.appendChild(card);
        root.prepend(wrap);
        root.dataset.enhanced = '1';

        // Animate counts up
        countUp(left.querySelector('.nova-score'), inviter.score);
        countUp(right.querySelector('.nova-score'), invited.score);
      }

      function watchFinal(){
        const final = document.getElementById('duel-final-container');
        if(!final) return;
        const runIfVisible = () => {
          const shown = getComputedStyle(final).display !== 'none';
          if(shown && !final.dataset.enhanced){
            // Slight delay to allow classes to be applied & confetti to fire
            setTimeout(buildResultUI, 40);
          }
        };
        // Observe style/class changes
        const obs = new MutationObserver(runIfVisible);
        obs.observe(final, { attributes:true, attributeFilter:['style','class'] });
        // Also run on load in case it's already visible
        runIfVisible();
      }

      ready(watchFinal);
    })();
    </script>
    <!-- NOVA_RESULT_SCRIPT_END -->
    

<!-- NOVA v5 overlay -->
<div id="duel-intro-overlay" class="nova-duel-arena" role="dialog" aria-label="Düello Başlangıç Ekranı">
  <div class="nova-backdrop"><div class="nova-stars"></div></div>
  <div class="arena">
    <div class="player-card" id="nova-playerA">
      <img class="player-photo" id="nova-pA-photo" src="" alt="Oyuncu A">
      <div class="player-name" id="nova-pA-name">Oyuncu A</div>
      <div class="player-meta">
        <span class="star-frame" id="nova-pA-stars"></span>
        <span class="rank-label" id="nova-pA-rank"></span>
        <span class="cup-pill" id="nova-pA-cups-wrap" data-empty="1">
          <span class="cup-emoji" aria-hidden="true">🏆</span>
          <span id="nova-pA-cups">0</span>
        </span>
      </div>
    </div>
    <div class="vs">
      <div class="vs-badge">VS</div>
      <div class="ring-wrap">
        <div class="ring" id="nova-ring" style="--pct:0%"></div>
        <div class="ring-center"><div class="countdown"><span id="nova-count">10</span>s</div></div>
      </div>
    </div>
    <div class="player-card" id="nova-playerB">
      <img class="player-photo" id="nova-pB-photo" src="" alt="Oyuncu B">
      <div class="player-name" id="nova-pB-name">Oyuncu B</div>
      <div class="player-meta">
        <span class="star-frame" id="nova-pB-stars"></span>
        <span class="rank-label" id="nova-pB-rank"></span>
        <span class="cup-pill" id="nova-pB-cups-wrap" data-empty="1">
          <span class="cup-emoji" aria-hidden="true">🏆</span>
          <span id="nova-pB-cups">0</span>
        </span>
      </div>
    </div>
  </div>
  <div class="flash"></div>
</div>


<script>
(function(){
  let novaIntroShown = false;
  let novaTimer = null;

  function qs(s,root=document){ return root.querySelector(s); }
  function qsa(s,root=document){ return Array.from(root.querySelectorAll(s)); }
  function findStartButton(){ return qs('.duel-start-button'); }

  // --- UI updaters ---
  function setText(id, val){ const el = document.getElementById(id); if (el) el.textContent = val; }
  function setSrc(id, val){ const el = document.getElementById(id); if (el && val) el.src = val; }
  function showCup(idWrap, idVal, n){
    const wrap = document.getElementById(idWrap);
    const valEl = document.getElementById(idVal);
    if (!wrap || !valEl) return;
    if (typeof n === 'number' && !Number.isNaN(n)){
      wrap.setAttribute('data-empty','0');
      valEl.textContent = String(n);
    } else {
      wrap.setAttribute('data-empty','1');
      valEl.textContent = '0';
    }
  }

  // ---- DOM scrape (fallback) ----
  function collectBlock(el){
    if (!el) return null;
    const img = qs('img', el);
    const nameEl = qs('.duel-player-name, .student-name, .name, .player-name', el);
    const rankEl = qs('.rank, .rutbe, .rütbe, .rank-badge, .level, .level-badge, .badge-rank', el);
    const cupsEl = qs('.cup, .cups, .trophy, .gameCup, [data-cup], [data-cups]', el);
    const cupsAttr = (cupsEl && (cupsEl.getAttribute('data-cup') || cupsEl.getAttribute('data-cups')));
    let cups = null;
    if (cupsEl){
      const t = (cupsEl.textContent||'').toLowerCase();
      const m = t.match(/(\d+)\s*(?:🏆|kupa|cups?|trophy)/);
      if (m) cups = parseInt(m[1],10);
    }
    if (cups == null && cupsAttr && /^\d+$/.test(cupsAttr)) cups = parseInt(cupsAttr,10);

    // try to expose data-* ids if present
    const studentId = el.dataset.studentId || el.dataset.uid || el.getAttribute('data-student-id') || el.getAttribute('data-uid') || null;
    const classId = el.dataset.classId || el.dataset.sinifId || el.getAttribute('data-class-id') || el.getAttribute('data-sinif-id') || null;
    // parse from a path
    const dp = el.getAttribute('data-path') || '';
    if ((!studentId || !classId) && dp && /classes\/([^/]+)\/students\/([^/]+)/.test(dp)){
      const m2 = dp.match(/classes\/([^/]+)\/students\/([^/]+)/);
      if (m2){ return { photo: img?img.src:'', name: nameEl?nameEl.textContent.trim():'', rank: rankEl?rankEl.textContent.trim():'', cups, studentId:m2[2], classId:m2[1] }; }
    }
    return {
      photo: img ? img.src : '',
      name: nameEl ? nameEl.textContent.trim() : '',
      rank: rankEl ? rankEl.textContent.trim() : '',
      cups,
      studentId,
      classId
    };
  }

  function collectPlayersFromDOM(){
    const infos = qsa('.duel-bottom-info .duel-player-info');
    if (infos.length >= 2){
      return { a: collectBlock(infos[0]), b: collectBlock(infos[1]) };
    }
    const scores = qsa('.players-info-row .duel-player-score');
    if (scores.length >= 2){
      return { a: collectBlock(scores[0]), b: collectBlock(scores[1]) };
    }
    return null;
  }

  // ---- Firebase helpers ----
  function getDB(){
    try{
      if (window.database && typeof window.database.ref === 'function') return window.database;
      if (window.firebase && firebase.database) return firebase.database();
    }catch(e){}
    return null;
  }
  // --- Robust student resolution by photo/name ---
  async function lookupStudentByPhotoOrName(photoUrl, displayName){
    const db = getDB(); if (!db) return null;
    try{
      const snap = await db.ref('classes').once('value');
      const obj = snap && snap.val ? snap.val() : null;
      if (!obj) return null;
      let hit = null;
      for (const classId of Object.keys(obj)){
        const students = obj[classId] && obj[classId].students;
        if (!students) continue;
        for (const sid of Object.keys(students)){
          const st = students[sid];
          if (!st) continue;
          const p = st.photo || st.photoUrl || st.avatarUrl || '';
          const n = st.name || st.displayName || st.fullName || '';
          const photoMatch = photoUrl && p && p === photoUrl;
          const nameMatch = displayName && n && n.toLowerCase() === displayName.toLowerCase();
          if (photoMatch || nameMatch){
            hit = { classId, studentId: sid, name: n, photo: p };
            // prefer exact photo match over name match
            if (photoMatch) return hit;
          }
        }
      }
      return hit;
    }catch(e){ console && console.warn && console.warn('NOVA: lookup by photo/name failed', e); return null; }
  }


  async function fetchStudent({classId, studentId}){
    const db = getDB();
    if (!db || !classId || !studentId) return null;
    try{
      const snap = await db.ref(`classes/${classId}/students/${studentId}`).once('value');
      const v = snap && snap.val ? snap.val() : null;
      if (!v) return null;
      // Try common field names
      const name = v.name || v.displayName || v.fullName || '';
      const rankName = v.rankName || v.rank || v.levelName || v.rutbe || v.rütbe || '';
      const cups = (v.gameCup != null) ? v.gameCup : (v.cups != null ? v.cups : null);
      const photo = v.photoUrl || v.profilePhoto || v.avatarUrl || v.photo || '';
      return { name, rank: rankName, cups, photo, duelCredits: (v.duelCredits || 0) };
    }catch(e){
      console && console.warn && console.warn('NOVA: Firebase read error', e);
      return null;
    }
  }

  function updateSide(side, data){
    if (!data) return;
    if (side === 'a'){
      if (data.photo) setSrc('nova-pA-photo', data.photo);
      if (data.name)  setText('nova-pA-name', data.name);
      try{ if (typeof getStars==='function' && document.getElementById('nova-pA-stars')) document.getElementById('nova-pA-stars').innerHTML = getStars(data.duelCredits||0); }catch(e){}
      try{ if (typeof getRankHTML==='function') document.getElementById('nova-pA-rank').innerHTML = getRankHTML(data.duelCredits||0); else if (data.rank) setText('nova-pA-rank', data.rank);}catch(e){ if (data.rank) setText('nova-pA-rank', data.rank); }
      showCup('nova-pA-cups-wrap','nova-pA-cups', data.cups);
    } else {
      if (data.photo) setSrc('nova-pB-photo', data.photo);
      if (data.name)  setText('nova-pB-name', data.name);
      try{ if (typeof getStars==='function' && document.getElementById('nova-pB-stars')) document.getElementById('nova-pB-stars').innerHTML = getStars(data.duelCredits||0); }catch(e){}
      try{ if (typeof getRankHTML==='function') document.getElementById('nova-pB-rank').innerHTML = getRankHTML(data.duelCredits||0); else if (data.rank) setText('nova-pB-rank', data.rank);}catch(e){ if (data.rank) setText('nova-pB-rank', data.rank); }
      showCup('nova-pB-cups-wrap','nova-pB-cups', data.cups);
    }
  }

  async function enrichFromFirebase(domData){
    const result = { a:null, b:null };
    // 1) if IDs present in DOM, use them
    if (domData){
      if (domData.a && domData.a.studentId && domData.a.classId) result.a = await fetchStudent({classId:domData.a.classId, studentId:domData.a.studentId});
      if (domData.b && domData.b.studentId && domData.b.classId) result.b = await fetchStudent({classId:domData.b.classId, studentId:domData.b.studentId});
    }
    // 2) globals used elsewhere in app
    try{
      const A = (window.selectedStudent && window.selectedStudent.studentId && window.selectedStudent.classId)
                ? {classId: window.selectedStudent.classId, studentId: window.selectedStudent.studentId} : null;
      const B = (window.opponentStudent && window.opponentStudent.studentId && window.opponentStudent.classId)
                ? {classId: window.opponentStudent.classId, studentId: window.opponentStudent.studentId} : null;
      if (!result.a && A) result.a = await fetchStudent(A);
      if (!result.b && B) result.b = await fetchStudent(B);
    }catch(e){}
    // 3) still missing? resolve by photo/name
    try{
      const aName = (domData && domData.a && domData.a.name) || document.getElementById('nova-pA-name')?.textContent || '';
      const bName = (domData && domData.b && domData.b.name) || document.getElementById('nova-pB-name')?.textContent || '';
      const aPhoto = document.getElementById('nova-pA-photo')?.src || (domData && domData.a && domData.a.photo) || '';
      const bPhoto = document.getElementById('nova-pB-photo')?.src || (domData && domData.b && domData.b.photo) || '';
      if (!result.a){ const hitA = await lookupStudentByPhotoOrName(aPhoto, aName); if (hitA) result.a = await fetchStudent(hitA); }
      if (!result.b){ const hitB = await lookupStudentByPhotoOrName(bPhoto, bName); if (hitB) result.b = await fetchStudent(hitB); }
    }catch(e){ console && console.warn && console.warn('NOVA: fallback photo/name lookup failed', e); }
    // Apply
    if (result.a) updateSide('a', result.a);
    if (result.b) updateSide('b', result.b);
  }

  // ---- Unwanted selection panel hide ----
  function hideLegacySelectionPanel(){
    const nodes = Array.from(document.querySelectorAll('.duel-selection-container, .duel-start, .duel-setup, .duel-start-content, .duel-panel, section, div'));
    nodes.forEach(el=>{
      if (!(el instanceof HTMLElement)) return;
      if (el.id==='duel-intro-overlay') return;
      if (el.hasAttribute('data-nova-hide')) return;
      const txt = (el.textContent||'').toLowerCase();
      const head = txt.includes('düello başlıyor');
      const fields = (txt.includes('sınıfınız') || txt.includes('düello dersi') || txt.includes('düello konusu'));
      if (head && fields) el.setAttribute('data-nova-hide','');
    });
  }

  function populateFromDOM(domData){
    if (!domData) return;
    const a = domData.a || {}; const b = domData.b || {};
    if (a.photo) setSrc('nova-pA-photo', a.photo);
    if (b.photo) setSrc('nova-pB-photo', b.photo);
    setText('nova-pA-name', a.name || 'Oyuncu A');
    setText('nova-pB-name', b.name || 'Oyuncu B');
    if (a.rank) setText('nova-pA-rank', a.rank);
    if (b.rank) setText('nova-pB-rank', b.rank);
    showCup('nova-pA-cups-wrap','nova-pA-cups', (typeof a.cups==='number') ? a.cups : null);
    showCup('nova-pB-cups-wrap','nova-pB-cups', (typeof b.cups==='number') ? b.cups : null);
  }

  function showIntro(seconds=10){
    if (novaIntroShown) return;
    const domData = collectPlayersFromDOM();
    populateFromDOM(domData);
    const overlay = document.getElementById('duel-intro-overlay');
    if (!overlay) return;
    overlay.classList.add('show');
    novaIntroShown = true;
    hideLegacySelectionPanel();
    enrichFromFirebase(domData); // async fetch true data from DB and update UI
    startCountdown(seconds);
  }

  function hideIntro(){
    const overlay = document.getElementById('duel-intro-overlay');
    overlay && overlay.classList.remove('show');
  }

  function startCountdown(seconds){
    const ring = document.getElementById('nova-ring');
    const label = document.getElementById('nova-count');
    const total = Math.max(1, Math.floor(seconds)) * 1000;
    const t0 = performance.now();
    const raf = (now)=>{
      const el = Math.min(total, now - t0);
      const pct = (el/total)*100;
      if (ring) ring.style.setProperty('--pct', pct + '%');
      const remain = Math.ceil((total - el)/1000);
      if (label) label.textContent = String(remain);
      if (el >= total){ startNow(); } else { novaTimer = requestAnimationFrame(raf); }
    };
    if (novaTimer) cancelAnimationFrame(novaTimer);
    novaTimer = requestAnimationFrame(raf);
  }

  function startNow(){
    if (novaTimer) cancelAnimationFrame(novaTimer);
    hideIntro();
    const btn = findStartButton();
    if (btn && btn.classList.contains('active')) btn.click();
    else document.dispatchEvent(new CustomEvent('nova:duelIntroDone'));
  }

  function interceptStartButton(){
    const btn = findStartButton();
    if (!btn) return;
    btn.addEventListener('click', function(ev){
      if (!novaIntroShown && btn.classList.contains('active')){
        ev.preventDefault(); ev.stopPropagation();
        showIntro(10);
        return false;
      }
    }, true);
  }

  function observeActivation(){
    const btn = findStartButton();
    if (!btn) return;
    const obs = new MutationObserver(()=>{
      if (btn.classList.contains('active') && !novaIntroShown) showIntro(10);
    });
    obs.observe(btn, {attributes:true, attributeFilter:['class']});
  }

  function observeSelection(){
    const c = document.querySelector('.duel-selection-container');
    if (!c) return;
    const obs = new MutationObserver(()=>{
      const style = getComputedStyle(c);
      if (style.display !== 'none'){
        const infos = document.querySelectorAll('.duel-bottom-info .duel-player-info');
        if (infos.length >= 2 && !novaIntroShown) setTimeout(()=> showIntro(10), 300);
      }
      hideLegacySelectionPanel();
    });
    obs.observe(c, {attributes:true, childList:true, subtree:true});
  }

  function globalObserver(){
    const obs = new MutationObserver(()=> hideLegacySelectionPanel());
    obs.observe(document.body, {childList:true, subtree:true});
  }

  function init(){
    interceptStartButton();
    observeActivation();
    observeSelection();
    globalObserver();
    hideLegacySelectionPanel();
    window.novaShowDuelIntro = showIntro;
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') init();
  else document.addEventListener('DOMContentLoaded', init);
})();
</script>


<!-- Nova Advice Guard v2: show ONLY on result screen -->
<script id="nova-advice-guard">
(function(){
  if (window.__novaAdviceGuardInstalledV2) return;
  window.__novaAdviceGuardInstalledV2 = true;

  function isVisible(el){
    if(!el) return false;
    var cs = getComputedStyle(el);
    if (cs.display === 'none' || cs.visibility === 'hidden' || cs.opacity === '0') return false;
    if ((el.offsetWidth|0) === 0 && (el.offsetHeight|0) === 0) return false;
    return true;
  }

  function resultVisible(){
    var sc = document.getElementById('score-container') ||
             document.querySelector('.score-container, .result-screen, #resultScreen');
    return isVisible(sc);
  }

  function hideAdvice(){
    try{
      // Remove both id and class variants if exist
      var byId = document.getElementById('teacher-advice-card');
      if (byId) byId.remove();
      document.querySelectorAll('.teacher-advice-card').forEach(function(el){ el.remove(); });
    }catch(e){}
  }

  function enforce(){
    if (!resultVisible()) hideAdvice();
  }

  function observeRoots(){
    var roots = [
      document.body,
      document.querySelector('.question-container'),
      document.querySelector('.single-player-game-container'),
      document.querySelector('.duel-game-container'),
      document.querySelector('.matchmaking-screen'),
      document.getElementById('score-container')
    ].filter(Boolean);
    roots.forEach(function(el){
      try{
        var obs = new MutationObserver(enforce);
        obs.observe(el, { attributes:true, childList:true, subtree:true });
      }catch(_){}
    });
  }

  function hook(name){
    try{
      var fn = window[name];
      if (typeof fn === 'function' && !fn.__novaAdviceV2){
        var orig = fn;
        window[name] = function(){
          var r = orig.apply(this, arguments);
          setTimeout(enforce, 0);
          return r;
        };
        window[name].__novaAdviceV2 = true;
      }
    }catch(_){}
  }

  function boot(){
    enforce();
    observeRoots();
    [
      'displayCurrentQuestion','proceedToNextQuestion','startNow','startTimer','findStartButton',
      'startGame','startSinglePlayer','startCountdown','startDuelGame','endGame','showResults'
    ].forEach(hook);

    document.addEventListener('click', function(e){
      var t = e.target;
      if (t && (t.closest ? t.closest('.option-button, .option-btn, .answer-button, .next-question-button, .question-container, #start-game-button') : null)){
        enforce();
      }
    }, true);
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot, {once:true});
  } else {
    boot();
  }
})();
</script>


<!-- NOVA: Duel Scale Toolbar Script (safe) -->



<!-- NOVA: Duel Scale Script v3 (no wrapper; scale element directly) -->
<script id="nova-duel-scale-script">
(function(){
  const DUEL_ID = 'duel-game-screen';
  const TOOL_ID = 'nova-duel-scale-toolbar';
  const RANGE_ID = 'nova-duel-scale-range';
  const PCT_ID = 'nova-duel-scale-pct';
  const LS_KEY = 'novaDuelScale';

  function getEl(id){ return document.getElementById(id); }

  function unwrapIfWrapped(){
    const duel = getEl(DUEL_ID);
    if (!duel) return;
    const p = duel.parentElement;
    if (p && p.id === 'nova-duel-scale-wrapper'){
      // Move duel out and remove wrapper to avoid affecting other screens
      p.parentElement.insertBefore(duel, p);
      p.remove();
    }
  }

  function setScale(k){
    if (isNaN(k)) k = 1;
    k = Math.max(0.70, Math.min(1.20, k));
    document.documentElement.style.setProperty('--duel-scale', String(k));
    const pct = Math.round(k*100);
    const pctEl = getEl(PCT_ID); if (pctEl) pctEl.textContent = pct + '%';
    const rng = getEl(RANGE_ID); if (rng) rng.value = String(pct);
    try{ localStorage.setItem(LS_KEY, String(k)); }catch(_){}
  }
  function getScale(){
    const val = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--duel-scale'));
    if (!isNaN(val) && val>0) return val;
    try { const v = parseFloat(localStorage.getItem(LS_KEY)); return isNaN(v)?1:v; } catch(_){}
    return 1;
  }
  function isVisible(el){
    if (!el) return false;
    const st = getComputedStyle(el);
    if (st.display === 'none' || st.visibility === 'hidden') return false;
    const r = el.getBoundingClientRect();
    return (r.width>1 && r.height>1);
  }
  function showToolbar(show){
    const t = getEl(TOOL_ID);
    if (!t) return;
    t.style.display = show ? 'flex' : 'none';
    t.setAttribute('aria-hidden', show ? 'false' : 'true');
  }
  function fitToViewport(){
    const duel = getEl(DUEL_ID);
    if (!duel) return;
    const prev = getScale();
    setScale(1);
    const rect = duel.getBoundingClientRect();
    const vw = window.innerWidth, vh = window.innerHeight;
    const availH = vh - 70;
    const k = Math.max(0.70, Math.min(1.20, Math.min(vw/rect.width, availH/rect.height)));
    setScale(k);
  }
  function mountToolbarOnce(){
    if (getEl(TOOL_ID)) return true;
    document.body.insertAdjacentHTML('beforeend', `
<!-- NOVA: Duel Scale Toolbar -->
<div id="nova-duel-scale-toolbar" aria-hidden="true">
  <span class="label">Ölçek</span>
  <div class="group grow">
    <button class="btn small" data-act="minus">−</button>
    <input id="nova-duel-scale-range" type="range" min="70" max="120" value="100" step="1" />
    <button class="btn small" data-act="plus">+</button>
  </div>
  <span class="pct badge" id="nova-duel-scale-pct">100%</span>
  <div class="sep"></div>
  <button class="btn" data-act="fit">Sığdır</button>
  <button class="btn" data-act="reset">Sıfırla</button>
</div>
`);
    const rng = getEl(RANGE_ID);
    if (rng){
      rng.addEventListener('input', ()=>{
        const pct = parseInt(rng.value, 10);
        setScale(pct/100);
      });
    }
    document.body.addEventListener('click', (e)=>{
      const btn = e.target.closest('#'+TOOL_ID+' [data-act]');
      if (!btn) return;
      const act = btn.getAttribute('data-act');
      let k = getScale();
      if (act==='minus') setScale((Math.round(k*100)-1)/100);
      else if (act==='plus') setScale((Math.round(k*100)+1)/100);
      else if (act==='reset') setScale(1);
      else if (act==='fit') fitToViewport();
    });
    return true;
  }

  (function init(){
    mountToolbarOnce();
    unwrapIfWrapped(); // migrate from v1/v2, remove wrapper if present
    setScale(getScale());
    let lastShown = false;
    setInterval(()=>{
      const duel = getEl(DUEL_ID);
      const shouldShow = isVisible(duel);
      if (shouldShow !== lastShown){
        showToolbar(shouldShow);
        // Only add scale class when visible to avoid affecting other screens
        if (duel){
          if (shouldShow) duel.classList.add('nova-scaled');
          else duel.classList.remove('nova-scaled');
        }
        lastShown = shouldShow;
      }
    }, 700);
  })();

  window.addEventListener('resize', function(){
    const t = getEl(TOOL_ID);
    if (t && t.style.display !== 'none'){
      // kullanıcı manuel ayarı korunur
    }
  });
})();</script>


<!-- NOVA: Duel Scale Toolbar -->
<div id="nova-duel-scale-toolbar" aria-hidden="true">
  <span class="label">Ölçek</span>
  <div class="group grow">
    <button class="btn small" data-act="minus">−</button>
    <input id="nova-duel-scale-range" type="range" min="70" max="120" value="100" step="1" />
    <button class="btn small" data-act="plus">+</button>
  </div>
  <span class="pct badge" id="nova-duel-scale-pct">100%</span>
  <div class="sep"></div>
  <button class="btn" data-act="fit">Sığdır</button>
  <button class="btn" data-act="reset">Sıfırla</button>
</div>


<script id="nova-image-cap-js">
(function(){
  if (window.__novaImageCapInstalledV3) return;
  window.__novaImageCapInstalledV3 = true;

  function capImage(img){
    try{
      if (!img || !img.naturalWidth || img.classList.contains('nz-info-img')) return;
      // Baseline = min(natural, 250px); cap = 2× baseline
      var baseW = Math.min(img.naturalWidth, 250);
      var baseH = Math.min(img.naturalHeight, 250);
      var maxW = baseW * 2;
      var maxH = baseH * 2;

      // Also respect viewport (keep fully visible)
      var vpW = Math.floor(window.innerWidth * 0.95);
      var vpH = Math.floor(window.innerHeight * 0.75);

      // If inside a question container, don't exceed its width too much
      var container = img.closest('.question-container');
      var cw = container ? Math.max(1, container.clientWidth) : vpW;

      img.style.width = 'auto';
      img.style.height = 'auto';
      img.style.maxWidth  = Math.min(maxW, cw, vpW) + 'px';
      img.style.maxHeight = Math.min(maxH, vpH) + 'px';
      img.style.objectFit = 'contain';
      // center (safety)
      img.style.display = 'block';
      img.style.marginLeft = 'auto';
      img.style.marginRight = 'auto';
    }catch(_){}
  }

  function hook(img){
    if (!img) return;
    if (img.complete && img.naturalWidth) {
      capImage(img);
    } else {
      img.addEventListener('load', function onload(){
        img.removeEventListener('load', onload);
        capImage(img);
      });
    }
  }

  function scan(){
    var sel = '#question-image, .question-image, #duel-question-image, .duel-question-image, .question-media img, .question-info-image';
    document.querySelectorAll(sel).forEach(hook);
  }

  // Observe DOM changes (questions change dynamically)
  var mo = new MutationObserver(scan);
  mo.observe(document.body, { childList:true, subtree:true, attributes:true, attributeFilter:['src','class','style'] });
  window.addEventListener('resize', scan, { passive:true });

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', scan, { once:true });
  } else {
    scan();
  }
})();
</script>


<!-- === NOVA HOMEWORK MODULE === -->
<style>
  .homework-fab{
    position:fixed; right:18px; top:calc(16px + env(safe-area-inset-top, 0px)); z-index:9999;
    background:linear-gradient(135deg,#ff9d00,#ff4d4d);
    color:#fff; border:none; border-radius:16px; padding:12px 18px;
    font-weight:800; letter-spacing:.3px; box-shadow:0 12px 24px rgba(0,0,0,.30);
    cursor:pointer; transform:translateZ(0); transition:transform .2s ease, box-shadow .2s ease, filter .2s ease;
    display:inline-flex; align-items:center; gap:10px;
  }
  .homework-fab:hover{ transform:translateY(-1px); box-shadow:0 14px 24px rgba(0,0,0,.28); filter:brightness(1.05); }
  .homework-fab:active{ transform:translateY(0); }
  .homework-fab .hw-badge{
    position:absolute; top:-6px; right:-6px; min-width:22px; height:22px; padding:0 6px;
    background:#ff2d55; color:#fff; border-radius:999px; font-size:12px; font-weight:900;
    display:flex; align-items:center; justify-content:center; box-shadow:0 0 0 3px rgba(0,0,0,.35), 0 6px 14px rgba(0,0,0,.3);
  }
  #homework-screen{ display:none; position:fixed; inset:0; z-index:9999; background:radial-gradient(1200px 600px at 80% -10%, rgba(255,77,77,.18), transparent 60%), #0d0f14; color:#e7ecf7; }
  .hw-wrap{ height:100%; display:grid; grid-template-columns: 320px 1fr; gap:16px; padding:20px; }
  .hw-left{ background:#0c111b; border:1px solid rgba(255,255,255,.06); border-radius:18px; overflow:auto; }
  .hw-right{ background:#0c111b; border:1px solid rgba(255,255,255,.06); border-radius:18px; display:flex; flex-direction:column; }
  .hw-title{ font-size:22px; font-weight:800; padding:16px 18px 4px; }
  .hw-desc{ font-size:14px; opacity:.9; padding:0 18px 16px; line-height:1.55 }
  .hw-actions{ margin-top:auto; display:flex; gap:12px; padding:18px; border-top:1px solid rgba(255,255,255,.06) }
  .hw-btn{ background:#1a6cff; border:none; color:#fff; font-weight:700; padding:12px 16px; border-radius:12px; cursor:pointer }
  .hw-btn.secondary{ background:#162136; color:#bdd3ff }
  .hw-list{ list-style:none; padding:10px; margin:0 }
  .hw-list li{ padding:10px 12px; border-radius:12px; margin:6px; background:#0a0f18; border:1px solid rgba(255,255,255,.06); cursor:pointer; display:flex; justify-content:space-between; align-items:center }
  .hw-list li.active{ outline:2px solid #1a6cff }
  .hw-meta{ font-size:12px; opacity:.8 }
  .hw-topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px; border-bottom:1px solid rgba(255,255,255,.06) }
  .hw-close{ background:transparent; border:none; color:#9fb4d8; font-size:18px; cursor:pointer }
  @media (max-width: 900px){
    .hw-wrap{ grid-template-columns: 1fr; }
    .homework-fab{ position:fixed; right:14px; bottom:16px; top:auto; }
  }
</style>
<div id="homework-screen" role="dialog" aria-modal="true" aria-labelledby="hw_title">
  <div class="hw-wrap">
    <aside class="hw-left">
      <div class="hw-topbar">
        <div style="font-weight:800; letter-spacing:.4px">📚 Ödevlerim</div>
        <button class="hw-close" id="hw_close">✖</button>
      </div>
      <ul class="hw-list" id="hw_list"></ul>
    </aside>
    <section class="hw-right">
      <div class="hw-title" id="hw_title">Ödev seçiniz</div>
      <div class="hw-desc" id="hw_desc">Öğretmeninizin verdiği ödev burada görünecek.</div>
      <div style="padding:0 18px 8px">
        <div class="hw-meta" id="hw_meta"></div>
      </div>
      <div class="hw-actions">
        <button class="hw-btn secondary" id="hw_video">🎬 Ders Videosu</button>
        <button class="hw-btn" id="hw_start">🚀 Sorulara Geç</button>
      </div>
    </section>
  </div>
</div>
<script>
(function(){
  // Create FAB once main screen is visible
  const ensureFab = ()=>{
    const ms = document.getElementById('main-screen');
    if(!ms) return;
    if(!document.getElementById('homework_fab')){
      const btn = document.createElement('button');
      btn.id = 'homework_fab';
      btn.className = 'homework-fab';
      btn.innerHTML = 'ÖDEV<span id="homework_badge" class="hw-badge" hidden>0</span>';
      btn.addEventListener('click', openHomeworkScreen);
      ms.appendChild(btn);
      try{ subscribeHomeworkBadge(); }catch(_){}
    }
  };

  // Subscribe badge to pending homework count
  function subscribeHomeworkBadge(){
    const badge = document.getElementById('homework_badge');
    function db(){ try{ return firebase.database(); }catch(_){ return null; } }
    function sid(){ try{ return selectedStudent && selectedStudent.studentId; }catch(_){ return null; } }
    const d = db(); const s = sid();
    if (!badge || !d || !s) return;
    d.ref('studentHomework/'+s).on('value', (snap)=>{
      try{
        const val = snap.exists()? snap.val() : {};
        const items = Object.values(val||{});
        const pending = items.filter(it => (it && it.status)!=='completed').length;
        if (pending>0){
          badge.textContent = pending > 99 ? '99+' : String(pending);
          badge.hidden = false;
        } else {
          badge.hidden = true;
        }
      }catch(e){ /* noop */ }
    });
  }
  // Observe main-screen visibility toggles
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      const fab = document.getElementById('homework_fab');
      if(!fab) return;
      // Show FAB only when main-screen is visible
      fab.style.display = e.isIntersecting ? 'inline-flex' : 'none';
    });
  }, {threshold: .1});
  window.addEventListener('load', ()=>{
    ensureFab();
    const ms = document.getElementById('main-screen');
    if(ms) io.observe(ms);
  });

  const hwListEl = document.getElementById('hw_list');
  const hwTitleEl = document.getElementById('hw_title');
  const hwDescEl = document.getElementById('hw_desc');
  const hwMetaEl = document.getElementById('hw_meta');
  const hwVideoBtn = document.getElementById('hw_video');
  const hwStartBtn = document.getElementById('hw_start');
  const hwScreen = document.getElementById('homework-screen');
  const hwClose = document.getElementById('hw_close');
  let selectedHw = null;
  let hwCache = {};

  function db(){ try{ return firebase.database(); }catch(_){ return null; } }
  function sid(){ try{ return selectedStudent && selectedStudent.studentId; }catch(_){ return null; } }

  function openHomeworkScreen(){
    hwScreen.style.display = 'block';
    document.body.style.overflow='hidden';
    loadStudentHomeworks();
  }
  hwClose.addEventListener('click', ()=>{ window.location.reload(); });

  async function loadStudentHomeworks(){
    try{
      hwListEl.innerHTML = '<li>Yükleniyor…</li>';
      const s = sid(); const d = db(); if(!s||!d){ hwListEl.innerHTML='<li>Giriş yapınız.</li>'; return; }
      const snap = await d.ref('studentHomework/'+s).get();
      const list = snap.exists()? snap.val() : {};
      const items = Object.entries(list).map(([hwId, info])=>({hwId, status: info?.status||'assigned', assignedAt: info?.assignedAt||0}));
      if(!items.length){ hwListEl.innerHTML = '<li>Şu an ödev yok.</li>'; hwTitleEl.textContent='Ödev yok'; hwDescEl.textContent='Yeni ödev verildiğinde burada göreceksiniz.'; return; }

      // Load details
      const details = {};
      for (const it of items){
        const hwSnap = await d.ref('homeworks/'+it.hwId).get();
        if(hwSnap.exists()) details[it.hwId] = hwSnap.val();
      }
      hwCache = details;

      // Render list
      hwListEl.innerHTML = '';
      items.forEach(it=>{
        const hw = details[it.hwId]||{};
        const li = document.createElement('li');
        li.setAttribute('data-id', it.hwId);
        const badge = it.status==='completed' ? '✅' : (it.status==='assigned' ? '🟡' : '⏳');
        li.innerHTML = '<div><div style="font-weight:700">'+(hw.title||'Ödev')+'</div><div class="hw-meta">'+(new Date(hw.createdAt||Date.now())).toLocaleString('tr-TR')+'</div></div><div>'+badge+'</div>';
        li.addEventListener('click', ()=> selectHw(it.hwId));
        hwListEl.appendChild(li);
      });

      // Select first pending or first item
      const firstPending = items.find(x=>x.status!=='completed') || items[0];
      selectHw(firstPending.hwId);
    }catch(e){
      console.warn('loadStudentHomeworks', e);
      hwListEl.innerHTML = '<li>Ödevler alınamadı.</li>';
    }
  }

  function selectHw(hwId){
    selectedHw = { id: hwId, detail: hwCache[hwId]||{} };
    const d = selectedHw.detail;
    hwTitleEl.textContent = d.title || 'Ödev';
    hwDescEl.textContent = d.description || '';
    const q = d.questionCount || 10;
    hwMetaEl.textContent = 'Soru sayısı: '+q;
    document.querySelectorAll('#hw_list li').forEach(li=> li.classList.toggle('active', li.getAttribute('data-id')===hwId));

    // Mark start button if already completed
    try{
      if (typeof database !== 'undefined' && selectedStudent && selectedStudent.studentId){
        const s = selectedStudent.studentId;
        const ref = database.ref('studentHomework/'+s+'/'+hwId+'/status');
        ref.get().then(snap=>{
          const st = snap && snap.val ? snap.val() : null;
          const btn = hwStartBtn;
          if (btn){
            if (st === 'completed'){
              btn.textContent = 'Ödev Tamamlandı';
              btn.disabled = false; // keep click to show warning
            }else{
              btn.textContent = 'Ödevi Başlat';
              btn.disabled = false;
            }
          }
        }).catch(()=>{});
      }
    }catch(_){}

  }

  // Video open
  
hwVideoBtn.addEventListener('click', async ()=>{
  if(!selectedHw) return;
  const d = selectedHw.detail||{};

  // Helper: normalize to YouTube /embed/ URL if possible
  function toEmbed(u){
    if (!u || typeof u !== 'string') return null;
    let s = u.trim();
    if (s.includes('watch?v=')) s = s.replace('watch?v=', 'embed/');
    else if (s.includes('youtu.be/')) {
      const vid = s.split('youtu.be/')[1].split(/[?&#]/)[0];
      s = 'https://www.youtube.com/embed/' + vid;
    }
    if (!/^https:\/\/(www\.)?youtube\.com\/embed\//.test(s) && !/^https:\/\/youtube\.com\/embed\//.test(s)) return null;
    return s;
  }

  // Helper: ensure we have an in-app viewer; prefer existing "lesson video screen", otherwise build overlay
  function openInApp(embedUrl, breadcrumbParts){
    // Try the shared lesson video screen first (same UI as single player)
    try {
      const title = document.getElementById('lesson-video-title');
      if (title) title.textContent = 'Ders Videosu';
      const crumb = document.getElementById('lesson-video-breadcrumb');
      if (crumb) crumb.textContent = (breadcrumbParts && breadcrumbParts.length) ? breadcrumbParts.join(' • ') : 'Ders & Konu';

      if (typeof videoIframe !== 'undefined' && videoIframe && typeof showOnly === 'function' && typeof videoScreen !== 'undefined') {
        videoIframe.src = embedUrl;
        try { window.scrollTo({top:0, behavior:'auto'}); } catch(_){}
        showOnly(videoScreen);
        return true;
      }
    } catch(_) {}

    // If shared screen infra isn't present, build a lightweight overlay viewer inside the app
    let overlay = document.getElementById('nova-video-overlay');
    if (!overlay){
      overlay = document.createElement('div');
      overlay.id = 'nova-video-overlay';
      overlay.setAttribute('role','dialog');
      overlay.setAttribute('aria-modal','true');
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.background = 'rgba(0,0,0,.8)';
      overlay.style.zIndex = '9999';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.padding = '2rem';

      const wrap = document.createElement('div');
      wrap.style.width = 'min(92vw, 1200px)';
      wrap.style.aspectRatio = '16 / 9';
      wrap.style.background = '#000';
      wrap.style.position = 'relative';
      wrap.style.borderRadius = '12px';
      wrap.style.boxShadow = '0 10px 40px rgba(0,0,0,.5)';
      wrap.style.overflow = 'hidden';

      const btn = document.createElement('button');
      btn.textContent = '✕';
      btn.setAttribute('aria-label','Kapat');
      btn.style.position = 'absolute';
      btn.style.top = '8px';
      btn.style.right = '10px';
      btn.style.fontSize = '20px';
      btn.style.lineHeight = '1';
      btn.style.padding = '6px 10px';
      btn.style.border = 'none';
      btn.style.borderRadius = '8px';
      btn.style.cursor = 'pointer';
      btn.style.background = 'rgba(255,255,255,.85)';
      btn.style.backdropFilter = 'blur(6px)';
      btn.addEventListener('click', ()=>{
        try { overlay.remove(); } catch(_){}
      });

      const iframe = document.createElement('iframe');
      iframe.id = 'nova-video-iframe';
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
      iframe.allowFullscreen = true;
      iframe.referrerPolicy = 'strict-origin-when-cross-origin';
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = '0';

      wrap.appendChild(iframe);
      wrap.appendChild(btn);
      overlay.appendChild(wrap);
      document.body.appendChild(overlay);
    }
    const iframe = overlay.querySelector('iframe#nova-video-iframe');
    if (iframe) iframe.src = embedUrl;
    overlay.style.display = 'flex';
    try { window.scrollTo({top:0, behavior:'auto'}); } catch(_){}
    return true;
  }

  // 1) Prefer admin override
  if (d.videoOverride){
    const embed = toEmbed(d.videoOverride);
    if (embed){
      const parts = [];
      if (d.headingName) parts.push(d.headingName);
      if (d.lessonName) parts.push(d.lessonName);
      if (d.topicName) parts.push(d.topicName);
      openInApp(embed, parts);
      return;
    }
    console.warn('videoOverride provided but not a valid YouTube URL; falling back to resolver.');
  }

  // 2) Fallback to the same resolver as single-player (stays in-app)
  try{
    window.__novaSelection__ = Object.assign({}, window.__novaSelection__||{}, {
      classId: d.headingId||'',
      subjectId: d.lessonId||'',
      topicId: d.topicId||'',
    });
    if (typeof openVideo === 'function') {
      openVideo(); // expected to use shared video screen
    } else {
      // minimal in-app fallback: if resolver publishes a custom event with a URL, capture it
      const handler = (ev)=>{
        if (!ev || !ev.detail || !ev.detail.url) return;
        const embed = toEmbed(ev.detail.url);
        if (embed) openInApp(embed, []);
        window.removeEventListener('nova:resolved-lesson-video', handler);
      };
      window.addEventListener('nova:resolved-lesson-video', handler, {once:true});
      try{ window.dispatchEvent(new Event('nova:open-lesson-video')); }catch(_){}
    }
  }catch(e){
    console.warn('Video open error', e);
  }
}); // Start homework game

  hwStartBtn.addEventListener('click', async ()=>{
    if(!selectedHw) return;
    const d = selectedHw.detail||{};
    
    // NOVA_HW_LOCK: prevent re-playing a completed homework
    if (typeof database !== 'undefined' && selectedStudent && selectedStudent.studentId){
      try{
        const s = selectedStudent.studentId;
        const ref = database.ref('studentHomework/'+s+'/'+selectedHw.id+'/status');
        const snap = await ref.get();
        const st = snap && snap.val ? snap.val() : null;
        if (st === 'completed'){
          // Soft modal/toast
          try{
            await showAlert('Ödev tamamlandı. Bu ödevi tekrar yapamazsın.');
          }catch(_){ showAlert('Ödev tamamlandı. Bu ödevi tekrar yapamazsın.'); }
          return; // block start
        }
      }catch(_){ /* fail-open to avoid blocking in error */ }
    }
window.NOVA_Q_LIMIT = Number(d.questionCount||10);
    window.NOVA_ACTIVE_HOMEWORK = { hwId: selectedHw.id, selection: { headingId: d.headingId, lessonId: d.lessonId, topicId: d.topicId } };
    window.NOVA_HW_STARTED_AT = Date.now();
    try{
      // Hide homework UI and kick off the single‑player flow with predefined selection
      const h=d.headingId, l=d.lessonId, t=d.topicId;
      if (typeof fetchQuestions === 'function'){
        
        // Hide all multi-screen panels and open the question screen as a new full screen
        try{
          ['main-screen','duel-selection-screen','duel-game-screen','rankingPanel','lesson-video-screen','single-player-screen'].forEach(id=>{
            const el = document.getElementById(id); if (el) el.style.display='none';
          });
          const game = document.getElementById('single-player-game-screen');
          if (game){ game.style.display='flex'; window.scrollTo({top:0, behavior:'auto'}); }
        }catch(_){}
    document.getElementById('single-player-screen').style.display = 'none';
        document.getElementById('homework-screen').style.display = 'none';
        document.body.style.overflow='';
        // Ensure the game screen shows
        fetchQuestions(h, l, t);
      }
    }catch(e){ console.warn('start hw', e); }
  });
})();</script>
<!-- === /NOVA HOMEWORK MODULE === -->


<script id="nova-move-homework-above-photo">
(function(){
  function moveFab(){
    try{
      var ms = document.getElementById('main-screen');
      if(!ms) return false;
      var photo = ms.querySelector('.student-photo');
      var btn = document.getElementById('homework_fab');
      if(!photo || !btn) return false;
      // Insert a row right above the photo if not present
      var row = document.getElementById('homework_above_photo_row');
      if(!row){
        row = document.createElement('div');
        row.id = 'homework_above_photo_row';
        row.className = 'homework-above-photo';
        photo.parentNode.insertBefore(row, photo);
      }
      if(btn.parentNode !== row){
        row.appendChild(btn); // this preserves all existing listeners and behavior
      }
      // Ensure layout wins over any fixed rules scoped elsewhere
      btn.style.position = 'static';
      btn.style.inset = 'auto';
      btn.style.margin = '0 auto';
      return true;
    }catch(e){ return false; }
  }
  // Try a few times during initial load (in case the button/photo render later)
  var tries = 0;
  var timer = setInterval(function(){
    if(moveFab()){ /* keep trying a bit in case DOM reorders */ }
    if(++tries > 40) clearInterval(timer);
  }, 200);
  // Watch for DOM changes inside main-screen to re-apply the placement without touching behavior
  var ms = document.getElementById('main-screen');
  if(ms){
    var mo = new MutationObserver(function(){ moveFab(); });
    mo.observe(ms, {childList:true, subtree:true, attributes:true, attributeFilter:['style','class']});
  }
  // Also run on resize and after a brief delay
  window.addEventListener('resize', moveFab);
  window.addEventListener('load', moveFab, {once:true});
  setTimeout(moveFab, 1200);
})();
</script>


<!-- NOVA OPTIMIZATIONS: DROP-IN EGRESS REDUCER -->
<script>
(function(){
  // Config
  const TTL = {
    headingsMs: 6 * 60 * 60 * 1000,  // 6h cache for championData/headings
    storeIndexMs: 12 * 60 * 60 * 1000, // 12h cache for store/profilePhotosIndex
  };

  // Safe localStorage helpers
  const cache = {
    get(k){
      try {
        const raw = localStorage.getItem(k);
        if(!raw) return null;
        const o = JSON.parse(raw);
        if (o.exp && Date.now() > o.exp) { localStorage.removeItem(k); return null; }
        return o.val;
      } catch(_) { return null; }
    },
    set(k, v, ttlMs){
      try {
        localStorage.setItem(k, JSON.stringify({exp: ttlMs ? (Date.now()+ttlMs) : 0, val: v}));
      } catch(_) {}
    }
  };

  // NetMeter (debug only) — shows approx bytes downloaded per path
  const NetMeter = (() => {
    let total = 0, byPath = {};
    function sizeOf(v){ try { return new Blob([JSON.stringify(v??null)]).size } catch(_) { return 0; } }
    function add(path, val){
      const b = sizeOf(val);
      total += b;
      byPath[path] = (byPath[path]||0) + b;
      // update HUD
      const hud = document.getElementById('nova-net-hud');
      if (hud){
        const best = Object.entries(byPath).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([k,v])=>{
          const mb=(v/1024/1024).toFixed(2);
          return `<div class="row"><span class="path">${k}</span><span class="bytes">${mb} MB</span></div>`;
        }).join("");
        hud.querySelector('.total').textContent = (total/1024/1024).toFixed(2)+' MB';
        hud.querySelector('.list').innerHTML = best || '<em>no data yet</em>';
      }
    }
    function mountHud(){
      if (document.getElementById('nova-net-hud')) return;
      const box = document.createElement('div'); box.id='nova-net-hud';
      box.style.cssText = 'position:fixed;right:10px;bottom:10px;z-index:999999;background:rgba(0,0,0,.7);color:#d9f99d;padding:8px 10px;border:1px solid #84cc16;border-radius:12px;font:12px/1.3 ui-monospace,monospace;box-shadow:0 6px 18px rgba(0,0,0,.4)';
      box.innerHTML = '<div style="font-weight:700;margin-bottom:6px">NET ⬇ <span class="total">0 MB</span></div><div class="list"></div><div style="margin-top:6px;color:#a3e635">Nova NetMeter</div>';
      document.body.appendChild(box);
    }
    return { add, mountHud };
  })();
  // Uncomment to view HUD
  // requestAnimationFrame(NetMeter.mountHud);

  // Firebase helpers (assumes v9 modular or compat available globally)
  function dbRef(path){
    try{
      if (window.firebase && window.firebase.database) {
        return window.firebase.database().ref(path); // compat
      }
      if (window.getDatabase && window.ref) {
        return window.ref(window.getDatabase(), path); // modular
      }
    }catch(_){}
    throw new Error('Firebase Database not detected');
  }
  async function dbGet(path){
    // Compat
    if (window.firebase && window.firebase.database){
      const snap = await dbRef(path).once('value');
      NetMeter.add(path, snap.val());
      return snap;
    }
    // Modular
    if (window.get && window.getDatabase && window.ref){
      const snap = await window.get(window.ref(window.getDatabase(), path));
      NetMeter.add(path, snap.val());
      return snap;
    }
    throw new Error('Firebase get() not found');
  }
  function dbOnValue(path, cb){
    if (window.firebase && window.firebase.database){
      return dbRef(path).on('value', s => { NetMeter.add(path, s.val()); cb(s); });
    }
    if (window.onValue && window.getDatabase && window.ref){
      return window.onValue(window.ref(window.getDatabase(), path), s => { NetMeter.add(path, s.val()); cb(s); });
    }
    throw new Error('Firebase onValue() not found');
  }
  function dbOff(path){
    try {
      if (window.firebase && window.firebase.database){
        dbRef(path).off();
      } else if (window.off && window.getDatabase && window.ref){
        window.off(window.ref(window.getDatabase(), path));
      }
    } catch(_){}
  }

  // 1) SMART VIDEO URL LOOKUP (cheap first)
  async function getTopicVideoUrlSmart({topicId, lessonName, topicName}){
    // A) Direct index: /topicVideoUrls/{topicId}
    try {
      if (topicId){
        const a = await dbGet('topicVideoUrls/'+topicId);
        if (a && a.val && a.val()) return a.val();
      }
    } catch(_){}
    // B) Per-topic field: scan cached headings (localStorage) then resolve once
    try {
      const cacheKey='nova_headings_cache_v1';
      let tree = cache.get(cacheKey);
      if (!tree){
        const s = await dbGet('championData/headings');
        tree = s.val() || null;
        if (tree) cache.set(cacheKey, tree, TTL.headingsMs);
      }
      if (tree && topicId){
        // Traverse to find topicId once
        for (const hid in tree){
          const lessons = tree[hid]?.lessons||{};
          for (const lid in lessons){
            const topics = lessons[lid]?.topics||{};
            if (topics[topicId] && topics[topicId].videoUrl){
              return topics[topicId].videoUrl;
            }
          }
        }
      }
    } catch(_){}
    // C) Fallback name based lookup: /lessonVideoLookup/{lessonName}/{topicName}
    try {
      if (lessonName && topicName){
        const s = await dbGet(`lessonVideoLookup/${lessonName}/${topicName}`);
        if (s && s.val && s.val()) return s.val();
      }
    } catch(_){}
    return '';
  }
  // Expose to global + override old if present
  try { window.getTopicVideoUrlSmart = getTopicVideoUrlSmart; } catch(_){}

  // 2) STORE CATEGORIES: INDEX-FIRST + LAZY LOAD
  async function getStoreCategories(){
    // A) light index path
    try{
      const key='nova_store_index_v1';
      let idx = cache.get(key);
      if (!idx){
        const s = await dbGet('store/profilePhotosIndex'); // {cat: {count, updatedAt}}
        idx = s.val() || null;
        if (idx) cache.set(key, idx, TTL.storeIndexMs);
      }
      if (idx) return Object.keys(idx);
    }catch(_){}
    // B) fallback: minimal guess (avoid heavy download)
    return ['duel','EFSANE']; // will still work; user can switch category; heavy fetch only when category clicked
  }
  async function loadProfilePhotos(category){
    // Called after user chooses category; fetch only that branch
    const s = await dbGet('store/profilePhotos/'+category);
    const obj = s.val()||{};
    // Render area if exists
    const container = document.getElementById('profilePhotosContainer');
    if (container){
      container.innerHTML = '';
      Object.keys(obj).filter(k=>k!=='_meta').forEach(photoId=>{
        const ph = obj[photoId];
        const el = document.createElement('div');
        el.className='photo';
        el.innerHTML = `<img src="${ph.url}" alt=""><div class="price">${ph.price||0}</div>`;
        container.appendChild(el);
      });
    }
    return obj;
  }
  async function renderStoreCategoryButtons_optimized(){
    const area = document.querySelector('.profile-categories');
    if (!area) return;
    area.style.display='flex'; area.innerHTML='';
    const cats = await getStoreCategories();
    cats.forEach((k,i)=>{
      const btn = document.createElement('button');
      btn.className = 'category-button'+(i===0?' active':'');
      btn.dataset.category=k; btn.textContent=k;
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.category-button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const duelStore = document.getElementById('duelCreditsStore');
        const photosContainer = document.getElementById('profilePhotosContainer');
        if (duelStore && photosContainer){
          if (k==='duel'){ duelStore.style.display='block'; photosContainer.style.display='none'; }
          else { duelStore.style.display='none'; photosContainer.style.display='grid'; }
        }
        if (k!=='duel') loadProfilePhotos(k);
      });
      area.appendChild(btn);
    });
    // Auto-load first non-duel category's photos lazily
    const first = cats.find(c=>c!=='duel'); if (first) loadProfilePhotos(first);
  }
  // Try to override existing renderer if available
  try { window.renderStoreCategoryButtons = renderStoreCategoryButtons_optimized; } catch(_){}

  // 3) LISTENER HYGIENE HELPERS
  const NovaListeners = new Set();
  function trackOnValue(path, cb){
    const offFn = dbOnValue(path, cb) || (()=>dbOff(path));
    NovaListeners.add({path, off: offFn});
    return offFn;
  }
  function offAllNova(){
    NovaListeners.forEach(o=>{ try{o.off()}catch(_){ dbOff(o.path); } });
    NovaListeners.clear();
  }
  window.novaOffAllListeners = offAllNova;

  // 4) DUELS: Prefer /duelsByUser/{uid} if exists, fallback to costly queries
  async function subscribeDuelsForUser(uid, onList){
    try{
      const s = await dbGet('duelsByUser/'+uid);
      if (s.exists()){
        // light path
        trackOnValue('duelsByUser/'+uid, async ss=>{
          const ids = Object.keys(ss.val()||{});
          const out = [];
          for (const id of ids.slice(0,50)){
            const d = await dbGet('duels/'+id);
            out.push({id, ...(d.val()||{})});
          }
          onList(out);
        });
        return;
      }
    }catch(_){}
    // fallback: keep old behavior but limit range (needs indexes)
    const pathA = 'duels';
    trackOnValue(pathA, s=>{
      const all=s.val()||{};
      const arr = Object.entries(all).map(([id,d])=>({id,...d})).filter(d=>(d.inviter?.studentId===uid || d.invited?.studentId===uid)).slice(-50);
      onList(arr);
    });
  }
  window.subscribeDuelsForUser = subscribeDuelsForUser;

  // 5) MATCHMAKING: prefer user-only queue if exists; else limit by status/timestamp
  async function subscribeOwnQueue(uid, classId, onItem){
    try{
      const p = 'matchmakingByUser/'+uid;
      const s = await dbGet(p);
      if (s.exists()){
        trackOnValue(p, ss=>onItem(ss.val()));
        return;
      }
    }catch(_){}
    // Fallback limited
    trackOnValue(`matchmaking/${classId}`, ss=>{
      const all=ss.val()||{};
      // filter locally; expected small class queues
      const mine = Object.values(all).find(x=>x.studentId===uid);
      onItem(mine||null);
    });
  }
  window.subscribeOwnQueue = subscribeOwnQueue;

  console.log('%cNova Optimizer active','background:#0ea5e9;color:#fff;padding:2px 6px;border-radius:6px');
})();
</script>


<script>
/* === NOVA: Homework Diamond Rewards (one-time per HW/student) === */
async function awardHomeworkDiamonds(hwId, correct, total, sObj){
  try{
    const p = Math.round((Number(correct||0)/Math.max(1, Number(total||0))) * 100);
    let amount = 0;
    if (p >= 95) amount = 500;
    else if (p >= 80) amount = 250;
    else if (p >= 50) amount = 100;
    else if (p >= 40) amount = 20;
    else amount = 0;
    /* Mark first completion regardless of amount */
    const s = (sObj && sObj.studentId) ? sObj.studentId : (window.selectedStudent && selectedStudent.studentId);
    const c = (sObj && sObj.classId) ? sObj.classId : (window.selectedStudent && selectedStudent.classId);
    if(!s || !c) return;

    const rewardRef = database.ref('studentHomework/'+s+'/'+hwId+'/reward');
    let committed = false;
    await rewardRef.transaction(curr => {
      if (curr && curr.claimed) return curr;
      return { claimed: true, amount: amount, percent: p, claimedAt: Date.now() };
    }, function(err, commit, snap){
      committed = !!commit;
    });

    if (!committed) return; // already claimed earlier

    if (amount <= 0) { return; }

    const userRef = database.ref('classes/'+c+'/students/'+s);
    await userRef.transaction(user => {
      user = user || {};
      user.diamond = Math.min(25000, Number(user.diamond||0) + amount);
      user.lastDiamondUpdate = Date.now();
      return user;
    });

    // Visual celebration (no DB writes)
    showHomeworkRewardOverlay(amount, p);

    // Try to refresh on-screen counters
    try{
      if (typeof updateDiamondCount === 'function') updateDiamondCount();
      else {
        const dv = document.getElementById('diamond-value');
        if (dv){
          const snap = await userRef.child('diamond').get();
          dv.textContent = String(snap && snap.val ? (snap.val()||0) : '');
        }
      }
    }catch(_){}

  }catch(e){
    console.warn('awardHomeworkDiamonds error', e);
  }
}

function showHomeworkRewardOverlay(amount, percent){
  const id = 'nova-hw-reward-overlay';
  let el = document.getElementById(id);
  if (!el){
    el = document.createElement('div');
    el.id = id;
    el.className = 'reward-overlay'; // CSS already present in app
    el.innerHTML = `
      <div class="reward-card">
        <div class="reward-title">ÖDEV ÖDÜLÜ</div>
        <div class="reward-amount"><span class="num"></span> 💎</div>
        <div class="reward-sub">%<span class="pct"></span> başarıyla tamamladın!</div>
        <button class="reward-okay">Harika!</button>
      </div>
    `;
    document.body.appendChild(el);
    const style = document.createElement('style');
    style.textContent = `
      #${id}{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:99999; align-items:center; justify-content:center; }
      #${id} .reward-card{ background:linear-gradient(180deg,#0b1c3a,#071229); border:2px solid rgba(0,220,255,.35); color:#e9f4ff; border-radius:18px; padding:24px 28px; text-align:center; box-shadow:0 12px 40px rgba(0,0,0,.65), inset 0 0 24px rgba(0,200,255,.2); min-width: clamp(280px, 40vw, 520px); }
      #${id} .reward-title{ font-weight:900; letter-spacing:.5px; margin-bottom:8px; text-shadow:0 0 12px rgba(0,255,255,.5); }
      #${id} .reward-amount{ font-size: clamp(36px, 5vw, 72px); font-weight:900; margin: 6px 0 8px 0; filter: drop-shadow(0 0 14px rgba(0,255,255,.45)); }
      #${id} .reward-sub{ opacity:.9; margin-bottom:14px; }
      #${id} .reward-okay{ background:#10b981; border:none; color:#fff; font-weight:800; padding:10px 16px; border-radius:12px; cursor:pointer; }
      #${id} .float-diamond{ position:absolute; font-size: 24px; pointer-events:none; animation: floatUp 1100ms ease-out forwards; }
      @keyframes floatUp{ from{ transform: translateY(10px); opacity:.0;} to{ transform: translateY(-80px); opacity:0;} }
    `;
    document.head.appendChild(style);

    el.querySelector('.reward-okay').addEventListener('click', ()=> el.style.display='none');
  }
  el.querySelector('.num').textContent = String(amount);
  el.querySelector('.pct').textContent = String(percent);
  el.style.display = 'flex';
  // spawn a few floating diamonds
  for(let i=0;i<12;i++){
    const d = document.createElement('div');
    d.className = 'float-diamond';
    d.textContent = '💎';
    d.style.left = Math.round(30 + Math.random()*40)+'%';
    d.style.top = Math.round(40 + Math.random()*10)+'%';
    el.appendChild(d);
    setTimeout(()=> d.remove(), 1100+Math.random()*500);
  }
  // auto-hide after 3.5s if not clicked
  setTimeout(()=>{ if (el.style.display==='flex') el.style.display='none'; }, 3500);
}
</script>
</body>
</html>

<style>
/* Alevli "EFSANE" butonu stili (mobil 
<!-- NOVA SAFE SCRIPTS -->
<script>
(function(){
  function qs(s,r=document){ return r.querySelector(s); }
  function qsa(s,r=document){ return Array.from(r.querySelectorAll(s)); }
  function rect(el){ try{return el.getBoundingClientRect();}catch(_){return null;} }
  function area(r){ return r? Math.max(0, r.width*r.height) : 0; }
  function intersects(a,b){ if(!a||!b) return false; return !(a.right<b.left||a.left>b.right||a.bottom<b.top||a.top>b.bottom); }

  function findQuestion(root){
    let q = qs('.question-container', root) || qs('.question', root) || qs('[class*=\"soru\" i]', root);
    if(q) return q;
    const candidates = qsa('div,section,article,main', root).filter(el=>{
      const t=(el.innerText||'').trim(); if(t.length < 20) return false;
      const r=rect(el), ar=rect(root); if(!r||!ar) return false;
      const cx=(r.left+r.right)/2, cy=(r.top+r.bottom)/2;
      const inCentral = cx>ar.left+ar.width*.15 && cx<ar.right-ar.width*.15 && cy>ar.top+ar.height*.12 && cy<ar.bottom-ar.height*.35;
      return inCentral;
    });
    let best=null, bestA=0; candidates.forEach(el=>{const a=area(rect(el)); if(a>bestA){best=el; bestA=a;}});
    return best;
  }

  function markArena(){
    const root = document.body;
    const q = findQuestion(root);
    if(!q) return null;
    let arena = q.closest('.nova-duel-arena');
    if(!arena){
      arena = q.parentElement;
      if(!arena) return null;
      arena.classList.add('nova-duel-arena');
    }
    // Elevate question block
    if(!q.classList.contains('nova-question')){
      q.classList.add('nova-question');
      const aur = document.createElement('div'); aur.className = 'nova-aurora'; q.appendChild(aur);
    }
    return arena;
  }

  function injectOrbs(arena){
    if(!arena) return;
    if(qs('.nova-orbs', arena)) return;
    const wrap=document.createElement('div'); wrap.className='nova-orbs';
    const a=document.createElement('div'); a.className='nova-orb orb-a';
    const b=document.createElement('div'); b.className='nova-orb orb-b';
    wrap.appendChild(a); wrap.appendChild(b); arena.appendChild(wrap);
  }

  function sanitizeDecor(arena){
    const q = findQuestion(arena);
    const qR = rect(q);
    const options = qsa('.option-button, button, [role=\"button\"]', arena);
    const forbidden = [qR];
    if(options.length){
      // union
      let l=Infinity,t=Infinity,r=-Infinity,b=-Infinity;
      options.map(rect).forEach(x=>{ if(!x) return; l=Math.min(l,x.left); t=Math.min(t,x.top); r=Math.max(r,x.right); b=Math.max(b,x.bottom); });
      forbidden.push({left:l,top:t,right:r,bottom:b});
    }
    const suspects = qsa('*', arena).filter(el=>{
      if(el.closest('.nova-orbs')) return false;
      const tag=el.tagName.toLowerCase();
      if(tag==='button'||tag==='input'||tag==='select'||tag==='textarea') return false;
      const t=(el.textContent||'').trim(); if(t.length>2) return false;
      const cs=getComputedStyle(el);
      const abs = cs.position==='absolute'||cs.position==='fixed';
      if(!abs) return false;
      const w=el.offsetWidth,h=el.offsetHeight; if(w<24||h<24) return false;
      const ratio=Math.abs(w-h)<=Math.min(20, Math.max(w,h)*0.2);
      const radius=Math.max(parseFloat(cs.borderTopLeftRadius)||0,parseFloat(cs.borderTopRightRadius)||0,parseFloat(cs.borderBottomLeftRadius)||0,parseFloat(cs.borderBottomRightRadius)||0);
      const roundish = ratio && (radius >= Math.min(w,h)*0.35 || /50%/.test(cs.borderRadius));
      const named = /orb|ball|bubble|planet|gezegen|top/i.test(el.className+' '+el.id);
      return roundish || named;
    });
    suspects.forEach(el=>{
      el.classList.add('nova-force-behind');
      const r=rect(el);
      if(forbidden.some(z=>z && intersects(r,z))){
        // push to safest corner
        const ar=rect(arena);
        const corners=[{x:8,y:8},{x:ar.width-el.offsetWidth-8,y:8},{x:8,y:ar.height-el.offsetHeight-8},{x:ar.width-el.offsetWidth-8,y:ar.height-el.offsetHeight-8}];
        const zone=forbidden.filter(Boolean).reduce((u,z)=>({left:Math.min(u.left,z.left),top:Math.min(u.top,z.top),right:Math.max(u.right,z.right),bottom:Math.max(u.bottom,z.bottom)}),{left:Infinity,top:Infinity,right:-Infinity,bottom:-Infinity});
        const zx=(zone.left+zone.right)/2, zy=(zone.top+zone.bottom)/2;
        let best=corners[0], bestD=-1;
        corners.forEach(c=>{ const cx=(ar.left+c.x)+el.offsetWidth/2, cy=(ar.top+c.y)+el.offsetHeight/2; const d=Math.hypot(cx-zx,cy-zy); if(d>bestD){bestD=d; best=c;} });
        el.style.left=best.x+'px'; el.style.top=best.y+'px';
      }
    });
  }

  function hookPlusOneShock(arena){
    const orbb = arena.querySelector('.nova-orb.orb-b');
    if(!orbb) return;
    const counters = qsa('.duel-player-correct-count, [class*=\"score\" i]', arena);
    const obs = new MutationObserver(()=>{
      const ring=document.createElement('div'); ring.className='shockwave'; orbb.appendChild(ring);
      setTimeout(()=>ring.remove(), 900);
    });
    counters.forEach(el=> obs.observe(el, {childList:true, characterData:true, subtree:true}));
  }

  function removeVs(arena){
    const all = arena.querySelectorAll('*');
    all.forEach(el=>{
      try{
        const t=(el.textContent||'').toLowerCase().replace(/\s+/g,' ');
        const isVs = (t.includes('oyuncu 1')||t.includes('oyuncu1')) && t.includes(' vs ') && (t.includes('oyuncu 2')||t.includes('oyuncu2'));
        const classOrIdVs=/(^|[-_\s])vs([-_\s]|$)/i.test(el.className||'') || /vs/i.test(el.id||'');
        if((isVs||classOrIdVs) && !el.closest('[class*=\"score\" i]')) el.style.display='none';
      }catch(_){}
    });
  }

  function init(){
    const arena = markArena();
    if(!arena) return;
    injectOrbs(arena);
    sanitizeDecor(arena);
    hookPlusOneShock(arena);
    removeVs(arena);
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
  new MutationObserver(init).observe(document.documentElement, {childList:true, subtree:true, attributes:true});
  window.addEventListener('resize', init);
})();
</script>
+ desktop uyumlu) */
.category-button.legend {
  position: relative;
  background: linear-gradient(135deg, #ff4d00, #ff8800, #ffcd3c);
  color: #fff;
  font-weight: 900;
  letter-spacing: .6px;
  box-shadow: 0 0 12px rgba(255,77,0,.55), 0 0 24px rgba(255,136,0,.35);
  border: 2px solid rgba(255,255,255,.15);
  text-transform: uppercase;
  isolation: isolate;
  animation: flicker 1.15s infinite ease-in-out;
}
.category-button.legend::before,
.category-button.legend::after{
  content:"";
  position:absolute;
  inset:-6px;
  border-radius:12px;
  background: conic-gradient(from 180deg at 50% 50%, rgba(255,160,0,.15), transparent 30%, rgba(255,60,0,.18), transparent 55%, rgba(255,230,0,.18), transparent 80%);
  filter: blur(8px);
  z-index:-1;
  animation: heat 2.2s linear infinite;
  pointer-events:none;
}
.category-button.legend::after{
  inset:-10px;
  filter: blur(18px);
  opacity:.6;
  animation-direction: reverse;
}
@keyframes flicker{
  0%,100%{ filter: brightness(1); transform: translateY(0) }
  35%{ filter: brightness(1.25); transform: translateY(-1px) }
  60%{ filter: brightness(0.95); transform: translateY(0) }
}
@keyframes heat{
  0%{ transform: rotate(0deg) }
  100%{ transform: rotate(360deg) }
}

/* Mağaza başlığını, elmas değeri ve takas bölümünü aynı satırda tutan esnek düzen */
/* Bu sınıflar sayfada yoksa etkisiz kalır; varsa responsive hizalama sağlar */
.store-header-grid{
  display: grid;
  grid-template-columns: 1fr auto auto;
  align-items: center;
  gap: 12px;
}
@media (max-width: 700px){
  .store-header-grid{
    grid-template-columns: 1fr;
    gap: 8px;
  }
  .store-title{ text-align:center }
  .diamond-wrap{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap }
}


/* === Nova Responsive Question UI (2025-10-03) === */
:root{
  --q-maxw: min(1000px, 95vw);
  --q-minh: clamp(320px, 50vh, 560px);
  --q-pad: clamp(16px, 3vw, 28px);
  --q-border: 4px;
  --q-radius: 16px;
  --q-shadow: 0 8px 24px rgba(0,0,0,.15);
  --q-font: clamp(1.1rem, 2.4vw, 1.6rem);
  --opt-font: clamp(0.95rem, 2vw, 1.3rem);
  --opt-pad-y: clamp(10px, 1.8vh, 16px);
  --opt-pad-x: clamp(12px, 3vw, 22px);
  --opt-minw: clamp(140px, 40%, 420px);
}

/* Container for single and duel question cards */
.single-player-game-container,
.duel-game-container{
  align-items:center;
  justify-content:center;
  padding: clamp(14px, 3vw, 32px);
}

/* Question frame */
.question-container{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  width: 100%;
  max-width: var(--q-maxw);
  min-height: var(--q-minh);
  padding: var(--q-pad);
  text-align:center;
  border: var(--q-border) solid #ff8a00;
  border-radius: var(--q-radius);
  background: #fffbea;
  box-shadow: var(--q-shadow);
  overflow:hidden;
  margin-inline:auto;
}

/* Question text */
.question-text{
  font-size: var(--q-font);
  font-weight: 800;
  line-height: 1.35;
  margin: 8px 0 12px 0;
  text-wrap: pretty;
  word-break: break-word;
  max-width: 90ch;
}

/* Optional image inside the question */
.question-image{
  max-width: 100%;
  max-height: 50vh;
  object-fit: contain;
  margin: 8px auto 10px auto;
  display:block;
}

/* Options grid */
.options-container{
  display:flex;
  flex-wrap: wrap;
  justify-content:center;
  align-items:stretch;
  gap: clamp(8px, 2vw, 16px);
  width: 100%;
  max-width: var(--q-maxw);
  margin-top: 6px;
}

/* Option buttons */
.option-button{
  flex: 1 1 var(--opt-minw);
  min-width: var(--opt-minw);
  max-width: 480px;
  padding: var(--opt-pad-y) var(--opt-pad-x);
  font-size: var(--opt-font);
  line-height: 1.25;
  border-radius: 14px;
  box-shadow: 0 6px 14px rgba(0,0,0,.12);
  white-space: normal;
  word-break: break-word;
}

/* Progress/timer tighten spacing on mobile */
.progress-container{max-width: var(--q-maxw);}
.timer{font-size: clamp(1rem, 2.4vw, 1.2rem);}

/* Portrait phones: ensure full-bleed fit */
@media (max-width: 480px) {
  .question-container{
    min-height: clamp(320px, 58vh, 620px);
  }
  .options-container{
    gap: 8px;
  }
}

/* Tall screens (tablet portrait) */
@media (min-height: 900px) and (max-width: 1024px){
  .question-container{ min-height: clamp(480px, 60vh, 700px); }
}

/* Landscape small devices: keep text within frame without overflow */
@media (max-height: 420px) and (orientation: landscape){
  .question-image{ max-height: 40vh; }
  .question-text{ font-size: clamp(1rem, 2.2vw, 1.3rem); }
  .option-button{ font-size: clamp(0.9rem, 2vw, 1.1rem); }
}
/* === End Nova Responsive Question UI === */

</style>
<script>
/* -------------------- NOVA: Güvenli kategori oluşturucu --------------------
   Hedefler:
   1) 'EFSANE' butonu DOM'da MUTLAKA en sonda yer alacak.
   2) 'EFSANE' butonu alevli/özel animasyonlu olacak.
   3) 'duel' kategorisi varsa açılışta ona geçiş desteklenecek.
   4) Mevcut loadProfilePhotos ve DOM yapını bozmadan çalışır.
---------------------------------------------------------------------------- */
(function(){
  // Yardımcı: benzersiz liste
  function unique(arr){ const s = new Set(); return arr.filter(x => (x && !s.has(x) && s.add(x))); }

  // Güvenli ana fonksiyon
  window.renderStoreCategoryButtons = function renderStoreCategoryButtons(){
    const area = document.querySelector('.profile-categories');
    if(!area) return;
    area.style.display = 'flex';
    area.innerHTML = '';

    // Veri kaynağı: photoCategories varsa anahtarlarını al, yoksa bilinen varsayılanlar
    let keys = [];
    try {
      if (typeof photoCategories === 'object' && photoCategories){
        keys = Object.keys(photoCategories);
      }
    } catch(e){}
    if(!keys.length){
      keys = ['duel','DünyaDevleri','cesur','TemelKarakterler','SüperLig','DünyaFutbolcuları','KizlarKösesi','EFSANE'];
    }

    // Temizlik + sıralama: 'EFSANE' sonda, 'duel' en başta kalsın (varsa)
    keys = unique(keys);
    const hasDuel = keys.includes('duel');
    keys = keys.filter(k => k !== 'EFSANE' && k !== 'duel'); // ikisini geçici çıkar
    if (hasDuel) keys.unshift('duel');
    keys.push('EFSANE'); // EFSANE sona

    // DOM üretimi
    keys.forEach((k, i) => {
      const btn = document.createElement('button');
      btn.className = 'category-button' + (i===0 ? ' active' : '');
      btn.dataset.category = k;
      btn.textContent = k;

      // EFSANE için özel sınıf
      if (k === 'EFSANE'){
        btn.classList.add('legend');
        btn.title = '🔥 Efsane Seçkisi';
      }

      btn.addEventListener('click', () => {
        document.querySelectorAll('.category-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const duelStore = document.getElementById('duelCreditsStore');
        const photosContainer = document.getElementById('profilePhotosContainer');
        if (duelStore && photosContainer){
          if (k === 'duel'){
            duelStore.style.display = 'block';
            photosContainer.style.display = 'none';
          } else {
            duelStore.style.display = 'none';
            photosContainer.style.display = 'grid';
          }
        }
        if (typeof loadProfilePhotos === 'function' && k !== 'duel'){
          loadProfilePhotos(k);
        }
      });

      area.appendChild(btn);
    });
  };

  // Mağaza üst başlık hizalama (varsa uygula)
  document.addEventListener('DOMContentLoaded', function(){
    // Olası başlık-seçenek yapılarının kapsayıcısını yakala
    var title = document.querySelector('.store-title, .magaza-title, .shop-title');
    var diamond = document.querySelector('.diamond-value, .diamond-display, #diamondDisplay');
    var exchange = document.querySelector('.diamond-exchange, .diamond-takas, #diamondExchange');

    // Eğer üçlüden en az ikisi varsa grid uygula
    if (title || diamond || exchange){
      // En uygun kapsayıcıyı seç
      var host = (title && title.parentElement) || (diamond && diamond.parentElement) || (exchange && exchange.parentElement);
      if (host && !host.classList.contains('store-header-grid')){
        host.classList.add('store-header-grid');
        if (title) title.classList.add('store-title');
        if (diamond){
          var wrap = document.createElement('div');
          wrap.className = 'diamond-wrap';
          diamond.parentElement.insertBefore(wrap, diamond);
          wrap.appendChild(diamond);
          if (exchange) wrap.appendChild(exchange);
        }
      }
    }

    // Sayfa açılışında kategorileri güvenle çiz
    try { window.renderStoreCategoryButtons(); } catch(e){ console.warn('Kategori çizimi hatası:', e); }
  });
})();
</script>
<!-- === /NOVA PATCH === -->


<script>
(function(){
  // Nova fix v2: back button should only appear on result screen and
  // should behave like the in-result "Geri Dön" (id=final-back-button).
  function isVisible(el){
    if(!el) return false;
    const cs = getComputedStyle(el);
    if(cs.visibility==='hidden' or cs.display==='none') return False;
    if(el.offsetParent===null && cs.position!=='fixed') return false;
    return true;
  }

  function toggleBackStrict(){
    var sc = document.getElementById('score-container');
    var endBtn = document.getElementById('final-back-button');
    var backBtn = document.getElementById('result-back-btn');
    if(!backBtn) return;
    var show = isVisible(sc) && isVisible(endBtn);
    backBtn.style.display = show ? 'inline-flex' : 'none';
  }

  function wireBackStrict(){
    var backBtn = document.getElementById('result-back-btn');
    if(!backBtn || backBtn.dataset.wired2) return;
    backBtn.dataset.wired2='1';
    backBtn.addEventListener('click', function(){
      var endBtn = document.getElementById('final-back-button');
      if(endBtn && isVisible(endBtn)){
        endBtn.click(); // this replaces the result panel in-place
        return;
      }
      // Fallbacks
      var singleNav = document.querySelector('.single-player');
      if(singleNav){ singleNav.click(); }
    });
  }

  // Observe DOM for changes to results screen
  var mo = new MutationObserver(function(){ toggleBackStrict(); });
  mo.observe(document.body, {subtree:true, childList:true, attributes:true, attributeFilter:['style','class']});

  document.addEventListener('DOMContentLoaded', function(){
    wireBackStrict(); toggleBackStrict();
  });
  window.addEventListener('load', function(){
    wireBackStrict(); toggleBackStrict();
  });
})();
</script>


<script>
(function(){
  function hardBack(){
    try{
      // stop all music if function exists
      if (typeof stopAllMusic === 'function') stopAllMusic();
    }catch(_){}
    try{
      var singlePlayerGameScreen = document.getElementById('single-player-game-screen');
      var mainScreen = document.getElementById('main-screen');
      var scoreContainer = document.getElementById('score-container');
      if (scoreContainer) scoreContainer.style.display='none';
      if (singlePlayerGameScreen) singlePlayerGameScreen.style.display='none';
      if (mainScreen) mainScreen.style.display='flex';
      if (typeof resetGameScreens === 'function') resetGameScreens();
    }catch(_){}
  }

  var backBtn = document.getElementById('result-back-btn');
  if (backBtn && !backBtn.dataset.hardbound){
    backBtn.dataset.hardbound='1';
    backBtn.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      // Try the native final-back-button first (if visible)
      var endBtn = document.getElementById('final-back-button');
      if (endBtn && getComputedStyle(endBtn).display!=='none') {
        endBtn.click();
        setTimeout(hardBack, 20); // ensure consistency
      } else {
        hardBack();
      }
    }, true);
  }
})();
</script>


<script>
// === NOVA: Homework Diamond Rewards (final override) ===
async function awardHomeworkDiamonds(hwId, correct, total, sObj){
  try{
    const p = Math.round((Number(correct||0)/Math.max(1, Number(total||0))) * 100);
    let amount = 0;
    if (p === 100) amount = 500;
    else if (p >= 80) amount = 250;
    else if (p >= 50) amount = 100;
    else if (p >= 40) amount = 20;
    else amount = 0;

    const s = (sObj && sObj.studentId) ? sObj.studentId : (window.selectedStudent && selectedStudent.studentId);
    const c = (sObj && sObj.classId) ? sObj.classId : (window.selectedStudent && selectedStudent.classId);
    if(!s || !c) return;

    // Transaction guard: mark first completion regardless of amount
    const rewardRef = database.ref('studentHomework/'+s+'/'+hwId+'/reward');
    let committed = false;
    await rewardRef.transaction(curr => {
      if (curr && curr.claimed) return curr;
      return { claimed:true, amount: amount, percent: p, claimedAt: Date.now() };
    }, function(err, commit, snap){ committed = !!commit; });

    if (!committed) return; // already completed earlier → no further action

    // If amount > 0, credit diamonds atomically and celebrate
    if (amount > 0){
      const userRef = database.ref('classes/'+c+'/students/'+s);
      await userRef.transaction(user => {
        user = user || {};
        user.diamond = Math.min(25000, Number(user.diamond||0) + amount);
        user.lastDiamondUpdate = Date.now();
        return user;
      });
      showHomeworkRewardOverlay(amount, p);
      try{
        if (typeof updateDiamondCount === 'function') updateDiamondCount();
      }catch(_){}
    }
  }catch(e){
    console.warn('awardHomeworkDiamonds error', e);
  }
}

function showHomeworkRewardOverlay(amount, percent){
  const id = 'nova-hw-reward-overlay-final';
  let el = document.getElementById(id);
  if (!el){
    el = document.createElement('div');
    el.id = id;
    el.style.position = 'fixed';
    el.style.inset = '0';
    el.style.background = 'rgba(0,0,0,.6)';
    el.style.zIndex = '99999';
    el.style.display = 'none';
    el.style.alignItems = 'center';
    el.style.justifyContent = 'center';
    el.innerHTML = `
      <div class="reward-card" style="background:linear-gradient(180deg,#0b1c3a,#071229);border:2px solid rgba(0,220,255,.35);color:#e9f4ff;border-radius:18px;padding:24px 28px;text-align:center;box-shadow:0 12px 40px rgba(0,0,0,.65), inset 0 0 24px rgba(0,200,255,.2);min-width: clamp(280px, 40vw, 520px);">
        <div class="reward-title" style="font-weight:900;letter-spacing:.5px;margin-bottom:8px;text-shadow:0 0 12px rgba(0,255,255,.5);">ÖDEV ÖDÜLÜ</div>
        <div class="reward-amount" style="font-size: clamp(36px, 5vw, 72px); font-weight:900; margin: 6px 0 8px 0; filter: drop-shadow(0 0 14px rgba(0,255,255,.45));"><span class="num"></span> 💎</div>
        <div class="reward-sub" style="opacity:.9; margin-bottom:14px;">%<span class="pct"></span> başarıyla tamamladın!</div>
        <button class="reward-okay" style="background:#10b981;border:none;color:#fff;font-weight:800;padding:10px 16px;border-radius:12px;cursor:pointer;">Harika!</button>
      </div>
    `;
    document.body.appendChild(el);
    el.querySelector('.reward-okay').addEventListener('click', ()=> el.style.display='none');
  }
  el.querySelector('.num').textContent = String(amount);
  el.querySelector('.pct').textContent = String(percent);
  el.style.display = 'flex';
  for(let i=0;i<12;i++){
    const d = document.createElement('div');
    d.textContent = '💎';
    d.style.position='absolute';
    d.style.left = (30 + Math.random()*40)+'%';
    d.style.top = (40 + Math.random()*16)+'%';
    d.style.fontSize = '24px';
    d.style.animation = 'floatUp 1100ms ease-out forwards';
    d.style.pointerEvents = 'none';
    el.appendChild(d);
    setTimeout(()=> d.remove(), 1400);
  }
  setTimeout(()=>{ if (el.style.display==='flex') el.style.display='none'; }, 3500);
}
</script>
